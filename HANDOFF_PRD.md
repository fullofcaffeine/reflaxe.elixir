# Reflaxe.Elixir Compiler - Task Handoff PRD
**Date**: 2025-01-25
**Status**: Ready for handoff to new development session
**Context**: Comprehensive list of pending tasks and known issues for continuation

## ðŸŽ¯ Executive Summary

This document provides a complete handoff for continuing development on the Reflaxe.Elixir compiler. The compiler has recently resolved critical Y-combinator compilation errors and Module.concat issues. Several important tasks remain pending to achieve production-ready status.

**PRIMARY GOAL**: The todo-app must work flawlessly - it's the primary integration test and showcase for the compiler. All issues should be fixed in their proper place (compiler bugs in the compiler, app issues in the app) resulting in a clean, warning-free compilation and smooth runtime experience.

## âœ… Recent Accomplishments (Context)

### 1. Fixed Module.concat Compilation Issue
- **Problem**: `Module.concat` was being compiled as array concatenation (`Module ++ [...]`) instead of method call
- **Root Cause**: MethodCallCompiler treated any `.concat()` call as array operation
- **Solution**: Added `isExternModuleCall()` check to distinguish extern module methods from array methods
- **Files Modified**: 
  - `/src/reflaxe/elixir/helpers/MethodCallCompiler.hx` (lines 365-368, 1150-1185)
  - `/std/phoenix/SafePubSub.hx` (removed all `__elixir__()` workarounds)
- **Status**: âœ… COMPLETE - Phoenix server starts successfully

### 2. Y-Combinator Pattern Fixes (Previous Work)
- Fixed malformed inline if-else expressions with struct updates
- Forced block syntax for proper Elixir generation
- Comprehensive documentation in `/docs/03-compiler-development/Y_COMBINATOR_PATTERNS.md`

## ðŸš¨ CRITICAL: Pending Tasks

### 1. Complete TVar.id Variable Mapping Integration
**Priority**: HIGH  
**Complexity**: Medium  
**Documentation**: `/docs/03-compiler-development/VARIABLE_MAPPING_IMPLEMENTATION_STATUS.md`

#### Problem
JsonPrinter still generates incorrect output with duplicate variable names:
```elixir
# CURRENT (BROKEN)
fn -> ((g_array < g_array)) end,

# EXPECTED (FIXED)
fn -> ((g_counter < g_array)) end,
```

#### Technical Context
- Foundation is implemented in `VariableCompiler.hx` with `variableIdMap: Map<Int, String>`
- TVar.id-based mapping prevents variable name collisions
- Integration incomplete - LoopCompiler still uses hardcoded names

#### Required Work
1. **Update LoopCompiler.hx**:
   - Remove hardcoded check at line 3595: `if (varName == "g_counter")`
   - Integrate with VariableCompiler's `setupLoopDesugaringMappings()`
   - Use TVar.id when creating desugared variables

2. **Enhance VariableMappingManager**:
   - Convert internal maps from `Map<String, String>` to `Map<Int, String>`
   - Update `transformVariableName` to accept TVar instead of String
   - Ensure consistency across all variable resolution

3. **Testing**:
   - Verify JsonPrinter generates unique names
   - Test nested loops and complex enum scenarios
   - Run full regression suite: `npm test`

### 2. Implement Enum.with_index Array Optimization
**Priority**: Medium  
**Complexity**: Medium  
**Context**: Convert array iteration fallbacks to idiomatic Elixir patterns

#### Current State
Array iteration generates verbose loop constructs instead of idiomatic Elixir:
```elixir
# CURRENT (VERBOSE)
Enum.reduce(Enum.with_index(array), acc, fn {item, index}, acc ->
  # Complex desugared logic
end)

# EXPECTED (IDIOMATIC)
array |> Enum.with_index() |> Enum.map(fn {item, index} ->
  # Clean transformation
end)
```

#### Required Work
1. Detect array iteration patterns in AST
2. Generate `Enum.with_index()` for indexed iterations
3. Optimize pipeline operations for readability
4. Update test snapshots with improved output

### 3. Fix Todo-App Compilation Warnings
**Priority**: HIGH  
**Complexity**: Medium  
**Impact**: Clean compilation is essential for production readiness

#### Compiler Issues (Must fix in compiler)
1. **Unused temp_string variables** (ChildSpecBuilder.ex lines 15-17, 27-29)
   - Compiler generates temp variables that are immediately reassigned
   - Fix: Detect and eliminate redundant temp variable generation

2. **Unused temp_number variables** (multiple files)
   - Similar pattern to temp_string issue
   - Generated by compiler's temporary variable system

3. **Invalid empty expressions `()`**
   - Compiler generating empty parentheses in some contexts
   - Should generate `nil` or proper expression

4. **Unused function parameters**
   - Parameters like `filter`, `user`, `id`, `term` not prefixed with underscore
   - Compiler should detect unused params and prefix with `_`

#### Application Issues (Fix in todo-app)
1. **Missing FileSystem dependency**
   - HaxeWatcher requires FileSystem module (lines 268, 270)
   - Add `:file_system` to mix.exs dependencies

2. **Unused configuration variables**
   - `app_name` and `config` parameters in some modules
   - Review and either use or prefix with underscore

### 4. Legacy Code Cleanup
**Priority**: Low  
**Complexity**: Low  
**Risk**: Ensure no regressions

#### Items to Remove
- Old Y-combinator workaround code (if confirmed stable)
- Unused helper functions in ExpressionCompiler
- Deprecated pattern detection heuristics
- Commented debug traces

#### Validation Required
- Full test suite must pass: `npm test`
- Todo-app must compile and run: `cd examples/todo-app && mix phx.server`
- No performance regressions

## âš ï¸ Known Issues to Address

### 1. Hardcoded Variable Names in LoopCompiler
**Location**: `/src/reflaxe/elixir/helpers/LoopCompiler.hx:3595`
```haxe
if (varName == conditionInfo.indexVar || varName == "g_counter") {
```
**Fix**: Replace with TVar.id-based check

### 2. Missing Variable Registration Points
**Issue**: Loop desugaring creates variables without registering them in variableIdMap
**Solution**: Call `registerVariableMapping()` when creating loop variables

### 3. Incomplete Pattern Detection
**Issue**: Some collection patterns not recognized for optimization
**Solution**: Expand pattern detection in LoopPatternDetector

### 4. Compiler Warning Generation Issues

#### Temp Variable Generation
**Files Affected**: ChildSpecBuilder.ex, TypeSafeChildSpecTools.ex, multiple others
**Pattern**:
```elixir
temp_string = nil              # Line 15: unused warning
temp_string = if condition...  # Line 17: reassignment warning
```
**Root Cause**: Compiler generates temporary variables even when not needed
**Fix Location**: Check ExpressionCompiler or TernaryCompiler for redundant temp generation

#### Empty Expression Generation
**Warning**: `invalid expression ()`
**Root Cause**: Compiler generating empty parentheses instead of proper expressions
**Fix**: Should generate `nil` or appropriate value, not empty `()`

#### Unused Parameters Not Prefixed
**Examples**: `filter`, `user`, `id`, `term` parameters
**Issue**: Unused function parameters not prefixed with underscore
**Fix**: Compiler should detect unused parameters and prefix with `_` automatically

### 5. Application Dependency Issues

#### Missing FileSystem Module
**File**: HaxeWatcher.ex lines 268, 270
**Error**: `FileSystem.start_link/1 is undefined`
**Fix**: Add to todo-app's mix.exs:
```elixir
{:file_system, "~> 1.0"}
```

## ðŸ“‹ Testing Checklist

After implementing any changes:

### Required Tests
- [ ] Run full snapshot test suite: `npm test`
- [ ] Test todo-app compilation: `cd examples/todo-app && npx haxe build-server.hxml`
- [ ] Verify Elixir compilation: `mix compile --force`
- [ ] Test application runtime: `mix phx.server`
- [ ] Check for memory leaks in long compilations
- [ ] Verify compilation performance (<15ms target)

### Edge Cases to Test
- [ ] Nested loops with same variable names
- [ ] Complex enum pattern matching
- [ ] Reflect.fields optimization
- [ ] Y-combinator recursive patterns
- [ ] Array method chaining

## ðŸ”§ Development Environment Setup

### Prerequisites
```bash
# Verify environment
haxe --version  # Should be 4.3.x
elixir --version  # Should be 1.14+
mix --version
npm --version

# Install dependencies
npm install
mix deps.get
```

### Key Files to Review
1. **Compiler Core**:
   - `/src/reflaxe/elixir/ElixirCompiler.hx` - Main compiler (10,661 lines - needs refactoring!)
   - `/src/reflaxe/elixir/helpers/VariableCompiler.hx` - TVar.id mapping implementation
   - `/src/reflaxe/elixir/helpers/LoopCompiler.hx` - Loop compilation needing integration

2. **Documentation**:
   - `/CLAUDE.md` - Main AI context (keep under 40k chars)
   - `/docs/03-compiler-development/VARIABLE_MAPPING_FIX.md` - TVar.id solution details
   - `/docs/03-compiler-development/VARIABLE_MAPPING_IMPLEMENTATION_STATUS.md` - Current status

3. **Tests**:
   - `/test/tests/` - Snapshot tests
   - `/examples/todo-app/` - Primary integration test

## ðŸš€ Quick Start Commands

```bash
# Run tests after changes
npm test

# Test todo-app integration
cd examples/todo-app
rm -rf lib/*.ex lib/**/*.ex
npx haxe build-server.hxml
mix compile --force
mix phx.server

# Debug compilation
npx haxe build-server.hxml -D debug_loops -D debug_optimization

# Accept new test output
haxe test/Test.hxml update-intended
```

## ðŸ“š Architecture Context

### Key Principles
1. **No Band-Aid Fixes**: Always fix root causes, never patch symptoms
2. **Use Established Patterns**: Follow Reflaxe framework patterns (e.g., MarkUnusedVariablesImpl)
3. **No Hardcoding**: Never hardcode enum names or types in compiler logic
4. **Comprehensive Documentation**: Every change needs WHY/WHAT/HOW documentation
5. **Type Safety**: Avoid `untyped` and `Dynamic` unless absolutely necessary

### Variable Mapping Architecture
- **TVar.id** is the unique identifier for variables (integer)
- **variableIdMap**: Maps TVar.id â†’ Elixir variable name
- **Framework Pattern**: Follows Reflaxe's MarkUnusedVariablesImpl approach
- **Collision-Free**: Integer keys prevent name collision issues

## ðŸŽ¯ Success Criteria

The following must be achieved for task completion:

### Todo-App Excellence (PRIMARY GOAL)
- [ ] **Zero compilation warnings** - Clean `npx haxe build-server.hxml` output
- [ ] **Zero Elixir warnings** - Clean `mix compile --force` output  
- [ ] **Smooth runtime** - `mix phx.server` starts without errors
- [ ] **Full functionality** - All features work (LiveView, routing, database)
- [ ] **Clean logs** - No runtime warnings or deprecations
- [ ] **Idiomatic code** - Generated Elixir looks hand-written
- [ ] **Performance** - Fast compilation and responsive runtime

### Functional Requirements
- [ ] JsonPrinter generates unique variable names (no `g_array < g_array`)
- [ ] All snapshot tests pass (`npm test` succeeds)
- [ ] Todo-app compiles and runs without errors
- [ ] No hardcoded variable checks remain
- [ ] TVar.id used consistently for mapping
- [ ] Temp variables eliminated or properly used
- [ ] Unused parameters prefixed with underscore

### Quality Requirements
- [ ] Generated Elixir is idiomatic and readable
- [ ] Compilation performance maintained (<15ms)
- [ ] No memory leaks or performance regressions
- [ ] Code properly documented with WHY/WHAT/HOW
- [ ] Test coverage for new functionality
- [ ] No `()` empty expressions in generated code
- [ ] Proper variable naming without collisions

### Documentation Requirements
- [ ] Update VARIABLE_MAPPING_IMPLEMENTATION_STATUS.md
- [ ] Document any new patterns discovered
- [ ] Update CLAUDE.md if exceeding 40k chars
- [ ] Add integration examples if needed
- [ ] Document warning fixes and their solutions

## ðŸ” Debugging Tips

### Enable Debug Traces
```haxe
// Add to see variable mapping
#if debug_variables
trace('[XRay Variables] Mapping TVar.id ${tvar.id} to "${mappedName}"');
#end
```

### Common Issues
1. **"Unknown identifier" errors**: Variable not found in mapping
2. **Duplicate names**: TVar.id mapping not applied
3. **Compilation timeout**: Check for infinite loops in compiler
4. **Phoenix errors**: Module.concat or PubSub issues

### Investigation Commands
```bash
# Check recent commits for context
git log --oneline -30

# Find related changes
git grep -n "TVar.id"
git grep -n "variableIdMap"

# Check for TODOs
grep -r "TODO\|FIXME" src/
```

## ðŸ“ž Contact & Resources

### Project Resources
- GitHub: https://github.com/fullofcaffeine/reflaxe.elixir
- Haxe API: https://api.haxe.org/
- Reflaxe Framework: Reference implementation in `/haxe.elixir.reference/`

### Key Documentation
- Comprehensive guides in `/docs/` directory
- Compiler-specific context in `/docs/03-compiler-development/CLAUDE.md`
- Testing guide in `/docs/03-compiler-development/testing-infrastructure.md`

## âš ï¸ CRITICAL WARNINGS

### Never Do These
1. **DON'T edit generated .ex files** - they're overwritten on recompilation
2. **DON'T use `__elixir__()` injections** - fix the compiler properly
3. **DON'T skip tests** - always run `npm test` before committing
4. **DON'T leave TODOs** - fix issues completely or document in issues
5. **DON'T hardcode app names** - compiler must work for any Phoenix app

### Always Do These
1. **DO fix root causes** - no band-aid fixes ever
2. **DO follow Reflaxe patterns** - use established framework approaches
3. **DO document comprehensively** - WHY/WHAT/HOW for everything
4. **DO test integration** - todo-app must always work
5. **DO commit incrementally** - small, focused commits with clear messages

---

## Summary

**THE PRIMARY GOAL**: Make the todo-app work flawlessly with zero warnings and perfect runtime behavior. It's the showcase and primary integration test for the compiler.

**Top Priorities**:
1. Complete TVar.id variable mapping integration (fixes duplicate variable names)
2. Fix compiler warning generation (temp variables, empty expressions, unused parameters)
3. Implement Enum.with_index optimization for idiomatic code
4. Polish todo-app to production quality

The foundation is solid - the TVar.id mapping system is already in place in VariableCompiler. Most work is integration, warning fixes, and polishing. Remember: issues should be fixed in their proper place - compiler bugs in the compiler, app issues in the application.

**Estimated Time**: 
- TVar.id integration: 2-4 hours
- Enum.with_index optimization: 2-3 hours  
- Todo-app warning fixes: 3-4 hours (compiler issues are tricky)
- Legacy cleanup: 1 hour
- Testing & validation: 2-3 hours
- Final todo-app polish: 1-2 hours

**Total**: 11-17 hours of focused development

Good luck with the implementation! The architecture is sound - it just needs the final integration steps.