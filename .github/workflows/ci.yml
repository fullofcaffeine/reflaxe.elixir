name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  NODE_VERSION: '20'
  HAXE_VERSION: '4.3.7'
  ELIXIR_VERSION: '1.18.3'
  OTP_VERSION: '27.2'

jobs:
  secret-scan:
    name: Secret Scan (gitleaks)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  guards:
    name: Guardrails
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Install npm dependencies
        run: npm ci
      - name: Run guardrails
        run: npm run ci:guards

  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: [guards]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Setup Erlang/Elixir
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          elixir-version: ${{ env.ELIXIR_VERSION }}
      - name: Setup Haxe
        uses: krdlab/setup-haxe@v1
        with:
          haxe-version: ${{ env.HAXE_VERSION }}
      - name: Cache Mix deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.mix
            ~/.hex
            deps
            _build
          key: ${{ runner.os }}-mix-${{ hashFiles('mix.lock') }}
          restore-keys: |
            ${{ runner.os }}-mix-
      - name: Install npm dependencies
        run: npm ci
      - name: Download Haxe libraries (lix)
        run: npx lix download
      - name: Run full test suite
        run: npm test

  examples:
    name: Examples
    runs-on: ubuntu-latest
    needs: [guards]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      - name: Setup Haxe
        uses: krdlab/setup-haxe@v1
        with:
          haxe-version: ${{ env.HAXE_VERSION }}
      - name: Install npm dependencies
        run: npm ci
      - name: Download Haxe libraries (lix)
        run: npx lix download
      - name: Compile-check examples
        run: npm run test:examples
