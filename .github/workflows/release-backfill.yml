name: Release (Backfill Existing Tag)

on:
  workflow_dispatch:
    inputs:
      all_tags:
        description: "Backfill releases for all semver tags (vX.Y.Z). When true, 'tag' is ignored."
        required: false
        type: boolean
        default: false
      overwrite_existing:
        description: "Overwrite release bodies for existing releases (use CHANGELOG.md when present)."
        required: false
        type: boolean
        default: false
      tag:
        description: "Existing tag to publish (e.g. v1.1.5). Ignored when all_tags=true."
        required: false
        default: ""
      skip_verify:
        description: "Skip verification steps (useful for backfilling historical tags)."
        required: false
        type: boolean
        default: true

concurrency:
  group: release-backfill-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write

env:
  NODE_VERSION: "20"
  HAXE_VERSION: "4.3.7"
  ELIXIR_VERSION: "1.18.3"
  OTP_VERSION: "27.2"

jobs:
  verify-and-release:
    name: Verify + Publish Release (Backfill)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Resolve tag metadata
        id: meta
        run: |
          set -euo pipefail
          echo "skip_verify=${{ inputs.skip_verify }}" >> "$GITHUB_OUTPUT"
          echo "all_tags=${{ inputs.all_tags }}" >> "$GITHUB_OUTPUT"
          echo "tag=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"

      - name: Validate inputs
        run: |
          set -euo pipefail
          if [[ "${{ inputs.all_tags }}" == "true" && "${{ inputs.skip_verify }}" != "true" ]]; then
            echo "ERROR: all_tags=true requires skip_verify=true (backfill should be fast + non-blocking)."
            exit 2
          fi
          if [[ "${{ inputs.all_tags }}" != "true" ]]; then
            if [[ -z "${{ inputs.tag }}" ]]; then
              echo "ERROR: tag is required when all_tags=false"
              exit 2
            fi
          fi

      - name: Checkout (main)
        if: ${{ inputs.all_tags == true }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Checkout (tag)
        if: ${{ inputs.all_tags != true }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ steps.meta.outputs.tag }}

      - name: Backfill releases for all tags
        if: ${{ inputs.all_tags == true }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          repo="${{ github.repository }}"
          overwrite="${{ inputs.overwrite_existing }}"

          echo "[backfill] Fetch tags"
          git fetch --tags --force --prune --quiet

          echo "[backfill] Find semver tags"
          tags="$(git tag --list 'v*.*.*' --sort=version:refname)"
          if [[ -z "$tags" ]]; then
            echo "[backfill] No semver tags found"
            exit 0
          fi

          created=0
          updated=0
          skipped=0
          while IFS= read -r tag; do
            if [[ -z "$tag" ]]; then
              continue
            fi

            prerelease=false
            if [[ "$tag" == *"-"* ]]; then
              prerelease=true
            fi

            release_json="$(curl -fsSL -H "Authorization: Bearer ${GITHUB_TOKEN}" -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${repo}/releases/tags/${tag}" 2>/dev/null || true)"

            release_id=""
            if [[ -n "$release_json" ]]; then
              release_id="$(echo "$release_json" | python3 -c "import json,sys; j=json.load(sys.stdin); print(j.get('id',''))")"
            fi

            notes_file="$(mktemp)"
            if node scripts/release/extract-changelog-section.js "$tag" >"$notes_file" 2>/dev/null; then
              # Prefer changelog sections only when they contain semantic-release style commit links.
              if grep -q "/commit/" "$notes_file"; then
                notes_source="changelog"
              elif node scripts/release/generate-release-notes-from-git.js "$tag" >"$notes_file" 2>/dev/null; then
                notes_source="git"
              else
                echo "[backfill] WARN: Failed to generate release notes for $tag; falling back to GitHub auto notes"
                notes_source="github"
                : >"$notes_file"
              fi
            elif node scripts/release/generate-release-notes-from-git.js "$tag" >"$notes_file" 2>/dev/null; then
              notes_source="git"
            else
              echo "[backfill] WARN: Failed to generate release notes for $tag; falling back to GitHub auto notes"
              notes_source="github"
              : >"$notes_file"
            fi

            if [[ -n "$release_id" ]]; then
              if [[ "$overwrite" == "true" ]]; then
                echo "[backfill] Update existing release: $tag (id=$release_id, notes=$notes_source)"
                payload="$(python3 -c "import json,sys; tag=sys.argv[1]; pr=sys.argv[2]=='true'; notes_path=sys.argv[3]; notes=open(notes_path,'r',encoding='utf8').read(); d={'tag_name':tag,'name':tag,'prerelease':pr};\nif notes.strip():\n  d['body']=notes\nelse:\n  d['generate_release_notes']=True\nprint(json.dumps(d))" "$tag" "$prerelease" "$notes_file")"
                curl -fsSL -X PATCH \
                  -H "Authorization: Bearer ${GITHUB_TOKEN}" \
                  -H "Accept: application/vnd.github+json" \
                  "https://api.github.com/repos/${repo}/releases/${release_id}" \
                  -d "$payload" >/dev/null
                updated=$((updated+1))
              else
                echo "[backfill] Skip existing release: $tag"
                skipped=$((skipped+1))
              fi
              rm -f "$notes_file"
              continue
            fi

            echo "[backfill] Create release: $tag (prerelease=$prerelease, notes=$notes_source)"
            payload="$(python3 -c "import json,sys; tag=sys.argv[1]; pr=sys.argv[2]=='true'; notes_path=sys.argv[3]; notes=open(notes_path,'r',encoding='utf8').read(); d={'tag_name':tag,'name':tag,'prerelease':pr};\nif notes.strip():\n  d['body']=notes\nelse:\n  d['generate_release_notes']=True\nprint(json.dumps(d))" "$tag" "$prerelease" "$notes_file")"
            curl -fsSL -X POST \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${repo}/releases" \
              -d "$payload" >/dev/null
            created=$((created+1))
            rm -f "$notes_file"
          done <<<"$tags"

          echo "[backfill] Done: created=$created updated=$updated skipped=$skipped"

      - name: Resolve single-tag metadata
        if: ${{ inputs.all_tags != true }}
        id: tagmeta
        run: |
          set -euo pipefail
          TAG="${{ inputs.tag }}"
          echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
          if [[ "$TAG" == *"-"* ]]; then
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
          else
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install ripgrep (rg)
        if: ${{ steps.meta.outputs.skip_verify != 'true' }}
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Setup Node.js
        if: ${{ steps.meta.outputs.skip_verify != 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Setup Erlang/Elixir
        if: ${{ steps.meta.outputs.skip_verify != 'true' }}
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          elixir-version: ${{ env.ELIXIR_VERSION }}

      - name: Setup Haxe
        if: ${{ steps.meta.outputs.skip_verify != 'true' }}
        uses: krdlab/setup-haxe@v1
        with:
          haxe-version: ${{ env.HAXE_VERSION }}

      - name: Install npm dependencies
        if: ${{ steps.meta.outputs.skip_verify != 'true' }}
        run: npm ci

      - name: Download Haxe libraries (lix)
        if: ${{ steps.meta.outputs.skip_verify != 'true' }}
        run: npx lix download

      - name: Run guardrails
        if: ${{ steps.meta.outputs.skip_verify != 'true' }}
        run: npm run ci:guards

      - name: Run tests
        if: ${{ steps.meta.outputs.skip_verify != 'true' }}
        run: npm test

      - name: Validate examples Elixir (warnings as errors)
        if: ${{ steps.meta.outputs.skip_verify != 'true' }}
        run: npm run test:examples-elixir

      - name: Run budgets (perf + determinism)
        if: ${{ steps.meta.outputs.skip_verify != 'true' }}
        run: npm run ci:budgets

      - name: Verify repo hygiene (no build artifacts tracked)
        if: ${{ steps.meta.outputs.skip_verify != 'true' }}
        run: |
          set -euo pipefail
          if git ls-files node_modules deps _build | grep -q .; then
            echo "ERROR: Tracked build artifacts detected (expected these to be gitignored):"
            git ls-files node_modules deps _build
            exit 1
          fi

      - name: Publish GitHub Release
        if: ${{ inputs.all_tags != true }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          repo="${{ github.repository }}"
          tag="${{ steps.tagmeta.outputs.tag }}"
          prerelease="${{ steps.tagmeta.outputs.prerelease }}"
          overwrite="${{ inputs.overwrite_existing }}"

          notes_file="$(mktemp)"
          if node scripts/release/extract-changelog-section.js "$tag" >"$notes_file" 2>/dev/null; then
            if grep -q "/commit/" "$notes_file"; then
              notes_source="changelog"
            elif node scripts/release/generate-release-notes-from-git.js "$tag" >"$notes_file" 2>/dev/null; then
              notes_source="git"
            else
              echo "[backfill] WARN: Failed to generate release notes for $tag; falling back to GitHub auto notes"
              notes_source="github"
              : >"$notes_file"
            fi
          elif node scripts/release/generate-release-notes-from-git.js "$tag" >"$notes_file" 2>/dev/null; then
            notes_source="git"
          else
            echo "[backfill] WARN: Failed to generate release notes for $tag; falling back to GitHub auto notes"
            notes_source="github"
            : >"$notes_file"
          fi

          release_json="$(curl -fsSL -H \"Authorization: Bearer ${GITHUB_TOKEN}\" -H \"Accept: application/vnd.github+json\" \
            \"https://api.github.com/repos/${repo}/releases/tags/${tag}\" 2>/dev/null || true)"
          release_id=\"\"
          if [[ -n \"$release_json\" ]]; then
            release_id=\"$(echo \"$release_json\" | python3 -c \"import json,sys; j=json.load(sys.stdin); print(j.get('id',''))\")\"
          fi

          payload=\"$(python3 -c \"import json,sys; tag=sys.argv[1]; pr=sys.argv[2]=='true'; notes_path=sys.argv[3]; notes=open(notes_path,'r',encoding='utf8').read(); d={'tag_name':tag,'name':tag,'prerelease':pr};\nif notes.strip():\n  d['body']=notes\nelse:\n  d['generate_release_notes']=True\nprint(json.dumps(d))\" \"$tag\" \"$prerelease\" \"$notes_file\")\"

          if [[ -n \"$release_id\" ]]; then
            if [[ \"$overwrite\" == \"true\" ]]; then
              echo \"[backfill] Update existing release: $tag (id=$release_id, notes=$notes_source)\"
              curl -fsSL -X PATCH \
                -H \"Authorization: Bearer ${GITHUB_TOKEN}\" \
                -H \"Accept: application/vnd.github+json\" \
                \"https://api.github.com/repos/${repo}/releases/${release_id}\" \
                -d \"$payload\" >/dev/null
            else
              echo \"[backfill] Release already exists for $tag; set overwrite_existing=true to update its body\"
            fi
            rm -f \"$notes_file\"
            exit 0
          fi

          echo \"[backfill] Create release: $tag (prerelease=$prerelease, notes=$notes_source)\"
          curl -fsSL -X POST \
            -H \"Authorization: Bearer ${GITHUB_TOKEN}\" \
            -H \"Accept: application/vnd.github+json\" \
            \"https://api.github.com/repos/${repo}/releases\" \
            -d \"$payload\" >/dev/null
          rm -f \"$notes_file\"
