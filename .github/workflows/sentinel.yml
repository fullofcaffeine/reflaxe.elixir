name: QA Sentinel Smoke

on:
  push:
    branches: [ main ]
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: todo_app_e2e
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d todo_app_e2e"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            examples/todo-app/package-lock.json

      - name: Setup Erlang/Elixir
        uses: erlef/setup-beam@v1
        with:
          otp-version: '27.2'
          elixir-version: '1.18.3'

      - name: Cache mix deps
        uses: actions/cache@v4
        with:
          path: |
            ~/.mix
            ~/.hex
            examples/todo-app/deps
            examples/todo-app/_build
          key: ${{ runner.os }}-mix-${{ hashFiles('examples/todo-app/mix.lock') }}

      - name: Cache Haxe toolchain (lix)
        uses: actions/cache@v4
        with:
          path: |
            ~/haxe
          key: ${{ runner.os }}-lix-haxe-4.3.7-${{ hashFiles('.haxerc', 'haxe_libraries/*.hxml', 'package-lock.json', 'examples/todo-app/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-lix-haxe-4.3.7-

      - name: Install root dependencies
        run: npm ci --ignore-scripts --no-audit --no-fund

      - name: Install Haxe (pinned via lix)
        run: |
          set -euo pipefail
          npx lix download
          npx lix download haxe "4.3.7"
          npx lix use haxe "4.3.7"
          echo "$(pwd)/node_modules/.bin" >> "$GITHUB_PATH"
          export PATH="$(pwd)/node_modules/.bin:$PATH"
          haxe -version

      - name: Download Haxe libraries (lix)
        run: npx lix download

      - name: Verify JS client classpath (no repo std/src)
        env:
          WORKSPACE: ${{ github.workspace }}
        run: |
          set -euo pipefail
          cd examples/todo-app
          haxe -v build-client.hxml 2>&1 | tee classpath.log
          echo '--- Classpath line ---'
          grep '^Classpath:' classpath.log || true
          echo '--- Guard: ensure no repo std/src paths present ---'
          if grep -F "$WORKSPACE/std/" classpath.log; then echo "ERROR: repo std/ found in client classpath"; exit 1; fi
          if grep -F "$WORKSPACE/src/" classpath.log; then echo "ERROR: repo src/ found in client classpath"; exit 1; fi
          echo '--- Guard: ensure build-client.hxml does not add repo classpaths ---'
          if grep -E '^-cp\\s+\\.\\./\\.\\./(std|src)(/|\\s*$)' build-client.hxml; then
            echo "ERROR: build-client.hxml adds repo std/src via -cp ../../.."
            exit 1
          fi
          if grep -E '^-cp\\s+.*vendor/genes/src(/|\\s*$)' build-client.hxml; then
            echo "ERROR: build-client.hxml adds vendor/genes/src directly; use -lib genes"
            exit 1
          fi

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('examples/todo-app/package-lock.json') }}

      - name: Install Playwright browsers (cached)
        run: |
          npm -C examples/todo-app ci --prefer-offline --no-audit --no-fund
          npx -C examples/todo-app playwright install chromium

      - name: Run QA Sentinel smoke (bounded)
        env:
          MIX_ENV: e2e
          PGHOST: localhost
          PGUSER: postgres
          PGPASSWORD: postgres
          PGPORT: '5432'
        run: |
          set -euo pipefail
          scripts/qa-sentinel.sh --app examples/todo-app --port 4001 --compile-migrations --playwright --e2e-spec "e2e/*.spec.ts" --e2e-workers 1 --deadline 900 --verbose | tee qa-run.log

      - name: Upload QA logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-logs
          path: |
            /tmp/qa-*.log
            qa-run.log
