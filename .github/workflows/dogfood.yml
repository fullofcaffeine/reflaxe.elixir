name: Dogfood (Generated Phoenix App)

on:
  workflow_dispatch:
  schedule:
    # Weekly smoke to keep the real-user workflow healthy.
    - cron: "0 5 * * 1"

permissions:
  contents: read

env:
  NODE_VERSION: "20"
  HAXE_VERSION: "4.3.7"
  ELIXIR_VERSION: "1.18.3"
  OTP_VERSION: "27.2"

jobs:
  dogfood:
    name: Generate + Boot + Upgrade (bounded)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres -d postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install ripgrep (rg)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y ripgrep

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: Setup Erlang/Elixir
        uses: erlef/setup-beam@v1
        with:
          otp-version: ${{ env.OTP_VERSION }}
          elixir-version: ${{ env.ELIXIR_VERSION }}

      - name: Cache Haxe toolchain (lix)
        uses: actions/cache@v4
        with:
          path: |
            ~/haxe
          key: ${{ runner.os }}-lix-haxe-${{ env.HAXE_VERSION }}-${{ hashFiles('.haxerc', 'haxe_libraries/*.hxml', 'package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-lix-haxe-${{ env.HAXE_VERSION }}-

      - name: Install npm dependencies (repo)
        run: npm ci --ignore-scripts --no-audit --no-fund

      - name: Install Haxe (pinned via lix)
        run: |
          set -euo pipefail
          npx lix download haxe "${{ env.HAXE_VERSION }}"
          npx lix use haxe "${{ env.HAXE_VERSION }}"
          echo "$(pwd)/node_modules/.bin" >> "$GITHUB_PATH"
          export PATH="$(pwd)/node_modules/.bin:$PATH"
          haxe -version

      - name: Download Haxe libraries (lix)
        run: npx lix download

      - name: Run dogfood script (local mode, bounded)
        env:
          PGHOST: localhost
          PGUSER: postgres
          PGPASSWORD: postgres
          PGPORT: "5432"
        run: |
          set -euo pipefail
          scripts/dogfood-phoenix.sh --mode local --quiet

      - name: Upload QA logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dogfood-qa-logs
          path: |
            /tmp/qa-*.log
