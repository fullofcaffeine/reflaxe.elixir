name: Example Compilation Tests

on:
  push:
    branches: [ master, main, develop ]
    paths: 
      - 'examples/**'
      - 'src/**'
      - 'test/**'
      - 'package.json'
      - '.github/workflows/examples.yml'
  pull_request:
    branches: [ master, main, develop ]
    paths:
      - 'examples/**'
      - 'src/**' 
      - 'test/**'
      - 'package.json'
      - '.github/workflows/examples.yml'

jobs:
  test-examples:
    name: Test All 7 Examples Compilation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Setup Elixir
      uses: erlef/setup-beam@v1
      with:
        elixir-version: '1.15.6'
        otp-version: '26.0'
    
    - name: Install dependencies
      run: |
        npm ci
        mix local.hex --force
        mix local.rebar --force
        mix deps.get
    
    - name: Setup Haxe environment
      run: |
        npx lix scope create
        npx lix install haxelib:reflaxe
        npx lix install haxelib:tink_unittest  
        npx lix install haxelib:tink_testrunner
        npx lix download
    
    - name: Test Example Compilation
      run: npm run test:examples
      
    - name: Test Core Haxe Compiler
      run: npm run test:haxe
      
    - name: Test Mix Integration
      run: npm run test:mix
      env:
        MIX_ENV: test
        
    - name: Upload Examples as Artifacts
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: compiled-examples
        path: |
          examples/*/lib/
          examples/*/output/
        retention-days: 7

  validate-documentation:
    name: Validate Example Documentation
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Check README files exist
      run: |
        for example in examples/*/; do
          if [ ! -f "$example/README.md" ]; then
            echo "Missing README.md in $example"
            exit 1
          fi
          echo "‚úÖ Found README.md in $example"
        done
        
    - name: Check build.hxml files exist  
      run: |
        for example in examples/*/; do
          if [ ! -f "$example/build.hxml" ] && [ ! -f "$example/compile-all.hxml" ]; then
            echo "Missing build configuration in $example"
            exit 1
          fi
          echo "‚úÖ Found build configuration in $example"
        done
        
    - name: Validate example structure
      run: |
        echo "üìã Validating example directory structure..."
        for example in examples/*/; do
          example_name=$(basename "$example")
          if [ "$example_name" = "test-integration" ]; then
            continue  # Skip test-integration as it has different structure
          fi
          
          if [ ! -d "$example/src_haxe" ]; then
            echo "‚ùå Missing src_haxe directory in $example"
            exit 1
          fi
          echo "‚úÖ $example has proper structure"
        done