class reflaxe.elixir.preprocessors.RemoveOrphanedEnumParametersImpl extends reflaxe.preprocessors.BasePreprocessor {

	public function new() {
		this.renamedVariableMap = new haxe.ds.StringMap();
		this.parameterVars = new haxe.ds.IntMap();
		this.foundOrphaned = false;
		this.exprList = [];
	}

	var exprList:Array<haxe.macro.TypedExpr>;

	public function process(data:reflaxe.data.ClassFuncData, compiler:reflaxe.BaseCompiler) {
		if (data.expr != null) {
			this.exprList = [data.expr];
			var result = this.removeOrphanedEnumParameters();
			if (result.length > 0 && result[0] != data.expr) {
				data.setExpr(result[0]);
			};
		};
	}

	@:value(false)
	var foundOrphaned:Bool;

	@:value([])
	var parameterVars:Map<Int, { used : Bool, tvar : haxe.macro.TVar, originalName : String }>;

	@:value([])
	var renamedVariableMap:Map<String, Int>;

	public function removeOrphanedEnumParameters() {
		this.foundOrphaned = false;
		{
			var ` = 0;
			var ` = this.exprList;
			while (` < `.length) {
				var e = `[`];
				++ `;
				this.analyzeExpression(e);
			};
		};
		{
			var ` = {
				var this = this.parameterVars;
				cast new haxe.iterators.MapKeyValueIterator(cast this);
			};
			while (`.hasNext()) {
				var ` = `.next();
				var id = `.key;
				var data = `.value;
				{
					if (! data.used) {
						if (! reflaxe.helpers.NullableMetaAccessHelper.maybeHas(data.tvar.meta, "-reflaxe.unused")) {
							reflaxe.helpers.NullableMetaAccessHelper.maybeAdd(data.tvar.meta, "-reflaxe.unused", [], haxe.macro.Context.currentPos());
							this.foundOrphaned = true;
						};
					} else {
						if (this.isRenamedVariable(data.tvar.name)) {
							var originalName = this.extractOriginalName(data.tvar.name);
							if (! reflaxe.helpers.NullableMetaAccessHelper.maybeHas(data.tvar.meta, "-reflaxe.renamed")) {
								reflaxe.helpers.NullableMetaAccessHelper.maybeAdd(data.tvar.meta, "-reflaxe.renamed", [{expr : haxe.macro.ExprDef.EConst(haxe.macro.Constant.CString(originalName, null)), pos : haxe.macro.Context.currentPos()}], haxe.macro.Context.currentPos());
							};
						};
					};
				};
			};
		};
		return this.exprList;
	}

	function isRenamedVariable(name:String) {
		return new EReg("^.+[0-9]+$", "").match(name);
	}

	function extractOriginalName(name:String) {
		if (new EReg("^(.+?)([0-9]+)$", "").match(name)) {
			return new EReg("^(.+?)([0-9]+)$", "").replace(name, "$1");
		};
		return name;
	}

	function analyzeExpression(expr:haxe.macro.TypedExpr) {
		@:ast(switch (expr.expr) {
	case TSwitch(e, cases, edef):
		analyzeSwitchExpression(e, cases, edef);	
	case TVar(tvar, maybeExpr) if (maybeExpr != null):
		switch (maybeExpr.expr) {
			case TEnumParameter(_, _, _):
				var originalName = extractOriginalName(tvar.name);
				parameterVars.set(tvar.id, { tvar : tvar, used : false, originalName : originalName });			
			case _:
		};	
	case TLocal(tvar):
		if (parameterVars.exists(tvar.id)) {
			parameterVars.get(tvar.id).used = true;
		};	
	case _:
}) {
			var ` = expr.expr;
			switch (enumIndex `) {
				case 1: {
					var ` = `[0];
					{
						var tvar = `;
						{
							if ({
								var this = this.parameterVars;
								var key = tvar.id;
								cast this.exists(key);
							}) {
								{
									var this = this.parameterVars;
									var key = tvar.id;
									cast this.get(key);
								}.used = true;
							};
						};
					};
				};
				case 13: {
					var ` = `[0];
					var ` = `[1];
					{
						var tvar = `;
						var maybeExpr = `;
						if (maybeExpr != null) {
							@:ast(switch (maybeExpr.expr) {
	case TEnumParameter(_, _, _):
		var originalName = extractOriginalName(tvar.name);
		parameterVars.set(tvar.id, { tvar : tvar, used : false, originalName : originalName });	
	case _:
}) {
								var ` = maybeExpr.expr;
								if (enumIndex ` == 26) {
									var ` = `[0];
									var ` = `[1];
									var ` = `[2];
									{
										var originalName = this.extractOriginalName(tvar.name);
										{
											var this = this.parameterVars;
											var key = tvar.id;
											cast this.set(key, {tvar : tvar, used : false, originalName : originalName});
										};
									};
								} else {};
							};
						} else {};
					};
				};
				case 18: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					{
						var e = `;
						var cases = `;
						var edef = `;
						{
							this.analyzeSwitchExpression(e, cases, edef);
						};
					};
				};
				default: {}
			};
		};
		haxe.macro.TypedExprTools.iter(expr, this.analyzeExpression);
	}

	function analyzeSwitchExpression(switchExpr:haxe.macro.TypedExpr, cases:Array<{ values : Array<haxe.macro.TypedExpr>, expr : haxe.macro.TypedExpr }>, defaultExpr:Null<haxe.macro.TypedExpr>) {
		this.parameterVars = {
			{};
			new haxe.ds.IntMap();
		};
		{
			var ` = 0;
			while (` < cases.length) {
				var c = cases[`];
				++ `;
				this.collectEnumParameters(c.expr);
			};
		};
		if (defaultExpr != null) {
			this.collectEnumParameters(defaultExpr);
		};
		{
			var ` = 0;
			while (` < cases.length) {
				var c = cases[`];
				++ `;
				this.checkParameterUsageInExpression(c.expr);
			};
		};
		if (defaultExpr != null) {
			this.checkParameterUsageInExpression(defaultExpr);
		};
	}

	function collectEnumParameters(expr:haxe.macro.TypedExpr) {
		@:ast(switch (expr.expr) {
	case TVar(tvar, maybeExpr) if (maybeExpr != null):
		switch (maybeExpr.expr) {
			case TEnumParameter(_, _, _):
				var originalName = extractOriginalName(tvar.name);
				parameterVars.set(tvar.id, { tvar : tvar, used : false, originalName : originalName });
				if (isRenamedVariable(tvar.name)) {
					renamedVariableMap.set(originalName, tvar.id);
				};			
			case _:
		};	
	case _:
}) {
			var ` = expr.expr;
			if (enumIndex ` == 13) {
				var ` = `[0];
				var ` = `[1];
				{
					var tvar = `;
					var maybeExpr = `;
					if (maybeExpr != null) {
						@:ast(switch (maybeExpr.expr) {
	case TEnumParameter(_, _, _):
		var originalName = extractOriginalName(tvar.name);
		parameterVars.set(tvar.id, { tvar : tvar, used : false, originalName : originalName });
		if (isRenamedVariable(tvar.name)) {
			renamedVariableMap.set(originalName, tvar.id);
		};	
	case _:
}) {
							var ` = maybeExpr.expr;
							if (enumIndex ` == 26) {
								var ` = `[0];
								var ` = `[1];
								var ` = `[2];
								{
									var originalName = this.extractOriginalName(tvar.name);
									{
										var this = this.parameterVars;
										var key = tvar.id;
										cast this.set(key, {tvar : tvar, used : false, originalName : originalName});
									};
									if (this.isRenamedVariable(tvar.name)) {
										{
											var this = this.renamedVariableMap;
											var value = tvar.id;
											cast this.set(originalName, value);
										};
									};
								};
							} else {};
						};
					} else {};
				};
			} else {};
		};
		haxe.macro.TypedExprTools.iter(expr, this.collectEnumParameters);
	}

	function checkParameterUsageInExpression(expr:haxe.macro.TypedExpr) {
		@:ast(switch (expr.expr) {
	case TLocal(tvar):
		if (parameterVars.exists(tvar.id)) {
			parameterVars.get(tvar.id).used = true;
		};	
	case _:
}) {
			var ` = expr.expr;
			if (enumIndex ` == 1) {
				var ` = `[0];
				{
					var tvar = `;
					{
						if ({
							var this = this.parameterVars;
							var key = tvar.id;
							cast this.exists(key);
						}) {
							{
								var this = this.parameterVars;
								var key = tvar.id;
								cast this.get(key);
							}.used = true;
						};
					};
				};
			} else {};
		};
		haxe.macro.TypedExprTools.iter(expr, this.checkParameterUsageInExpression);
	}
}