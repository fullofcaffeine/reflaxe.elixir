class reflaxe.elixir.behaviors.BehaviorTransformer {

	public function new() {
		this.activeBehavior = null;
	}

	@:value(null)
	public var activeBehavior:Null<String>;

	public function checkAndActivateBehavior(classType:haxe.macro.ClassType) {
		{
			var ` = 0;
			var ` = classType.meta.get();
			while (` < `.length) {
				var meta = `[`];
				++ `;
				var behaviorName = @:ast(switch (meta.name) {
	case ":presence":
		"presence";	
	case ":genserver":
		"genserver";	
	case ":supervisor":
		"supervisor";	
	default:
		null;	
}) {
					var ` = meta.name;
					switch (`) {
						case ":genserver": {
							{
								"genserver";
							};
						};
						case ":presence": {
							{
								"presence";
							};
						};
						case ":supervisor": {
							{
								"supervisor";
							};
						};
						default: {
							null;
						}
					};
				};
				if (behaviorName != null) {
					this.activeBehavior = behaviorName;
					return behaviorName;
				};
			};
		};
		return null;
	}

	public function transformMethodCall(className:String, methodName:String, args:Array<reflaxe.elixir.ast.ElixirAST>, isStatic:Bool) {
		if (this.activeBehavior == null) {
			return null;
		};
		var transformer = {
			var this = reflaxe.elixir.behaviors.BehaviorTransformer.transformers;
			var key = this.activeBehavior;
			cast this.get(key);
		};
		if (transformer == null) {
			return null;
		};
		return transformer.transformMethodCall(className, methodName, args, isStatic);
	}

	public function deactivate() {
		this.activeBehavior = null;
	}

	@:value(new Map())
	static var transformers:Map<String, reflaxe.elixir.behaviors.IBehaviorTransformer> = {
		{};
		new haxe.ds.StringMap();
	};

	public static function register(name:String, transformer:reflaxe.elixir.behaviors.IBehaviorTransformer) {
		{
			var this = reflaxe.elixir.behaviors.BehaviorTransformer.transformers;
			cast this.set(name, transformer);
		};
	}

	public static function initialize() {
		reflaxe.elixir.behaviors.BehaviorTransformer.register("presence", new reflaxe.elixir.behaviors.PresenceBehaviorTransformer());
	}
}