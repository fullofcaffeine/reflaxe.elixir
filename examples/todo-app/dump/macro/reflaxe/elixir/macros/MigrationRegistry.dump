class reflaxe.elixir.macros.MigrationRegistry {

	@:value(new Map())
	static var tables:Map<String, reflaxe.elixir.macros.TableMetadata> = {
		{};
		new haxe.ds.StringMap();
	};

	@:value([])
	static var migrationOrder:Array<String> = [];

	public static function registerTable(name:String, pos:haxe.macro.Position) {
		if ({
			var this = reflaxe.elixir.macros.MigrationRegistry.tables;
			cast this.exists(name);
		}) {
			haxe.macro.Context.warning("Table \"" + name + "\" already exists", pos, null);
		};
		{
			var this = reflaxe.elixir.macros.MigrationRegistry.tables;
			var value = {name : name, columns : {
				{};
				new haxe.ds.StringMap();
			}, indexes : [], constraints : [], createdAt : pos};
			cast this.set(name, value);
		};
	}

	public static function unregisterTable(name:String) {
		{
			var this = reflaxe.elixir.macros.MigrationRegistry.tables;
			cast this.remove(name);
		};
	}

	public static function registerColumn(table:String, column:String, type:String, nullable:Bool, pos:haxe.macro.Position) {
		if (! {
			var this = reflaxe.elixir.macros.MigrationRegistry.tables;
			cast this.exists(table);
		}) {
			haxe.macro.Context.error("Table \"" + table + "\" does not exist", pos, null);
			return;
		};
		var tableData = {
			var this = reflaxe.elixir.macros.MigrationRegistry.tables;
			cast this.get(table);
		};
		if ({
			var this = tableData.columns;
			cast this.exists(column);
		}) {
			haxe.macro.Context.warning("Column \"" + column + "\" already exists in table \"" + table + "\"", pos, null);
		};
		{
			var this = tableData.columns;
			cast this.set(column, {name : column, type : type, nullable : nullable});
		};
	}

	public static function validateTableExists(name:String, pos:haxe.macro.Position) {
		if (! {
			var this = reflaxe.elixir.macros.MigrationRegistry.tables;
			cast this.exists(name);
		}) {
			haxe.macro.Context.error("Table \"" + name + "\" does not exist. Make sure the migration that creates it runs first.", pos, null);
		};
	}

	public static function validateColumnExists(table:String, column:String, pos:haxe.macro.Position) {
		if (! {
			var this = reflaxe.elixir.macros.MigrationRegistry.tables;
			cast this.exists(table);
		}) {
			haxe.macro.Context.error("Table \"" + table + "\" does not exist", pos, null);
			return;
		};
		var tableData = {
			var this = reflaxe.elixir.macros.MigrationRegistry.tables;
			cast this.get(table);
		};
		if (! {
			var this = tableData.columns;
			cast this.exists(column);
		}) {
			haxe.macro.Context.error("Column \"" + column + "\" does not exist in table \"" + table + "\"", pos, null);
		};
	}

	public static function validateColumnsExist(table:String, columns:Array<String>, pos:haxe.macro.Position) {
		if (! {
			var this = reflaxe.elixir.macros.MigrationRegistry.tables;
			cast this.exists(table);
		}) {
			haxe.macro.Context.error("Table \"" + table + "\" does not exist", pos, null);
			return;
		};
		var tableData = {
			var this = reflaxe.elixir.macros.MigrationRegistry.tables;
			cast this.get(table);
		};
		{
			var ` = 0;
			while (` < columns.length) {
				var column = columns[`];
				++ `;
				if (! {
					var this = tableData.columns;
					cast this.exists(column);
				}) {
					haxe.macro.Context.error("Column \"" + column + "\" does not exist in table \"" + table + "\"", pos, null);
				};
			};
		};
	}

	public static function getAllTables() {
		return reflaxe.elixir.macros.MigrationRegistry.tables;
	}
}