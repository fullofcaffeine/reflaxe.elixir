class reflaxe.elixir.helpers.MutabilityDetector {

	public static function detectMutatedVariables(expr:haxe.macro.TypedExpr) {
		var mutatedVars = {
			{};
			new haxe.ds.IntMap();
		};
		var traverse = [null];
		traverse[0] = function(e:haxe.macro.TypedExpr) {
			if (e == null) {
				return;
			};
			@:ast(switch (e.expr) {
	case TBinop(OpAssign | OpAssignOp(_), e1, _):
		switch (e1.expr) {
			case TLocal(v):
				mutatedVars.set(v.id, v);			
			default:
		};	
	case TVar(v, init):
		if (init != null) {
			switch (init.expr) {
				case TConst(_):
				default:
			};
		};	
	default:
		TypedExprTools.iter(e, traverse);	
}) {
				var ` = e.expr;
				switch (enumIndex `) {
					case 3: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						switch (enumIndex `) {
							case 4: {
								{
									var e1 = `;
									{
										@:ast(switch (e1.expr) {
	case TLocal(v):
		mutatedVars.set(v.id, v);	
	default:
}) {
											var ` = e1.expr;
											if (enumIndex ` == 1) {
												var ` = `[0];
												{
													var v = `;
													{
														{
															var key = v.id;
															mutatedVars.set(key, v);
														};
													};
												};
											} else {};
										};
									};
								};
							};
							case 20: {
								var ` = `[0];
								{
									var e1 = `;
									{
										@:ast(switch (e1.expr) {
	case TLocal(v):
		mutatedVars.set(v.id, v);	
	default:
}) {
											var ` = e1.expr;
											if (enumIndex ` == 1) {
												var ` = `[0];
												{
													var v = `;
													{
														{
															var key = v.id;
															mutatedVars.set(key, v);
														};
													};
												};
											} else {};
										};
									};
								};
							};
							default: {
								haxe.macro.TypedExprTools.iter(e, traverse[0]);
							}
						};
					};
					case 13: {
						var ` = `[0];
						var ` = `[1];
						{
							var v = `;
							var init = `;
							{
								if (init != null) {
									@:ast(switch (init.expr) {
	case TConst(_):
	default:
}) {
										var ` = init.expr;
										if (enumIndex ` == 0) {
											var ` = `[0];
											{};
										} else {};
									};
								};
							};
						};
					};
					default: {
						haxe.macro.TypedExprTools.iter(e, traverse[0]);
					}
				};
			};
		};
		traverse[0](expr);
		return mutatedVars;
	}

	public static function isVariableMutated(varId:Int, expr:haxe.macro.TypedExpr) {
		var mutatedVars = reflaxe.elixir.helpers.MutabilityDetector.detectMutatedVariables(expr);
		return mutatedVars.exists(varId);
	}
}