@:nullSafety(Off)
class reflaxe.elixir.ast.builders.LiteralBuilder {

	public static function buildConst(c:haxe.macro.TConstant, expr:haxe.macro.TypedExpr, context:reflaxe.elixir.CompilationContext) {
		@:ast(switch (c) {
	case TString(s):
		return buildStringLiteral(s, expr);	
	case TThis:
		return buildThisReference(context);	
	default:
		var ast = CoreExprBuilder.buildConst(c);
		return ast.def;	
}) switch (enumIndex c) {
			case 2: {
				var ` = c[0];
				{
					var s = `;
					{
						return reflaxe.elixir.ast.builders.LiteralBuilder.buildStringLiteral(s, expr);
					};
				};
			};
			case 5: {
				{
					return reflaxe.elixir.ast.builders.LiteralBuilder.buildThisReference(context);
				};
			};
			default: {
				var ast = reflaxe.elixir.ast.builders.CoreExprBuilder.buildConst(c, null);
				return ast.def;
			}
		};
	}

	static function buildStringLiteral(s:String, expr:haxe.macro.TypedExpr) {
		var isAtom = false;
		@:ast(switch (expr.t) {
	case TAbstract(ref, _):
		var abstractType = ref.get();
		if (abstractType.pack.join(".") == "elixir.types" && abstractType.name == "Atom") {
			isAtom = true;
		};	
	case _:
}) {
			var ` = expr.t;
			if (enumIndex ` == 8) {
				var ` = `[0];
				var ` = `[1];
				{
					var ref = `;
					{
						var abstractType = ref.get();
						if (abstractType.pack.join(".") == "elixir.types" && abstractType.name == "Atom") {
							isAtom = true;
						};
					};
				};
			} else {};
		};
		if (isAtom) {
			return reflaxe.elixir.ast.ElixirASTDef.EAtom(@:implicitCast {
				var this;
				this = reflaxe.elixir.ast.NameUtils.toSnakeCase(s);
				cast cast this;
			});
		} else {
			return reflaxe.elixir.ast.ElixirASTDef.EString(s);
		};
	}

	static function buildThisReference(context:reflaxe.elixir.CompilationContext) {
		if (context.isInClassMethodContext && context.currentReceiverParamName != null) {
			return reflaxe.elixir.ast.ElixirASTDef.EVar(context.currentReceiverParamName);
		} else {
			if (context.isInExUnitTest) {
				return reflaxe.elixir.ast.ElixirASTDef.EVar("context");
			} else {
				if (context.currentReceiverParamName != null) {
					return reflaxe.elixir.ast.ElixirASTDef.EVar(context.currentReceiverParamName);
				} else {
					return reflaxe.elixir.ast.ElixirASTDef.EVar("struct");
				};
			};
		};
	}
}