@:nullSafety(Off)
class reflaxe.elixir.ast.builders.ComprehensionBuilder {

	public static function tryBuildArrayComprehensionFromBlock(statements:Array<haxe.macro.TypedExpr>, context:reflaxe.elixir.ast.context.BuildContext) {
		if (statements.length < 2) {
			return null;
		};
		if (reflaxe.elixir.ast.builders.ComprehensionBuilder.isComprehensionPattern(statements)) {
			var data = reflaxe.elixir.ast.builders.ComprehensionBuilder.extractComprehensionData(statements);
			if (data != null) {
				var body = if (data.condition != null) {
					@:ast(switch (data.body.expr) {
	case TBlock(stmts):
		var nested = tryBuildArrayComprehensionFromBlock(stmts, context);
		if (nested != null) nested else context.getExpressionBuilder()(data.body);	
	default:
		context.getExpressionBuilder()(data.body);	
}) {
						var ` = data.body.expr;
						if (enumIndex ` == 14) {
							var ` = `[0];
							{
								var stmts = `;
								{
									var nested = reflaxe.elixir.ast.builders.ComprehensionBuilder.tryBuildArrayComprehensionFromBlock(stmts, context);
									if (nested != null) {
										nested;
									} else {
										context.getExpressionBuilder()(data.body);
									};
								};
							};
						} else {
							context.getExpressionBuilder()(data.body);
						};
					};
				} else {
					context.getExpressionBuilder()(data.body);
				};
				var filters = if (data.condition != null) {
					[context.getExpressionBuilder()(data.condition)];
				} else {
					[];
				};
				return {
					var def = reflaxe.elixir.ast.ElixirASTDef.EFor([{pattern : reflaxe.elixir.ast.EPattern.PVar(data.loopVar), expr : context.getExpressionBuilder()(data.iterator)}], filters, body, null, false);
					var pos = null;
					{def : def, metadata : {}, pos : pos};
				};
			};
		};
		if (reflaxe.elixir.ast.builders.ComprehensionBuilder.isUnrolledComprehension(statements)) {
			var elements = reflaxe.elixir.ast.builders.ComprehensionBuilder.extractUnrolledElements(statements, context);
			if (elements != null && elements.length > 0) {
				return {
					var pos = null;
					{def : reflaxe.elixir.ast.ElixirASTDef.EList(elements), metadata : {}, pos : pos};
				};
			};
		};
		if (statements.length >= 3) {
			var firstStmt = reflaxe.elixir.ast.builders.ComprehensionBuilder.unwrapMetaParens(statements[0]);
			var lastStmt = reflaxe.elixir.ast.builders.ComprehensionBuilder.unwrapMetaParens(statements[statements.length - 1]);
			@:ast(switch (firstStmt.expr) {
	case TVar(v, { expr : TArrayDecl([]) }):
		switch (lastStmt.expr) {
			case TLocal(returnVar) if (returnVar.name == v.name):
				var middleStmts = statements.slice(1, statements.length - 1);
				var result = tryReconstructConditionalComprehension(middleStmts, v.name, context);
				if (result != null) {
					return result;
				};			
			default:
		};	
	default:
}) {
				var ` = firstStmt.expr;
				if (enumIndex ` == 13) {
					var ` = `[0];
					var ` = `[1];
					if (` == null) {} else {
						var ` = `.expr;
						var ` = `.pos;
						var ` = `.t;
						if (enumIndex ` == 8) {
							var ` = `[0];
							if (`.length == 0) {
								{
									var v = `;
									{
										@:ast(switch (lastStmt.expr) {
	case TLocal(returnVar) if (returnVar.name == v.name):
		var middleStmts = statements.slice(1, statements.length - 1);
		var result = tryReconstructConditionalComprehension(middleStmts, v.name, context);
		if (result != null) {
			return result;
		};	
	default:
}) {
											var ` = lastStmt.expr;
											if (enumIndex ` == 1) {
												var ` = `[0];
												{
													var returnVar = `;
													if (returnVar.name == v.name) {
														var middleStmts = statements.slice(1, statements.length - 1);
														var result = reflaxe.elixir.ast.builders.ComprehensionBuilder.tryReconstructConditionalComprehension(middleStmts, v.name, context);
														if (result != null) {
															return result;
														};
													} else {};
												};
											} else {};
										};
									};
								};
							} else {};
						} else {};
					};
				} else {};
			};
		};
		return null;
	}

	static function isComprehensionPattern(statements:Array<haxe.macro.TypedExpr>) {
		if (statements.length < 3) {
			return false;
		};
		var firstStmt = reflaxe.elixir.ast.builders.ComprehensionBuilder.unwrapMetaParens(statements[0]);
		var lastStmt = reflaxe.elixir.ast.builders.ComprehensionBuilder.unwrapMetaParens(statements[statements.length - 1]);
		var tempVarName = null;
		@:ast(switch (firstStmt.expr) {
	case TVar(v, { expr : TArrayDecl([]) }):
		tempVarName = v.name;	
	default:
		return false;	
}) {
			var ` = firstStmt.expr;
			if (enumIndex ` == 13) {
				var ` = `[0];
				var ` = `[1];
				if (` == null) {
					return false;
				} else {
					var ` = `.expr;
					var ` = `.pos;
					var ` = `.t;
					if (enumIndex ` == 8) {
						var ` = `[0];
						if (`.length == 0) {
							{
								var v = `;
								{
									tempVarName = v.name;
								};
							};
						} else {
							return false;
						};
					} else {
						return false;
					};
				};
			} else {
				return false;
			};
		};
		@:ast(switch (lastStmt.expr) {
	case TLocal(v) if (v.name == tempVarName):
	default:
		return false;	
}) {
			var ` = lastStmt.expr;
			if (enumIndex ` == 1) {
				var ` = `[0];
				{
					var v = `;
					if (v.name == tempVarName) {} else {
						return false;
					};
				};
			} else {
				return false;
			};
		};
		{
			var ` = 1;
			var ` = statements.length - 1;
			while (` < `) {
				var i = ` ++;
				var stmt = reflaxe.elixir.ast.builders.ComprehensionBuilder.unwrapMetaParens(statements[i]);
				@:ast(switch (stmt.expr) {
	case TFor(_, _, _) | TWhile(_, _, _):
		return true;	
	default:
}) {
					var ` = stmt.expr;
					switch (enumIndex `) {
						case 15: {
							var ` = `[0];
							var ` = `[1];
							var ` = `[2];
							{
								return true;
							};
						};
						case 17: {
							var ` = `[0];
							var ` = `[1];
							var ` = `[2];
							{
								return true;
							};
						};
						default: {}
					};
				};
			};
		};
		return false;
	}

	static function isUnrolledComprehension(statements:Array<haxe.macro.TypedExpr>) {
		if (statements.length < 3) {
			return false;
		};
		var firstStmt = reflaxe.elixir.ast.builders.ComprehensionBuilder.unwrapMetaParens(statements[0]);
		var lastStmt = reflaxe.elixir.ast.builders.ComprehensionBuilder.unwrapMetaParens(statements[statements.length - 1]);
		var tempVarName = null;
		@:ast(switch (firstStmt.expr) {
	case TVar(v, { expr : TArrayDecl([]) }):
		tempVarName = v.name;	
	default:
		return false;	
}) {
			var ` = firstStmt.expr;
			if (enumIndex ` == 13) {
				var ` = `[0];
				var ` = `[1];
				if (` == null) {
					return false;
				} else {
					var ` = `.expr;
					var ` = `.pos;
					var ` = `.t;
					if (enumIndex ` == 8) {
						var ` = `[0];
						if (`.length == 0) {
							{
								var v = `;
								{
									tempVarName = v.name;
								};
							};
						} else {
							return false;
						};
					} else {
						return false;
					};
				};
			} else {
				return false;
			};
		};
		@:ast(switch (lastStmt.expr) {
	case TLocal(v) if (v.name == tempVarName):
	default:
		return false;	
}) {
			var ` = lastStmt.expr;
			if (enumIndex ` == 1) {
				var ` = `[0];
				{
					var v = `;
					if (v.name == tempVarName) {} else {
						return false;
					};
				};
			} else {
				return false;
			};
		};
		var hasConcatenation = false;
		{
			var ` = 1;
			var ` = statements.length - 1;
			while (` < `) {
				var i = ` ++;
				var stmt = reflaxe.elixir.ast.builders.ComprehensionBuilder.unwrapMetaParens(statements[i]);
				@:ast(switch (stmt.expr) {
	case TBinop(OpAssignOp(OpAdd), { expr : TLocal(v) }, _) if (v.name == tempVarName):
		hasConcatenation = true;	
	case TBinop(OpAssign, { expr : TLocal(v) }, { expr : TBinop(OpAdd, _, _) }) if (v.name == tempVarName):
		hasConcatenation = true;	
	case TIf(_, _, _):
		hasConcatenation = true;	
	default:
}) {
					var ` = stmt.expr;
					switch (enumIndex `) {
						case 3: {
							var ` = `[0];
							var ` = `[1];
							var ` = `[2];
							switch (enumIndex `) {
								case 4: {
									{
										var ` = `.expr;
										var ` = `.pos;
										var ` = `.t;
										if (enumIndex ` == 1) {
											var ` = `[0];
											{
												var ` = `.expr;
												var ` = `.pos;
												var ` = `.t;
												if (enumIndex ` == 3) {
													var ` = `[0];
													var ` = `[1];
													var ` = `[2];
													if (enumIndex ` == 0) {
														{
															var v = `;
															if (v.name == tempVarName) {
																hasConcatenation = true;
															} else {};
														};
													} else {};
												} else {};
											};
										} else {};
									};
								};
								case 20: {
									var ` = `[0];
									if (enumIndex ` == 0) {
										{
											var ` = `.expr;
											var ` = `.pos;
											var ` = `.t;
											if (enumIndex ` == 1) {
												var ` = `[0];
												{
													var v = `;
													if (v.name == tempVarName) {
														hasConcatenation = true;
													} else {};
												};
											} else {};
										};
									} else {};
								};
								default: {}
							};
						};
						case 16: {
							var ` = `[0];
							var ` = `[1];
							var ` = `[2];
							{
								hasConcatenation = true;
							};
						};
						default: {}
					};
				};
			};
		};
		return hasConcatenation;
	}

	public static function looksLikeListBuildingBlock(stmts:Array<haxe.macro.TypedExpr>) {
		if (stmts.length < 3) {
			return false;
		};
		var firstStmt = reflaxe.elixir.ast.builders.ComprehensionBuilder.unwrapMetaParens(stmts[0]);
		var lastStmt = reflaxe.elixir.ast.builders.ComprehensionBuilder.unwrapMetaParens(stmts[stmts.length - 1]);
		var tempVar = null;
		@:ast(switch (firstStmt.expr) {
	case TVar(v, { expr : TArrayDecl([]) }):
		tempVar = v.name;	
	default:
		return false;	
}) {
			var ` = firstStmt.expr;
			if (enumIndex ` == 13) {
				var ` = `[0];
				var ` = `[1];
				if (` == null) {
					return false;
				} else {
					var ` = `.expr;
					var ` = `.pos;
					var ` = `.t;
					if (enumIndex ` == 8) {
						var ` = `[0];
						if (`.length == 0) {
							{
								var v = `;
								{
									tempVar = v.name;
								};
							};
						} else {
							return false;
						};
					} else {
						return false;
					};
				};
			} else {
				return false;
			};
		};
		@:ast(switch (lastStmt.expr) {
	case TLocal(v) if (v.name == tempVar):
		for (i  in  1 ... stmts.length - 1) {
			var stmt = unwrapMetaParens(stmts[i]);
			switch (stmt.expr) {
				case TBinop(OpAdd, { expr : TLocal(v) }, _) if (v.name == tempVar):
					return true;				
				case TBinop(OpAssignOp(OpAdd), { expr : TLocal(v) }, _) if (v.name == tempVar):
					return true;				
				default:
			};
		};	
	default:
}) {
			var ` = lastStmt.expr;
			if (enumIndex ` == 1) {
				var ` = `[0];
				{
					var v = `;
					if (v.name == tempVar) {
						{
							var ` = 1;
							var ` = stmts.length - 1;
							while (` < `) {
								var i = ` ++;
								var stmt = reflaxe.elixir.ast.builders.ComprehensionBuilder.unwrapMetaParens(stmts[i]);
								@:ast(switch (stmt.expr) {
	case TBinop(OpAdd, { expr : TLocal(v) }, _) if (v.name == tempVar):
		return true;	
	case TBinop(OpAssignOp(OpAdd), { expr : TLocal(v) }, _) if (v.name == tempVar):
		return true;	
	default:
}) {
									var ` = stmt.expr;
									if (enumIndex ` == 3) {
										var ` = `[0];
										var ` = `[1];
										var ` = `[2];
										switch (enumIndex `) {
											case 0: {
												{
													var ` = `.expr;
													var ` = `.pos;
													var ` = `.t;
													if (enumIndex ` == 1) {
														var ` = `[0];
														{
															var v = `;
															if (v.name == tempVar) {
																return true;
															} else {};
														};
													} else {};
												};
											};
											case 20: {
												var ` = `[0];
												if (enumIndex ` == 0) {
													{
														var ` = `.expr;
														var ` = `.pos;
														var ` = `.t;
														if (enumIndex ` == 1) {
															var ` = `[0];
															{
																var v = `;
																if (v.name == tempVar) {
																	return true;
																} else {};
															};
														} else {};
													};
												} else {};
											};
											default: {}
										};
									} else {};
								};
							};
						};
					} else {};
				};
			} else {};
		};
		return false;
	}

	static function extractComprehensionData(statements:Array<haxe.macro.TypedExpr>) {
		if (statements.length < 3) {
			return null;
		};
		var firstStmt = reflaxe.elixir.ast.builders.ComprehensionBuilder.unwrapMetaParens(statements[0]);
		var tempVarName = null;
		@:ast(switch (firstStmt.expr) {
	case TVar(v, _):
		tempVarName = v.name;	
	default:
		return null;	
}) {
			var ` = firstStmt.expr;
			if (enumIndex ` == 13) {
				var ` = `[0];
				var ` = `[1];
				{
					var v = `;
					{
						tempVarName = v.name;
					};
				};
			} else {
				return null;
			};
		};
		{
			var ` = 1;
			var ` = statements.length - 1;
			while (` < `) {
				var i = ` ++;
				var stmt = reflaxe.elixir.ast.builders.ComprehensionBuilder.unwrapMetaParens(statements[i]);
				@:ast(switch (stmt.expr) {
	case TFor(_, iterator, body):
		var pushData = extractPushFromBody(body, tempVarName);
		if (pushData != null) {
			var loopVar = switch (stmt.expr) {
				case TFor(v, _, _):
					v.name;				
				default:
					"";				
			};
			return { tempVar : tempVarName, loopVar : loopVar, iterator : iterator, body : pushData.value, condition : pushData.condition };
		};	
	case TWhile(_, body, _):
		continue;	
	default:
}) {
					var ` = stmt.expr;
					switch (enumIndex `) {
						case 15: {
							var ` = `[0];
							var ` = `[1];
							var ` = `[2];
							{
								var iterator = `;
								var body = `;
								{
									var pushData = reflaxe.elixir.ast.builders.ComprehensionBuilder.extractPushFromBody(body, tempVarName);
									if (pushData != null) {
										var loopVar = @:ast(switch (stmt.expr) {
	case TFor(v, _, _):
		v.name;	
	default:
		"";	
}) {
											var ` = stmt.expr;
											if (enumIndex ` == 15) {
												var ` = `[0];
												var ` = `[1];
												var ` = `[2];
												{
													var v = `;
													{
														v.name;
													};
												};
											} else {
												"";
											};
										};
										return {tempVar : tempVarName, loopVar : loopVar, iterator : iterator, body : pushData.value, condition : pushData.condition};
									};
								};
							};
						};
						case 17: {
							var ` = `[0];
							var ` = `[1];
							var ` = `[2];
							{
								var body = `;
								{
									continue;
								};
							};
						};
						default: {}
					};
				};
			};
		};
		return null;
	}

	static function extractPushFromBody(body:haxe.macro.TypedExpr, tempVar:String) {
		@:ast(switch (body.expr) {
	case TCall({ expr : TField({ expr : TLocal(v) }, FInstance(_, _, field)) }, [value]) if (v.name == tempVar && field.get().name == "push"):
		return { value : value, condition : null };	
	case TIf(condition, thenExpr, null):
		var pushData = extractPushFromBody(thenExpr, tempVar);
		if (pushData != null) {
			return { value : pushData.value, condition : condition };
		};	
	case TBlock(stmts):
		for (stmt  in  stmts) {
			var pushData = extractPushFromBody(stmt, tempVar);
			if (pushData != null) {
				return pushData;
			};
		};	
	default:
}) {
			var ` = body.expr;
			switch (enumIndex `) {
				case 9: {
					var ` = `[0];
					var ` = `[1];
					{
						var ` = `.expr;
						var ` = `.pos;
						var ` = `.t;
						if (enumIndex ` == 4) {
							var ` = `[0];
							var ` = `[1];
							{
								var ` = `.expr;
								var ` = `.pos;
								var ` = `.t;
								if (enumIndex ` == 1) {
									var ` = `[0];
									if (enumIndex ` == 0) {
										var ` = `[0];
										var ` = `[1];
										var ` = `[2];
										if (`.length == 1) {
											var ` = `[0];
											{
												var value = `;
												var v = `;
												var field = `;
												if (v.name == tempVar && field.get().name == "push") {
													return {value : value, condition : null};
												} else {};
											};
										} else {};
									} else {};
								} else {};
							};
						} else {};
					};
				};
				case 14: {
					var ` = `[0];
					{
						var stmts = `;
						{
							{
								var ` = 0;
								while (` < stmts.length) {
									var stmt = stmts[`];
									++ `;
									var pushData = reflaxe.elixir.ast.builders.ComprehensionBuilder.extractPushFromBody(stmt, tempVar);
									if (pushData != null) {
										return pushData;
									};
								};
							};
						};
					};
				};
				case 16: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					if (` == null) {
						var thenExpr = `;
						var condition = `;
						{
							var pushData = reflaxe.elixir.ast.builders.ComprehensionBuilder.extractPushFromBody(thenExpr, tempVar);
							if (pushData != null) {
								return {value : pushData.value, condition : condition};
							};
						};
					} else {};
				};
				default: {}
			};
		};
		return null;
	}

	static function extractUnrolledElements(statements:Array<haxe.macro.TypedExpr>, context:reflaxe.elixir.ast.context.BuildContext) {
		if (statements.length < 3) {
			return null;
		};
		var tempVarName = null;
		var firstStmt = reflaxe.elixir.ast.builders.ComprehensionBuilder.unwrapMetaParens(statements[0]);
		@:ast(switch (firstStmt.expr) {
	case TVar(v, _):
		tempVarName = v.name;	
	default:
		return null;	
}) {
			var ` = firstStmt.expr;
			if (enumIndex ` == 13) {
				var ` = `[0];
				var ` = `[1];
				{
					var v = `;
					{
						tempVarName = v.name;
					};
				};
			} else {
				return null;
			};
		};
		var elements = [];
		{
			var ` = 1;
			var ` = statements.length - 1;
			while (` < `) {
				var i = ` ++;
				var stmt = reflaxe.elixir.ast.builders.ComprehensionBuilder.unwrapMetaParens(statements[i]);
				@:ast(switch (stmt.expr) {
	case TBinop(OpAssignOp(OpAdd), { expr : TLocal(v) }, { expr : TArrayDecl([value]) }) if (v.name == tempVarName):
		elements.push(context.getExpressionBuilder()(value));	
	case TBinop(OpAssign, { expr : TLocal(v) }, { expr : TBinop(OpAdd, { expr : TLocal(v2) }, { expr : TArrayDecl([value]) }) }) if (v.name == tempVarName && v2.name == tempVarName):
		elements.push(context.getExpressionBuilder()(value));	
	case TIf(condition, thenExpr, elseExpr):
		switch (thenExpr.expr) {
			case TBinop(OpAssignOp(OpAdd), { expr : TLocal(v) }, { expr : TArrayDecl([value]) }) if (v.name == tempVarName):
				elements.push(context.getExpressionBuilder()(value));			
			case TBinop(OpAssign, { expr : TLocal(v) }, { expr : TBinop(OpAdd, _, { expr : TArrayDecl([value]) }) }) if (v.name == tempVarName):
				elements.push(context.getExpressionBuilder()(value));			
			default:
		};	
	default:
}) {
					var ` = stmt.expr;
					switch (enumIndex `) {
						case 3: {
							var ` = `[0];
							var ` = `[1];
							var ` = `[2];
							switch (enumIndex `) {
								case 4: {
									{
										var ` = `.expr;
										var ` = `.pos;
										var ` = `.t;
										if (enumIndex ` == 1) {
											var ` = `[0];
											{
												var ` = `.expr;
												var ` = `.pos;
												var ` = `.t;
												if (enumIndex ` == 3) {
													var ` = `[0];
													var ` = `[1];
													var ` = `[2];
													if (enumIndex ` == 0) {
														{
															var ` = `.expr;
															var ` = `.pos;
															var ` = `.t;
															if (enumIndex ` == 1) {
																var ` = `[0];
																{
																	var ` = `.expr;
																	var ` = `.pos;
																	var ` = `.t;
																	if (enumIndex ` == 8) {
																		var ` = `[0];
																		if (`.length == 1) {
																			var ` = `[0];
																			{
																				var value = `;
																				var v2 = `;
																				var v = `;
																				if (v.name == tempVarName && v2.name == tempVarName) {
																					elements.push(context.getExpressionBuilder()(value));
																				} else {};
																			};
																		} else {};
																	} else {};
																};
															} else {};
														};
													} else {};
												} else {};
											};
										} else {};
									};
								};
								case 20: {
									var ` = `[0];
									if (enumIndex ` == 0) {
										{
											var ` = `.expr;
											var ` = `.pos;
											var ` = `.t;
											if (enumIndex ` == 1) {
												var ` = `[0];
												{
													var ` = `.expr;
													var ` = `.pos;
													var ` = `.t;
													if (enumIndex ` == 8) {
														var ` = `[0];
														if (`.length == 1) {
															var ` = `[0];
															{
																var value = `;
																var v = `;
																if (v.name == tempVarName) {
																	elements.push(context.getExpressionBuilder()(value));
																} else {};
															};
														} else {};
													} else {};
												};
											} else {};
										};
									} else {};
								};
								default: {}
							};
						};
						case 16: {
							var ` = `[0];
							var ` = `[1];
							var ` = `[2];
							{
								var condition = `;
								var thenExpr = `;
								var elseExpr = `;
								{
									@:ast(switch (thenExpr.expr) {
	case TBinop(OpAssignOp(OpAdd), { expr : TLocal(v) }, { expr : TArrayDecl([value]) }) if (v.name == tempVarName):
		elements.push(context.getExpressionBuilder()(value));	
	case TBinop(OpAssign, { expr : TLocal(v) }, { expr : TBinop(OpAdd, _, { expr : TArrayDecl([value]) }) }) if (v.name == tempVarName):
		elements.push(context.getExpressionBuilder()(value));	
	default:
}) {
										var ` = thenExpr.expr;
										if (enumIndex ` == 3) {
											var ` = `[0];
											var ` = `[1];
											var ` = `[2];
											switch (enumIndex `) {
												case 4: {
													{
														var ` = `.expr;
														var ` = `.pos;
														var ` = `.t;
														if (enumIndex ` == 1) {
															var ` = `[0];
															{
																var ` = `.expr;
																var ` = `.pos;
																var ` = `.t;
																if (enumIndex ` == 3) {
																	var ` = `[0];
																	var ` = `[1];
																	var ` = `[2];
																	if (enumIndex ` == 0) {
																		{
																			var ` = `.expr;
																			var ` = `.pos;
																			var ` = `.t;
																			if (enumIndex ` == 8) {
																				var ` = `[0];
																				if (`.length == 1) {
																					var ` = `[0];
																					{
																						var value = `;
																						var v = `;
																						if (v.name == tempVarName) {
																							elements.push(context.getExpressionBuilder()(value));
																						} else {};
																					};
																				} else {};
																			} else {};
																		};
																	} else {};
																} else {};
															};
														} else {};
													};
												};
												case 20: {
													var ` = `[0];
													if (enumIndex ` == 0) {
														{
															var ` = `.expr;
															var ` = `.pos;
															var ` = `.t;
															if (enumIndex ` == 1) {
																var ` = `[0];
																{
																	var ` = `.expr;
																	var ` = `.pos;
																	var ` = `.t;
																	if (enumIndex ` == 8) {
																		var ` = `[0];
																		if (`.length == 1) {
																			var ` = `[0];
																			{
																				var value = `;
																				var v = `;
																				if (v.name == tempVarName) {
																					elements.push(context.getExpressionBuilder()(value));
																				} else {};
																			};
																		} else {};
																	} else {};
																};
															} else {};
														};
													} else {};
												};
												default: {}
											};
										} else {};
									};
								};
							};
						};
						default: {}
					};
				};
			};
		};
		return if (elements.length > 0) {
			elements;
		} else {
			null;
		};
	}

	public static function tryReconstructConditionalComprehension(statements:Array<haxe.macro.TypedExpr>, tempVarName:String, context:reflaxe.elixir.ast.context.BuildContext) {
		if (statements.length == 0) {
			return null;
		};
		if (statements.length == 1) {
			@:ast(switch (statements[0].expr) {
	case TBlock(innerStmts):
		return tryReconstructConditionalComprehension(innerStmts, tempVarName, context);	
	default:
}) {
				var ` = statements[0].expr;
				if (enumIndex ` == 14) {
					var ` = `[0];
					{
						var innerStmts = `;
						{
							return reflaxe.elixir.ast.builders.ComprehensionBuilder.tryReconstructConditionalComprehension(innerStmts, tempVarName, context);
						};
					};
				} else {};
			};
		};
		{
			var ` = 0;
			while (` < statements.length) {
				var stmt = statements[`];
				++ `;
				@:ast(switch (stmt.expr) {
	case TFor(_, iterator, body):
		var filterAndValue = extractConditionalConcatenation(body, tempVarName);
		if (filterAndValue != null) {
			var loopVarName = switch (stmt.expr) {
				case TFor(v, _, _):
					v.name;				
				default:
					"";				
			};
			return makeAST(EFor([{ pattern : PVar(loopVarName), expr : context.getExpressionBuilder()(iterator) }], [context.getExpressionBuilder()(filterAndValue.condition)], context.getExpressionBuilder()(filterAndValue.value), null, false));
		};	
	case TWhile({ expr : TBinop(OpLt, { expr : TLocal(indexVar) }, limit) }, body, _):
		continue;	
	default:
}) {
					var ` = stmt.expr;
					switch (enumIndex `) {
						case 15: {
							var ` = `[0];
							var ` = `[1];
							var ` = `[2];
							{
								var iterator = `;
								var body = `;
								{
									var filterAndValue = reflaxe.elixir.ast.builders.ComprehensionBuilder.extractConditionalConcatenation(body, tempVarName);
									if (filterAndValue != null) {
										var loopVarName = @:ast(switch (stmt.expr) {
	case TFor(v, _, _):
		v.name;	
	default:
		"";	
}) {
											var ` = stmt.expr;
											if (enumIndex ` == 15) {
												var ` = `[0];
												var ` = `[1];
												var ` = `[2];
												{
													var v = `;
													{
														v.name;
													};
												};
											} else {
												"";
											};
										};
										return {
											var def = reflaxe.elixir.ast.ElixirASTDef.EFor([{pattern : reflaxe.elixir.ast.EPattern.PVar(loopVarName), expr : context.getExpressionBuilder()(iterator)}], [context.getExpressionBuilder()(filterAndValue.condition)], context.getExpressionBuilder()(filterAndValue.value), null, false);
											var pos = null;
											{def : def, metadata : {}, pos : pos};
										};
									};
								};
							};
						};
						case 17: {
							var ` = `[0];
							var ` = `[1];
							var ` = `[2];
							{
								var ` = `.expr;
								var ` = `.pos;
								var ` = `.t;
								if (enumIndex ` == 3) {
									var ` = `[0];
									var ` = `[1];
									var ` = `[2];
									if (enumIndex ` == 9) {
										{
											var ` = `.expr;
											var ` = `.pos;
											var ` = `.t;
											if (enumIndex ` == 1) {
												var ` = `[0];
												{
													var indexVar = `;
													var limit = `;
													var body = `;
													{
														continue;
													};
												};
											} else {};
										};
									} else {};
								} else {};
							};
						};
						default: {}
					};
				};
			};
		};
		var elements = [];
		var hasConditions = false;
		{
			var ` = 0;
			while (` < statements.length) {
				var stmt = statements[`];
				++ `;
				@:ast(switch (stmt.expr) {
	case TIf(condition, thenExpr, _):
		hasConditions = true;
		switch (thenExpr.expr) {
			case TBinop(OpAssignOp(OpAdd), { expr : TLocal(v) }, { expr : TArrayDecl([value]) }) if (v.name == tempVarName):
				elements.push(context.getExpressionBuilder()(value));			
			case TBinop(OpAssign, { expr : TLocal(v) }, { expr : TBinop(OpAdd, _, { expr : TArrayDecl([value]) }) }) if (v.name == tempVarName):
				elements.push(context.getExpressionBuilder()(value));			
			default:
		};	
	default:
}) {
					var ` = stmt.expr;
					if (enumIndex ` == 16) {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var condition = `;
							var thenExpr = `;
							{
								hasConditions = true;
								@:ast(switch (thenExpr.expr) {
	case TBinop(OpAssignOp(OpAdd), { expr : TLocal(v) }, { expr : TArrayDecl([value]) }) if (v.name == tempVarName):
		elements.push(context.getExpressionBuilder()(value));	
	case TBinop(OpAssign, { expr : TLocal(v) }, { expr : TBinop(OpAdd, _, { expr : TArrayDecl([value]) }) }) if (v.name == tempVarName):
		elements.push(context.getExpressionBuilder()(value));	
	default:
}) {
									var ` = thenExpr.expr;
									if (enumIndex ` == 3) {
										var ` = `[0];
										var ` = `[1];
										var ` = `[2];
										switch (enumIndex `) {
											case 4: {
												{
													var ` = `.expr;
													var ` = `.pos;
													var ` = `.t;
													if (enumIndex ` == 1) {
														var ` = `[0];
														{
															var ` = `.expr;
															var ` = `.pos;
															var ` = `.t;
															if (enumIndex ` == 3) {
																var ` = `[0];
																var ` = `[1];
																var ` = `[2];
																if (enumIndex ` == 0) {
																	{
																		var ` = `.expr;
																		var ` = `.pos;
																		var ` = `.t;
																		if (enumIndex ` == 8) {
																			var ` = `[0];
																			if (`.length == 1) {
																				var ` = `[0];
																				{
																					var value = `;
																					var v = `;
																					if (v.name == tempVarName) {
																						elements.push(context.getExpressionBuilder()(value));
																					} else {};
																				};
																			} else {};
																		} else {};
																	};
																} else {};
															} else {};
														};
													} else {};
												};
											};
											case 20: {
												var ` = `[0];
												if (enumIndex ` == 0) {
													{
														var ` = `.expr;
														var ` = `.pos;
														var ` = `.t;
														if (enumIndex ` == 1) {
															var ` = `[0];
															{
																var ` = `.expr;
																var ` = `.pos;
																var ` = `.t;
																if (enumIndex ` == 8) {
																	var ` = `[0];
																	if (`.length == 1) {
																		var ` = `[0];
																		{
																			var value = `;
																			var v = `;
																			if (v.name == tempVarName) {
																				elements.push(context.getExpressionBuilder()(value));
																			} else {};
																		};
																	} else {};
																} else {};
															};
														} else {};
													};
												} else {};
											};
											default: {}
										};
									} else {};
								};
							};
						};
					} else {};
				};
			};
		};
		if (elements.length > 0) {
			return {
				var pos = null;
				{def : reflaxe.elixir.ast.ElixirASTDef.EList(elements), metadata : {}, pos : pos};
			};
		};
		return null;
	}

	static function extractConditionalConcatenation(stmt:haxe.macro.TypedExpr, tempVarName:String) {
		@:ast(switch (stmt.expr) {
	case TIf(condition, thenExpr, _):
		switch (thenExpr.expr) {
			case TBinop(OpAssignOp(OpAdd), { expr : TLocal(v) }, { expr : TArrayDecl([value]) }) if (v.name == tempVarName):
				return { condition : condition, value : value };			
			case TBinop(OpAssign, { expr : TLocal(v) }, { expr : TBinop(OpAdd, _, { expr : TArrayDecl([value]) }) }) if (v.name == tempVarName):
				return { condition : condition, value : value };			
			case TBlock(stmts):
				for (s  in  stmts) {
					var result = extractConditionalConcatenation(s, tempVarName);
					if (result != null) return result;
				};			
			default:
		};	
	case TBlock(stmts):
		for (s  in  stmts) {
			var result = extractConditionalConcatenation(s, tempVarName);
			if (result != null) return result;
		};	
	default:
}) {
			var ` = stmt.expr;
			switch (enumIndex `) {
				case 14: {
					var ` = `[0];
					{
						var stmts = `;
						{
							{
								var ` = 0;
								while (` < stmts.length) {
									var s = stmts[`];
									++ `;
									var result = reflaxe.elixir.ast.builders.ComprehensionBuilder.extractConditionalConcatenation(s, tempVarName);
									if (result != null) {
										return result;
									};
								};
							};
						};
					};
				};
				case 16: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					{
						var condition = `;
						var thenExpr = `;
						{
							@:ast(switch (thenExpr.expr) {
	case TBinop(OpAssignOp(OpAdd), { expr : TLocal(v) }, { expr : TArrayDecl([value]) }) if (v.name == tempVarName):
		return { condition : condition, value : value };	
	case TBinop(OpAssign, { expr : TLocal(v) }, { expr : TBinop(OpAdd, _, { expr : TArrayDecl([value]) }) }) if (v.name == tempVarName):
		return { condition : condition, value : value };	
	case TBlock(stmts):
		for (s  in  stmts) {
			var result = extractConditionalConcatenation(s, tempVarName);
			if (result != null) return result;
		};	
	default:
}) {
								var ` = thenExpr.expr;
								switch (enumIndex `) {
									case 3: {
										var ` = `[0];
										var ` = `[1];
										var ` = `[2];
										switch (enumIndex `) {
											case 4: {
												{
													var ` = `.expr;
													var ` = `.pos;
													var ` = `.t;
													if (enumIndex ` == 1) {
														var ` = `[0];
														{
															var ` = `.expr;
															var ` = `.pos;
															var ` = `.t;
															if (enumIndex ` == 3) {
																var ` = `[0];
																var ` = `[1];
																var ` = `[2];
																if (enumIndex ` == 0) {
																	{
																		var ` = `.expr;
																		var ` = `.pos;
																		var ` = `.t;
																		if (enumIndex ` == 8) {
																			var ` = `[0];
																			if (`.length == 1) {
																				var ` = `[0];
																				{
																					var value = `;
																					var v = `;
																					if (v.name == tempVarName) {
																						return {condition : condition, value : value};
																					} else {};
																				};
																			} else {};
																		} else {};
																	};
																} else {};
															} else {};
														};
													} else {};
												};
											};
											case 20: {
												var ` = `[0];
												if (enumIndex ` == 0) {
													{
														var ` = `.expr;
														var ` = `.pos;
														var ` = `.t;
														if (enumIndex ` == 1) {
															var ` = `[0];
															{
																var ` = `.expr;
																var ` = `.pos;
																var ` = `.t;
																if (enumIndex ` == 8) {
																	var ` = `[0];
																	if (`.length == 1) {
																		var ` = `[0];
																		{
																			var value = `;
																			var v = `;
																			if (v.name == tempVarName) {
																				return {condition : condition, value : value};
																			} else {};
																		};
																	} else {};
																} else {};
															};
														} else {};
													};
												} else {};
											};
											default: {}
										};
									};
									case 14: {
										var ` = `[0];
										{
											var stmts = `;
											{
												{
													var ` = 0;
													while (` < stmts.length) {
														var s = stmts[`];
														++ `;
														var result = reflaxe.elixir.ast.builders.ComprehensionBuilder.extractConditionalConcatenation(s, tempVarName);
														if (result != null) {
															return result;
														};
													};
												};
											};
										};
									};
									default: {}
								};
							};
						};
					};
				};
				default: {}
			};
		};
		return null;
	}

	public static function extractListElements(stmts:Array<haxe.macro.TypedExpr>) {
		if (! reflaxe.elixir.ast.builders.ComprehensionBuilder.looksLikeListBuildingBlock(stmts)) {
			return null;
		};
		var elements = [];
		{
			var ` = 1;
			var ` = stmts.length - 1;
			while (` < `) {
				var i = ` ++;
				var stmt = reflaxe.elixir.ast.builders.ComprehensionBuilder.unwrapMetaParens(stmts[i]);
				@:ast(switch (stmt.expr) {
	case TBinop(OpAdd, { expr : TLocal(v) }, { expr : TArrayDecl([value]) }):
		switch (value.expr) {
			case TBlock(innerStmts) if (looksLikeListBuildingBlock(innerStmts)):
				var nestedElements = extractListElements(innerStmts);
				if (nestedElements != null && nestedElements.length > 0) {
					var listExpr = { expr : TArrayDecl(nestedElements), pos : value.pos, t : value.t };
					elements.push(listExpr);
				} else {
					elements.push(value);
				};			
			default:
				elements.push(value);			
		};	
	case TBinop(OpAdd, _, { expr : TBlock(blockStmts) }):
		if (looksLikeListBuildingBlock(blockStmts)) {
			var nestedElements = extractListElements(blockStmts);
			if (nestedElements != null && nestedElements.length > 0) {
				var listExpr = { expr : TArrayDecl(nestedElements), pos : stmt.pos, t : stmt.t };
				elements.push(listExpr);
			} else {
				elements.push({ expr : TBlock(blockStmts), pos : stmt.pos, t : stmt.t });
			};
		} else {
			elements.push({ expr : TBlock(blockStmts), pos : stmt.pos, t : stmt.t });
		};	
	case TBinop(OpAssign, _, rhs):
		switch (rhs.expr) {
			case TBinop(OpAdd, _, { expr : TArrayDecl([value]) }):
				switch (value.expr) {
					case TBlock(innerStmts) if (looksLikeListBuildingBlock(innerStmts)):
						var nestedElements = extractListElements(innerStmts);
						if (nestedElements != null && nestedElements.length > 0) {
							var listExpr = { expr : TArrayDecl(nestedElements), pos : value.pos, t : value.t };
							elements.push(listExpr);
						} else {
							elements.push(value);
						};					
					default:
						elements.push(value);					
				};			
			case TBinop(OpAdd, _, { expr : TBlock(blockStmts) }):
				if (looksLikeListBuildingBlock(blockStmts)) {
					var nestedElements = extractListElements(blockStmts);
					if (nestedElements != null && nestedElements.length > 0) {
						var listExpr = { expr : TArrayDecl(nestedElements), pos : rhs.pos, t : rhs.t };
						elements.push(listExpr);
					} else {
						elements.push({ expr : TBlock(blockStmts), pos : rhs.pos, t : rhs.t });
					};
				} else {
					elements.push({ expr : TBlock(blockStmts), pos : rhs.pos, t : rhs.t });
				};			
			default:
		};	
	default:
}) {
					var ` = stmt.expr;
					if (enumIndex ` == 3) {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						switch (enumIndex `) {
							case 0: {
								{
									var ` = `.expr;
									var ` = `.pos;
									var ` = `.t;
									if (enumIndex ` == 1) {
										var ` = `[0];
										{
											var ` = `.expr;
											var ` = `.pos;
											var ` = `.t;
											switch (enumIndex `) {
												case 8: {
													var ` = `[0];
													if (`.length == 1) {
														var ` = `[0];
														{
															var value = `;
															var v = `;
															{
																@:ast(switch (value.expr) {
	case TBlock(innerStmts) if (looksLikeListBuildingBlock(innerStmts)):
		var nestedElements = extractListElements(innerStmts);
		if (nestedElements != null && nestedElements.length > 0) {
			var listExpr = { expr : TArrayDecl(nestedElements), pos : value.pos, t : value.t };
			elements.push(listExpr);
		} else {
			elements.push(value);
		};	
	default:
		elements.push(value);	
}) {
																	var ` = value.expr;
																	if (enumIndex ` == 14) {
																		var ` = `[0];
																		{
																			var innerStmts = `;
																			if (reflaxe.elixir.ast.builders.ComprehensionBuilder.looksLikeListBuildingBlock(innerStmts)) {
																				var nestedElements = reflaxe.elixir.ast.builders.ComprehensionBuilder.extractListElements(innerStmts);
																				if (nestedElements != null && nestedElements.length > 0) {
																					var listExpr = {expr : haxe.macro.TypedExprDef.TArrayDecl(nestedElements), pos : value.pos, t : value.t};
																					elements.push(listExpr);
																				} else {
																					elements.push(value);
																				};
																			} else {
																				elements.push(value);
																			};
																		};
																	} else {
																		elements.push(value);
																	};
																};
															};
														};
													} else {};
												};
												case 14: {
													var ` = `[0];
													{
														var blockStmts = `;
														{
															if (reflaxe.elixir.ast.builders.ComprehensionBuilder.looksLikeListBuildingBlock(blockStmts)) {
																var nestedElements = reflaxe.elixir.ast.builders.ComprehensionBuilder.extractListElements(blockStmts);
																if (nestedElements != null && nestedElements.length > 0) {
																	var listExpr = {expr : haxe.macro.TypedExprDef.TArrayDecl(nestedElements), pos : stmt.pos, t : stmt.t};
																	elements.push(listExpr);
																} else {
																	elements.push({expr : haxe.macro.TypedExprDef.TBlock(blockStmts), pos : stmt.pos, t : stmt.t});
																};
															} else {
																elements.push({expr : haxe.macro.TypedExprDef.TBlock(blockStmts), pos : stmt.pos, t : stmt.t});
															};
														};
													};
												};
												default: {}
											};
										};
									} else {
										var ` = `.expr;
										var ` = `.pos;
										var ` = `.t;
										if (enumIndex ` == 14) {
											var ` = `[0];
											{
												var blockStmts = `;
												{
													if (reflaxe.elixir.ast.builders.ComprehensionBuilder.looksLikeListBuildingBlock(blockStmts)) {
														var nestedElements = reflaxe.elixir.ast.builders.ComprehensionBuilder.extractListElements(blockStmts);
														if (nestedElements != null && nestedElements.length > 0) {
															var listExpr = {expr : haxe.macro.TypedExprDef.TArrayDecl(nestedElements), pos : stmt.pos, t : stmt.t};
															elements.push(listExpr);
														} else {
															elements.push({expr : haxe.macro.TypedExprDef.TBlock(blockStmts), pos : stmt.pos, t : stmt.t});
														};
													} else {
														elements.push({expr : haxe.macro.TypedExprDef.TBlock(blockStmts), pos : stmt.pos, t : stmt.t});
													};
												};
											};
										} else {};
									};
								};
							};
							case 4: {
								{
									var rhs = `;
									{
										@:ast(switch (rhs.expr) {
	case TBinop(OpAdd, _, { expr : TArrayDecl([value]) }):
		switch (value.expr) {
			case TBlock(innerStmts) if (looksLikeListBuildingBlock(innerStmts)):
				var nestedElements = extractListElements(innerStmts);
				if (nestedElements != null && nestedElements.length > 0) {
					var listExpr = { expr : TArrayDecl(nestedElements), pos : value.pos, t : value.t };
					elements.push(listExpr);
				} else {
					elements.push(value);
				};			
			default:
				elements.push(value);			
		};	
	case TBinop(OpAdd, _, { expr : TBlock(blockStmts) }):
		if (looksLikeListBuildingBlock(blockStmts)) {
			var nestedElements = extractListElements(blockStmts);
			if (nestedElements != null && nestedElements.length > 0) {
				var listExpr = { expr : TArrayDecl(nestedElements), pos : rhs.pos, t : rhs.t };
				elements.push(listExpr);
			} else {
				elements.push({ expr : TBlock(blockStmts), pos : rhs.pos, t : rhs.t });
			};
		} else {
			elements.push({ expr : TBlock(blockStmts), pos : rhs.pos, t : rhs.t });
		};	
	default:
}) {
											var ` = rhs.expr;
											if (enumIndex ` == 3) {
												var ` = `[0];
												var ` = `[1];
												var ` = `[2];
												if (enumIndex ` == 0) {
													{
														var ` = `.expr;
														var ` = `.pos;
														var ` = `.t;
														switch (enumIndex `) {
															case 8: {
																var ` = `[0];
																if (`.length == 1) {
																	var ` = `[0];
																	{
																		var value = `;
																		{
																			@:ast(switch (value.expr) {
	case TBlock(innerStmts) if (looksLikeListBuildingBlock(innerStmts)):
		var nestedElements = extractListElements(innerStmts);
		if (nestedElements != null && nestedElements.length > 0) {
			var listExpr = { expr : TArrayDecl(nestedElements), pos : value.pos, t : value.t };
			elements.push(listExpr);
		} else {
			elements.push(value);
		};	
	default:
		elements.push(value);	
}) {
																				var ` = value.expr;
																				if (enumIndex ` == 14) {
																					var ` = `[0];
																					{
																						var innerStmts = `;
																						if (reflaxe.elixir.ast.builders.ComprehensionBuilder.looksLikeListBuildingBlock(innerStmts)) {
																							var nestedElements = reflaxe.elixir.ast.builders.ComprehensionBuilder.extractListElements(innerStmts);
																							if (nestedElements != null && nestedElements.length > 0) {
																								var listExpr = {expr : haxe.macro.TypedExprDef.TArrayDecl(nestedElements), pos : value.pos, t : value.t};
																								elements.push(listExpr);
																							} else {
																								elements.push(value);
																							};
																						} else {
																							elements.push(value);
																						};
																					};
																				} else {
																					elements.push(value);
																				};
																			};
																		};
																	};
																} else {};
															};
															case 14: {
																var ` = `[0];
																{
																	var blockStmts = `;
																	{
																		if (reflaxe.elixir.ast.builders.ComprehensionBuilder.looksLikeListBuildingBlock(blockStmts)) {
																			var nestedElements = reflaxe.elixir.ast.builders.ComprehensionBuilder.extractListElements(blockStmts);
																			if (nestedElements != null && nestedElements.length > 0) {
																				var listExpr = {expr : haxe.macro.TypedExprDef.TArrayDecl(nestedElements), pos : rhs.pos, t : rhs.t};
																				elements.push(listExpr);
																			} else {
																				elements.push({expr : haxe.macro.TypedExprDef.TBlock(blockStmts), pos : rhs.pos, t : rhs.t});
																			};
																		} else {
																			elements.push({expr : haxe.macro.TypedExprDef.TBlock(blockStmts), pos : rhs.pos, t : rhs.t});
																		};
																	};
																};
															};
															default: {}
														};
													};
												} else {};
											} else {};
										};
									};
								};
							};
							default: {}
						};
					} else {};
				};
			};
		};
		return elements;
	}

	static function unwrapMetaParens(expr:haxe.macro.TypedExpr) {
		return @:ast(switch (expr.expr) {
	case TMeta({ name : ":mergeBlock" | ":implicitReturn" }, e) | TParenthesis(e):
		unwrapMetaParens(e);	
	default:
		expr;	
}) {
			var ` = expr.expr;
			switch (enumIndex `) {
				case 6: {
					var ` = `[0];
					{
						var e = `;
						{
							reflaxe.elixir.ast.builders.ComprehensionBuilder.unwrapMetaParens(e);
						};
					};
				};
				case 25: {
					var ` = `[0];
					var ` = `[1];
					{
						var ` = `.name;
						var ` = `.params;
						var ` = `.pos;
						switch (`) {
							case ":implicitReturn", ":mergeBlock": {
								{
									var e = `;
									{
										reflaxe.elixir.ast.builders.ComprehensionBuilder.unwrapMetaParens(e);
									};
								};
							};
							default: {
								expr;
							}
						};
					};
				};
				default: {
					expr;
				}
			};
		};
	}
}