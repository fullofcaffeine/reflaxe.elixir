#!/bin/bash

# Clean up remaining PascalCase .ex files from intended directories
# These are leftover files that couldn't be renamed because snake_case versions already existed
# Generated by Claude Code on 2025-01-22

set -e  # Exit on any error

echo "üßπ Cleaning up remaining PascalCase .ex files"
echo "Removing duplicate PascalCase files where snake_case versions exist..."

# Function to convert PascalCase to snake_case
pascal_to_snake() {
    echo "$1" | sed 's/\([A-Z]\)/_\1/g' | sed 's/^_//' | tr '[:upper:]' '[:lower:]'
}

# Initialize counters
removed_count=0
skipped_count=0
errors=()

# Find all PascalCase .ex files that still exist
while IFS= read -r pascal_file; do
    if [[ -z "$pascal_file" ]]; then
        continue
    fi
    
    # Extract directory and filename
    dir=$(dirname "$pascal_file")
    filename=$(basename "$pascal_file")
    
    # Convert filename to snake_case
    snake_filename=$(pascal_to_snake "$filename")
    snake_filepath="$dir/$snake_filename"
    
    # Only remove PascalCase file if snake_case version exists
    if [[ -f "$snake_filepath" ]]; then
        echo "üóëÔ∏è  Removing duplicate: $filename (snake_case version exists)"
        if rm "$pascal_file"; then
            ((removed_count++))
        else
            echo "‚ùå Failed to remove: $pascal_file"
            errors+=("Failed to remove: $pascal_file")
        fi
    else
        echo "‚ö†Ô∏è  Keeping: $filename (no snake_case version found)"
        # Copy PascalCase to snake_case to fix the test
        echo "üìã Creating snake_case version: $filename ‚Üí $snake_filename"
        if cp "$pascal_file" "$snake_filepath"; then
            echo "üóëÔ∏è  Removing original PascalCase: $filename"
            if rm "$pascal_file"; then
                ((removed_count++))
            else
                echo "‚ùå Failed to remove original: $pascal_file"
                errors+=("Failed to remove original: $pascal_file")
            fi
        else
            echo "‚ùå Failed to copy: $pascal_file"
            errors+=("Failed to copy: $pascal_file")
            ((skipped_count++))
        fi
    fi
    
done < <(find test/tests -path "*/intended/*" -name "*.ex" | grep -E "/[A-Z][^/]*\.ex$")

echo ""
echo "üìà Cleanup Summary:"
echo "   üóëÔ∏è  Successfully removed: $removed_count files"
echo "   ‚è≠Ô∏è  Skipped: $skipped_count files"
echo "   ‚ùå Errors: ${#errors[@]} files"

if [[ ${#errors[@]} -gt 0 ]]; then
    echo ""
    echo "üö® Errors encountered:"
    for error in "${errors[@]}"; do
        echo "   - $error"
    done
fi

echo ""
echo "üß™ Next: Run tests to verify all fixes"
echo "Run: npm run test:quick"