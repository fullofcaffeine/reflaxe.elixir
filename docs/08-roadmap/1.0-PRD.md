# Reflaxe.Elixir 1.0 — Product Requirements Document (PRD)

## Vision

Deliver a production‑quality Haxe→Elixir compiler enabling developers to write business logic once in Haxe and deploy it anywhere, generating idiomatic, hand‑quality Elixir that Phoenix/Ecto experts recognize.

## Non‑Negotiable Requirements

- AST‑only pipeline: All compilation flows TypedExpr → ElixirAST → Transformations → Printer; no string concatenation emitters.
- Idiomatic Phoenix/Ecto output: Faithful APIs, no invented functions, standard patterns (router, LV lifecycle, Presence, PubSub, Ecto).
- Target‑conditional stdlib gating: Elixir‑specific std/_std and `__elixir__()` only available when the target is Elixir; macro/other targets see stock Haxe stdlib.
- Zero warnings policy for TodoApp: `npx haxe build-server.hxml` produces no compiler warnings; `mix compile --warnings-as-errors` passes; runtime is clean (no warnings/errors) under LiveView smoke.
- Module size constraint: Any single `.hx` source in compiler (builder/transformers) stays < 2000 LOC. If approaching the threshold, extract into dedicated modules.
- No band‑aids: Fix root causes; no TODOs, no arbitrary limits, no string post‑processing patches; no `-D analyzer-optimize` in server builds.

## Architectural Invariants

- ElixirASTTransformer acts as a thin registry/forwarder. Pass implementations live in domain modules (e.g., MapAndCollectionTransforms, StringTransforms, StructAndMapTransforms, loop/*).
- Builders are modular (PatternBuilder, LoopBuilder, CallExprBuilder, etc.) and never embed target‑specific hacks that belong in transforms.
- Public traversal helpers only: all passes use `ASTUtils.walk/transformAST` or a single exported walker; no private helper leakage.
- Passes are ordered to minimize revisits; prefer single‑walk composition where possible.

## Release Criteria

1. All snapshot categories pass (core, stdlib, regression, phoenix, ecto, otp).
2. TodoApp builds (Haxe) and compiles (Mix) with zero warnings; LiveView smoke shows no runtime errors.
3. Target‑conditional gating verified by a non‑Elixir build (e.g., JS) that succeeds without `__elixir__` symbols.
4. Large files refactored and enforced via a lightweight LOC gate in CI.
5. Documentation updated (WHAT/WHY/HOW of passes; PassOrdering.md), CHANGELOG written; version tagged v1.0.0.

## Pass Ordering (High‑Level)

1. Preprocess/Desugar (typed expr preprocessing)
2. Structural transforms (maps/structs/strings)
3. Loop transforms (for/comprehension/reduce_while)
4. Binder/Pattern transforms (aliasing, unused binder underscore)
5. Hygiene and dead assignment elimination
6. Minimal late sweep for stragglers (assign/Repo/push/nil)
7. Printer

Rationale: front‑load structure normalization; resolve loops before binders; finish with hygiene and a narrow late sweep to avoid overlap with builder responsibilities.

## Test Matrix

- Snapshots: run by category and full sweep; add targeted regressions for binder/loop and ERaw idioms.
- TodoApp: Haxe build, Mix compile (warnings‑as‑errors), LiveView runtime smoke; JS build to verify gating.
- Lint: LOC gate script over known hotspots (Transformer, Builder, Loop modules).

## Known Work Remaining (tracked in shrimp)

1. Replace private `iterateAST` usage in BinderTransforms with public walkers.
2. Purge/guard unused pattern cases (PatternBuilder, ElixirASTTransformer) to achieve zero warnings.
3. Transformer slimming Phase 1–2 (Loop family; Map/String/Struct) with forwarders only in registry.
4. Introduce Module Size Gate (CI/lint).
5. ERaw Guard normalization + minimal late sweep.
6. Verify target‑conditional stdlib gating.
7. TodoApp clean build, LiveView smoke; snapshot sweep; docs/changelog finalization.

## Out of Scope for 1.0

- New language features not required by idiomatic Phoenix/Ecto patterns.
- Alternative AST backends or experimental printers.
- Performance micro‑optimizations that harm readability.

## References

- .claude/commands/replan.md — replanning workflow and constraints
- .claude/agents/qa-sentinel.md — verification rubric per task
- docs/03-compiler-development/architecture.md — compiler design overview
- docs/05-architecture/AST_PIPELINE_MIGRATION.md — AST migration background

