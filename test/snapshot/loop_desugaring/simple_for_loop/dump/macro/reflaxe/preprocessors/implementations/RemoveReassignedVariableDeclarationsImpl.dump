class reflaxe.preprocessors.implementations.RemoveReassignedVariableDeclarationsImpl {

	public function new(list:Array<haxe.macro.TypedExpr>) {
		this.exprList = list;
	}

	var exprList:Array<haxe.macro.TypedExpr>;

	public function removeUnnecessaryVarDecls() {
		var result = [];
		var removableVars = [];
		var indexesToRemove = [];
		var i = 0;
		while (i < this.exprList.length) {
			var expr = this.exprList[i ++];
			@:ast(switch (expr.expr) {
	case TVar(tvar, e):
		{
			if (!isModifyingExpr(e)) {
				removableVars.push({ tvar : tvar, index : i - 1 });
			};
		};	
	case TBinop(OpAssign, { expr : TLocal(tvar) }, e):
		{
			removableVars = filterRemovableVars(e, removableVars);
			var successful = false;
			for (v  in  removableVars) {
				if (v.tvar.id == tvar.id) {
					var copyExpr = expr.copy();
					copyExpr.expr = TVar(tvar, e);
					result.push(copyExpr);
					indexesToRemove.push(v.index);
					successful = true;
					break;
				};
			};
			if (successful) {
				continue;
			};
		};	
	case TBlock(el):
		{
			var copyExpr = expr.copy();
			copyExpr.expr = TBlock(process(el));
			result.push(copyExpr);
			continue;
		};	
	case _:
		{
			removableVars = filterRemovableVars(expr, removableVars);
		};	
}) {
				var ` = expr.expr;
				switch (enumIndex `) {
					case 3: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						if (enumIndex ` == 4) {
							{
								var ` = `.expr;
								var ` = `.pos;
								var ` = `.t;
								if (enumIndex ` == 1) {
									var ` = `[0];
									{
										var tvar = `;
										var e = `;
										{
											{
												removableVars = this.filterRemovableVars(e, removableVars);
												var successful = false;
												{
													var ` = 0;
													while (` < removableVars.length) {
														var v = removableVars[`];
														++ `;
														if (v.tvar.id == tvar.id) {
															var copyExpr = reflaxe.helpers.TypedExprHelper.copy(expr, null);
															copyExpr.expr = haxe.macro.TypedExprDef.TVar(tvar, e);
															result.push(copyExpr);
															indexesToRemove.push(v.index);
															successful = true;
															break;
														};
													};
												};
												if (successful) {
													continue;
												};
											};
										};
									};
								} else {
									{
										removableVars = this.filterRemovableVars(expr, removableVars);
									};
								};
							};
						} else {
							{
								removableVars = this.filterRemovableVars(expr, removableVars);
							};
						};
					};
					case 13: {
						var ` = `[0];
						var ` = `[1];
						{
							var tvar = `;
							var e = `;
							{
								{
									if (! this.isModifyingExpr(e)) {
										removableVars.push({tvar : tvar, index : i - 1});
									};
								};
							};
						};
					};
					case 14: {
						var ` = `[0];
						{
							var el = `;
							{
								{
									var copyExpr = reflaxe.helpers.TypedExprHelper.copy(expr, null);
									copyExpr.expr = haxe.macro.TypedExprDef.TBlock(reflaxe.preprocessors.implementations.RemoveReassignedVariableDeclarationsImpl.process(el));
									result.push(copyExpr);
									continue;
								};
							};
						};
					};
					default: {
						{
							removableVars = this.filterRemovableVars(expr, removableVars);
						};
					}
				};
			};
			result.push(expr);
		};
		return {
			var filteredResult = [];
			{
				var ` = 0;
				var ` = result.length;
				while (` < `) {
					var i = ` ++;
					if (! indexesToRemove.contains(i)) {
						filteredResult.push(result[i]);
					};
				};
			};
			filteredResult;
		};
	}

	function filterRemovableVars(expr:haxe.macro.TypedExpr, removableVars:Array<{ tvar : haxe.macro.TVar, index : Int }>) {
		var removableVars = [removableVars];
		var exprIter = [null];
		exprIter[0] = function(e:haxe.macro.TypedExpr) {
			@:ast(switch (e.expr) {
	case TLocal(tvar):
		{
			removableVars = removableVars.filter(function(v) {
				return v.tvar.id != tvar.id;
			});
		};	
	case _:
}) {
				var ` = e.expr;
				if (enumIndex ` == 1) {
					var ` = `[0];
					{
						var tvar = `;
						{
							{
								removableVars[0] = {
									var ` = [];
									{
										var ` = 0;
										var ` = removableVars[0];
										while (` < `.length) {
											var v = `[`];
											++ `;
											if (function(v:{ tvar : haxe.macro.TVar, index : Int }) {
												return v.tvar.id != tvar.id;
											}(v)) {
												`.push(v);
											};
										};
									};
									`;
								};
							};
						};
					};
				} else {};
			};
			haxe.macro.TypedExprTools.iter(e, exprIter[0]);
		};
		exprIter[0](expr);
		return removableVars[0];
	}

	function isModifyingExpr(e:Null<haxe.macro.TypedExpr>) {
		var `this = this;
		if (e == null) {
			return false;
		};
		return @:ast(switch (e.expr) {
	case TCall(_, _):
		true;	
	case TNew(_, _, _):
		true;	
	case TReturn(_):
		true;	
	case TBreak | TContinue:
		true;	
	case _:
		{
			var modifying = false;
			haxe.macro.TypedExprTools.iter(e, function(subExpr:TypedExpr) {
				if (isModifyingExpr(subExpr)) {
					modifying = true;
				};
			});
			modifying;
		};	
}) {
			var ` = e.expr;
			switch (enumIndex `) {
				case 9: {
					var ` = `[0];
					var ` = `[1];
					{
						true;
					};
				};
				case 10: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					{
						true;
					};
				};
				case 20: {
					var ` = `[0];
					{
						true;
					};
				};
				case 21, 22: {
					{
						true;
					};
				};
				default: {
					{
						var modifying = [false];
						haxe.macro.TypedExprTools.iter(e, function(subExpr:haxe.macro.TypedExpr) {
							if (`this.isModifyingExpr(subExpr)) {
								modifying[0] = true;
							};
						});
						modifying[0];
					};
				}
			};
		};
	}

	public static function process(list:Array<haxe.macro.TypedExpr>) {
		var ubr = new reflaxe.preprocessors.implementations.RemoveReassignedVariableDeclarationsImpl(list);
		return ubr.removeUnnecessaryVarDecls();
	}
}