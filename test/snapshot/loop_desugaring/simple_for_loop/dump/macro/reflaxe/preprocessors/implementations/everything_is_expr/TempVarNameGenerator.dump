class reflaxe.preprocessors.implementations.everything_is_expr.TempVarNameGenerator {

	public function new() {
		this.variableNameCounts = new haxe.ds.StringMap();
	}

	@:value([])
	var variableNameCounts:Map<String, Int>;

	public function reserveNames(names:Array<String>) {
		{
			var ` = 0;
			while (` < names.length) {
				var n = names[`];
				++ `;
				var count = if ({
					var this = this.variableNameCounts;
					cast this.exists(n);
				}) {
					{
						var maybe = {
							var this = this.variableNameCounts;
							cast this.get(n);
						};
						if (maybe != null) {
							maybe;
						} else {
							0;
						};
					};
				} else {
					0;
				};
				{
					var this = this.variableNameCounts;
					cast this.set(n, count + 1);
				};
			};
		};
	}

	@:value({ baseNameOverride : null })
	public function generateName(t:Null<haxe.macro.Type>, baseNameOverride:Null<String> = null) {
		var baseName = if (baseNameOverride != null) {
			baseNameOverride;
		} else {
			this.replaceDisallowedCharacters(this.generateBaseName(t));
		};
		var count = if ({
			var this = this.variableNameCounts;
			cast this.exists(baseName);
		}) {
			{
				var maybe = {
					var this = this.variableNameCounts;
					cast this.get(baseName);
				};
				if (maybe != null) {
					maybe;
				} else {
					0;
				};
			};
		} else {
			0;
		};
		var result = this.makeName(baseName, count);
		{
			var this = this.variableNameCounts;
			cast this.set(baseName, count + 1);
		};
		return result;
	}

	function replaceDisallowedCharacters(s:String) {
		return new EReg("[^0-9a-zA-Z_]+", "g").split(s).join("");
	}

	public function unknownBaseTypeName() {
		return "var";
	}

	public function makeName(baseName:String, count:Int) {
		var base = this.capatalize(baseName);
		var suffix = (if (count > 0) {
			Std.string(count);
		} else {
			"";
		});
		return "temp" + base + suffix;
	}

	function capatalize(s:String) {
		return s.substring(0, 1).toUpperCase() + s.substring(1, null);
	}

	function generateBaseName(t:Null<haxe.macro.Type>) {
		return @:ast(switch (t) {
	case null:
		unknownBaseTypeName();	
	case TMono(typeRef):
		{
			var t = typeRef.get();
			if (t != null) {
				generateName(t);
			} else {
				unknownBaseTypeName();
			};
		};	
	case TEnum(enumTypeRef, _):
		{
			enumTypeRef.get().name;
		};	
	case TInst(classTypeRef, _):
		{
			classTypeRef.get().name;
		};	
	case TType(defTypeRef, _):
		{
			defTypeRef.get().name;
		};	
	case TFun(_, _):
		{
			"function";
		};	
	case TAnonymous(_):
		{
			"struct";
		};	
	case TDynamic(maybeType):
		{
			if (maybeType != null) {
				generateName(maybeType);
			} else {
				unknownBaseTypeName();
			};
		};	
	case TLazy(lazyFunc):
		{
			generateName(lazyFunc());
		};	
	case TAbstract(abstractTypeRef, params):
		{
			switch (abstractTypeRef.get().name) {
				case "Int" | "Float":
					"number";				
				case "String":
					"string";				
				case "Null":
					{
						if (params.length > 0) {
							"Maybe" + capatalize(generateBaseName(params[0]));
						} else {
							"Nullable";
						};
					};				
				case s:
					s;				
			};
		};	
}) if (t == null) {
			this.unknownBaseTypeName();
		} else switch (@:exhaustive enumIndex t) {
			case 0: {
				var ` = t[0];
				{
					var typeRef = `;
					{
						{
							var t = typeRef.get();
							if (t != null) {
								this.generateName(t, null);
							} else {
								this.unknownBaseTypeName();
							};
						};
					};
				};
			};
			case 1: {
				var ` = t[0];
				var ` = t[1];
				{
					var enumTypeRef = `;
					{
						{
							enumTypeRef.get().name;
						};
					};
				};
			};
			case 2: {
				var ` = t[0];
				var ` = t[1];
				{
					var classTypeRef = `;
					{
						{
							classTypeRef.get().name;
						};
					};
				};
			};
			case 3: {
				var ` = t[0];
				var ` = t[1];
				{
					var defTypeRef = `;
					{
						{
							defTypeRef.get().name;
						};
					};
				};
			};
			case 4: {
				var ` = t[0];
				var ` = t[1];
				{
					{
						"function";
					};
				};
			};
			case 5: {
				var ` = t[0];
				{
					{
						"struct";
					};
				};
			};
			case 6: {
				var ` = t[0];
				{
					var maybeType = `;
					{
						{
							if (maybeType != null) {
								this.generateName(maybeType, null);
							} else {
								this.unknownBaseTypeName();
							};
						};
					};
				};
			};
			case 7: {
				var ` = t[0];
				{
					var lazyFunc = `;
					{
						{
							this.generateName(lazyFunc(), null);
						};
					};
				};
			};
			case 8: {
				var ` = t[0];
				var ` = t[1];
				{
					var abstractTypeRef = `;
					var params = `;
					{
						{
							@:ast(switch (abstractTypeRef.get().name) {
	case "Int" | "Float":
		"number";	
	case "String":
		"string";	
	case "Null":
		{
			if (params.length > 0) {
				"Maybe" + capatalize(generateBaseName(params[0]));
			} else {
				"Nullable";
			};
		};	
	case s:
		s;	
}) {
								var ` = abstractTypeRef.get().name;
								switch (`) {
									case "Float", "Int": {
										{
											"number";
										};
									};
									case "Null": {
										{
											{
												if (params.length > 0) {
													"Maybe" + this.capatalize(this.generateBaseName(params[0]));
												} else {
													"Nullable";
												};
											};
										};
									};
									case "String": {
										{
											"string";
										};
									};
									default: {
										var s = `;
										{
											s;
										};
									}
								};
							};
						};
					};
				};
			};
		};
	}
}