class reflaxe.data.ClassFuncArg {

	@:value({ tvar : null, expr : null, meta : null })
	public function new(index:Int, type:haxe.macro.Type, opt:Bool, originalName:String, meta:Null<haxe.macro.MetaAccess> = null, expr:Null<haxe.macro.TypedExpr> = null, tvar:Null<haxe.macro.TVar> = null) {
		this.index = index;
		this.type = type;
		this.opt = opt;
		this.originalName = originalName;
		this.meta = meta;
		this.expr = expr;
		this.tvar = tvar;
	}

	public var funcData(default,null):Null<reflaxe.data.ClassFuncData>;

	public var index(default,null):Int;

	public var type(default,null):haxe.macro.Type;

	public var opt(default,null):Bool;

	public var meta(default,null):Null<haxe.macro.MetaAccess>;

	public var expr(default,null):Null<haxe.macro.TypedExpr>;

	public var tvar(default,null):Null<haxe.macro.TVar>;

	public var originalName(default,null):String;

	public var overrideName(default,null):Null<String>;

	var extraMetadata:Null<haxe.macro.Metadata>;

	public function setFuncData(funcData:reflaxe.data.ClassFuncData) {
		this.funcData = funcData;
	}

	public function getName() {
		return if (this.overrideName != null) {
			this.overrideName;
		} else {
			this.originalName;
		};
	}

	public function ensureNameDoesntMatch(names:Array<String>) {
		var currentName = this.getName();
		var matchFound = false;
		{
			var ` = 0;
			while (` < names.length) {
				var name = names[`];
				++ `;
				if (currentName == name) {
					this.overrideName = currentName + "2";
					matchFound = true;
					break;
				};
			};
		};
		if (matchFound) {
			this.ensureNameDoesntMatch(names);
		};
		return matchFound;
	}

	public function isOptionalWithNoDefault() {
		return this.opt && this.expr == null;
	}

	public function isFrontOptional() {
		if (! this.opt) {
			return false;
		};
		var args = {
			var maybe = this.funcData;
			cast {
				if (maybe == null) {
					throw "Trusted on null value.";
				};
				@:nullSafety(Off) maybe;
			};
		}.args;
		{
			var ` = (this.index + 1);
			var ` = args.length;
			while (` < `) {
				var i = ` ++;
				if (! args[i].opt) {
					return true;
				};
			};
		};
		return false;
	}

	public function hasConflictingDefaultValue() {
		if ({
			var maybe = this.funcData;
			cast {
				if (maybe == null) {
					throw "Trusted on null value.";
				};
				@:nullSafety(Off) maybe;
			};
		}.isStatic) {
			return false;
		};
		var overrides = reflaxe.input.ClassHierarchyTracker.findAllOverrides({
			var maybe = this.funcData;
			cast {
				if (maybe == null) {
					throw "Trusted on null value.";
				};
				@:nullSafety(Off) maybe;
			};
		});
		{
			var ` = 0;
			while (` < overrides.length) {
				var funcData = overrides[`];
				++ `;
				if (funcData != null && funcData.args.length > this.index) {
					var otherDefault = funcData.args[this.index].expr;
					if (this.expr != null && otherDefault != null) {
						if (! reflaxe.helpers.TypedExprHelper.equals(this.expr, otherDefault)) {
							return true;
						};
					} else {
						if (this.expr != null || otherDefault != null) {
							return true;
						};
					};
				};
			};
		};
		return false;
	}

	public function toString() {
		return (if (this.opt) {
			"?";
		} else {
			"";
		}) + this.originalName + ": " + Std.string(this.type) + (if (this.expr != null) {
			Std.string(this.expr);
		} else {
			"";
		});
	}

	public function addExtraMetadata(m:haxe.macro.MetadataEntry) {
		if (this.extraMetadata == null) {
			this.extraMetadata = [];
		};
		this.extraMetadata.push(m);
	}

	public function getMetadata() {
		if (this.meta == null && this.extraMetadata == null) {
			return null;
		};
		var metadata = reflaxe.helpers.NullableMetaAccessHelper.maybeGet(this.meta);
		return if (this.extraMetadata != null) {
			metadata.concat(this.extraMetadata);
		} else {
			metadata;
		};
	}

	function findMetadata(name:String) {
		var metadata = this.getMetadata();
		if (metadata == null) {
			return null;
		};
		{
			var ` = 0;
			while (` < metadata.length) {
				var meta = metadata[`];
				++ `;
				if (meta.name == name) {
					return meta;
				};
			};
		};
		return null;
	}

	public function hasMetadata(name:String) {
		return this.findMetadata(name) != null;
	}

	public function getMetadataFirstString(name:String) {
		var entryParams = {
			var tmp = this.findMetadata(name);
			if (tmp != null) tmp.params else null;
		};
		if (entryParams != null && entryParams.length > 0) {
			@:ast(switch (entryParams[0].expr) {
	case EConst(CString(s, _)):
		return s;	
	case _:
}) {
				var ` = entryParams[0].expr;
				if (enumIndex ` == 0) {
					var ` = `[0];
					if (enumIndex ` == 2) {
						var ` = `[0];
						var ` = `[1];
						{
							var s = `;
							{
								return s;
							};
						};
					} else {};
				} else {};
			};
		};
		return null;
	}

	public function getMetadataFirstPosition(name:String) {
		var entry = this.findMetadata(name);
		return if (entry != null) entry.pos else null;
	}
}