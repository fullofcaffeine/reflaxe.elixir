@:coreApi
class haxe.format.JsonPrinter {

	public function new(replacer:Null<(key : Dynamic, value : Dynamic) -> Dynamic> = null, space:Null<String> = null) {
		this.replacer = replacer;
		this.space = space;
	}

	var replacer:Null<(key : Dynamic, value : Dynamic) -> Dynamic>;

	var space:Null<String>;

	function writeValue(v:Dynamic, key:String) {
		if (this.replacer != null) {
			v = this.replacer(key, v);
		};
		if (v == null) {
			return "null";
		};
		if (Std.isOfType(v, Bool)) {
			return if (v) {
				"true";
			} else {
				"false";
			};
		};
		if (Std.isOfType(v, Int)) {
			return Std.string(v);
		};
		if (Std.isOfType(v, Float)) {
			var s = Std.string(v);
			if (s == "NaN" || s == "Infinity" || s == "-Infinity") {
				return "null";
			};
			return s;
		};
		if (Std.isOfType(v, String)) {
			return this.quoteString(v);
		};
		if (Std.isOfType(v, Array)) {
			return this.writeArray(v);
		};
		return this.writeObject(v);
	}

	function writeArray(arr:Array<Dynamic>) {
		var items = [];
		{
			var ` = 0;
			var ` = arr.length;
			while (` < `) {
				var i = ` ++;
				items.push(this.writeValue(arr[i], Std.string(i)));
			};
		};
		if (this.space != null && items.length > 0) {
			return "[\n  " + items.join(",\n  ") + "\n]";
		} else {
			return "[" + items.join(",") + "]";
		};
	}

	function writeObject(obj:Dynamic) {
		var fields = Reflect.fields(obj);
		var pairs = [];
		{
			var ` = 0;
			while (` < fields.length) {
				var field = fields[`];
				++ `;
				var value = Reflect.field(obj, field);
				var key = this.quoteString(field);
				var val = this.writeValue(value, field);
				if (this.space != null) {
					pairs.push(key + ": " + val);
				} else {
					pairs.push(key + ":" + val);
				};
			};
		};
		if (this.space != null && pairs.length > 0) {
			return "{\n  " + pairs.join(",\n  ") + "\n}";
		} else {
			return "{" + pairs.join(",") + "}";
		};
	}

	function quoteString(s:String) {
		var result = "\"";
		{
			var ` = 0;
			var ` = s.length;
			while (` < `) {
				var i = ` ++;
				var c = s.charCodeAt(i);
				@:ast(switch (c) {
	case 0x22:
		result += "\\\"";	
	case 0x5C:
		result += "\\\\";	
	case 0x08:
		result += "\\b";	
	case 0x0C:
		result += "\\f";	
	case 0x0A:
		result += "\\n";	
	case 0x0D:
		result += "\\r";	
	case 0x09:
		result += "\\t";	
	default:
		if (c < 0x20) {
			var hex = StringTools.hex(c, 4);
			result += "\\u" + hex;
		} else {
			result += s.charAt(i);
		};	
}) if (c == null) {
					if (c < 32) {
						var hex = StringTools.hex(c, 4);
						result += "\\u" + hex;
					} else {
						result += s.charAt(i);
					};
				} else switch (c) {
					case 8: {
						{
							result += "\\b";
						};
					};
					case 9: {
						{
							result += "\\t";
						};
					};
					case 10: {
						{
							result += "\\n";
						};
					};
					case 12: {
						{
							result += "\\f";
						};
					};
					case 13: {
						{
							result += "\\r";
						};
					};
					case 34: {
						{
							result += "\\\"";
						};
					};
					case 92: {
						{
							result += "\\\\";
						};
					};
					default: {
						if (c < 32) {
							var hex = StringTools.hex(c, 4);
							result += "\\u" + hex;
						} else {
							result += s.charAt(i);
						};
					}
				};
			};
		};
		result += "\"";
		return result;
	}

	public function write(k:String, v:Dynamic) {
		return this.writeValue(v, k);
	}

	public static function print(o:Dynamic, replacer:Null<(key : Dynamic, value : Dynamic) -> Dynamic> = null, space:Null<String> = null) {
		var printer = new haxe.format.JsonPrinter(replacer, space);
		return printer.writeValue(o, "");
	}
}