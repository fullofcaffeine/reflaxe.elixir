class reflaxe.helpers.NullableMetaAccessHelper {

	public static function maybeHas(m:Null<haxe.macro.MetaAccess>, name:String) {
		return m != null && m.has != null && m.has(name);
	}

	public static function maybeExtract(m:Null<haxe.macro.MetaAccess>, name:String) {
		if (m == null || m.extract == null) {
			return [];
		};
		return m.extract(name);
	}

	public static function maybeGet(m:Null<haxe.macro.MetaAccess>) {
		if (m == null || m.extract == null) {
			return [];
		};
		return m.get();
	}

	public static function maybeAdd(m:Null<haxe.macro.MetaAccess>, name:String, params:Array<haxe.macro.Expr>, pos:haxe.macro.Position) {
		if (m != null && m.add != null) {
			m.add(name, params, pos);
		};
	}

	public static function getFirstPosition(m:Null<haxe.macro.MetaAccess>, name:String) {
		var entries = reflaxe.helpers.NullableMetaAccessHelper.maybeExtract(m, name);
		return if (entries.length > 0) {
			entries[0].pos;
		} else {
			null;
		};
	}

	@:value({ allowMultiParam : true })
	public static function extractNativeMeta(metaAccess:Null<haxe.macro.MetaAccess>, allowMultiParam:Bool = true) {
		if (metaAccess == null || metaAccess.extract == null) {
			return null;
		};
		var result = [];
		var meta = metaAccess.extract(":meta");
		{
			var ` = 0;
			while (` < meta.length) {
				var m = meta[`];
				++ `;
				if (m.params == null || m.params.length == 0) {
					haxe.macro.Context.error("Native meta expression expected as parameter.", m.pos, null);
					return null;
				};
				if (! allowMultiParam && m.params.length > 1) {
					haxe.macro.Context.error("Only one expression should be supplied for native meta.", m.pos, null);
					return null;
				};
				{
					var ` = 0;
					var ` = m.params;
					while (` < `.length) {
						var param = `[`];
						++ `;
						result.push(haxe.macro.ExprTools.toString(param));
					};
				};
			};
		};
		return result;
	}

	public static function extractExpressionsFromFirstMeta(metaAccess:Null<haxe.macro.MetaAccess>, metaName:String) {
		if (metaAccess != null) {
			var entries = metaAccess.extract(metaName);
			if (entries.length > 0) {
				return entries[0].params;
			};
		};
		return null;
	}

	@:value({ index : 0 })
	public static function extractStringFromFirstMeta(metaAccess:Null<haxe.macro.MetaAccess>, metaName:String, index:Int = 0) {
		var result = reflaxe.helpers.NullableMetaAccessHelper.extractPrimtiveFromFirstMeta(metaAccess, metaName, index);
		return if (result != null && reflaxe.helpers.DynamicHelper.isString(result)) {
			result;
		} else {
			null;
		};
	}

	@:value({ index : 0 })
	public static function extractPrimtiveFromFirstMeta(metaAccess:Null<haxe.macro.MetaAccess>, metaName:String, index:Int = 0) {
		if (metaAccess == null) {
			return null;
		};
		var metaList = reflaxe.helpers.NullableMetaAccessHelper.maybeExtract(metaAccess, metaName);
		{
			var ` = 0;
			while (` < metaList.length) {
				var m = metaList[`];
				++ `;
				var result = reflaxe.helpers.NullableMetaAccessHelper.extractPrimitiveFromEntry(m, index);
				if (result != null) {
					return result;
				};
			};
		};
		return null;
	}

	@:value({ index : 0 })
	public static function extractStringFromAllMeta(metaAccess:Null<haxe.macro.MetaAccess>, metaName:String, index:Int = 0) {
		var primitives = reflaxe.helpers.NullableMetaAccessHelper.extractPrimtiveFromAllMeta(metaAccess, metaName, index);
		var result = [];
		{
			var ` = 0;
			while (` < primitives.length) {
				var obj = primitives[`];
				++ `;
				if (obj != null && reflaxe.helpers.DynamicHelper.isString(obj)) {
					result.push(obj);
				};
			};
		};
		return result;
	}

	@:value({ index : 0 })
	public static function extractPrimtiveFromAllMeta(metaAccess:Null<haxe.macro.MetaAccess>, metaName:String, index:Int = 0) {
		if (metaAccess == null) {
			return [];
		};
		var result = [];
		var metaList = reflaxe.helpers.NullableMetaAccessHelper.maybeExtract(metaAccess, metaName);
		{
			var ` = 0;
			while (` < metaList.length) {
				var m = metaList[`];
				++ `;
				var prim = reflaxe.helpers.NullableMetaAccessHelper.extractPrimitiveFromEntry(m, index);
				if (prim != null) {
					result.push(prim);
				};
			};
		};
		return result;
	}

	public static function extractParamsFromFirstMeta(metaAccess:Null<haxe.macro.MetaAccess>, metaName:String) {
		if (metaAccess == null) {
			return null;
		};
		var metaList = reflaxe.helpers.NullableMetaAccessHelper.maybeExtract(metaAccess, metaName);
		if (metaList.length > 0) {
			var result = [];
			var m = metaList[0];
			if (m.params != null) {
				{
					var ` = 0;
					var ` = m.params.length;
					while (` < `) {
						var i = ` ++;
						result.push(reflaxe.helpers.NullableMetaAccessHelper.extractPrimitiveFromEntry(m, i));
					};
				};
			};
			return result;
		};
		return null;
	}

	public static function extractParamsFromAllMeta(metaAccess:Null<haxe.macro.MetaAccess>, metaName:String) {
		if (metaAccess == null) {
			return [];
		};
		var metaList = reflaxe.helpers.NullableMetaAccessHelper.maybeExtract(metaAccess, metaName);
		var result = [];
		{
			var ` = 0;
			while (` < metaList.length) {
				var m = metaList[`];
				++ `;
				var params = [];
				if (m.params != null) {
					{
						var ` = 0;
						var ` = m.params.length;
						while (` < `) {
							var i = ` ++;
							var prim = reflaxe.helpers.NullableMetaAccessHelper.extractPrimitiveFromEntry(m, i);
							if (prim != null) {
								params.push(prim);
							};
						};
					};
				};
				result.push(params);
			};
		};
		return result;
	}

	@:value({ index : 0 })
	static function extractPrimitiveFromEntry(entry:haxe.macro.MetadataEntry, index:Int = 0) {
		if (entry.params == null) {
			return null;
		};
		return if (entry.params.length > index) {
			@:ast(switch (entry.params[index].expr) {
	case EConst(CInt(v)):
		Std.string(v);	
	case EConst(CFloat(f)):
		Std.string(f);	
	case EConst(CString(s, _)):
		s;	
	case EConst(CIdent(s)):
		{
			if (s == "true") true else if (s == "false") false else s;
		};	
	case EConst(CRegexp(r, opt)):
		"/" + r + "/" + opt;	
	case _:
		null;	
}) {
				var ` = entry.params[index].expr;
				if (enumIndex ` == 0) {
					var ` = `[0];
					switch (@:exhaustive enumIndex `) {
						case 0: {
							var ` = `[0];
							var ` = `[1];
							{
								var v = `;
								{
									Std.string(v);
								};
							};
						};
						case 1: {
							var ` = `[0];
							var ` = `[1];
							{
								var f = `;
								{
									Std.string(f);
								};
							};
						};
						case 2: {
							var ` = `[0];
							var ` = `[1];
							{
								var s = `;
								{
									s;
								};
							};
						};
						case 3: {
							var ` = `[0];
							{
								var s = `;
								{
									{
										if (s == "true") {
											true;
										} else {
											if (s == "false") {
												false;
											} else {
												s;
											};
										};
									};
								};
							};
						};
						case 4: {
							var ` = `[0];
							var ` = `[1];
							{
								var r = `;
								var opt = `;
								{
									"/" + r + "/" + opt;
								};
							};
						};
					};
				} else {
					null;
				};
			};
		} else {
			null;
		};
	}

	@:value({ index : 0 })
	static function extractIdentifierFromEntry(entry:haxe.macro.MetadataEntry, index:Int = 0) {
		if (entry.params == null) {
			return null;
		};
		return if (entry.params.length > index) {
			@:ast(switch (entry.params[index].expr) {
	case EConst(CIdent(s)):
		s;	
	case _:
		null;	
}) {
				var ` = entry.params[index].expr;
				if (enumIndex ` == 0) {
					var ` = `[0];
					if (enumIndex ` == 3) {
						var ` = `[0];
						{
							var s = `;
							{
								s;
							};
						};
					} else {
						null;
					};
				} else {
					null;
				};
			};
		} else {
			null;
		};
	}

	@:value({ index : 0 })
	public static function extractIdentifierFromFirstMeta(metaAccess:Null<haxe.macro.MetaAccess>, metaName:String, index:Int = 0) {
		if (metaAccess == null) {
			return null;
		};
		var metaList = reflaxe.helpers.NullableMetaAccessHelper.maybeExtract(metaAccess, metaName);
		{
			var ` = 0;
			while (` < metaList.length) {
				var m = metaList[`];
				++ `;
				var result = reflaxe.helpers.NullableMetaAccessHelper.extractIdentifierFromEntry(m, index);
				if (result != null) {
					return result;
				};
			};
		};
		return null;
	}
}