class reflaxe.preprocessors.implementations.PreventRepeatVariablesImpl {

	@:value({ initVarNames : null, parent : null })
	public function new(expr:haxe.macro.TypedExpr, parent:Null<reflaxe.preprocessors.implementations.PreventRepeatVariablesImpl> = null, initVarNames:Null<Array<String>> = null) {
		this.expr = expr;
		this.parent = parent;
		this.exprList = @:ast(switch (expr.expr) {
	case TBlock(exprs):
		exprs.map(function(e) ->  @:implicitReturn return e.copy());	
	case _:
		[expr.copy()];	
}) {
			var ` = expr.expr;
			if (enumIndex ` == 14) {
				var ` = `[0];
				{
					var exprs = `;
					{
						{
							var ` = [];
							{
								var ` = 0;
								var ` = exprs;
								while (` < `.length) {
									var v = `[`];
									++ `;
									`.push(function(e:haxe.macro.TypedExpr) {
										return reflaxe.helpers.TypedExprHelper.copy(e, null);
									}(v));
								};
							};
							`;
						};
					};
				};
			} else {
				[reflaxe.helpers.TypedExprHelper.copy(expr, null)];
			};
		};
		this.varNames = {
			{};
			new haxe.ds.StringMap();
		};
		if (initVarNames != null) {
			{
				var ` = 0;
				while (` < initVarNames.length) {
					var name = initVarNames[`];
					++ `;
					{
						var this = this.varNames;
						cast this.set(name, true);
					};
				};
			};
		};
		this.varReplacements = {
			{};
			new haxe.ds.IntMap();
		};
	}

	var expr:haxe.macro.TypedExpr;

	var exprList:Array<haxe.macro.TypedExpr>;

	var parent:Null<reflaxe.preprocessors.implementations.PreventRepeatVariablesImpl>;

	var varNames:Map<String, Bool>;

	var varReplacements:Map<Int, haxe.macro.TVar>;

	public function registerVarReplacement(newName:String, previousTVar:haxe.macro.TVar) {
		{
			var this = this.varReplacements;
			var key = previousTVar.id;
			var value = reflaxe.helpers.TVarHelper.copy(previousTVar, newName);
			cast this.set(key, value);
		};
		{
			var this = this.varNames;
			cast this.set(newName, true);
		};
	}

	public function fixRepeatVariables() {
		var result = [];
		{
			var ` = 0;
			var ` = this.exprList;
			while (` < `.length) {
				var expr = `[`];
				++ `;
				@:ast(switch (expr.expr) {
	case TVar(tvar, maybeExpr):
		{
			var name = tvar.name;
			while (varExists(name)) {
				var regex = ~/[\w\d_]+(\d+)/;
				if (regex.match(name)) {
					var m = regex.matched(1);
					var num = Std.parseInt(m);
					if (num != null) {
						name = name.substring(0, name.length - m.length) + (num + 1);
					};
				} else {
					name += "2";
				};
			};
			varNames.set(name, true);
			if (name != tvar.name) {
				var copyTVar = tvar.copy(name);
				varReplacements.set(copyTVar.id, copyTVar);
				var modifiedExpr = maybeExpr != null ? handleExpression(maybeExpr) : null;
				var temp = expr.copy(TVar(copyTVar, modifiedExpr));
				result.push(temp);
				continue;
			} else {
				result.push(handleExpression(expr));
			};
		};	
	case TBlock(_):
		{
			result.push(handleBlock(expr));
			continue;
		};	
	case _:
		{
			result.push(handleExpression(expr));
		};	
}) {
					var ` = expr.expr;
					switch (enumIndex `) {
						case 13: {
							var ` = `[0];
							var ` = `[1];
							{
								var tvar = `;
								var maybeExpr = `;
								{
									{
										var name = tvar.name;
										while (this.varExists(name)) {
											var regex = new EReg("[\\w\\d_]+(\\d+)", "i");
											if (regex.match(name)) {
												var m = regex.matched(1);
												var num = Std.parseInt(m);
												if (num != null) {
													name = name.substring(0, name.length - m.length) + (num + 1);
												};
											} else {
												name += "2";
											};
										};
										{
											var this = this.varNames;
											cast this.set(name, true);
										};
										if (name != tvar.name) {
											var copyTVar = reflaxe.helpers.TVarHelper.copy(tvar, name);
											{
												var this = this.varReplacements;
												var key = copyTVar.id;
												cast this.set(key, copyTVar);
											};
											var modifiedExpr = if (maybeExpr != null) {
												this.handleExpression(maybeExpr);
											} else {
												null;
											};
											var temp = reflaxe.helpers.TypedExprHelper.copy(expr, haxe.macro.TypedExprDef.TVar(copyTVar, modifiedExpr));
											result.push(temp);
											continue;
										} else {
											result.push(this.handleExpression(expr));
										};
									};
								};
							};
						};
						case 14: {
							var ` = `[0];
							{
								{
									result.push(this.handleBlock(expr));
									continue;
								};
							};
						};
						default: {
							{
								result.push(this.handleExpression(expr));
							};
						}
					};
				};
			};
		};
		return reflaxe.helpers.TypedExprHelper.copy(this.expr, haxe.macro.TypedExprDef.TBlock(result));
	}

	function handleExpression(expr:haxe.macro.TypedExpr) {
		@:ast(switch (expr.expr) {
	case TBlock(_):
		{
			return handleBlock(expr);
		};	
	case TLocal(tvar):
		{
			var replacement = varReplacement(tvar.id);
			if (replacement != null) {
				return expr.copy(TLocal(replacement));
			};
		};	
	case _:
}) {
			var ` = expr.expr;
			switch (enumIndex `) {
				case 1: {
					var ` = `[0];
					{
						var tvar = `;
						{
							{
								var replacement = this.varReplacement(tvar.id);
								if (replacement != null) {
									return reflaxe.helpers.TypedExprHelper.copy(expr, haxe.macro.TypedExprDef.TLocal(replacement));
								};
							};
						};
					};
				};
				case 14: {
					var ` = `[0];
					{
						{
							return this.handleBlock(expr);
						};
					};
				};
				default: {}
			};
		};
		return haxe.macro.TypedExprTools.map(expr, this.handleExpression);
	}

	function handleBlock(subExpr:haxe.macro.TypedExpr) {
		var rvf = new reflaxe.preprocessors.implementations.PreventRepeatVariablesImpl(subExpr, this, null);
		return rvf.fixRepeatVariables();
	}

	function varExists(name:String) {
		return if ({
			var this = this.varNames;
			cast this.exists(name);
		}) {
			true;
		} else {
			if (this.parent != null) {
				this.parent.varExists(name);
			} else {
				false;
			};
		};
	}

	function varReplacement(id:Int) {
		return if ({
			var this = this.varReplacements;
			cast this.exists(id);
		}) {
			{
				var this = this.varReplacements;
				cast this.get(id);
			};
		} else {
			if (this.parent != null) {
				this.parent.varReplacement(id);
			} else {
				null;
			};
		};
	}
}