class reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms {

	public static function pass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EModule(name, attrs, body) if (isController(name)):
		var out = [for (b  in  body) cleanseDefs(b)];
		makeASTWithMeta(EModule(name, attrs, out), n.metadata, n.pos);	
	case EDefmodule(name2, doBlock) if (isController(name2)):
		makeASTWithMeta(EDefmodule(name2, cleanseDefs(doBlock)), n.metadata, n.pos);	
	case ECase(expr, clauses):
		var newClauses = [];
		for (cl  in  clauses) {
			var cleanedBody = cleanseBody(cl.body);
			var binder:Null<String> = null;
			switch (cl.pattern) {
				case PTuple(es) if (es.length == 2):
					switch (es[1]) {
						case PVar(nm):
							binder = nm;						
						default:
					};				
				default:
			};
			var newPattern = maybeRenameBinderFromBodyMapKeys(cl.pattern, cleanedBody);
			var effectiveBinder:Null<String> = switch (newPattern) {
				case PTuple(es2) if (es2.length == 2):
					switch (es2[1]) {
						case PVar(nn):
							nn;						
						default:
							null;						
					};				
				default:
					binder;				
			};
			var finalBody = cleanedBody;
			if (effectiveBinder != null) {
				finalBody = mapUndefinedVarsToBinder(finalBody, effectiveBinder, defaultControllerEnv());
			};
			finalBody = cleanseAliasInBody(finalBody);
			var cleaned = { pattern : newPattern, guard : cl.guard, body : finalBody };
			newClauses.push(cleaned);
		};
		makeASTWithMeta(ECase(expr, newClauses), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 0: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var name = `;
							var attrs = `;
							var body = `;
							if (name != null && name.indexOf("Web.", null) > 0 && StringTools.endsWith(name, "Controller")) {
								var out = {
									var ` = [];
									{
										var ` = 0;
										while (` < body.length) {
											var b = body[`];
											++ `;
											`.push(reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.cleanseDefs(b));
										};
									};
									`;
								};
								{def : reflaxe.elixir.ast.ElixirASTDef.EModule(name, attrs, out), metadata : n.metadata, pos : n.pos};
							} else {
								n;
							};
						};
					};
					case 1: {
						var ` = `[0];
						var ` = `[1];
						{
							var name2 = `;
							var doBlock = `;
							if (name2 != null && name2.indexOf("Web.", null) > 0 && StringTools.endsWith(name2, "Controller")) {
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EDefmodule(name2, reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.cleanseDefs(doBlock));
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							} else {
								n;
							};
						};
					};
					case 6: {
						var ` = `[0];
						var ` = `[1];
						{
							var expr = `;
							var clauses = `;
							{
								var newClauses = [];
								{
									var ` = 0;
									while (` < clauses.length) {
										var cl = clauses[`];
										++ `;
										var cleanedBody = reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.cleanseBody(cl.body);
										var binder = null;
										@:ast(switch (cl.pattern) {
	case PTuple(es) if (es.length == 2):
		switch (es[1]) {
			case PVar(nm):
				binder = nm;			
			default:
		};	
	default:
}) {
											var ` = cl.pattern;
											if (enumIndex ` == 2) {
												var ` = `[0];
												{
													var es = `;
													if (es.length == 2) {
														@:ast(switch (es[1]) {
	case PVar(nm):
		binder = nm;	
	default:
}) {
															var ` = es[1];
															if (enumIndex ` == 0) {
																var ` = `[0];
																{
																	var nm = `;
																	{
																		binder = nm;
																	};
																};
															} else {};
														};
													} else {};
												};
											} else {};
										};
										var newPattern = reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.maybeRenameBinderFromBodyMapKeys(cl.pattern, cleanedBody);
										var effectiveBinder = @:ast(switch (newPattern) {
	case PTuple(es2) if (es2.length == 2):
		switch (es2[1]) {
			case PVar(nn):
				nn;			
			default:
				null;			
		};	
	default:
		binder;	
}) if (enumIndex newPattern == 2) {
											var ` = newPattern[0];
											{
												var es2 = `;
												if (es2.length == 2) {
													@:ast(switch (es2[1]) {
	case PVar(nn):
		nn;	
	default:
		null;	
}) {
														var ` = es2[1];
														if (enumIndex ` == 0) {
															var ` = `[0];
															{
																var nn = `;
																{
																	nn;
																};
															};
														} else {
															null;
														};
													};
												} else {
													binder;
												};
											};
										} else {
											binder;
										};
										var finalBody = cleanedBody;
										if (effectiveBinder != null) {
											finalBody = reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.mapUndefinedVarsToBinder(finalBody, effectiveBinder, {
												var m = {
													{};
													new haxe.ds.StringMap();
												};
												{
													m.set("conn", true);
												};
												{
													m.set("params", true);
												};
												{
													m.set("socket", true);
												};
												{
													m.set("live_socket", true);
												};
												{
													m.set("liveSocket", true);
												};
												m;
											});
										};
										finalBody = reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.cleanseAliasInBody(finalBody);
										var cleaned = {pattern : newPattern, guard : cl.guard, body : finalBody};
										newClauses.push(cleaned);
									};
								};
								{def : reflaxe.elixir.ast.ElixirASTDef.ECase(expr, newClauses), metadata : n.metadata, pos : n.pos};
							};
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}

	static inline function isController(name:String) {
		return name != null && name.indexOf("Web.", null) > 0 && StringTools.endsWith(name, "Controller");
	}

	static function cleanseDefs(node:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(node, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EDef(fn, args, guards, body):
		makeASTWithMeta(EDef(fn, args, guards, cleanseBody(body)), n.metadata, n.pos);	
	case EDefp(fn2, args2, guards2, body2):
		makeASTWithMeta(EDefp(fn2, args2, guards2, cleanseBody(body2)), n.metadata, n.pos);	
	case ECase(expr, clauses):
		var newClauses = [];
		for (cl  in  clauses) {
			var cleanedBody = cleanseBody(cl.body);
			var newPat = maybeRenameBinderFromBodyMapKeys(cl.pattern, cleanedBody);
			var effBinder:Null<String> = switch (newPat) {
				case PTuple(es) if (es.length == 2):
					switch (es[1]) {
						case PVar(n):
							n;						
						default:
							null;						
					};				
				default:
					null;				
			};
			var finalBody = cleanedBody;
			if (effBinder != null) {
				finalBody = mapUndefinedVarsToBinder(finalBody, effBinder, defaultControllerEnv());
			};
			finalBody = cleanseAliasInBody(finalBody);
			newClauses.push({ pattern : newPat, guard : cl.guard, body : finalBody });
		};
		makeASTWithMeta(ECase(expr, newClauses), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 2: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var fn = `;
							var args = `;
							var guards = `;
							var body = `;
							{
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EDef(fn, args, guards, reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.cleanseBody(body));
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							};
						};
					};
					case 3: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var fn2 = `;
							var args2 = `;
							var guards2 = `;
							var body2 = `;
							{
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EDefp(fn2, args2, guards2, reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.cleanseBody(body2));
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							};
						};
					};
					case 6: {
						var ` = `[0];
						var ` = `[1];
						{
							var expr = `;
							var clauses = `;
							{
								var newClauses = [];
								{
									var ` = 0;
									while (` < clauses.length) {
										var cl = clauses[`];
										++ `;
										var cleanedBody = reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.cleanseBody(cl.body);
										var newPat = reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.maybeRenameBinderFromBodyMapKeys(cl.pattern, cleanedBody);
										var effBinder = @:ast(switch (newPat) {
	case PTuple(es) if (es.length == 2):
		switch (es[1]) {
			case PVar(n):
				n;			
			default:
				null;			
		};	
	default:
		null;	
}) if (enumIndex newPat == 2) {
											var ` = newPat[0];
											{
												var es = `;
												if (es.length == 2) {
													@:ast(switch (es[1]) {
	case PVar(n):
		n;	
	default:
		null;	
}) {
														var ` = es[1];
														if (enumIndex ` == 0) {
															var ` = `[0];
															{
																var n = `;
																{
																	n;
																};
															};
														} else {
															null;
														};
													};
												} else {
													null;
												};
											};
										} else {
											null;
										};
										var finalBody = cleanedBody;
										if (effBinder != null) {
											finalBody = reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.mapUndefinedVarsToBinder(finalBody, effBinder, {
												var m = {
													{};
													new haxe.ds.StringMap();
												};
												{
													m.set("conn", true);
												};
												{
													m.set("params", true);
												};
												{
													m.set("socket", true);
												};
												{
													m.set("live_socket", true);
												};
												{
													m.set("liveSocket", true);
												};
												m;
											});
										};
										finalBody = reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.cleanseAliasInBody(finalBody);
										newClauses.push({pattern : newPat, guard : cl.guard, body : finalBody});
									};
								};
								{def : reflaxe.elixir.ast.ElixirASTDef.ECase(expr, newClauses), metadata : n.metadata, pos : n.pos};
							};
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}

	static function cleanseBody(b:reflaxe.elixir.ast.ElixirAST) {
		return @:ast(switch (b.def) {
	case EBlock(stmts):
		makeASTWithMeta(EBlock(rewrite(stmts)), b.metadata, b.pos);	
	case EDo(stmts2):
		makeASTWithMeta(EDo(rewrite(stmts2)), b.metadata, b.pos);	
	default:
		b;	
}) {
			var ` = b.def;
			switch (enumIndex `) {
				case 53: {
					var ` = `[0];
					{
						var stmts = `;
						{
							{
								var def = reflaxe.elixir.ast.ElixirASTDef.EBlock(reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.rewrite(stmts));
								var meta = b.metadata;
								var pos = b.pos;
								{def : def, metadata : meta, pos : pos};
							};
						};
					};
				};
				case 55: {
					var ` = `[0];
					{
						var stmts2 = `;
						{
							{
								var def = reflaxe.elixir.ast.ElixirASTDef.EDo(reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.rewrite(stmts2));
								var meta = b.metadata;
								var pos = b.pos;
								{def : def, metadata : meta, pos : pos};
							};
						};
					};
				};
				default: {
					b;
				}
			};
		};
	}

	static inline function defaultControllerEnv() {
		var m = {
			{};
			new haxe.ds.StringMap();
		};
		{
			m.set("conn", true);
		};
		{
			m.set("params", true);
		};
		{
			m.set("socket", true);
		};
		{
			m.set("live_socket", true);
		};
		{
			m.set("liveSocket", true);
		};
		return m;
	}

	static inline function isOkAtom(ast:reflaxe.elixir.ast.ElixirAST) {
		return @:ast(switch (ast.def) {
	case EAtom(v):
		v == ":ok" || v == "ok";	
	default:
		false;	
}) {
			var ` = ast.def;
			if (enumIndex ` == 31) {
				var ` = `[0];
				{
					var v = `;
					{
						v == ":ok" || v == "ok";
					};
				};
			} else {
				false;
			};
		};
	}

	static function maybeRenameBinderFromBodyMapKeys(pat:reflaxe.elixir.ast.EPattern, body:reflaxe.elixir.ast.ElixirAST) {
		var binder = null;
		var headOk = false;
		@:ast(switch (pat) {
	case PTuple(es) if (es.length == 2):
		switch (es[0]) {
			case PLiteral(l) if (isOkAtom(l)):
				headOk = true;			
			default:
		};
		switch (es[1]) {
			case PVar(nm):
				binder = nm;			
			default:
		};	
	default:
}) if (enumIndex pat == 2) {
			var ` = pat[0];
			{
				var es = `;
				if (es.length == 2) {
					@:ast(switch (es[0]) {
	case PLiteral(l) if (isOkAtom(l)):
		headOk = true;	
	default:
}) {
						var ` = es[0];
						if (enumIndex ` == 1) {
							var ` = `[0];
							{
								var l = `;
								if (@:ast(switch (ast.def) {
	case EAtom(v):
		v == ":ok" || v == "ok";	
	default:
		false;	
}) {
									var ` = l.def;
									if (enumIndex ` == 31) {
										var ` = `[0];
										{
											var v = `;
											{
												v == ":ok" || v == "ok";
											};
										};
									} else {
										false;
									};
								}) {
									headOk = true;
								} else {};
							};
						} else {};
					};
					@:ast(switch (es[1]) {
	case PVar(nm):
		binder = nm;	
	default:
}) {
						var ` = es[1];
						if (enumIndex ` == 0) {
							var ` = `[0];
							{
								var nm = `;
								{
									binder = nm;
								};
							};
						} else {};
					};
				} else {};
			};
		} else {};
		if (! headOk || binder == null) {
			return pat;
		};
		var undefInMap = {
			{};
			new haxe.ds.StringMap();
		};
		var declared = {
			{};
			new haxe.ds.StringMap();
		};
		reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.collectPatternDecls(pat, declared);
		reflaxe.elixir.ast.ASTUtils.walk(body, function(x:reflaxe.elixir.ast.ElixirAST) {
			@:ast(switch (x.def) {
	case EMatch(p, _):
		collectPatternDecls(p, declared);	
	case EBinary(Match, l, _):
		collectLhs(l, declared);	
	default:
}) {
				var ` = x.def;
				switch (enumIndex `) {
					case 8: {
						var ` = `[0];
						var ` = `[1];
						{
							var p = `;
							{
								reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.collectPatternDecls(p, declared);
							};
						};
					};
					case 26: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						if (enumIndex ` == 27) {
							{
								var l = `;
								{
									reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.collectLhs(l, declared);
								};
							};
						} else {};
					};
					default: {}
				};
			};
		});
		{
			declared.set("socket", true);
		};
		{
			declared.set("live_socket", true);
		};
		{
			declared.set("liveSocket", true);
		};
		{
			declared.set("conn", true);
		};
		{
			declared.set("params", true);
		};
		reflaxe.elixir.ast.ElixirASTTransformer.transformNode(body, function(n:reflaxe.elixir.ast.ElixirAST) {
			@:ast(switch (n.def) {
	case ERemoteCall(target, fnName, args) if (fnName == "json" && args != null && args.length == 2):
		switch (args[1].def) {
			case EMap(pairs):
				for (p  in  pairs) switch (p.value.def) {
					case EVar(vn):
						if (!declared.exists(vn)) undefInMap.set(vn, true);					
					default:
				};			
			default:
		};	
	default:
}) {
				var ` = n.def;
				if (enumIndex ` == 24) {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					{
						var target = `;
						var fnName = `;
						var args = `;
						if (fnName == "json" && args != null && args.length == 2) {
							@:ast(switch (args[1].def) {
	case EMap(pairs):
		for (p  in  pairs) switch (p.value.def) {
			case EVar(vn):
				if (!declared.exists(vn)) undefInMap.set(vn, true);			
			default:
		};	
	default:
}) {
								var ` = args[1].def;
								if (enumIndex ` == 17) {
									var ` = `[0];
									{
										var pairs = `;
										{
											{
												var ` = 0;
												while (` < pairs.length) {
													var p = pairs[`];
													++ `;
													@:ast(switch (p.value.def) {
	case EVar(vn):
		if (!declared.exists(vn)) undefInMap.set(vn, true);	
	default:
}) {
														var ` = p.value.def;
														if (enumIndex ` == 38) {
															var ` = `[0];
															{
																var vn = `;
																{
																	if (! declared.exists(vn)) {
																		{
																			undefInMap.set(vn, true);
																		};
																	};
																};
															};
														} else {};
													};
												};
											};
										};
									};
								} else {};
							};
						} else {};
					};
				} else {};
			};
			return n;
		});
		var want = null;
		var cnt = 0;
		for (k in undefInMap.keys()) {
			want = k;
			cnt ++;
		};
		if (cnt != 1) {
			want = null;
		};
		if (want != null && binder != want) {
			return @:ast(switch (pat) {
	case PTuple(es) if (es.length == 2):
		PTuple([es[0], PVar(want)]);	
	default:
		pat;	
}) if (enumIndex pat == 2) {
				var ` = pat[0];
				{
					var es = `;
					if (es.length == 2) {
						reflaxe.elixir.ast.EPattern.PTuple([es[0], reflaxe.elixir.ast.EPattern.PVar(want)]);
					} else {
						pat;
					};
				};
			} else {
				pat;
			};
		};
		return pat;
	}

	static function mapUndefinedVarsToBinder(body:reflaxe.elixir.ast.ElixirAST, binder:String, env:Map<String, Bool>) {
		var declared = {
			{};
			new haxe.ds.StringMap();
		};
		reflaxe.elixir.ast.ASTUtils.walk(body, function(n:reflaxe.elixir.ast.ElixirAST) {
			@:ast(switch (n.def) {
	case EMatch(p, _):
		collectPatternDecls(p, declared);	
	case EBinary(Match, l, _):
		collectLhs(l, declared);	
	case ECase(_, cs):
		for (c  in  cs) collectPatternDecls(c.pattern, declared);	
	default:
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 6: {
						var ` = `[0];
						var ` = `[1];
						{
							var cs = `;
							{
								{
									var ` = 0;
									while (` < cs.length) {
										var c = cs[`];
										++ `;
										reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.collectPatternDecls(c.pattern, declared);
									};
								};
							};
						};
					};
					case 8: {
						var ` = `[0];
						var ` = `[1];
						{
							var p = `;
							{
								reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.collectPatternDecls(p, declared);
							};
						};
					};
					case 26: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						if (enumIndex ` == 27) {
							{
								var l = `;
								{
									reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.collectLhs(l, declared);
								};
							};
						} else {};
					};
					default: {}
				};
			};
		});
		for (k in env.keys()) {
			{
				declared.set(k, true);
			};
		};
		var rewriteUndefinedInMap = function(arg:reflaxe.elixir.ast.ElixirAST, declared:Map<String, Bool>) {
			return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(arg, function(x:reflaxe.elixir.ast.ElixirAST) {
				return @:ast(switch (x.def) {
	case EMap(pairs):
		var npairs:Array<EMapPair> = [];
		for (p  in  pairs) {
			var v2 = p.value;
			switch (p.value.def) {
				case EVar(vname) if (vname != null && vname.length > 0):
					var c = vname.charAt(0);
					if (c.toLowerCase() == c && !declared.exists(vname) && vname != "socket" && vname != "live_socket" && vname != "liveSocket") {
						v2 = makeAST(EVar(binder));
					};				
				default:
			};
			npairs.push({ key : p.key, value : v2 });
		};
		makeASTWithMeta(EMap(npairs), x.metadata, x.pos);	
	default:
		x;	
}) {
					var ` = x.def;
					if (enumIndex ` == 17) {
						var ` = `[0];
						{
							var pairs = `;
							{
								var npairs = [];
								{
									var ` = 0;
									while (` < pairs.length) {
										var p = pairs[`];
										++ `;
										var v2 = p.value;
										@:ast(switch (p.value.def) {
	case EVar(vname) if (vname != null && vname.length > 0):
		var c = vname.charAt(0);
		if (c.toLowerCase() == c && !declared.exists(vname) && vname != "socket" && vname != "live_socket" && vname != "liveSocket") {
			v2 = makeAST(EVar(binder));
		};	
	default:
}) {
											var ` = p.value.def;
											if (enumIndex ` == 38) {
												var ` = `[0];
												{
													var vname = `;
													if (vname != null && vname.length > 0) {
														var c = vname.charAt(0);
														if (c.toLowerCase() == c && ! declared.exists(vname) && vname != "socket" && vname != "live_socket" && vname != "liveSocket") {
															v2 = {
																var pos = null;
																{def : reflaxe.elixir.ast.ElixirASTDef.EVar(binder), metadata : {}, pos : pos};
															};
														};
													} else {};
												};
											} else {};
										};
										npairs.push({key : p.key, value : v2});
									};
								};
								{def : reflaxe.elixir.ast.ElixirASTDef.EMap(npairs), metadata : x.metadata, pos : x.pos};
							};
						};
					} else {
						x;
					};
				};
			});
		};
		var rewriteJsonCall = function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case ERemoteCall(target, fnName, args) if (fnName == "json" && args != null && args.length == 2):
		var newSecond = switch (args[1].def) {
			case EVar(vn) if (vn == "data"):
				makeAST(EVar(binder));			
			default:
				rewriteUndefinedInMap(args[1], declared);			
		};
		makeASTWithMeta(ERemoteCall(target, fnName, [args[0], newSecond]), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				if (enumIndex ` == 24) {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					{
						var target = `;
						var fnName = `;
						var args = `;
						if (fnName == "json" && args != null && args.length == 2) {
							var newSecond = @:ast(switch (args[1].def) {
	case EVar(vn) if (vn == "data"):
		makeAST(EVar(binder));	
	default:
		rewriteUndefinedInMap(args[1], declared);	
}) {
								var ` = args[1].def;
								if (enumIndex ` == 38) {
									var ` = `[0];
									{
										var vn = `;
										if (vn == "data") {
											{
												var pos = null;
												{def : reflaxe.elixir.ast.ElixirASTDef.EVar(binder), metadata : {}, pos : pos};
											};
										} else {
											rewriteUndefinedInMap(args[1], declared);
										};
									};
								} else {
									rewriteUndefinedInMap(args[1], declared);
								};
							};
							{def : reflaxe.elixir.ast.ElixirASTDef.ERemoteCall(target, fnName, [args[0], newSecond]), metadata : n.metadata, pos : n.pos};
						} else {
							n;
						};
					};
				} else {
					n;
				};
			};
		};
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(body, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EVar(v) if (v != null && v.length > 0):
		var c = v.charAt(0);
		if (c.toLowerCase() == c && !declared.exists(v) && v != "socket" && v != "live_socket" && v != "liveSocket") {
			makeASTWithMeta(EVar(binder), n.metadata, n.pos);
		} else n;	
	case ERemoteCall(_, _, _):
		rewriteJsonCall(n);	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 24: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							rewriteJsonCall(n);
						};
					};
					case 38: {
						var ` = `[0];
						{
							var v = `;
							if (v != null && v.length > 0) {
								var c = v.charAt(0);
								if (c.toLowerCase() == c && ! declared.exists(v) && v != "socket" && v != "live_socket" && v != "liveSocket") {
									{def : reflaxe.elixir.ast.ElixirASTDef.EVar(binder), metadata : n.metadata, pos : n.pos};
								} else {
									n;
								};
							} else {
								n;
							};
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}

	static function collectPatternDecls(p:reflaxe.elixir.ast.EPattern, acc:Map<String, Bool>) {
		@:ast(switch (p) {
	case PVar(n):
		acc.set(n, true);	
	case PTuple(es) | PList(es):
		for (e  in  es) collectPatternDecls(e, acc);	
	case PCons(h, t):
		collectPatternDecls(h, acc);
		collectPatternDecls(t, acc);	
	case PMap(kvs):
		for (kv  in  kvs) collectPatternDecls(kv.value, acc);	
	case PStruct(_, fs):
		for (f  in  fs) collectPatternDecls(f.value, acc);	
	case PPin(inner):
		collectPatternDecls(inner, acc);	
	default:
}) switch (enumIndex p) {
			case 0: {
				var ` = p[0];
				{
					var n = `;
					{
						{
							acc.set(n, true);
						};
					};
				};
			};
			case 2: {
				var ` = p[0];
				{
					var es = `;
					{
						{
							var ` = 0;
							while (` < es.length) {
								var e = es[`];
								++ `;
								reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.collectPatternDecls(e, acc);
							};
						};
					};
				};
			};
			case 3: {
				var ` = p[0];
				{
					var es = `;
					{
						{
							var ` = 0;
							while (` < es.length) {
								var e = es[`];
								++ `;
								reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.collectPatternDecls(e, acc);
							};
						};
					};
				};
			};
			case 4: {
				var ` = p[0];
				var ` = p[1];
				{
					var h = `;
					var t = `;
					{
						reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.collectPatternDecls(h, acc);
						reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.collectPatternDecls(t, acc);
					};
				};
			};
			case 5: {
				var ` = p[0];
				{
					var kvs = `;
					{
						{
							var ` = 0;
							while (` < kvs.length) {
								var kv = kvs[`];
								++ `;
								reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.collectPatternDecls(kv.value, acc);
							};
						};
					};
				};
			};
			case 6: {
				var ` = p[0];
				var ` = p[1];
				{
					var fs = `;
					{
						{
							var ` = 0;
							while (` < fs.length) {
								var f = fs[`];
								++ `;
								reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.collectPatternDecls(f.value, acc);
							};
						};
					};
				};
			};
			case 7: {
				var ` = p[0];
				{
					var inner = `;
					{
						reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.collectPatternDecls(inner, acc);
					};
				};
			};
			default: {}
		};
	}

	static function collectLhs(lhs:reflaxe.elixir.ast.ElixirAST, acc:Map<String, Bool>) {
		@:ast(switch (lhs.def) {
	case EVar(n):
		acc.set(n, true);	
	case EBinary(Match, l2, r2):
		collectLhs(l2, acc);
		collectLhs(r2, acc);	
	default:
}) {
			var ` = lhs.def;
			switch (enumIndex `) {
				case 26: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					if (enumIndex ` == 27) {
						{
							var l2 = `;
							var r2 = `;
							{
								reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.collectLhs(l2, acc);
								reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.collectLhs(r2, acc);
							};
						};
					} else {};
				};
				case 38: {
					var ` = `[0];
					{
						var n = `;
						{
							{
								acc.set(n, true);
							};
						};
					};
				};
				default: {}
			};
		};
	}

	static function prefixBindUndefinedToBinder(body:reflaxe.elixir.ast.ElixirAST, binder:String) {
		var declared = {
			{};
			new haxe.ds.StringMap();
		};
		reflaxe.elixir.ast.ASTUtils.walk(body, function(n:reflaxe.elixir.ast.ElixirAST) {
			@:ast(switch (n.def) {
	case EMatch(p, _):
		collectPatternDecls(p, declared);	
	case EBinary(Match, l, _):
		collectLhs(l, declared);	
	case ECase(_, cs):
		for (c  in  cs) collectPatternDecls(c.pattern, declared);	
	default:
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 6: {
						var ` = `[0];
						var ` = `[1];
						{
							var cs = `;
							{
								{
									var ` = 0;
									while (` < cs.length) {
										var c = cs[`];
										++ `;
										reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.collectPatternDecls(c.pattern, declared);
									};
								};
							};
						};
					};
					case 8: {
						var ` = `[0];
						var ` = `[1];
						{
							var p = `;
							{
								reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.collectPatternDecls(p, declared);
							};
						};
					};
					case 26: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						if (enumIndex ` == 27) {
							{
								var l = `;
								{
									reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.collectLhs(l, declared);
								};
							};
						} else {};
					};
					default: {}
				};
			};
		});
		{
			declared.set("socket", true);
		};
		{
			declared.set("live_socket", true);
		};
		{
			declared.set("liveSocket", true);
		};
		{
			declared.set("conn", true);
		};
		{
			declared.set("params", true);
		};
		var used = {
			{};
			new haxe.ds.StringMap();
		};
		reflaxe.elixir.ast.ASTUtils.walk(body, function(n:reflaxe.elixir.ast.ElixirAST) {
			@:ast(switch (n.def) {
	case EVar(v):
		used.set(v, true);	
	default:
}) {
				var ` = n.def;
				if (enumIndex ` == 38) {
					var ` = `[0];
					{
						var v = `;
						{
							{
								used.set(v, true);
							};
						};
					};
				} else {};
			};
		});
		var undef = [];
		for (k in used.keys()) {
			if (! declared.exists(k)) {
				var c = k.charAt(0);
				if (c.toLowerCase() == c && k != "socket" && k != "live_socket" && k != "liveSocket" && k != "conn" && k != "params") {
					undef.push(k);
				};
			};
		};
		if (undef.length == 0) {
			return body;
		};
		var assigns = [];
		{
			var ` = 0;
			while (` < undef.length) {
				var u = undef[`];
				++ `;
				assigns.push({
					var pos = null;
					{def : reflaxe.elixir.ast.ElixirASTDef.EMatch(reflaxe.elixir.ast.EPattern.PVar(u), {
						var pos = null;
						{def : reflaxe.elixir.ast.ElixirASTDef.EVar(binder), metadata : {}, pos : pos};
					}), metadata : {}, pos : pos};
				});
			};
		};
		return {
			var def = reflaxe.elixir.ast.ElixirASTDef.EBlock(assigns.concat([body]));
			var pos = null;
			{def : def, metadata : {}, pos : pos};
		};
	}

	static function cleanseAliasInBody(body:reflaxe.elixir.ast.ElixirAST) {
		return @:ast(switch (body.def) {
	case EBlock(stmts):
		makeASTWithMeta(EBlock(filterAlias(stmts)), body.metadata, body.pos);	
	case EDo(stmts):
		makeASTWithMeta(EDo(filterAlias(stmts)), body.metadata, body.pos);	
	default:
		body;	
}) {
			var ` = body.def;
			switch (enumIndex `) {
				case 53: {
					var ` = `[0];
					{
						var stmts = `;
						{
							{
								var def = reflaxe.elixir.ast.ElixirASTDef.EBlock(reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.filterAlias(stmts));
								var meta = body.metadata;
								var pos = body.pos;
								{def : def, metadata : meta, pos : pos};
							};
						};
					};
				};
				case 55: {
					var ` = `[0];
					{
						var stmts = `;
						{
							{
								var def = reflaxe.elixir.ast.ElixirASTDef.EDo(reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.filterAlias(stmts));
								var meta = body.metadata;
								var pos = body.pos;
								{def : def, metadata : meta, pos : pos};
							};
						};
					};
				};
				default: {
					body;
				}
			};
		};
	}

	static function filterAlias(stmts:Array<reflaxe.elixir.ast.ElixirAST>) {
		if (stmts == null) {
			return stmts;
		};
		var out = [];
		{
			var ` = 0;
			while (` < stmts.length) {
				var s = stmts[`];
				++ `;
				if (reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.isAssignTo("json", s) || reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.isAssignTo("data", s) || reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.isAssignTo("conn", s)) {
					var rv = reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.rhsVar(s);
					if (rv != null) {
						continue;
					};
				};
				out.push(s);
			};
		};
		return out;
	}

	static function isAssignTo(name:String, stmt:reflaxe.elixir.ast.ElixirAST) {
		return @:ast(switch (stmt.def) {
	case EBinary(Match, { def : EVar(nm) }, _):
		nm == name;	
	case EMatch(PVar(nm2), _):
		nm2 == name;	
	default:
		false;	
}) {
			var ` = stmt.def;
			switch (enumIndex `) {
				case 8: {
					var ` = `[0];
					var ` = `[1];
					if (enumIndex ` == 0) {
						var ` = `[0];
						{
							var nm2 = `;
							{
								nm2 == name;
							};
						};
					} else {
						false;
					};
				};
				case 26: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					if (enumIndex ` == 27) {
						{
							var ` = `.def;
							var ` = `.metadata;
							var ` = `.pos;
							if (enumIndex ` == 38) {
								var ` = `[0];
								{
									var nm = `;
									{
										nm == name;
									};
								};
							} else {
								false;
							};
						};
					} else {
						false;
					};
				};
				default: {
					false;
				}
			};
		};
	}

	static function rhsVar(stmt:reflaxe.elixir.ast.ElixirAST) {
		return @:ast(switch (stmt.def) {
	case EBinary(Match, _, { def : EVar(v) }):
		v;	
	case EMatch(_, { def : EVar(v2) }):
		v2;	
	default:
		null;	
}) {
			var ` = stmt.def;
			switch (enumIndex `) {
				case 8: {
					var ` = `[0];
					var ` = `[1];
					{
						var ` = `.def;
						var ` = `.metadata;
						var ` = `.pos;
						if (enumIndex ` == 38) {
							var ` = `[0];
							{
								var v2 = `;
								{
									v2;
								};
							};
						} else {
							null;
						};
					};
				};
				case 26: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					if (enumIndex ` == 27) {
						{
							var ` = `.def;
							var ` = `.metadata;
							var ` = `.pos;
							if (enumIndex ` == 38) {
								var ` = `[0];
								{
									var v = `;
									{
										v;
									};
								};
							} else {
								null;
							};
						};
					} else {
						null;
					};
				};
				default: {
					null;
				}
			};
		};
	}

	static function isJsonCall(e:reflaxe.elixir.ast.ElixirAST) {
		return @:ast(switch (e.def) {
	case ERemoteCall(target, fnName, args):
		if (fnName != "json" || args == null || args.length != 2) return false;
		switch (target.def) {
			case EVar(m) if (m == "Phoenix.Controller"):
				true;			
			default:
				false;			
		};	
	default:
		false;	
}) {
			var ` = e.def;
			if (enumIndex ` == 24) {
				var ` = `[0];
				var ` = `[1];
				var ` = `[2];
				{
					var target = `;
					var fnName = `;
					var args = `;
					{
						if (fnName != "json" || args == null || args.length != 2) {
							return false;
						};
						@:ast(switch (target.def) {
	case EVar(m) if (m == "Phoenix.Controller"):
		true;	
	default:
		false;	
}) {
							var ` = target.def;
							if (enumIndex ` == 38) {
								var ` = `[0];
								{
									var m = `;
									if (m == "Phoenix.Controller") {
										true;
									} else {
										false;
									};
								};
							} else {
								false;
							};
						};
					};
				};
			} else {
				false;
			};
		};
	}

	static function rewrite(stmts:Array<reflaxe.elixir.ast.ElixirAST>) {
		if (stmts == null) {
			return stmts;
		};
		var out = [];
		var i = 0;
		while (i < stmts.length) {
			if (reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.isAssignTo("json", stmts[i]) || reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.isAssignTo("data", stmts[i]) || reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.isAssignTo("conn", stmts[i])) {
				var rv0 = reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.rhsVar(stmts[i]);
				if (rv0 != null) {
					i ++;
					continue;
				};
			};
			if (reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.isJsonCall(stmts[i])) {
				var callIdx = i;
				var k = i - 1;
				var rhs = [null];
				while (k >= 0 && (reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.isAssignTo("json", stmts[k]) || reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.isAssignTo("data", stmts[k]) || reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.isAssignTo("conn", stmts[k]))) {
					var rv = reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.rhsVar(stmts[k]);
					if (rv != null) {
						rhs[0] = rv;
					};
					k --;
				};
				var j = out.length;
				while (j > 0 && (reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.isAssignTo("json", out[j - 1]) || reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.isAssignTo("data", out[j - 1]) || reflaxe.elixir.ast.transformers.ControllerJsonCallCleanupTransforms.isAssignTo("conn", out[j - 1]))) {
					out.pop();
					j --;
				};
				var call = stmts[i];
				if (rhs[0] != null) {
					call = reflaxe.elixir.ast.ElixirASTTransformer.transformNode(call, function(n:reflaxe.elixir.ast.ElixirAST) {
						return @:ast(switch (n.def) {
	case ERemoteCall(t, fnName, args) if (fnName == "json" && args.length == 2):
		makeASTWithMeta(ERemoteCall(t, fnName, [args[0], makeAST(EVar(rhs))]), n.metadata, n.pos);	
	default:
		n;	
}) {
							var ` = n.def;
							if (enumIndex ` == 24) {
								var ` = `[0];
								var ` = `[1];
								var ` = `[2];
								{
									var t = `;
									var fnName = `;
									var args = `;
									if (fnName == "json" && args.length == 2) {
										{def : reflaxe.elixir.ast.ElixirASTDef.ERemoteCall(t, fnName, [args[0], {
											var pos = null;
											{def : reflaxe.elixir.ast.ElixirASTDef.EVar(rhs[0]), metadata : {}, pos : pos};
										}]), metadata : n.metadata, pos : n.pos};
									} else {
										n;
									};
								};
							} else {
								n;
							};
						};
					});
				};
				out.push(call);
				i ++;
				continue;
			};
			out.push(stmts[i]);
			i ++;
		};
		return out;
	}
}