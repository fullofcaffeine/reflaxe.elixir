class reflaxe.elixir.ast.transformers.SanitizeAssignLhsIdentifierTransforms {

	public static function pass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EBlock(stmts):
		makeASTWithMeta(EBlock(sanitize(stmts)), n.metadata, n.pos);	
	case EDo(stmts2):
		makeASTWithMeta(EDo(sanitize(stmts2)), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 53: {
						var ` = `[0];
						{
							var stmts = `;
							{
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EBlock(reflaxe.elixir.ast.transformers.SanitizeAssignLhsIdentifierTransforms.sanitize(stmts));
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							};
						};
					};
					case 55: {
						var ` = `[0];
						{
							var stmts2 = `;
							{
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EDo(reflaxe.elixir.ast.transformers.SanitizeAssignLhsIdentifierTransforms.sanitize(stmts2));
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							};
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}

	static function sanitize(stmts:Array<reflaxe.elixir.ast.ElixirAST>) {
		var out = [];
		{
			var ` = 0;
			while (` < stmts.length) {
				var s = stmts[`];
				++ `;
				@:ast(switch (s.def) {
	case EBinary(Match, left, right):
		var ok = false;
		switch (left.def) {
			case EVar(name) if (isValidIdent(name)):
				ok = true;			
			default:
				var printed = ElixirASTPrinter.printAST(left);
				if (printed != null) {
					var t = StringTools.trim(printed);
					ok = isValidIdent(t);
				};			
		};
		if (!ok) out.push(makeASTWithMeta(EBinary(Match, makeASTWithMeta(EVar("_"), left.metadata, left.pos), right), s.metadata, s.pos)) else out.push(s);	
	case EMatch(pat, rhs):
		var pat2 = switch (pat) {
			case PVar(nm) if (!isValidIdent(nm)):
				PVar("_");			
			default:
				pat;			
		};
		if (pat2 != pat) out.push(makeASTWithMeta(EMatch(pat2, rhs), s.metadata, s.pos)) else out.push(s);	
	default:
		out.push(s);	
}) {
					var ` = s.def;
					switch (enumIndex `) {
						case 8: {
							var ` = `[0];
							var ` = `[1];
							{
								var pat = `;
								var rhs = `;
								{
									var pat2 = @:ast(switch (pat) {
	case PVar(nm) if (!isValidIdent(nm)):
		PVar("_");	
	default:
		pat;	
}) if (enumIndex pat == 0) {
										var ` = pat[0];
										{
											var nm = `;
											if (! reflaxe.elixir.ast.transformers.SanitizeAssignLhsIdentifierTransforms.isValidIdent(nm)) {
												reflaxe.elixir.ast.EPattern.PVar("_");
											} else {
												pat;
											};
										};
									} else {
										pat;
									};
									if (pat2 != pat) {
										out.push({def : reflaxe.elixir.ast.ElixirASTDef.EMatch(pat2, rhs), metadata : s.metadata, pos : s.pos});
									} else {
										out.push(s);
									};
								};
							};
						};
						case 26: {
							var ` = `[0];
							var ` = `[1];
							var ` = `[2];
							if (enumIndex ` == 27) {
								{
									var left = `;
									var right = `;
									{
										var ok = false;
										@:ast(switch (left.def) {
	case EVar(name) if (isValidIdent(name)):
		ok = true;	
	default:
		var printed = ElixirASTPrinter.printAST(left);
		if (printed != null) {
			var t = StringTools.trim(printed);
			ok = isValidIdent(t);
		};	
}) {
											var ` = left.def;
											if (enumIndex ` == 38) {
												var ` = `[0];
												{
													var name = `;
													if (reflaxe.elixir.ast.transformers.SanitizeAssignLhsIdentifierTransforms.isValidIdent(name)) {
														ok = true;
													} else {
														var printed = reflaxe.elixir.ast.ElixirASTPrinter.printAST(left, null);
														if (printed != null) {
															var t = StringTools.trim(printed);
															ok = reflaxe.elixir.ast.transformers.SanitizeAssignLhsIdentifierTransforms.isValidIdent(t);
														};
													};
												};
											} else {
												var printed = reflaxe.elixir.ast.ElixirASTPrinter.printAST(left, null);
												if (printed != null) {
													var t = StringTools.trim(printed);
													ok = reflaxe.elixir.ast.transformers.SanitizeAssignLhsIdentifierTransforms.isValidIdent(t);
												};
											};
										};
										if (! ok) {
											out.push({def : reflaxe.elixir.ast.ElixirASTDef.EBinary(reflaxe.elixir.ast.EBinaryOp.Match, {def : reflaxe.elixir.ast.ElixirASTDef.EVar("_"), metadata : left.metadata, pos : left.pos}, right), metadata : s.metadata, pos : s.pos});
										} else {
											out.push(s);
										};
									};
								};
							} else {
								out.push(s);
							};
						};
						default: {
							out.push(s);
						}
					};
				};
			};
		};
		return out;
	}

	static function isValidIdent(name:String) {
		if (name == null) {
			return false;
		};
		if (name.length == 0) {
			return false;
		};
		var c0 = name.charAt(0);
		var lowerStart = c0.toLowerCase() == c0;
		if (! lowerStart) {
			return false;
		};
		{
			var ` = 0;
			var ` = name.length;
			while (` < `) {
				var i = ` ++;
				var c = name.charCodeAt(i);
				var isAlpha = (c >= 97 && c <= 122);
				var isDigit = (c >= 48 && c <= 57);
				var isUnd = (c == 95);
				if (! (isAlpha || isDigit || isUnd)) {
					return false;
				};
			};
		};
		return true;
	}
}