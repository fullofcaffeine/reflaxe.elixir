class reflaxe.elixir.ast.transformers.FinalLocalReferenceAlignTransforms {

	public static function pass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EDef(name, args, guards, body):
		var nb = alignInBody(body, args);
		makeASTWithMeta(EDef(name, args, guards, nb), n.metadata, n.pos);	
	case EDefp(name2, args2, guards2, body2):
		var nb2 = alignInBody(body2, args2);
		makeASTWithMeta(EDefp(name2, args2, guards2, nb2), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 2: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name = `;
							var args = `;
							var guards = `;
							var body = `;
							{
								var nb = reflaxe.elixir.ast.transformers.FinalLocalReferenceAlignTransforms.alignInBody(body, args);
								{def : reflaxe.elixir.ast.ElixirASTDef.EDef(name, args, guards, nb), metadata : n.metadata, pos : n.pos};
							};
						};
					};
					case 3: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name2 = `;
							var args2 = `;
							var guards2 = `;
							var body2 = `;
							{
								var nb2 = reflaxe.elixir.ast.transformers.FinalLocalReferenceAlignTransforms.alignInBody(body2, args2);
								{def : reflaxe.elixir.ast.ElixirASTDef.EDefp(name2, args2, guards2, nb2), metadata : n.metadata, pos : n.pos};
							};
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}

	static function alignInBody(body:reflaxe.elixir.ast.ElixirAST, args:Array<reflaxe.elixir.ast.EPattern>) {
		var declared = {
			{};
			new haxe.ds.StringMap();
		};
		var declaredCanonToName = {
			{};
			new haxe.ds.StringMap();
		};
		{
			var ` = 0;
			while (` < args.length) {
				var a = args[`];
				++ `;
				reflaxe.elixir.ast.transformers.FinalLocalReferenceAlignTransforms.collectPatternNames(a, declared);
			};
		};
		reflaxe.elixir.ast.ElixirASTTransformer.transformNode(body, function(x:reflaxe.elixir.ast.ElixirAST) {
			@:ast(switch (x.def) {
	case EMatch(p, _):
		collectPatternNames(p, declared);	
	case EBinary(Match, left, _):
		collectLhsVars(left, declared);	
	case ECase(_, clauses):
		for (c  in  clauses) collectPatternNames(c.pattern, declared);	
	case EFn(clauses):
		for (cl  in  clauses) for (a  in  cl.args) collectPatternNames(a, declared);	
	default:
}) {
				var ` = x.def;
				switch (enumIndex `) {
					case 6: {
						var ` = `[0];
						var ` = `[1];
						{
							var clauses = `;
							{
								{
									var ` = 0;
									while (` < clauses.length) {
										var c = clauses[`];
										++ `;
										reflaxe.elixir.ast.transformers.FinalLocalReferenceAlignTransforms.collectPatternNames(c.pattern, declared);
									};
								};
							};
						};
					};
					case 8: {
						var ` = `[0];
						var ` = `[1];
						{
							var p = `;
							{
								reflaxe.elixir.ast.transformers.FinalLocalReferenceAlignTransforms.collectPatternNames(p, declared);
							};
						};
					};
					case 26: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						if (enumIndex ` == 27) {
							{
								var left = `;
								{
									reflaxe.elixir.ast.transformers.FinalLocalReferenceAlignTransforms.collectLhsVars(left, declared);
								};
							};
						} else {};
					};
					case 42: {
						var ` = `[0];
						{
							var clauses = `;
							{
								{
									var ` = 0;
									while (` < clauses.length) {
										var cl = clauses[`];
										++ `;
										{
											var ` = 0;
											var ` = cl.args;
											while (` < `.length) {
												var a = `[`];
												++ `;
												reflaxe.elixir.ast.transformers.FinalLocalReferenceAlignTransforms.collectPatternNames(a, declared);
											};
										};
									};
								};
							};
						};
					};
					default: {}
				};
			};
			return x;
		});
		{};
		var canonCounts = {
			{};
			new haxe.ds.StringMap();
		};
		for (k in declared.keys()) {
			var ck = if (k == null) {
				k;
			} else {
				var snake = if (k == null) {
					k;
				} else {
					var buf = new StringBuf();
					{
						var ` = 0;
						var ` = k.length;
						while (` < `) {
							var i = ` ++;
							var ch = k.charAt(i);
							var code = k.charCodeAt(i);
							var isUpper = code >= 65 && code <= 90;
							if (isUpper) {
								if (i > 0) {
									buf.add("_");
								};
								buf.add(ch.toLowerCase());
							} else {
								buf.add(ch);
							};
						};
					};
					buf.toString();
				};
				var buf = new StringBuf();
				{
					var ` = 0;
					var ` = snake.length;
					while (` < `) {
						var i = ` ++;
						var ch = snake.charAt(i);
						if (ch != "_") {
							buf.add(ch);
						};
					};
				};
				buf.toString();
			};
			{
				var value = (if ((canonCounts.exists(ck))) canonCounts.get(ck) else 0) + 1;
				canonCounts.set(ck, value);
			};
		};
		for (k in declared.keys()) {
			var ck = if (k == null) {
				k;
			} else {
				var snake = if (k == null) {
					k;
				} else {
					var buf = new StringBuf();
					{
						var ` = 0;
						var ` = k.length;
						while (` < `) {
							var i = ` ++;
							var ch = k.charAt(i);
							var code = k.charCodeAt(i);
							var isUpper = code >= 65 && code <= 90;
							if (isUpper) {
								if (i > 0) {
									buf.add("_");
								};
								buf.add(ch.toLowerCase());
							} else {
								buf.add(ch);
							};
						};
					};
					buf.toString();
				};
				var buf = new StringBuf();
				{
					var ` = 0;
					var ` = snake.length;
					while (` < `) {
						var i = ` ++;
						var ch = snake.charAt(i);
						if (ch != "_") {
							buf.add(ch);
						};
					};
				};
				buf.toString();
			};
			if (cast canonCounts.get(ck) == 1) {
				{
					declaredCanonToName.set(ck, k);
				};
			};
		};
		{};
		var findOkBinder = function() {
			var found = null;
			for (k in declared.keys()) {
				if (StringTools.startsWith(k, "ok_")) {
					if (found != null) {
						return null;
					};
					found = k;
				};
			};
			return found;
		};
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(body, function(x:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (x.def) {
	case EVar(v) if (v != null):
		var target:Null<String> = null;
		if (v.charAt(0) == "_" && v.length > 1) {
			var base = v.substr(1);
			if (has(base) && !has(v)) target = base;
		};
		if (target == null && !has(v) && has("_" + v)) target = "_" + v;
		if (target == null) {
			var i = v.length - 1;
			while (i >= 0 && v.charCodeAt(i) >= "0".code && v.charCodeAt(i) <= "9".code) i--;
			if (i < v.length - 1) {
				var base = v.substr(0, i + 1);
				if (has(base) && !has(v)) target = base;
			};
		};
		if (target == null) {
			var snake = toSnakeCase(v);
			if (snake != v && has(snake) && !has(v)) target = snake;
		};
		if (target == null) {
			var lower = v.toLowerCase();
			if (lower != v && has(lower) && !has(v)) target = lower;
		};
		if (target == null && v == "todo" && has("item") && !has("todo")) target = "item";
		if (target == null && !has(v)) {
			var cv = canon(v);
			if (declaredCanonToName.exists(cv)) {
				var unique = declaredCanonToName.get(cv);
				if (unique != null && unique != v) target = unique;
			};
		};
		if (target != null) {
			makeASTWithMeta(EVar(target), x.metadata, x.pos);
		} else {
			x;
		};	
	case EString(s) if (s != null && s.indexOf("#{") != -1):
		var rewritten = rewriteInterpolationVars(s, declared, declaredCanonToName);
		if (rewritten != s) makeASTWithMeta(EString(rewritten), x.metadata, x.pos) else x;	
	case ERaw(code) if (code != null && code.indexOf("#{") != -1):
		var rewritten2 = rewriteInterpolationVars(code, declared, declaredCanonToName);
		if (rewritten2 != code) makeASTWithMeta(ERaw(rewritten2), x.metadata, x.pos) else x;	
	default:
		x;	
}) {
				var ` = x.def;
				switch (enumIndex `) {
					case 32: {
						var ` = `[0];
						{
							var s = `;
							if (s != null && s.indexOf("#{", null) != -1) {
								var rewritten = reflaxe.elixir.ast.transformers.FinalLocalReferenceAlignTransforms.rewriteInterpolationVars(s, declared, declaredCanonToName);
								if (rewritten != s) {
									{def : reflaxe.elixir.ast.ElixirASTDef.EString(rewritten), metadata : x.metadata, pos : x.pos};
								} else {
									x;
								};
							} else {
								x;
							};
						};
					};
					case 38: {
						var ` = `[0];
						{
							var v = `;
							if (v != null) {
								var target = null;
								if (v.charAt(0) == "_" && v.length > 1) {
									var base = v.substr(1, null);
									if (declared.exists(base) && ! declared.exists(v)) {
										target = base;
									};
								};
								if (target == null && ! declared.exists(v) && declared.exists("_" + v)) {
									target = "_" + v;
								};
								if (target == null) {
									var i = v.length - 1;
									while (i >= 0 && v.charCodeAt(i) >= 48 && v.charCodeAt(i) <= 57) {
										i --;
									};
									if (i < v.length - 1) {
										var base = v.substr(0, i + 1);
										if (declared.exists(base) && ! declared.exists(v)) {
											target = base;
										};
									};
								};
								if (target == null) {
									var snake = if (v == null) {
										v;
									} else {
										var buf = new StringBuf();
										{
											var ` = 0;
											var ` = v.length;
											while (` < `) {
												var i = ` ++;
												var ch = v.charAt(i);
												var code = v.charCodeAt(i);
												var isUpper = code >= 65 && code <= 90;
												if (isUpper) {
													if (i > 0) {
														buf.add("_");
													};
													buf.add(ch.toLowerCase());
												} else {
													buf.add(ch);
												};
											};
										};
										buf.toString();
									};
									if (snake != v && declared.exists(snake) && ! declared.exists(v)) {
										target = snake;
									};
								};
								if (target == null) {
									var lower = v.toLowerCase();
									if (lower != v && declared.exists(lower) && ! declared.exists(v)) {
										target = lower;
									};
								};
								if (target == null && v == "todo" && declared.exists("item") && ! declared.exists("todo")) {
									target = "item";
								};
								if (target == null && ! declared.exists(v)) {
									var cv = if (v == null) {
										v;
									} else {
										var snake = if (v == null) {
											v;
										} else {
											var buf = new StringBuf();
											{
												var ` = 0;
												var ` = v.length;
												while (` < `) {
													var i = ` ++;
													var ch = v.charAt(i);
													var code = v.charCodeAt(i);
													var isUpper = code >= 65 && code <= 90;
													if (isUpper) {
														if (i > 0) {
															buf.add("_");
														};
														buf.add(ch.toLowerCase());
													} else {
														buf.add(ch);
													};
												};
											};
											buf.toString();
										};
										var buf = new StringBuf();
										{
											var ` = 0;
											var ` = snake.length;
											while (` < `) {
												var i = ` ++;
												var ch = snake.charAt(i);
												if (ch != "_") {
													buf.add(ch);
												};
											};
										};
										buf.toString();
									};
									if (declaredCanonToName.exists(cv)) {
										var unique = cast declaredCanonToName.get(cv);
										if (unique != null && unique != v) {
											target = unique;
										};
									};
								};
								if (target != null) {
									{def : reflaxe.elixir.ast.ElixirASTDef.EVar(target), metadata : x.metadata, pos : x.pos};
								} else {
									x;
								};
							} else {
								x;
							};
						};
					};
					case 62: {
						var ` = `[0];
						{
							var code = `;
							if (code != null && code.indexOf("#{", null) != -1) {
								var rewritten2 = reflaxe.elixir.ast.transformers.FinalLocalReferenceAlignTransforms.rewriteInterpolationVars(code, declared, declaredCanonToName);
								if (rewritten2 != code) {
									{def : reflaxe.elixir.ast.ElixirASTDef.ERaw(rewritten2), metadata : x.metadata, pos : x.pos};
								} else {
									x;
								};
							} else {
								x;
							};
						};
					};
					default: {
						x;
					}
				};
			};
		});
	}

	static inline function toSnakeCase(name:String) {
		if (name == null) {
			return name;
		};
		var buf = new StringBuf();
		{
			var ` = 0;
			var ` = name.length;
			while (` < `) {
				var i = ` ++;
				var ch = name.charAt(i);
				var code = name.charCodeAt(i);
				var isUpper = code >= 65 && code <= 90;
				if (isUpper) {
					if (i > 0) {
						buf.add("_");
					};
					buf.add(ch.toLowerCase());
				} else {
					buf.add(ch);
				};
			};
		};
		return buf.toString();
	}

	static function rewriteInterpolationVars(src:String, declared:Map<String, Bool>, declaredCanonToName:Map<String, String>) {
		if (src == null || src.indexOf("#{", null) == -1) {
			return src;
		};
		{};
		{};
		var out = new StringBuf();
		var i = 0;
		while (i < src.length) {
			var o = src.indexOf("#{", i);
			if (o == -1) {
				out.add(src.substr(i, null));
				break;
			};
			out.add(src.substr(i, o - i));
			var k = o + 2;
			var dep = 1;
			while (k < src.length && dep > 0) {
				var ch = src.charAt(k);
				if (ch == "{") {
					dep ++;
				} else {
					if (ch == "}") {
						dep --;
					};
				};
				k ++;
			};
			var inner = src.substr(o + 2, (k - 1) - (o + 2));
			var buf = new StringBuf();
			var j = 0;
			while (j < inner.length) {
				var c = inner.charAt(j);
				var isIdStart = new EReg("^[a-z_]$", "").match(c);
				if (! isIdStart) {
					buf.add(c);
					j ++;
					continue;
				};
				var start = j;
				j ++;
				while (j < inner.length) {
					var c2 = inner.charAt(j);
					if (! new EReg("^[A-Za-z0-9_]$", "").match(c2)) {
						break;
					};
					j ++;
				};
				var id = inner.substr(start, j - start);
				var k2 = j;
				while (k2 < inner.length && StringTools.isSpace(inner, k2)) {
					k2 ++;
				};
				var isCall = (k2 < inner.length && inner.charAt(k2) == "(");
				if (isCall) {
					buf.add(id);
					continue;
				};
				var repl = null;
				var snake = if (id == null) {
					id;
				} else {
					var buf = new StringBuf();
					{
						var ` = 0;
						var ` = id.length;
						while (` < `) {
							var i = ` ++;
							var ch = id.charAt(i);
							var up = ch.toUpperCase();
							var low = ch.toLowerCase();
							if (ch == up && ch != low) {
								if (i > 0) {
									buf.add("_");
								};
								buf.add(low);
							} else {
								buf.add(ch);
							};
						};
					};
					buf.toString();
				};
				if (snake != id && declared.exists(snake) && ! declared.exists(id)) {
					repl = snake;
				};
				if (repl == null) {
					var ck = if (id == null) {
						id;
					} else {
						var snake = if (id == null) {
							id;
						} else {
							var buf = new StringBuf();
							{
								var ` = 0;
								var ` = id.length;
								while (` < `) {
									var i = ` ++;
									var ch = id.charAt(i);
									var up = ch.toUpperCase();
									var low = ch.toLowerCase();
									if (ch == up && ch != low) {
										if (i > 0) {
											buf.add("_");
										};
										buf.add(low);
									} else {
										buf.add(ch);
									};
								};
							};
							buf.toString();
						};
						var b = new StringBuf();
						{
							var ` = 0;
							var ` = snake.length;
							while (` < `) {
								var i = ` ++;
								var c = snake.charAt(i);
								if (c != "_") {
									b.add(c);
								};
							};
						};
						b.toString();
					};
					if (declaredCanonToName.exists(ck)) {
						var uniq = cast declaredCanonToName.get(ck);
						if (uniq != null && uniq != id) {
							repl = uniq;
						};
					};
				};
				buf.add(if (repl != null) {
					repl;
				} else {
					id;
				});
			};
			out.add("#{" + buf.toString() + "}");
			i = k;
		};
		return out.toString();
	}

	static function collectPatternNames(p:reflaxe.elixir.ast.EPattern, acc:Map<String, Bool>) {
		@:ast(switch (p) {
	case PVar(nm) if (nm != null):
		acc.set(nm, true);	
	case PTuple(es) | PList(es):
		for (e  in  es) collectPatternNames(e, acc);	
	case PCons(h, t):
		collectPatternNames(h, acc);
		collectPatternNames(t, acc);	
	case PMap(kvs):
		for (kv  in  kvs) collectPatternNames(kv.value, acc);	
	case PStruct(_, fs):
		for (f  in  fs) collectPatternNames(f.value, acc);	
	case PPin(inner):
		collectPatternNames(inner, acc);	
	default:
}) switch (enumIndex p) {
			case 0: {
				var ` = p[0];
				{
					var nm = `;
					if (nm != null) {
						{
							acc.set(nm, true);
						};
					} else {};
				};
			};
			case 2: {
				var ` = p[0];
				{
					var es = `;
					{
						{
							var ` = 0;
							while (` < es.length) {
								var e = es[`];
								++ `;
								reflaxe.elixir.ast.transformers.FinalLocalReferenceAlignTransforms.collectPatternNames(e, acc);
							};
						};
					};
				};
			};
			case 3: {
				var ` = p[0];
				{
					var es = `;
					{
						{
							var ` = 0;
							while (` < es.length) {
								var e = es[`];
								++ `;
								reflaxe.elixir.ast.transformers.FinalLocalReferenceAlignTransforms.collectPatternNames(e, acc);
							};
						};
					};
				};
			};
			case 4: {
				var ` = p[0];
				var ` = p[1];
				{
					var h = `;
					var t = `;
					{
						reflaxe.elixir.ast.transformers.FinalLocalReferenceAlignTransforms.collectPatternNames(h, acc);
						reflaxe.elixir.ast.transformers.FinalLocalReferenceAlignTransforms.collectPatternNames(t, acc);
					};
				};
			};
			case 5: {
				var ` = p[0];
				{
					var kvs = `;
					{
						{
							var ` = 0;
							while (` < kvs.length) {
								var kv = kvs[`];
								++ `;
								reflaxe.elixir.ast.transformers.FinalLocalReferenceAlignTransforms.collectPatternNames(kv.value, acc);
							};
						};
					};
				};
			};
			case 6: {
				var ` = p[0];
				var ` = p[1];
				{
					var fs = `;
					{
						{
							var ` = 0;
							while (` < fs.length) {
								var f = fs[`];
								++ `;
								reflaxe.elixir.ast.transformers.FinalLocalReferenceAlignTransforms.collectPatternNames(f.value, acc);
							};
						};
					};
				};
			};
			case 7: {
				var ` = p[0];
				{
					var inner = `;
					{
						reflaxe.elixir.ast.transformers.FinalLocalReferenceAlignTransforms.collectPatternNames(inner, acc);
					};
				};
			};
			default: {}
		};
	}

	static function collectLhsVars(lhs:reflaxe.elixir.ast.ElixirAST, acc:Map<String, Bool>) {
		@:ast(switch (lhs.def) {
	case EVar(nm) if (nm != null):
		acc.set(nm, true);	
	case EBinary(Match, l2, r2):
		collectLhsVars(l2, acc);
		collectLhsVars(r2, acc);	
	default:
}) {
			var ` = lhs.def;
			switch (enumIndex `) {
				case 26: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					if (enumIndex ` == 27) {
						{
							var l2 = `;
							var r2 = `;
							{
								reflaxe.elixir.ast.transformers.FinalLocalReferenceAlignTransforms.collectLhsVars(l2, acc);
								reflaxe.elixir.ast.transformers.FinalLocalReferenceAlignTransforms.collectLhsVars(r2, acc);
							};
						};
					} else {};
				};
				case 38: {
					var ` = `[0];
					{
						var nm = `;
						if (nm != null) {
							{
								acc.set(nm, true);
							};
						} else {};
					};
				};
				default: {}
			};
		};
	}
}