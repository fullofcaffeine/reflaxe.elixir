class reflaxe.elixir.ast.transformers.EFnUnusedArgUnderscoreTransforms {

	public static function transformPass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EFn(clauses):
		var newClauses = [];
		for (cl  in  clauses) {
			var newArgs:Array<EPattern> = [];
			var i = 0;
			inline function isUsed(name:String):Bool {
				if (name == null) return false;
				var underscored = "_" + name;
				return VariableUsageCollector.usedInFunctionScope(cl.body, name) || VariableUsageCollector.usedInFunctionScope(cl.body, underscored) || erawUsesName(cl.body, name) || erawUsesName(cl.body, underscored) || containsVarName(cl.body, name) || containsVarName(cl.body, underscored);
			};
			inline function normalizedBinder(name:String):String {
				if (name == null) return name;
				var needsUnderscore = !isUsed(name) && (name.length == 0 || name.charAt(0) != "_");
				return needsUnderscore ? ("_" + name) : name;
			};
			for (a  in  cl.args) {
				switch (a) {
					case PVar(name):
						var nn = normalizedBinder(name);
						newArgs.push(PVar(nn));					
					case PAlias(name, pat):
						var nn = normalizedBinder(name);
						newArgs.push(PAlias(nn, pat));					
					default:
						newArgs.push(a);					
				};
				i++;
			};
			newClauses.push({ args : newArgs, guard : cl.guard, body : cl.body });
		};
		makeASTWithMeta(EFn(newClauses), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				if (enumIndex ` == 42) {
					var ` = `[0];
					{
						var clauses = `;
						{
							var newClauses = [];
							{
								var ` = 0;
								while (` < clauses.length) {
									var cl = clauses[`];
									++ `;
									var newArgs = [];
									var i = 0;
									{};
									{};
									{
										var ` = 0;
										var ` = cl.args;
										while (` < `.length) {
											var a = `[`];
											++ `;
											@:ast(switch (a) {
	case PVar(name):
		var nn = normalizedBinder(name);
		newArgs.push(PVar(nn));	
	case PAlias(name, pat):
		var nn = normalizedBinder(name);
		newArgs.push(PAlias(nn, pat));	
	default:
		newArgs.push(a);	
}) switch (enumIndex a) {
												case 0: {
													var ` = a[0];
													{
														var name = `;
														{
															var nn = if (name == null) {
																name;
															} else {
																var needsUnderscore = ! if (name == null) {
																	false;
																} else {
																	var underscored = "_" + name;
																	reflaxe.elixir.ast.analyzers.VariableUsageCollector.usedInFunctionScope(cl.body, name) || reflaxe.elixir.ast.analyzers.VariableUsageCollector.usedInFunctionScope(cl.body, underscored) || reflaxe.elixir.ast.transformers.EFnUnusedArgUnderscoreTransforms.erawUsesName(cl.body, name) || reflaxe.elixir.ast.transformers.EFnUnusedArgUnderscoreTransforms.erawUsesName(cl.body, underscored) || reflaxe.elixir.ast.transformers.EFnUnusedArgUnderscoreTransforms.containsVarName(cl.body, name) || reflaxe.elixir.ast.transformers.EFnUnusedArgUnderscoreTransforms.containsVarName(cl.body, underscored);
																} && (name.length == 0 || name.charAt(0) != "_");
																if (needsUnderscore) {
																	("_" + name);
																} else {
																	name;
																};
															};
															newArgs.push(reflaxe.elixir.ast.EPattern.PVar(nn));
														};
													};
												};
												case 9: {
													var ` = a[0];
													var ` = a[1];
													{
														var name = `;
														var pat = `;
														{
															var nn = if (name == null) {
																name;
															} else {
																var needsUnderscore = ! if (name == null) {
																	false;
																} else {
																	var underscored = "_" + name;
																	reflaxe.elixir.ast.analyzers.VariableUsageCollector.usedInFunctionScope(cl.body, name) || reflaxe.elixir.ast.analyzers.VariableUsageCollector.usedInFunctionScope(cl.body, underscored) || reflaxe.elixir.ast.transformers.EFnUnusedArgUnderscoreTransforms.erawUsesName(cl.body, name) || reflaxe.elixir.ast.transformers.EFnUnusedArgUnderscoreTransforms.erawUsesName(cl.body, underscored) || reflaxe.elixir.ast.transformers.EFnUnusedArgUnderscoreTransforms.containsVarName(cl.body, name) || reflaxe.elixir.ast.transformers.EFnUnusedArgUnderscoreTransforms.containsVarName(cl.body, underscored);
																} && (name.length == 0 || name.charAt(0) != "_");
																if (needsUnderscore) {
																	("_" + name);
																} else {
																	name;
																};
															};
															newArgs.push(reflaxe.elixir.ast.EPattern.PAlias(nn, pat));
														};
													};
												};
												default: {
													newArgs.push(a);
												}
											};
											i ++;
										};
									};
									newClauses.push({args : newArgs, guard : cl.guard, body : cl.body});
								};
							};
							{def : reflaxe.elixir.ast.ElixirASTDef.EFn(newClauses), metadata : n.metadata, pos : n.pos};
						};
					};
				} else {
					n;
				};
			};
		});
	}

	static function erawUsesName(body:reflaxe.elixir.ast.ElixirAST, name:String) {
		var found = [false];
		{};
		var walk = [null];
		walk[0] = function(n:reflaxe.elixir.ast.ElixirAST) {
			if (n == null || n.def == null || found[0]) {
				return;
			};
			@:ast(switch (n.def) {
	case ERaw(code):
		if (code != null && name != null && name.length > 0 && name.charAt(0) != "_") {
			var start = 0;
			while (!found) {
				var i = code.indexOf(name, start);
				if (i == -1) break;
				var before = i > 0 ? code.substr(i - 1, 1) : null;
				var afterIdx = i + name.length;
				var after = afterIdx < code.length ? code.substr(afterIdx, 1) : null;
				if (!isIdentChar(before) && !isIdentChar(after)) {
					found = true;
					break;
				};
				start = i + name.length;
			};
		};	
	case EBlock(ss):
		for (s  in  ss) walk(s);	
	case EDo(statements):
		for (s  in  statements) walk(s);	
	case EIf(c, t, e):
		walk(c);
		walk(t);
		if (e != null) walk(e);	
	case ECase(expr, clauses):
		walk(expr);
		for (c  in  clauses) {
			if (c.guard != null) walk(c.guard);
			walk(c.body);
		};	
	case EWith(clauses, doBlock, elseBlock):
		for (wc  in  clauses) walk(wc.expr);
		walk(doBlock);
		if (elseBlock != null) walk(elseBlock);	
	case ECall(t, _, as):
		if (t != null) walk(t);
		for (a  in  as) walk(a);	
	case ERemoteCall(targetExpr, _, argsList):
		walk(targetExpr);
		for (argNode  in  argsList) walk(argNode);	
	case EField(obj, _):
		walk(obj);	
	case EAccess(objectExpr, key):
		walk(objectExpr);
		walk(key);	
	case EKeywordList(pairs):
		for (p  in  pairs) walk(p.value);	
	case EMap(pairs):
		for (p  in  pairs) {
			walk(p.key);
			walk(p.value);
		};	
	case EStructUpdate(base, fs):
		walk(base);
		for (f  in  fs) walk(f.value);	
	case ETuple(es) | EList(es):
		for (e  in  es) walk(e);	
	case EFn(clauses):
		for (cl  in  clauses) {
			if (cl.guard != null) walk(cl.guard);
			walk(cl.body);
		};	
	default:
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 6: {
						var ` = `[0];
						var ` = `[1];
						{
							var expr = `;
							var clauses = `;
							{
								walk[0](expr);
								{
									var ` = 0;
									while (` < clauses.length) {
										var c = clauses[`];
										++ `;
										if (c.guard != null) {
											walk[0](c.guard);
										};
										walk[0](c.body);
									};
								};
							};
						};
					};
					case 9: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var clauses = `;
							var doBlock = `;
							var elseBlock = `;
							{
								{
									var ` = 0;
									while (` < clauses.length) {
										var wc = clauses[`];
										++ `;
										walk[0](wc.expr);
									};
								};
								walk[0](doBlock);
								if (elseBlock != null) {
									walk[0](elseBlock);
								};
							};
						};
					};
					case 10: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var c = `;
							var t = `;
							var e = `;
							{
								walk[0](c);
								walk[0](t);
								if (e != null) {
									walk[0](e);
								};
							};
						};
					};
					case 15: {
						var ` = `[0];
						{
							var es = `;
							{
								{
									var ` = 0;
									while (` < es.length) {
										var e = es[`];
										++ `;
										walk[0](e);
									};
								};
							};
						};
					};
					case 16: {
						var ` = `[0];
						{
							var es = `;
							{
								{
									var ` = 0;
									while (` < es.length) {
										var e = es[`];
										++ `;
										walk[0](e);
									};
								};
							};
						};
					};
					case 17: {
						var ` = `[0];
						{
							var pairs = `;
							{
								{
									var ` = 0;
									while (` < pairs.length) {
										var p = pairs[`];
										++ `;
										walk[0](p.key);
										walk[0](p.value);
									};
								};
							};
						};
					};
					case 19: {
						var ` = `[0];
						var ` = `[1];
						{
							var base = `;
							var fs = `;
							{
								walk[0](base);
								{
									var ` = 0;
									while (` < fs.length) {
										var f = fs[`];
										++ `;
										walk[0](f.value);
									};
								};
							};
						};
					};
					case 20: {
						var ` = `[0];
						{
							var pairs = `;
							{
								{
									var ` = 0;
									while (` < pairs.length) {
										var p = pairs[`];
										++ `;
										walk[0](p.value);
									};
								};
							};
						};
					};
					case 22: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var t = `;
							var as = `;
							{
								if (t != null) {
									walk[0](t);
								};
								{
									var ` = 0;
									while (` < as.length) {
										var a = as[`];
										++ `;
										walk[0](a);
									};
								};
							};
						};
					};
					case 24: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var targetExpr = `;
							var argsList = `;
							{
								walk[0](targetExpr);
								{
									var ` = 0;
									while (` < argsList.length) {
										var argNode = argsList[`];
										++ `;
										walk[0](argNode);
									};
								};
							};
						};
					};
					case 28: {
						var ` = `[0];
						var ` = `[1];
						{
							var obj = `;
							{
								walk[0](obj);
							};
						};
					};
					case 29: {
						var ` = `[0];
						var ` = `[1];
						{
							var objectExpr = `;
							var key = `;
							{
								walk[0](objectExpr);
								walk[0](key);
							};
						};
					};
					case 42: {
						var ` = `[0];
						{
							var clauses = `;
							{
								{
									var ` = 0;
									while (` < clauses.length) {
										var cl = clauses[`];
										++ `;
										if (cl.guard != null) {
											walk[0](cl.guard);
										};
										walk[0](cl.body);
									};
								};
							};
						};
					};
					case 53: {
						var ` = `[0];
						{
							var ss = `;
							{
								{
									var ` = 0;
									while (` < ss.length) {
										var s = ss[`];
										++ `;
										walk[0](s);
									};
								};
							};
						};
					};
					case 55: {
						var ` = `[0];
						{
							var statements = `;
							{
								{
									var ` = 0;
									while (` < statements.length) {
										var s = statements[`];
										++ `;
										walk[0](s);
									};
								};
							};
						};
					};
					case 62: {
						var ` = `[0];
						{
							var code = `;
							{
								if (code != null && name != null && name.length > 0 && name.charAt(0) != "_") {
									var start = 0;
									while (! found[0]) {
										var i = code.indexOf(name, start);
										if (i == -1) {
											break;
										};
										var before = if (i > 0) {
											code.substr(i - 1, 1);
										} else {
											null;
										};
										var afterIdx = i + name.length;
										var after = if (afterIdx < code.length) {
											code.substr(afterIdx, 1);
										} else {
											null;
										};
										if (! if (before == null || before.length == 0) {
											false;
										} else {
											var ch = before.charCodeAt(0);
											(ch >= 48 && ch <= 57) || (ch >= 65 && ch <= 90) || (ch >= 97 && ch <= 122) || before == "_" || before == ".";
										} && ! if (after == null || after.length == 0) {
											false;
										} else {
											var ch = after.charCodeAt(0);
											(ch >= 48 && ch <= 57) || (ch >= 65 && ch <= 90) || (ch >= 97 && ch <= 122) || after == "_" || after == ".";
										}) {
											found[0] = true;
											break;
										};
										start = i + name.length;
									};
								};
							};
						};
					};
					default: {}
				};
			};
		};
		walk[0](body);
		return found[0];
	}

	static function containsVarName(body:reflaxe.elixir.ast.ElixirAST, name:String) {
		var found = [false];
		var walk = [null];
		walk[0] = function(n:reflaxe.elixir.ast.ElixirAST) {
			if (n == null || n.def == null || found[0]) {
				return;
			};
			@:ast(switch (n.def) {
	case EVar(v) if (v == name):
		found = true;	
	case EPin(inner):
		walk(inner);	
	case EParen(e):
		walk(e);	
	case EBinary(_, l, r):
		walk(l);
		walk(r);	
	case EMatch(_, rhs):
		walk(rhs);	
	case EBlock(ss):
		for (s  in  ss) walk(s);	
	case EDo(statements):
		for (s  in  statements) walk(s);	
	case EIf(c, t, e):
		walk(c);
		walk(t);
		if (e != null) walk(e);	
	case ECase(expr, clauses):
		walk(expr);
		for (c  in  clauses) {
			if (c.guard != null) walk(c.guard);
			walk(c.body);
		};	
	case EWith(clauses, doBlock, elseBlock):
		for (wc  in  clauses) walk(wc.expr);
		walk(doBlock);
		if (elseBlock != null) walk(elseBlock);	
	case ECall(t, _, as):
		if (t != null) walk(t);
		for (a  in  as) walk(a);	
	case ERemoteCall(targetExpr, _, argsList):
		walk(targetExpr);
		for (argNode  in  argsList) walk(argNode);	
	case EField(obj, _):
		walk(obj);	
	case EAccess(obj2, key):
		walk(obj2);
		walk(key);	
	case EKeywordList(pairs):
		for (p  in  pairs) walk(p.value);	
	case EMap(pairs):
		for (p  in  pairs) {
			walk(p.key);
			walk(p.value);
		};	
	case EStructUpdate(base, fs):
		walk(base);
		for (f  in  fs) walk(f.value);	
	case ETuple(es) | EList(es):
		for (e  in  es) walk(e);	
	case EFn(clauses):
		for (cl  in  clauses) {
			if (cl.guard != null) walk(cl.guard);
			walk(cl.body);
		};	
	default:
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 6: {
						var ` = `[0];
						var ` = `[1];
						{
							var expr = `;
							var clauses = `;
							{
								walk[0](expr);
								{
									var ` = 0;
									while (` < clauses.length) {
										var c = clauses[`];
										++ `;
										if (c.guard != null) {
											walk[0](c.guard);
										};
										walk[0](c.body);
									};
								};
							};
						};
					};
					case 8: {
						var ` = `[0];
						var ` = `[1];
						{
							var rhs = `;
							{
								walk[0](rhs);
							};
						};
					};
					case 9: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var clauses = `;
							var doBlock = `;
							var elseBlock = `;
							{
								{
									var ` = 0;
									while (` < clauses.length) {
										var wc = clauses[`];
										++ `;
										walk[0](wc.expr);
									};
								};
								walk[0](doBlock);
								if (elseBlock != null) {
									walk[0](elseBlock);
								};
							};
						};
					};
					case 10: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var c = `;
							var t = `;
							var e = `;
							{
								walk[0](c);
								walk[0](t);
								if (e != null) {
									walk[0](e);
								};
							};
						};
					};
					case 15: {
						var ` = `[0];
						{
							var es = `;
							{
								{
									var ` = 0;
									while (` < es.length) {
										var e = es[`];
										++ `;
										walk[0](e);
									};
								};
							};
						};
					};
					case 16: {
						var ` = `[0];
						{
							var es = `;
							{
								{
									var ` = 0;
									while (` < es.length) {
										var e = es[`];
										++ `;
										walk[0](e);
									};
								};
							};
						};
					};
					case 17: {
						var ` = `[0];
						{
							var pairs = `;
							{
								{
									var ` = 0;
									while (` < pairs.length) {
										var p = pairs[`];
										++ `;
										walk[0](p.key);
										walk[0](p.value);
									};
								};
							};
						};
					};
					case 19: {
						var ` = `[0];
						var ` = `[1];
						{
							var base = `;
							var fs = `;
							{
								walk[0](base);
								{
									var ` = 0;
									while (` < fs.length) {
										var f = fs[`];
										++ `;
										walk[0](f.value);
									};
								};
							};
						};
					};
					case 20: {
						var ` = `[0];
						{
							var pairs = `;
							{
								{
									var ` = 0;
									while (` < pairs.length) {
										var p = pairs[`];
										++ `;
										walk[0](p.value);
									};
								};
							};
						};
					};
					case 22: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var t = `;
							var as = `;
							{
								if (t != null) {
									walk[0](t);
								};
								{
									var ` = 0;
									while (` < as.length) {
										var a = as[`];
										++ `;
										walk[0](a);
									};
								};
							};
						};
					};
					case 24: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var targetExpr = `;
							var argsList = `;
							{
								walk[0](targetExpr);
								{
									var ` = 0;
									while (` < argsList.length) {
										var argNode = argsList[`];
										++ `;
										walk[0](argNode);
									};
								};
							};
						};
					};
					case 26: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var l = `;
							var r = `;
							{
								walk[0](l);
								walk[0](r);
							};
						};
					};
					case 28: {
						var ` = `[0];
						var ` = `[1];
						{
							var obj = `;
							{
								walk[0](obj);
							};
						};
					};
					case 29: {
						var ` = `[0];
						var ` = `[1];
						{
							var obj2 = `;
							var key = `;
							{
								walk[0](obj2);
								walk[0](key);
							};
						};
					};
					case 38: {
						var ` = `[0];
						{
							var v = `;
							if (v == name) {
								found[0] = true;
							} else {};
						};
					};
					case 39: {
						var ` = `[0];
						{
							var inner = `;
							{
								walk[0](inner);
							};
						};
					};
					case 42: {
						var ` = `[0];
						{
							var clauses = `;
							{
								{
									var ` = 0;
									while (` < clauses.length) {
										var cl = clauses[`];
										++ `;
										if (cl.guard != null) {
											walk[0](cl.guard);
										};
										walk[0](cl.body);
									};
								};
							};
						};
					};
					case 53: {
						var ` = `[0];
						{
							var ss = `;
							{
								{
									var ` = 0;
									while (` < ss.length) {
										var s = ss[`];
										++ `;
										walk[0](s);
									};
								};
							};
						};
					};
					case 54: {
						var ` = `[0];
						{
							var e = `;
							{
								walk[0](e);
							};
						};
					};
					case 55: {
						var ` = `[0];
						{
							var statements = `;
							{
								{
									var ` = 0;
									while (` < statements.length) {
										var s = statements[`];
										++ `;
										walk[0](s);
									};
								};
							};
						};
					};
					default: {}
				};
			};
		};
		walk[0](body);
		return found[0];
	}
}