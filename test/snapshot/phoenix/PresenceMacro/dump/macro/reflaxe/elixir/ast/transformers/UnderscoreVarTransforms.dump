class reflaxe.elixir.ast.transformers.UnderscoreVarTransforms {

	public static function removeUnderscoreFromUsedLocalsPass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(node:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (node.def) {
	case EDef(name, params, guards, body):
		var newBody = normalize(body);
		makeASTWithMeta(EDef(name, params, guards, newBody), node.metadata, node.pos);	
	case EDefp(name, params, guards, body):
		var newBody = normalize(body);
		makeASTWithMeta(EDefp(name, params, guards, newBody), node.metadata, node.pos);	
	default:
		node;	
}) {
				var ` = node.def;
				switch (enumIndex `) {
					case 2: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name = `;
							var params = `;
							var guards = `;
							var body = `;
							{
								var newBody = reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.normalize(body);
								{def : reflaxe.elixir.ast.ElixirASTDef.EDef(name, params, guards, newBody), metadata : node.metadata, pos : node.pos};
							};
						};
					};
					case 3: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name = `;
							var params = `;
							var guards = `;
							var body = `;
							{
								var newBody = reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.normalize(body);
								{def : reflaxe.elixir.ast.ElixirASTDef.EDefp(name, params, guards, newBody), metadata : node.metadata, pos : node.pos};
							};
						};
					};
					default: {
						node;
					}
				};
			};
		});
	}

	static function normalize(body:reflaxe.elixir.ast.ElixirAST) {
		var declared = {
			{};
			new haxe.ds.StringMap();
		};
		var referenced = {
			{};
			new haxe.ds.StringMap();
		};
		reflaxe.elixir.ast.ASTUtils.walk(body, function(n:reflaxe.elixir.ast.ElixirAST) {
			if (n == null || n.def == null) {
				return;
			};
			@:ast(switch (n.def) {
	case EMatch(p, _):
		collectPatternDecls(p, declared);	
	case EBinary(Match, left, _):
		collectLhsDecls(left, declared);	
	case EFn(clauses):
		for (cl  in  clauses) for (a  in  cl.args) collectPatternDecls(a, declared);	
	default:
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 8: {
						var ` = `[0];
						var ` = `[1];
						{
							var p = `;
							{
								reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.collectPatternDecls(p, declared);
							};
						};
					};
					case 26: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						if (enumIndex ` == 27) {
							{
								var left = `;
								{
									reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.collectLhsDecls(left, declared);
								};
							};
						} else {};
					};
					case 42: {
						var ` = `[0];
						{
							var clauses = `;
							{
								{
									var ` = 0;
									while (` < clauses.length) {
										var cl = clauses[`];
										++ `;
										{
											var ` = 0;
											var ` = cl.args;
											while (` < `.length) {
												var a = `[`];
												++ `;
												reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.collectPatternDecls(a, declared);
											};
										};
									};
								};
							};
						};
					};
					default: {}
				};
			};
		});
		referenced = reflaxe.elixir.ast.analyzers.VariableUsageCollector.referencedInFunctionScope(body);
		var rename = {
			{};
			new haxe.ds.StringMap();
		};
		for (k in declared.keys()) {
			if (k.length > 1 && k.charAt(0) == "_") {
				var base = k.substr(1, null);
				if (k == "_value") {
					continue;
				};
				if ((referenced.exists(base) || referenced.exists(k)) && ! declared.exists(base)) {
					{
						rename.set(k, base);
					};
				};
			};
		};
		if (Lambda.count(cast rename, null) > 0) {
			haxe.Log.trace("[UnderscoreVarTransforms] renames: " + {
				var ` = [];
				for (k in rename.keys()) {
					`.push(k + "->" + cast rename.get(k));
				};
				`;
			}.join(", "), {fileName : "../../../../src/reflaxe/elixir/ast/transformers/UnderscoreVarTransforms.hx", lineNumber : 95, className : "reflaxe.elixir.ast.transformers.UnderscoreVarTransforms", methodName : "normalize"});
		};
		if (Lambda.count(cast rename, null) == 0) {
			return body;
		};
		var tx = function(n:reflaxe.elixir.ast.ElixirAST) {
			if (n == null || n.def == null) {
				return n;
			};
			return @:ast(switch (n.def) {
	case EMatch(p, rhs):
		var newP = renamePattern(p, rename);
		makeASTWithMeta(EMatch(newP, rhs), n.metadata, n.pos);	
	case EBinary(Match, left, rhs):
		var newLeft = renameLhs(left, rename);
		makeASTWithMeta(EBinary(Match, newLeft, rhs), n.metadata, n.pos);	
	case EVar(v) if (rename.exists(v)):
		makeASTWithMeta(EVar(rename.get(v)), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 8: {
						var ` = `[0];
						var ` = `[1];
						{
							var p = `;
							var rhs = `;
							{
								var newP = reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.renamePattern(p, rename);
								{def : reflaxe.elixir.ast.ElixirASTDef.EMatch(newP, rhs), metadata : n.metadata, pos : n.pos};
							};
						};
					};
					case 26: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						if (enumIndex ` == 27) {
							{
								var left = `;
								var rhs = `;
								{
									var newLeft = reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.renameLhs(left, rename);
									{def : reflaxe.elixir.ast.ElixirASTDef.EBinary(reflaxe.elixir.ast.EBinaryOp.Match, newLeft, rhs), metadata : n.metadata, pos : n.pos};
								};
							};
						} else {
							n;
						};
					};
					case 38: {
						var ` = `[0];
						{
							var v = `;
							if (rename.exists(v)) {
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EVar(rename.get(v));
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							} else {
								n;
							};
						};
					};
					default: {
						n;
					}
				};
			};
		};
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(body, tx);
	}

	static function collectPatternDecls(p:reflaxe.elixir.ast.EPattern, declared:Map<String, Bool>) {
		@:ast(switch (p) {
	case PVar(n):
		declared.set(n, true);	
	case PTuple(es) | PList(es):
		for (e  in  es) collectPatternDecls(e, declared);	
	case PCons(h, t):
		collectPatternDecls(h, declared);
		collectPatternDecls(t, declared);	
	case PMap(kvs):
		for (kv  in  kvs) collectPatternDecls(kv.value, declared);	
	case PStruct(_, fs):
		for (f  in  fs) collectPatternDecls(f.value, declared);	
	case PPin(inner):
		collectPatternDecls(inner, declared);	
	default:
}) switch (enumIndex p) {
			case 0: {
				var ` = p[0];
				{
					var n = `;
					{
						{
							declared.set(n, true);
						};
					};
				};
			};
			case 2: {
				var ` = p[0];
				{
					var es = `;
					{
						{
							var ` = 0;
							while (` < es.length) {
								var e = es[`];
								++ `;
								reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.collectPatternDecls(e, declared);
							};
						};
					};
				};
			};
			case 3: {
				var ` = p[0];
				{
					var es = `;
					{
						{
							var ` = 0;
							while (` < es.length) {
								var e = es[`];
								++ `;
								reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.collectPatternDecls(e, declared);
							};
						};
					};
				};
			};
			case 4: {
				var ` = p[0];
				var ` = p[1];
				{
					var h = `;
					var t = `;
					{
						reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.collectPatternDecls(h, declared);
						reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.collectPatternDecls(t, declared);
					};
				};
			};
			case 5: {
				var ` = p[0];
				{
					var kvs = `;
					{
						{
							var ` = 0;
							while (` < kvs.length) {
								var kv = kvs[`];
								++ `;
								reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.collectPatternDecls(kv.value, declared);
							};
						};
					};
				};
			};
			case 6: {
				var ` = p[0];
				var ` = p[1];
				{
					var fs = `;
					{
						{
							var ` = 0;
							while (` < fs.length) {
								var f = fs[`];
								++ `;
								reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.collectPatternDecls(f.value, declared);
							};
						};
					};
				};
			};
			case 7: {
				var ` = p[0];
				{
					var inner = `;
					{
						reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.collectPatternDecls(inner, declared);
					};
				};
			};
			default: {}
		};
	}

	static function collectLhsDecls(lhs:reflaxe.elixir.ast.ElixirAST, declared:Map<String, Bool>) {
		@:ast(switch (lhs.def) {
	case EVar(n):
		declared.set(n, true);	
	case EBinary(Match, l2, r2):
		collectLhsDecls(l2, declared);
		collectLhsDecls(r2, declared);	
	default:
}) {
			var ` = lhs.def;
			switch (enumIndex `) {
				case 26: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					if (enumIndex ` == 27) {
						{
							var l2 = `;
							var r2 = `;
							{
								reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.collectLhsDecls(l2, declared);
								reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.collectLhsDecls(r2, declared);
							};
						};
					} else {};
				};
				case 38: {
					var ` = `[0];
					{
						var n = `;
						{
							{
								declared.set(n, true);
							};
						};
					};
				};
				default: {}
			};
		};
	}

	static function renameLhs(lhs:reflaxe.elixir.ast.ElixirAST, rename:Map<String, String>) {
		return @:ast(switch (lhs.def) {
	case EVar(v) if (rename.exists(v)):
		makeASTWithMeta(EVar(rename.get(v)), lhs.metadata, lhs.pos);	
	case EBinary(Match, l2, r2):
		var nl = renameLhs(l2, rename);
		var nr = renameLhs(r2, rename);
		makeASTWithMeta(EBinary(Match, nl, nr), lhs.metadata, lhs.pos);	
	default:
		lhs;	
}) {
			var ` = lhs.def;
			switch (enumIndex `) {
				case 26: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					if (enumIndex ` == 27) {
						{
							var l2 = `;
							var r2 = `;
							{
								var nl = reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.renameLhs(l2, rename);
								var nr = reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.renameLhs(r2, rename);
								{def : reflaxe.elixir.ast.ElixirASTDef.EBinary(reflaxe.elixir.ast.EBinaryOp.Match, nl, nr), metadata : lhs.metadata, pos : lhs.pos};
							};
						};
					} else {
						lhs;
					};
				};
				case 38: {
					var ` = `[0];
					{
						var v = `;
						if (rename.exists(v)) {
							{
								var def = reflaxe.elixir.ast.ElixirASTDef.EVar(rename.get(v));
								var meta = lhs.metadata;
								var pos = lhs.pos;
								{def : def, metadata : meta, pos : pos};
							};
						} else {
							lhs;
						};
					};
				};
				default: {
					lhs;
				}
			};
		};
	}

	static function renamePattern(p:reflaxe.elixir.ast.EPattern, rename:Map<String, String>) {
		return @:ast(switch (p) {
	case PVar(n) if (rename.exists(n)):
		PVar(rename.get(n));	
	case PTuple(es):
		PTuple([for (e  in  es) renamePattern(e, rename)]);	
	case PList(es):
		PList([for (e  in  es) renamePattern(e, rename)]);	
	case PCons(h, t):
		PCons(renamePattern(h, rename), renamePattern(t, rename));	
	case PMap(kvs):
		PMap([for (kv  in  kvs) { key : kv.key, value : renamePattern(kv.value, rename) }]);	
	case PStruct(nm, fs):
		PStruct(nm, [for (f  in  fs) { key : f.key, value : renamePattern(f.value, rename) }]);	
	case PPin(inner):
		PPin(renamePattern(inner, rename));	
	default:
		p;	
}) switch (enumIndex p) {
			case 0: {
				var ` = p[0];
				{
					var n = `;
					if (rename.exists(n)) {
						reflaxe.elixir.ast.EPattern.PVar(cast rename.get(n));
					} else {
						p;
					};
				};
			};
			case 2: {
				var ` = p[0];
				{
					var es = `;
					{
						reflaxe.elixir.ast.EPattern.PTuple({
							var ` = [];
							{
								var ` = 0;
								while (` < es.length) {
									var e = es[`];
									++ `;
									`.push(reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.renamePattern(e, rename));
								};
							};
							`;
						});
					};
				};
			};
			case 3: {
				var ` = p[0];
				{
					var es = `;
					{
						reflaxe.elixir.ast.EPattern.PList({
							var ` = [];
							{
								var ` = 0;
								while (` < es.length) {
									var e = es[`];
									++ `;
									`.push(reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.renamePattern(e, rename));
								};
							};
							`;
						});
					};
				};
			};
			case 4: {
				var ` = p[0];
				var ` = p[1];
				{
					var h = `;
					var t = `;
					{
						reflaxe.elixir.ast.EPattern.PCons(reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.renamePattern(h, rename), reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.renamePattern(t, rename));
					};
				};
			};
			case 5: {
				var ` = p[0];
				{
					var kvs = `;
					{
						reflaxe.elixir.ast.EPattern.PMap({
							var ` = [];
							{
								var ` = 0;
								while (` < kvs.length) {
									var kv = kvs[`];
									++ `;
									`.push({key : kv.key, value : reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.renamePattern(kv.value, rename)});
								};
							};
							`;
						});
					};
				};
			};
			case 6: {
				var ` = p[0];
				var ` = p[1];
				{
					var nm = `;
					var fs = `;
					{
						reflaxe.elixir.ast.EPattern.PStruct(nm, {
							var ` = [];
							{
								var ` = 0;
								while (` < fs.length) {
									var f = fs[`];
									++ `;
									`.push({key : f.key, value : reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.renamePattern(f.value, rename)});
								};
							};
							`;
						});
					};
				};
			};
			case 7: {
				var ` = p[0];
				{
					var inner = `;
					{
						reflaxe.elixir.ast.EPattern.PPin(reflaxe.elixir.ast.transformers.UnderscoreVarTransforms.renamePattern(inner, rename));
					};
				};
			};
			default: {
				p;
			}
		};
	}
}