class reflaxe.elixir.ast.context.ElixirASTContext {

	public function new() {
		this.lookupFrequency = new haxe.ds.StringMap();
		this.nodeIdCounter = 0;
		this.currentPhase = reflaxe.elixir.ast.context.CompilationPhase.NotStarted;
		this.registeredBuilders = new haxe.ds.StringMap();
		this.featureFlags = new haxe.ds.StringMap();
		this.functionNameMap = new haxe.ds.StringMap();
		this.moduleNameMap = new haxe.ds.StringMap();
		this.testResults = new haxe.ds.StringMap();
		this.currentTestPath = null;
		this.enumBindingPlans = new haxe.ds.StringMap();
		this.loopContextStack = [];
		this.loopDepth = 0;
		this.isInPattern = false;
		this.idiomaticEnums = new haxe.ds.StringMap();
		this.enumTypeCache = new haxe.ds.StringMap();
		this.nodeMetadata = new haxe.ds.StringMap();
		this.clauseContextStack = [];
		this.tempVariableMap = new haxe.ds.StringMap();
		this.renamedVariableMap = new haxe.ds.IntMap();
		this.patternVariableRegistry = new haxe.ds.IntMap();
		this.globalVariableMap = new haxe.ds.IntMap();
		this.initializeFeatureFlags();
	}

	@:value(new Map())
	public var globalVariableMap:Map<Int, String>;

	@:value(new Map())
	public var patternVariableRegistry:Map<Int, String>;

	@:value(new Map())
	public var renamedVariableMap:Map<Int, { renamed : String, original : String }>;

	@:value(new Map())
	public var tempVariableMap:Map<String, String>;

	@:value([])
	public var clauseContextStack:Array<reflaxe.elixir.ast.context.ClauseContext>;

	@:value(new Map())
	public var nodeMetadata:Map<String, Dynamic>;

	@:value(new Map())
	public var enumTypeCache:Map<String, haxe.macro.EnumType>;

	@:value(new Map())
	public var idiomaticEnums:Map<String, Bool>;

	@:value(false)
	public var isInPattern:Bool;

	@:value(0)
	public var loopDepth:Int;

	@:value([])
	public var loopContextStack:Array<reflaxe.elixir.ast.LoopContext>;

	@:value(new Map())
	public var enumBindingPlans:Map<String, reflaxe.elixir.ast.context.EnumBindingPlan>;

	@:value(null)
	public var currentTestPath:String;

	@:value(new Map())
	public var testResults:Map<String, reflaxe.elixir.ast.context.TestResult>;

	@:value(new Map())
	public var moduleNameMap:Map<String, String>;

	@:value(new Map())
	public var functionNameMap:Map<String, String>;

	@:value(new Map())
	public var featureFlags:Map<String, Bool>;

	@:value(new Map())
	public var registeredBuilders:Map<String, reflaxe.elixir.ast.builders.IBuilder>;

	@:value(CompilationPhase.NotStarted)
	public var currentPhase:reflaxe.elixir.ast.context.CompilationPhase;

	@:value(0)
	var nodeIdCounter:Int;

	function initializeFeatureFlags() {
		{
			var this = this.featureFlags;
			cast this.set("use_new_pattern_builder", false);
		};
		{
			var this = this.featureFlags;
			cast this.set("use_new_loop_builder", false);
		};
		{
			var this = this.featureFlags;
			cast this.set("use_new_function_builder", false);
		};
		{
			var this = this.featureFlags;
			cast this.set("use_new_comprehension_builder", false);
		};
		{
			var this = this.featureFlags;
			cast this.set("enable_loop_to_comprehension", true);
		};
		{
			var this = this.featureFlags;
			cast this.set("enable_idiomatic_enums", true);
		};
		{
			var this = this.featureFlags;
			cast this.set("disable_redundant_extraction", false);
		};
		{
			var this = this.featureFlags;
			cast this.set("enable_pipe_operator", false);
		};
		{
			var this = this.featureFlags;
			cast this.set("preserve_integer_indices", false);
		};
	}

	public function resolveVariable(tvarId:Int, defaultName:String) {
		if ({
			var this = this.patternVariableRegistry;
			cast this.exists(tvarId);
		}) {
			return {
				var this = this.patternVariableRegistry;
				cast this.get(tvarId);
			};
		};
		var currentClause = this.getCurrentClauseContext();
		if (currentClause != null && {
			var this = currentClause.localToName;
			cast this.exists(tvarId);
		}) {
			return {
				var this = currentClause.localToName;
				cast this.get(tvarId);
			};
		};
		if ({
			var this = this.globalVariableMap;
			cast this.exists(tvarId);
		}) {
			return {
				var this = this.globalVariableMap;
				cast this.get(tvarId);
			};
		};
		return defaultName;
	}

	public function registerPatternVariable(tvarId:Int, patternName:String) {
		{
			var this = this.patternVariableRegistry;
			cast this.set(tvarId, patternName);
		};
	}

	public function registerTempMapping(tempName:String, actualName:String) {
		{
			var this = this.tempVariableMap;
			cast this.set(tempName, actualName);
		};
	}

	public function registerRenamedVariable(tvarId:Int, originalName:String, renamedName:String) {
		{
			var this = this.renamedVariableMap;
			cast this.set(tvarId, {original : originalName, renamed : renamedName});
		};
		{
			var this = this.globalVariableMap;
			cast this.set(tvarId, renamedName);
		};
	}

	public function getRenamedMapping(tvarId:Int) {
		return {
			var this = this.renamedVariableMap;
			cast this.get(tvarId);
		};
	}

	public function findRenamedVariableByOriginalName(name:String) {
		for (id in {
			var this = this.renamedVariableMap;
			cast this.keys();
		}) {
			var mapping = {
				var this = this.renamedVariableMap;
				cast this.get(id);
			};
			if (mapping != null && mapping.original == name) {
				return id;
			};
		};
		return null;
	}

	public function pushClauseContext(context:reflaxe.elixir.ast.context.ClauseContext) {
		this.clauseContextStack.push(context);
	}

	public function popClauseContext() {
		return this.clauseContextStack.pop();
	}

	public function getCurrentClauseContext() {
		return if (this.clauseContextStack.length > 0) {
			this.clauseContextStack[this.clauseContextStack.length - 1];
		} else {
			null;
		};
	}

	public function setNodeMetadata(nodeId:String, metadata:Dynamic) {
		{
			var this = this.nodeMetadata;
			cast this.set(nodeId, cast metadata);
		};
	}

	public function getNodeMetadata(nodeId:String) {
		return {
			var this = this.nodeMetadata;
			cast this.get(nodeId);
		};
	}

	public function isIdiomaticEnum(enumName:String, enumType:haxe.macro.EnumType) {
		if (! {
			var this = this.idiomaticEnums;
			cast this.exists(enumName);
		}) {
			var isIdiomatic = enumType != null && enumType.meta.has(":elixirIdiomatic");
			{
				var this = this.idiomaticEnums;
				cast this.set(enumName, isIdiomatic);
			};
		};
		return {
			var this = this.idiomaticEnums;
			cast this.get(enumName);
		};
	}

	public function storeEnumBindingPlan(id:String, plan:reflaxe.elixir.ast.context.EnumBindingPlan) {
		{
			var this = this.enumBindingPlans;
			cast this.set(id, plan);
		};
	}

	@:value(new Map())
	var lookupFrequency:Map<String, Int>;

	public function getEnumBindingPlan(id:String) {
		var plan = {
			var this = this.enumBindingPlans;
			cast this.get(id);
		};
		return plan;
	}

	public function startTest(testPath:String) {
		this.currentTestPath = testPath;
		{
			var this = this.testResults;
			cast this.set(testPath, reflaxe.elixir.ast.context.TestResult.InProgress);
		};
	}

	public function completeTest(success:Bool) {
		if (this.currentTestPath != null) {
			{
				var this = this.testResults;
				var key = this.currentTestPath;
				cast this.set(key, if ((success)) reflaxe.elixir.ast.context.TestResult.Success else reflaxe.elixir.ast.context.TestResult.Failure);
			};
			this.currentTestPath = null;
		};
	}

	public function getTestResults() {
		return {
			var this = this.testResults;
			cast cast cast this.copy();
		};
	}

	public function getModuleName(originalName:String) {
		if (! {
			var this = this.moduleNameMap;
			cast this.exists(originalName);
		}) {
			var transformed = this.transformModuleName(originalName);
			{
				var this = this.moduleNameMap;
				cast this.set(originalName, transformed);
			};
		};
		return {
			var this = this.moduleNameMap;
			cast this.get(originalName);
		};
	}

	public function getFunctionName(originalName:String) {
		if (! {
			var this = this.functionNameMap;
			cast this.exists(originalName);
		}) {
			var transformed = this.transformFunctionName(originalName);
			{
				var this = this.functionNameMap;
				cast this.set(originalName, transformed);
			};
		};
		return {
			var this = this.functionNameMap;
			cast this.get(originalName);
		};
	}

	function transformModuleName(name:String) {
		return name;
	}

	function transformFunctionName(name:String) {
		return name;
	}

	public function isFeatureEnabled(flag:String) {
		return {
			var this = this.featureFlags;
			cast this.exists(flag);
		} && {
			var this = this.featureFlags;
			cast this.get(flag);
		};
	}

	public function setFeatureFlag(flag:String, enabled:Bool) {
		{
			var this = this.featureFlags;
			cast this.set(flag, enabled);
		};
	}

	public function registerBuilder(builderType:String, builder:reflaxe.elixir.ast.builders.IBuilder) {
		if (builder.getType() != builderType) {
			throw "Builder type mismatch: expected " + builderType + ", got " + builder.getType();
		};
		if (! builder.isReady()) {
			throw "Builder " + builderType + " is not ready for registration";
		};
		{
			var this = this.registeredBuilders;
			cast this.set(builderType, builder);
		};
	}

	public function getBuilder(builderType:String) {
		return {
			var this = this.registeredBuilders;
			cast this.get(builderType);
		};
	}

	public function beginCompilation() {
		{
			var this = this.globalVariableMap;
			cast this.clear();
		};
		{
			var this = this.patternVariableRegistry;
			cast this.clear();
		};
		{
			var this = this.tempVariableMap;
			cast this.clear();
		};
		{
			var this = this.renamedVariableMap;
			cast this.clear();
		};
		this.clauseContextStack = [];
		{
			var this = this.nodeMetadata;
			cast this.clear();
		};
		{
			var this = this.testResults;
			cast this.clear();
		};
		{
			var this = this.enumBindingPlans;
			cast this.clear();
		};
		this.nodeIdCounter = 0;
		this.currentTestPath = null;
		this.currentPhase = reflaxe.elixir.ast.context.CompilationPhase.Building;
	}

	public function beginTransformation() {
		if (this.currentPhase != reflaxe.elixir.ast.context.CompilationPhase.Building) {
			throw "Invalid phase transition: " + Std.string(this.currentPhase) + " -> Transformation";
		};
		this.currentPhase = reflaxe.elixir.ast.context.CompilationPhase.Transforming;
	}

	public function beginPrinting() {
		if (this.currentPhase != reflaxe.elixir.ast.context.CompilationPhase.Transforming) {
			throw "Invalid phase transition: " + Std.string(this.currentPhase) + " -> Printing";
		};
		this.currentPhase = reflaxe.elixir.ast.context.CompilationPhase.Printing;
	}

	public function endCompilation() {
		this.currentPhase = reflaxe.elixir.ast.context.CompilationPhase.Completed;
	}

	public function generateNodeId() {
		return "node_" + this.nodeIdCounter ++;
	}

	public function reset() {
		{
			var this = this.globalVariableMap;
			cast this.clear();
		};
		{
			var this = this.patternVariableRegistry;
			cast this.clear();
		};
		{
			var this = this.tempVariableMap;
			cast this.clear();
		};
		{
			var this = this.renamedVariableMap;
			cast this.clear();
		};
		this.clauseContextStack = [];
		{
			var this = this.nodeMetadata;
			cast this.clear();
		};
		{
			var this = this.enumTypeCache;
			cast this.clear();
		};
		{
			var this = this.idiomaticEnums;
			cast this.clear();
		};
		{
			var this = this.testResults;
			cast this.clear();
		};
		{
			var this = this.moduleNameMap;
			cast this.clear();
		};
		{
			var this = this.functionNameMap;
			cast this.clear();
		};
		{
			var this = this.enumBindingPlans;
			cast this.clear();
		};
		this.nodeIdCounter = 0;
		this.currentTestPath = null;
		this.currentPhase = reflaxe.elixir.ast.context.CompilationPhase.NotStarted;
		this.initializeFeatureFlags();
	}
}