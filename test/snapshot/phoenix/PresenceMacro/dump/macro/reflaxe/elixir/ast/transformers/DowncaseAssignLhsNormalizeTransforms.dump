class reflaxe.elixir.ast.transformers.DowncaseAssignLhsNormalizeTransforms {

	public static function pass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EBinary(Match, left, right):
		var p = extractDowncaseVar(right);
		if (p != null && isDowncaseCallOf(left, p)) {
			Sys.println("[DowncaseAssignLhsNormalize] fixing LHS to " + p);
			makeASTWithMeta(EBinary(Match, makeAST(EVar(p)), right), n.metadata, n.pos);
		} else n;	
	case EMatch(pat, rhs):
		var p2 = extractDowncaseVar(rhs);
		n;	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 8: {
						var ` = `[0];
						var ` = `[1];
						{
							var pat = `;
							var rhs = `;
							{
								var p2 = reflaxe.elixir.ast.transformers.DowncaseAssignLhsNormalizeTransforms.extractDowncaseVar(rhs);
								n;
							};
						};
					};
					case 26: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						if (enumIndex ` == 27) {
							{
								var left = `;
								var right = `;
								{
									var p = reflaxe.elixir.ast.transformers.DowncaseAssignLhsNormalizeTransforms.extractDowncaseVar(right);
									if (p != null && reflaxe.elixir.ast.transformers.DowncaseAssignLhsNormalizeTransforms.isDowncaseCallOf(left, p)) {
										Sys.println("[DowncaseAssignLhsNormalize] fixing LHS to " + p);
										{def : reflaxe.elixir.ast.ElixirASTDef.EBinary(reflaxe.elixir.ast.EBinaryOp.Match, {
											var pos = null;
											{def : reflaxe.elixir.ast.ElixirASTDef.EVar(p), metadata : {}, pos : pos};
										}, right), metadata : n.metadata, pos : n.pos};
									} else {
										n;
									};
								};
							};
						} else {
							n;
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}

	static function extractDowncaseVar(e:reflaxe.elixir.ast.ElixirAST) {
		return @:ast(switch (e.def) {
	case ERemoteCall({ def : EVar(m) }, "downcase", args) if (m == "String" && args != null && args.length == 1):
		switch (args[0].def) {
			case EVar(v):
				v;			
			default:
				null;			
		};	
	default:
		null;	
}) {
			var ` = e.def;
			if (enumIndex ` == 24) {
				var ` = `[0];
				var ` = `[1];
				var ` = `[2];
				{
					var ` = `.def;
					var ` = `.metadata;
					var ` = `.pos;
					if (enumIndex ` == 38) {
						var ` = `[0];
						if (` == "downcase") {
							{
								var m = `;
								var args = `;
								if (m == "String" && args != null && args.length == 1) {
									@:ast(switch (args[0].def) {
	case EVar(v):
		v;	
	default:
		null;	
}) {
										var ` = args[0].def;
										if (enumIndex ` == 38) {
											var ` = `[0];
											{
												var v = `;
												{
													v;
												};
											};
										} else {
											null;
										};
									};
								} else {
									null;
								};
							};
						} else {
							null;
						};
					} else {
						null;
					};
				};
			} else {
				null;
			};
		};
	}

	static function isDowncaseCallOf(e:reflaxe.elixir.ast.ElixirAST, name:String) {
		return @:ast(switch (e.def) {
	case ERemoteCall({ def : EVar(m) }, "downcase", args):
		if (m != "String" || args == null || args.length != 1) false else switch (args[0].def) {
			case EVar(v) if (v == name):
				true;			
			default:
				false;			
		};	
	default:
		false;	
}) {
			var ` = e.def;
			if (enumIndex ` == 24) {
				var ` = `[0];
				var ` = `[1];
				var ` = `[2];
				{
					var ` = `.def;
					var ` = `.metadata;
					var ` = `.pos;
					if (enumIndex ` == 38) {
						var ` = `[0];
						if (` == "downcase") {
							{
								var m = `;
								var args = `;
								{
									if (m != "String" || args == null || args.length != 1) {
										false;
									} else {
										@:ast(switch (args[0].def) {
	case EVar(v) if (v == name):
		true;	
	default:
		false;	
}) {
											var ` = args[0].def;
											if (enumIndex ` == 38) {
												var ` = `[0];
												{
													var v = `;
													if (v == name) {
														true;
													} else {
														false;
													};
												};
											} else {
												false;
											};
										};
									};
								};
							};
						} else {
							false;
						};
					} else {
						false;
					};
				};
			} else {
				false;
			};
		};
	}
}