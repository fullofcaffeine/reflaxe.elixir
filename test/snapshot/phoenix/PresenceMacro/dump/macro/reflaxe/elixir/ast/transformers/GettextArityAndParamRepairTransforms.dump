class reflaxe.elixir.ast.transformers.GettextArityAndParamRepairTransforms {

	static inline function endsWithGettext(name:String) {
		return name != null && StringTools.endsWith(name, ".Gettext");
	}

	static function bodyUsesName(body:reflaxe.elixir.ast.ElixirAST, name:String) {
		var found = [false];
		if (name == null || name.length == 0) {
			return false;
		};
		reflaxe.elixir.ast.ElixirASTTransformer.transformNode(body, function(n:reflaxe.elixir.ast.ElixirAST) {
			if (found[0]) {
				return n;
			};
			@:ast(switch (n.def) {
	case EVar(v) if (v == name):
		found = true;
		return n;	
	case ERaw(code):
		if (code != null && code.indexOf(name) != -1) {
			var i = 0;
			inline function isIdent(c:String):Bool {
				if (c == null || c.length == 0) return false;
				var ch = c.charCodeAt(0);
				return (ch >= "0".code && ch <= "9".code) || (ch >= "A".code && ch <= "Z".code) || (ch >= "a".code && ch <= "z".code) || c == "_";
			};
			while (true) {
				var idx = code.indexOf(name, i);
				if (idx == -1) break;
				var before = idx > 0 ? code.substr(idx - 1, 1) : null;
				var afterIdx = idx + name.length;
				var after = afterIdx < code.length ? code.substr(afterIdx, 1) : null;
				if (!isIdent(before) && !isIdent(after)) {
					found = true;
					break;
				};
				i = idx + name.length;
			};
		};
		return n;	
	default:
		return n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 38: {
						var ` = `[0];
						{
							var v = `;
							if (v == name) {
								found[0] = true;
								return n;
							} else {
								return n;
							};
						};
					};
					case 62: {
						var ` = `[0];
						{
							var code = `;
							{
								if (code != null && code.indexOf(name, null) != -1) {
									var i = 0;
									{};
									while (true) {
										var idx = code.indexOf(name, i);
										if (idx == -1) {
											break;
										};
										var before = if (idx > 0) {
											code.substr(idx - 1, 1);
										} else {
											null;
										};
										var afterIdx = idx + name.length;
										var after = if (afterIdx < code.length) {
											code.substr(afterIdx, 1);
										} else {
											null;
										};
										if (! if (before == null || before.length == 0) {
											false;
										} else {
											var ch = before.charCodeAt(0);
											(ch >= 48 && ch <= 57) || (ch >= 65 && ch <= 90) || (ch >= 97 && ch <= 122) || before == "_";
										} && ! if (after == null || after.length == 0) {
											false;
										} else {
											var ch = after.charCodeAt(0);
											(ch >= 48 && ch <= 57) || (ch >= 65 && ch <= 90) || (ch >= 97 && ch <= 122) || after == "_";
										}) {
											found[0] = true;
											break;
										};
										i = idx + name.length;
									};
								};
								return n;
							};
						};
					};
					default: {
						return n;
					}
				};
			};
		});
		return found[0];
	}

	static function repairParams(args:Array<reflaxe.elixir.ast.EPattern>, body:reflaxe.elixir.ast.ElixirAST) {
		if (args == null) {
			return args;
		};
		return {
			var ` = [];
			{
				var ` = 0;
				while (` < args.length) {
					var a = args[`];
					++ `;
					`.push(@:ast(switch (a) {
	case PVar(nm) if (nm != null && nm.length > 1 && nm.charAt(0) == "_" && bodyUsesName(body, nm.substr(1))):
		PVar(nm.substr(1));	
	default:
		a;	
}) if (enumIndex a == 0) {
						var ` = a[0];
						{
							var nm = `;
							if (nm != null && nm.length > 1 && nm.charAt(0) == "_" && reflaxe.elixir.ast.transformers.GettextArityAndParamRepairTransforms.bodyUsesName(body, nm.substr(1, null))) {
								reflaxe.elixir.ast.EPattern.PVar(nm.substr(1, null));
							} else {
								a;
							};
						};
					} else {
						a;
					});
				};
			};
			`;
		};
	}

	static function functionSigSet(body:Array<reflaxe.elixir.ast.ElixirAST>) {
		var map = {
			{};
			new haxe.ds.StringMap();
		};
		{
			var ` = 0;
			while (` < body.length) {
				var b = body[`];
				++ `;
				@:ast(switch (b.def) {
	case EDef(nm, args, _, _):
		var m = map.exists(nm) ? map.get(nm) : new Map<Int,Bool>();
		m.set(args != null ? args.length : 0, true);
		map.set(nm, m);	
	case EDefp(nm2, args2, _, _):
		var m2 = map.exists(nm2) ? map.get(nm2) : new Map<Int,Bool>();
		m2.set(args2 != null ? args2.length : 0, true);
		map.set(nm2, m2);	
	default:
}) {
					var ` = b.def;
					switch (enumIndex `) {
						case 2: {
							var ` = `[0];
							var ` = `[1];
							var ` = `[2];
							var ` = `[3];
							{
								var nm = `;
								var args = `;
								{
									var m = if (map.exists(nm)) {
										cast map.get(nm);
									} else {
										{
											{};
											new haxe.ds.IntMap();
										};
									};
									{
										var key = if ((args != null)) args.length else 0;
										m.set(key, true);
									};
									{
										map.set(nm, m);
									};
								};
							};
						};
						case 3: {
							var ` = `[0];
							var ` = `[1];
							var ` = `[2];
							var ` = `[3];
							{
								var nm2 = `;
								var args2 = `;
								{
									var m2 = if (map.exists(nm2)) {
										cast map.get(nm2);
									} else {
										{
											{};
											new haxe.ds.IntMap();
										};
									};
									{
										var key = if ((args2 != null)) args2.length else 0;
										m2.set(key, true);
									};
									{
										map.set(nm2, m2);
									};
								};
							};
						};
						default: {}
					};
				};
			};
		};
		return map;
	}

	static function insertArityShims(body:Array<reflaxe.elixir.ast.ElixirAST>) {
		var sigs = reflaxe.elixir.ast.transformers.GettextArityAndParamRepairTransforms.functionSigSet(body);
		var out = body.copy();
		{};
		if (sigs.exists("gettext") && {
			var this = sigs.get("gettext");
			cast this.exists(2);
		} && ! sigs.exists("gettext") && {
			var this = sigs.get("gettext");
			cast this.exists(1);
		}) {
			out.unshift({
				var pos = null;
				{def : reflaxe.elixir.ast.ElixirASTDef.EDef("gettext", [reflaxe.elixir.ast.EPattern.PVar("msgid")], null, {
					var pos = null;
					{def : reflaxe.elixir.ast.ElixirASTDef.ECall(null, "gettext", [{
						var pos = null;
						{def : reflaxe.elixir.ast.ElixirASTDef.EVar("msgid"), metadata : {}, pos : pos};
					}, {
						var pos = null;
						{def : reflaxe.elixir.ast.ElixirASTDef.EMap([]), metadata : {}, pos : pos};
					}]), metadata : {}, pos : pos};
				}), metadata : {}, pos : pos};
			});
		};
		if (sigs.exists("dgettext") && {
			var this = sigs.get("dgettext");
			cast this.exists(3);
		} && ! sigs.exists("dgettext") && {
			var this = sigs.get("dgettext");
			cast this.exists(2);
		}) {
			out.unshift({
				var pos = null;
				{def : reflaxe.elixir.ast.ElixirASTDef.EDef("dgettext", [reflaxe.elixir.ast.EPattern.PVar("domain"), reflaxe.elixir.ast.EPattern.PVar("msgid")], null, {
					var pos = null;
					{def : reflaxe.elixir.ast.ElixirASTDef.ECall(null, "dgettext", [{
						var pos = null;
						{def : reflaxe.elixir.ast.ElixirASTDef.EVar("domain"), metadata : {}, pos : pos};
					}, {
						var pos = null;
						{def : reflaxe.elixir.ast.ElixirASTDef.EVar("msgid"), metadata : {}, pos : pos};
					}, {
						var pos = null;
						{def : reflaxe.elixir.ast.ElixirASTDef.EMap([]), metadata : {}, pos : pos};
					}]), metadata : {}, pos : pos};
				}), metadata : {}, pos : pos};
			});
		};
		if (sigs.exists("ngettext") && {
			var this = sigs.get("ngettext");
			cast this.exists(4);
		} && ! sigs.exists("ngettext") && {
			var this = sigs.get("ngettext");
			cast this.exists(3);
		}) {
			out.unshift({
				var pos = null;
				{def : reflaxe.elixir.ast.ElixirASTDef.EDef("ngettext", [reflaxe.elixir.ast.EPattern.PVar("msgid"), reflaxe.elixir.ast.EPattern.PVar("msgid_plural"), reflaxe.elixir.ast.EPattern.PVar("count")], null, {
					var pos = null;
					{def : reflaxe.elixir.ast.ElixirASTDef.ECall(null, "ngettext", [{
						var pos = null;
						{def : reflaxe.elixir.ast.ElixirASTDef.EVar("msgid"), metadata : {}, pos : pos};
					}, {
						var pos = null;
						{def : reflaxe.elixir.ast.ElixirASTDef.EVar("msgid_plural"), metadata : {}, pos : pos};
					}, {
						var pos = null;
						{def : reflaxe.elixir.ast.ElixirASTDef.EVar("count"), metadata : {}, pos : pos};
					}, {
						var pos = null;
						{def : reflaxe.elixir.ast.ElixirASTDef.EMap([]), metadata : {}, pos : pos};
					}]), metadata : {}, pos : pos};
				}), metadata : {}, pos : pos};
			});
		};
		if (sigs.exists("dngettext") && {
			var this = sigs.get("dngettext");
			cast this.exists(5);
		} && ! sigs.exists("dngettext") && {
			var this = sigs.get("dngettext");
			cast this.exists(4);
		}) {
			out.unshift({
				var pos = null;
				{def : reflaxe.elixir.ast.ElixirASTDef.EDef("dngettext", [reflaxe.elixir.ast.EPattern.PVar("domain"), reflaxe.elixir.ast.EPattern.PVar("msgid"), reflaxe.elixir.ast.EPattern.PVar("msgid_plural"), reflaxe.elixir.ast.EPattern.PVar("count")], null, {
					var pos = null;
					{def : reflaxe.elixir.ast.ElixirASTDef.ECall(null, "dngettext", [{
						var pos = null;
						{def : reflaxe.elixir.ast.ElixirASTDef.EVar("domain"), metadata : {}, pos : pos};
					}, {
						var pos = null;
						{def : reflaxe.elixir.ast.ElixirASTDef.EVar("msgid"), metadata : {}, pos : pos};
					}, {
						var pos = null;
						{def : reflaxe.elixir.ast.ElixirASTDef.EVar("msgid_plural"), metadata : {}, pos : pos};
					}, {
						var pos = null;
						{def : reflaxe.elixir.ast.ElixirASTDef.EVar("count"), metadata : {}, pos : pos};
					}, {
						var pos = null;
						{def : reflaxe.elixir.ast.ElixirASTDef.EMap([]), metadata : {}, pos : pos};
					}]), metadata : {}, pos : pos};
				}), metadata : {}, pos : pos};
			});
		};
		return out;
	}

	public static function transformPass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EModule(name, attrs, body) if (endsWithGettext(name)):
		var repaired = [for (b  in  body) switch (b.def) {
			case EDef(nm, args, guards, bd):
				var newArgs = repairParams(args, bd);
				var newBody = (nm == "error" && newArgs != null && newArgs.length == 2) ? (function() {
					return ElixirASTTransformer.transformNode(bd, function(x:ElixirAST):ElixirAST {
						return switch (x.def) {
							case ECall(null, fn, callArgs) if (fn == "gettext" && callArgs != null && callArgs.length == 1):
								makeAST(ERemoteCall(makeAST(EVar(name)), "gettext", [callArgs[0], makeAST(EMap([]))]));							
							default:
								x;							
						};
					});
				})() : bd;
				makeAST(EDef(nm, newArgs, guards, newBody));			
			case EDefp(nm2, args2, guards2, bd2):
				makeAST(EDefp(nm2, repairParams(args2, bd2), guards2, bd2));			
			default:
				b;			
		}];
		var withShims = insertArityShims(repaired);
		makeASTWithMeta(EModule(name, attrs, withShims), n.metadata, n.pos);	
	case EDefmodule(name2, doBlock) if (endsWithGettext(name2)):
		var stmts:Array<ElixirAST> = switch (doBlock.def) {
			case EBlock(ss):
				ss;			
			case EDo(ss2):
				ss2;			
			default:
				[doBlock];			
		};
		var repaired2 = [for (b  in  stmts) switch (b.def) {
			case EDef(nm, args, guards, bd):
				var newArgs = repairParams(args, bd);
				var newBody = (nm == "error" && newArgs != null && newArgs.length == 2) ? (function() {
					return ElixirASTTransformer.transformNode(bd, function(x:ElixirAST):ElixirAST {
						return switch (x.def) {
							case ECall(null, fn, callArgs) if (fn == "gettext" && callArgs != null && callArgs.length == 1):
								makeAST(ERemoteCall(makeAST(EVar(name2)), "gettext", [callArgs[0], makeAST(EMap([]))]));							
							default:
								x;							
						};
					});
				})() : bd;
				makeAST(EDef(nm, newArgs, guards, newBody));			
			case EDefp(nm2, args2, guards2, bd2):
				makeAST(EDefp(nm2, repairParams(args2, bd2), guards2, bd2));			
			default:
				b;			
		}];
		var withShims2 = insertArityShims(repaired2);
		var newDo:ElixirAST = switch (doBlock.def) {
			case EBlock(_):
				makeASTWithMeta(EBlock(withShims2), doBlock.metadata, doBlock.pos);			
			case EDo(_):
				makeASTWithMeta(EDo(withShims2), doBlock.metadata, doBlock.pos);			
			default:
				doBlock;			
		};
		makeASTWithMeta(EDefmodule(name2, newDo), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 0: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var name = `;
							var attrs = `;
							var body = `;
							if (name != null && StringTools.endsWith(name, ".Gettext")) {
								var repaired = {
									var ` = [];
									{
										var ` = 0;
										while (` < body.length) {
											var b = body[`];
											++ `;
											`.push(@:ast(switch (b.def) {
	case EDef(nm, args, guards, bd):
		var newArgs = repairParams(args, bd);
		var newBody = (nm == "error" && newArgs != null && newArgs.length == 2) ? (function() {
			return ElixirASTTransformer.transformNode(bd, function(x:ElixirAST):ElixirAST {
				return switch (x.def) {
					case ECall(null, fn, callArgs) if (fn == "gettext" && callArgs != null && callArgs.length == 1):
						makeAST(ERemoteCall(makeAST(EVar(name)), "gettext", [callArgs[0], makeAST(EMap([]))]));					
					default:
						x;					
				};
			});
		})() : bd;
		makeAST(EDef(nm, newArgs, guards, newBody));	
	case EDefp(nm2, args2, guards2, bd2):
		makeAST(EDefp(nm2, repairParams(args2, bd2), guards2, bd2));	
	default:
		b;	
}) {
												var ` = b.def;
												switch (enumIndex `) {
													case 2: {
														var ` = `[0];
														var ` = `[1];
														var ` = `[2];
														var ` = `[3];
														{
															var nm = `;
															var args = `;
															var guards = `;
															var bd = `;
															{
																var newArgs = reflaxe.elixir.ast.transformers.GettextArityAndParamRepairTransforms.repairParams(args, bd);
																var newBody = if ((nm == "error" && newArgs != null && newArgs.length == 2)) {
																	(function() {
																		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(bd, function(x:reflaxe.elixir.ast.ElixirAST) {
																			return @:ast(switch (x.def) {
	case ECall(null, fn, callArgs) if (fn == "gettext" && callArgs != null && callArgs.length == 1):
		makeAST(ERemoteCall(makeAST(EVar(name)), "gettext", [callArgs[0], makeAST(EMap([]))]));	
	default:
		x;	
}) {
																				var ` = x.def;
																				if (enumIndex ` == 22) {
																					var ` = `[0];
																					var ` = `[1];
																					var ` = `[2];
																					if (` == null) {
																						var fn = `;
																						var callArgs = `;
																						if (fn == "gettext" && callArgs != null && callArgs.length == 1) {
																							{
																								var pos = null;
																								{def : reflaxe.elixir.ast.ElixirASTDef.ERemoteCall({
																									var pos = null;
																									{def : reflaxe.elixir.ast.ElixirASTDef.EVar(name), metadata : {}, pos : pos};
																								}, "gettext", [callArgs[0], {
																									var pos = null;
																									{def : reflaxe.elixir.ast.ElixirASTDef.EMap([]), metadata : {}, pos : pos};
																								}]), metadata : {}, pos : pos};
																							};
																						} else {
																							x;
																						};
																					} else {
																						x;
																					};
																				} else {
																					x;
																				};
																			};
																		});
																	})();
																} else {
																	bd;
																};
																{
																	var pos = null;
																	{def : reflaxe.elixir.ast.ElixirASTDef.EDef(nm, newArgs, guards, newBody), metadata : {}, pos : pos};
																};
															};
														};
													};
													case 3: {
														var ` = `[0];
														var ` = `[1];
														var ` = `[2];
														var ` = `[3];
														{
															var nm2 = `;
															var args2 = `;
															var guards2 = `;
															var bd2 = `;
															{
																{
																	var def = reflaxe.elixir.ast.ElixirASTDef.EDefp(nm2, reflaxe.elixir.ast.transformers.GettextArityAndParamRepairTransforms.repairParams(args2, bd2), guards2, bd2);
																	var pos = null;
																	{def : def, metadata : {}, pos : pos};
																};
															};
														};
													};
													default: {
														b;
													}
												};
											});
										};
									};
									`;
								};
								var withShims = reflaxe.elixir.ast.transformers.GettextArityAndParamRepairTransforms.insertArityShims(repaired);
								{def : reflaxe.elixir.ast.ElixirASTDef.EModule(name, attrs, withShims), metadata : n.metadata, pos : n.pos};
							} else {
								n;
							};
						};
					};
					case 1: {
						var ` = `[0];
						var ` = `[1];
						{
							var name2 = `;
							var doBlock = `;
							if (name2 != null && StringTools.endsWith(name2, ".Gettext")) {
								var stmts = @:ast(switch (doBlock.def) {
	case EBlock(ss):
		ss;	
	case EDo(ss2):
		ss2;	
	default:
		[doBlock];	
}) {
									var ` = doBlock.def;
									switch (enumIndex `) {
										case 53: {
											var ` = `[0];
											{
												var ss = `;
												{
													ss;
												};
											};
										};
										case 55: {
											var ` = `[0];
											{
												var ss2 = `;
												{
													ss2;
												};
											};
										};
										default: {
											[doBlock];
										}
									};
								};
								var repaired2 = {
									var ` = [];
									{
										var ` = 0;
										while (` < stmts.length) {
											var b = stmts[`];
											++ `;
											`.push(@:ast(switch (b.def) {
	case EDef(nm, args, guards, bd):
		var newArgs = repairParams(args, bd);
		var newBody = (nm == "error" && newArgs != null && newArgs.length == 2) ? (function() {
			return ElixirASTTransformer.transformNode(bd, function(x:ElixirAST):ElixirAST {
				return switch (x.def) {
					case ECall(null, fn, callArgs) if (fn == "gettext" && callArgs != null && callArgs.length == 1):
						makeAST(ERemoteCall(makeAST(EVar(name2)), "gettext", [callArgs[0], makeAST(EMap([]))]));					
					default:
						x;					
				};
			});
		})() : bd;
		makeAST(EDef(nm, newArgs, guards, newBody));	
	case EDefp(nm2, args2, guards2, bd2):
		makeAST(EDefp(nm2, repairParams(args2, bd2), guards2, bd2));	
	default:
		b;	
}) {
												var ` = b.def;
												switch (enumIndex `) {
													case 2: {
														var ` = `[0];
														var ` = `[1];
														var ` = `[2];
														var ` = `[3];
														{
															var nm = `;
															var args = `;
															var guards = `;
															var bd = `;
															{
																var newArgs = reflaxe.elixir.ast.transformers.GettextArityAndParamRepairTransforms.repairParams(args, bd);
																var newBody = if ((nm == "error" && newArgs != null && newArgs.length == 2)) {
																	(function() {
																		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(bd, function(x:reflaxe.elixir.ast.ElixirAST) {
																			return @:ast(switch (x.def) {
	case ECall(null, fn, callArgs) if (fn == "gettext" && callArgs != null && callArgs.length == 1):
		makeAST(ERemoteCall(makeAST(EVar(name2)), "gettext", [callArgs[0], makeAST(EMap([]))]));	
	default:
		x;	
}) {
																				var ` = x.def;
																				if (enumIndex ` == 22) {
																					var ` = `[0];
																					var ` = `[1];
																					var ` = `[2];
																					if (` == null) {
																						var fn = `;
																						var callArgs = `;
																						if (fn == "gettext" && callArgs != null && callArgs.length == 1) {
																							{
																								var pos = null;
																								{def : reflaxe.elixir.ast.ElixirASTDef.ERemoteCall({
																									var pos = null;
																									{def : reflaxe.elixir.ast.ElixirASTDef.EVar(name2), metadata : {}, pos : pos};
																								}, "gettext", [callArgs[0], {
																									var pos = null;
																									{def : reflaxe.elixir.ast.ElixirASTDef.EMap([]), metadata : {}, pos : pos};
																								}]), metadata : {}, pos : pos};
																							};
																						} else {
																							x;
																						};
																					} else {
																						x;
																					};
																				} else {
																					x;
																				};
																			};
																		});
																	})();
																} else {
																	bd;
																};
																{
																	var pos = null;
																	{def : reflaxe.elixir.ast.ElixirASTDef.EDef(nm, newArgs, guards, newBody), metadata : {}, pos : pos};
																};
															};
														};
													};
													case 3: {
														var ` = `[0];
														var ` = `[1];
														var ` = `[2];
														var ` = `[3];
														{
															var nm2 = `;
															var args2 = `;
															var guards2 = `;
															var bd2 = `;
															{
																{
																	var def = reflaxe.elixir.ast.ElixirASTDef.EDefp(nm2, reflaxe.elixir.ast.transformers.GettextArityAndParamRepairTransforms.repairParams(args2, bd2), guards2, bd2);
																	var pos = null;
																	{def : def, metadata : {}, pos : pos};
																};
															};
														};
													};
													default: {
														b;
													}
												};
											});
										};
									};
									`;
								};
								var withShims2 = reflaxe.elixir.ast.transformers.GettextArityAndParamRepairTransforms.insertArityShims(repaired2);
								var newDo = @:ast(switch (doBlock.def) {
	case EBlock(_):
		makeASTWithMeta(EBlock(withShims2), doBlock.metadata, doBlock.pos);	
	case EDo(_):
		makeASTWithMeta(EDo(withShims2), doBlock.metadata, doBlock.pos);	
	default:
		doBlock;	
}) {
									var ` = doBlock.def;
									switch (enumIndex `) {
										case 53: {
											var ` = `[0];
											{
												{def : reflaxe.elixir.ast.ElixirASTDef.EBlock(withShims2), metadata : doBlock.metadata, pos : doBlock.pos};
											};
										};
										case 55: {
											var ` = `[0];
											{
												{def : reflaxe.elixir.ast.ElixirASTDef.EDo(withShims2), metadata : doBlock.metadata, pos : doBlock.pos};
											};
										};
										default: {
											doBlock;
										}
									};
								};
								{def : reflaxe.elixir.ast.ElixirASTDef.EDefmodule(name2, newDo), metadata : n.metadata, pos : n.pos};
							} else {
								n;
							};
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}
}