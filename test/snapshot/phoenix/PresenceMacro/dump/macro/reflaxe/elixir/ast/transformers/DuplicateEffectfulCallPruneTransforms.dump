class reflaxe.elixir.ast.transformers.DuplicateEffectfulCallPruneTransforms {

	public static function pass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EModule(name, attrs, body) if (looksLikePresenceModule(name, n)):
		n;	
	case EDefmodule(name, doBlock) if (looksLikePresenceModule(name, n)):
		n;	
	case EDef(name, args, guards, body):
		makeASTWithMeta(EDef(name, args, guards, pruneInBody(body)), n.metadata, n.pos);	
	case EDefp(name, args, guards, body):
		makeASTWithMeta(EDefp(name, args, guards, pruneInBody(body)), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 0: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var name = `;
							var attrs = `;
							var body = `;
							if (if (n != null && n.metadata != null && n.metadata.isPresence == true) {
								true;
							} else {
								if (name == null) {
									false;
								} else {
									StringTools.endsWith(name, ".Presence") || StringTools.endsWith(name, "Web.Presence");
								};
							}) {
								n;
							} else {
								n;
							};
						};
					};
					case 1: {
						var ` = `[0];
						var ` = `[1];
						{
							var name = `;
							var doBlock = `;
							if (if (n != null && n.metadata != null && n.metadata.isPresence == true) {
								true;
							} else {
								if (name == null) {
									false;
								} else {
									StringTools.endsWith(name, ".Presence") || StringTools.endsWith(name, "Web.Presence");
								};
							}) {
								n;
							} else {
								n;
							};
						};
					};
					case 2: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name = `;
							var args = `;
							var guards = `;
							var body = `;
							{
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EDef(name, args, guards, reflaxe.elixir.ast.transformers.DuplicateEffectfulCallPruneTransforms.pruneInBody(body));
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							};
						};
					};
					case 3: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name = `;
							var args = `;
							var guards = `;
							var body = `;
							{
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EDefp(name, args, guards, reflaxe.elixir.ast.transformers.DuplicateEffectfulCallPruneTransforms.pruneInBody(body));
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							};
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}

	static inline function looksLikePresenceModule(name:String, node:reflaxe.elixir.ast.ElixirAST) {
		if (node != null && node.metadata != null && node.metadata.isPresence == true) {
			return true;
		};
		if (name == null) {
			return false;
		};
		return StringTools.endsWith(name, ".Presence") || StringTools.endsWith(name, "Web.Presence");
	}

	static function pruneInBody(body:reflaxe.elixir.ast.ElixirAST) {
		return @:ast(switch (body.def) {
	case EBlock(stmts):
		var out:Array<ElixirAST> = [];
		var i = 0;
		while (i < stmts.length) {
			if (i + 1 < stmts.length) {
				var first = stmts[i];
				var second = stmts[i + 1];
				var firstCall = extractRightmostCall(first);
				var secondCaseCall = extractCaseHeadCall(second);
				if (firstCall != null && secondCaseCall != null && callsEqual(firstCall, secondCaseCall)) {
					out.push(second);
					i += 2;
					continue;
				};
			};
			out.push(stmts[i]);
			i++;
		};
		makeASTWithMeta(EBlock(out), body.metadata, body.pos);	
	default:
		body;	
}) {
			var ` = body.def;
			if (enumIndex ` == 53) {
				var ` = `[0];
				{
					var stmts = `;
					{
						var out = [];
						var i = 0;
						while (i < stmts.length) {
							if (i + 1 < stmts.length) {
								var first = stmts[i];
								var second = stmts[i + 1];
								var firstCall = reflaxe.elixir.ast.transformers.DuplicateEffectfulCallPruneTransforms.extractRightmostCall(first);
								var secondCaseCall = reflaxe.elixir.ast.transformers.DuplicateEffectfulCallPruneTransforms.extractCaseHeadCall(second);
								if (firstCall != null && secondCaseCall != null && reflaxe.elixir.ast.transformers.DuplicateEffectfulCallPruneTransforms.callsEqual(firstCall, secondCaseCall)) {
									out.push(second);
									i += 2;
									continue;
								};
							};
							out.push(stmts[i]);
							i ++;
						};
						{def : reflaxe.elixir.ast.ElixirASTDef.EBlock(out), metadata : body.metadata, pos : body.pos};
					};
				};
			} else {
				body;
			};
		};
	}

	static function extractRightmostCall(n:reflaxe.elixir.ast.ElixirAST) {
		var unwrap = [null];
		unwrap[0] = function(e:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (e.def) {
	case EBinary(Match, _, r):
		unwrap(r);	
	case EMatch(_, r2):
		unwrap(r2);	
	case EParen(inner):
		unwrap(inner);	
	default:
		e;	
}) {
				var ` = e.def;
				switch (enumIndex `) {
					case 8: {
						var ` = `[0];
						var ` = `[1];
						{
							var r2 = `;
							{
								unwrap[0](r2);
							};
						};
					};
					case 26: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						if (enumIndex ` == 27) {
							{
								var r = `;
								{
									unwrap[0](r);
								};
							};
						} else {
							e;
						};
					};
					case 54: {
						var ` = `[0];
						{
							var inner = `;
							{
								unwrap[0](inner);
							};
						};
					};
					default: {
						e;
					}
				};
			};
		};
		var e = unwrap[0](n);
		return @:ast(switch (e.def) {
	case ERemoteCall(_, _, _):
		e;	
	case ECall(_, _, _):
		e;	
	default:
		null;	
}) {
			var ` = e.def;
			switch (enumIndex `) {
				case 22: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					{
						e;
					};
				};
				case 24: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					{
						e;
					};
				};
				default: {
					null;
				}
			};
		};
	}

	static function extractCaseHeadCall(n:reflaxe.elixir.ast.ElixirAST) {
		return @:ast(switch (n.def) {
	case ECase(expr, _):
		var ex = expr;
		while (ex != null && ex.def != null) switch (ex.def) {
			case EParen(inner):
				ex = inner;
				continue;			
			default:
				break;			
		};
		return switch (ex.def) {
			case ERemoteCall(_, _, _):
				ex;			
			case ECall(_, _, _):
				ex;			
			default:
				null;			
		};	
	default:
		null;	
}) {
			var ` = n.def;
			if (enumIndex ` == 6) {
				var ` = `[0];
				var ` = `[1];
				{
					var expr = `;
					{
						var ex = expr;
						while (ex != null && ex.def != null) {
							@:ast(switch (ex.def) {
	case EParen(inner):
		ex = inner;
		continue;	
	default:
		break;	
}) {
								var ` = ex.def;
								if (enumIndex ` == 54) {
									var ` = `[0];
									{
										var inner = `;
										{
											ex = inner;
											continue;
										};
									};
								} else {
									break;
								};
							};
						};
						return @:ast(switch (ex.def) {
	case ERemoteCall(_, _, _):
		ex;	
	case ECall(_, _, _):
		ex;	
	default:
		null;	
}) {
							var ` = ex.def;
							switch (enumIndex `) {
								case 22: {
									var ` = `[0];
									var ` = `[1];
									var ` = `[2];
									{
										ex;
									};
								};
								case 24: {
									var ` = `[0];
									var ` = `[1];
									var ` = `[2];
									{
										ex;
									};
								};
								default: {
									null;
								}
							};
						};
					};
				};
			} else {
				null;
			};
		};
	}

	static function callsEqual(a:reflaxe.elixir.ast.ElixirAST, b:reflaxe.elixir.ast.ElixirAST) {
		return @:ast(switch [a.def, b.def] {
	case [ERemoteCall(ma, fa, aa), ERemoteCall(mb, fb, ab)]:
		exprEqual(ma, mb) && fa == fb && argsEqual(aa, ab);	
	case [ECall(ta, fa, aa), ECall(tb, fb, ab)]:
		exprEqual(ta, tb) && fa == fb && argsEqual(aa, ab);	
	default:
		false;	
}) {
			var ` = a.def;
			var ` = b.def;
			switch (enumIndex `) {
				case 22: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					if (enumIndex ` == 22) {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var tb = `;
							var fb = `;
							var ab = `;
							var aa = `;
							var fa = `;
							var ta = `;
							{
								reflaxe.elixir.ast.transformers.DuplicateEffectfulCallPruneTransforms.exprEqual(ta, tb) && fa == fb && reflaxe.elixir.ast.transformers.DuplicateEffectfulCallPruneTransforms.argsEqual(aa, ab);
							};
						};
					} else {
						false;
					};
				};
				case 24: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					if (enumIndex ` == 24) {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var mb = `;
							var fb = `;
							var ab = `;
							var aa = `;
							var fa = `;
							var ma = `;
							{
								reflaxe.elixir.ast.transformers.DuplicateEffectfulCallPruneTransforms.exprEqual(ma, mb) && fa == fb && reflaxe.elixir.ast.transformers.DuplicateEffectfulCallPruneTransforms.argsEqual(aa, ab);
							};
						};
					} else {
						false;
					};
				};
				default: {
					false;
				}
			};
		};
	}

	static function argsEqual(a:Array<reflaxe.elixir.ast.ElixirAST>, b:Array<reflaxe.elixir.ast.ElixirAST>) {
		if (a == null && b == null) {
			return true;
		};
		if (a == null || b == null) {
			return false;
		};
		if (a.length != b.length) {
			return false;
		};
		{
			var ` = 0;
			var ` = a.length;
			while (` < `) {
				var i = ` ++;
				if (! reflaxe.elixir.ast.transformers.DuplicateEffectfulCallPruneTransforms.exprEqual(a[i], b[i])) {
					return false;
				};
			};
		};
		return true;
	}

	static function exprEqual(a:reflaxe.elixir.ast.ElixirAST, b:reflaxe.elixir.ast.ElixirAST) {
		if (a == null || b == null) {
			return a == b;
		};
		if (Type.enumIndex(a.def) != Type.enumIndex(b.def)) {
			return false;
		};
		return @:ast(switch [a.def, b.def] {
	case [EVar(na), EVar(nb)]:
		na == nb;	
	case [EAtom(aa), EAtom(ab)]:
		aa == ab;	
	case [EString(sa), EString(sb)]:
		sa == sb;	
	case [EInteger(ia), EInteger(ib)]:
		ia == ib;	
	case [ERemoteCall(ma, fa, aa), ERemoteCall(mb, fb, ab)]:
		callsEqual(a, b);	
	case [ECall(ta, fa, aa), ECall(tb, fb, ab)]:
		callsEqual(a, b);	
	case [EAccess(ta, ka), EAccess(tb, kb)]:
		exprEqual(ta, tb) && exprEqual(ka, kb);	
	case [EParen(pa), EParen(pb)]:
		exprEqual(pa, pb);	
	default:
		Std.string(a.def) == Std.string(b.def);	
}) {
			var ` = a.def;
			var ` = b.def;
			switch (enumIndex `) {
				case 22: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					if (enumIndex ` == 22) {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var tb = `;
							var fb = `;
							var ab = `;
							var aa = `;
							var fa = `;
							var ta = `;
							{
								reflaxe.elixir.ast.transformers.DuplicateEffectfulCallPruneTransforms.callsEqual(a, b);
							};
						};
					} else {
						Std.string(a.def) == Std.string(b.def);
					};
				};
				case 24: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					if (enumIndex ` == 24) {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var mb = `;
							var fb = `;
							var ab = `;
							var aa = `;
							var fa = `;
							var ma = `;
							{
								reflaxe.elixir.ast.transformers.DuplicateEffectfulCallPruneTransforms.callsEqual(a, b);
							};
						};
					} else {
						Std.string(a.def) == Std.string(b.def);
					};
				};
				case 29: {
					var ` = `[0];
					var ` = `[1];
					if (enumIndex ` == 29) {
						var ` = `[0];
						var ` = `[1];
						{
							var tb = `;
							var kb = `;
							var ka = `;
							var ta = `;
							{
								reflaxe.elixir.ast.transformers.DuplicateEffectfulCallPruneTransforms.exprEqual(ta, tb) && reflaxe.elixir.ast.transformers.DuplicateEffectfulCallPruneTransforms.exprEqual(ka, kb);
							};
						};
					} else {
						Std.string(a.def) == Std.string(b.def);
					};
				};
				case 31: {
					var ` = `[0];
					if (enumIndex ` == 31) {
						var ` = `[0];
						{
							var ab = `;
							var aa = `;
							{
								aa == ab;
							};
						};
					} else {
						Std.string(a.def) == Std.string(b.def);
					};
				};
				case 32: {
					var ` = `[0];
					if (enumIndex ` == 32) {
						var ` = `[0];
						{
							var sb = `;
							var sa = `;
							{
								sa == sb;
							};
						};
					} else {
						Std.string(a.def) == Std.string(b.def);
					};
				};
				case 33: {
					var ` = `[0];
					if (enumIndex ` == 33) {
						var ` = `[0];
						{
							var ib = `;
							var ia = `;
							{
								ia == ib;
							};
						};
					} else {
						Std.string(a.def) == Std.string(b.def);
					};
				};
				case 38: {
					var ` = `[0];
					if (enumIndex ` == 38) {
						var ` = `[0];
						{
							var nb = `;
							var na = `;
							{
								na == nb;
							};
						};
					} else {
						Std.string(a.def) == Std.string(b.def);
					};
				};
				case 54: {
					var ` = `[0];
					if (enumIndex ` == 54) {
						var ` = `[0];
						{
							var pb = `;
							var pa = `;
							{
								reflaxe.elixir.ast.transformers.DuplicateEffectfulCallPruneTransforms.exprEqual(pa, pb);
							};
						};
					} else {
						Std.string(a.def) == Std.string(b.def);
					};
				};
				default: {
					Std.string(a.def) == Std.string(b.def);
				}
			};
		};
	}
}