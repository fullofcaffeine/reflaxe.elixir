class reflaxe.elixir.ast.transformers.ChangesetParamUsedRepairTransforms {

	public static function pass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EDef(name, args, guards, body) if (name == "changeset"):
		makeASTWithMeta(EDef(name, repair(args, body), guards, body), n.metadata, n.pos);	
	case EDefp(name2, args2, guards2, body2) if (name2 == "changeset"):
		makeASTWithMeta(EDefp(name2, repair(args2, body2), guards2, body2), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 2: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name = `;
							var args = `;
							var guards = `;
							var body = `;
							if (name == "changeset") {
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EDef(name, reflaxe.elixir.ast.transformers.ChangesetParamUsedRepairTransforms.repair(args, body), guards, body);
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							} else {
								n;
							};
						};
					};
					case 3: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name2 = `;
							var args2 = `;
							var guards2 = `;
							var body2 = `;
							if (name2 == "changeset") {
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EDefp(name2, reflaxe.elixir.ast.transformers.ChangesetParamUsedRepairTransforms.repair(args2, body2), guards2, body2);
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							} else {
								n;
							};
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}

	static function repair(args:Array<reflaxe.elixir.ast.EPattern>, body:reflaxe.elixir.ast.ElixirAST) {
		if (args == null) {
			return args;
		};
		return {
			var ` = [];
			{
				var ` = 0;
				while (` < args.length) {
					var a = args[`];
					++ `;
					`.push(@:ast(switch (a) {
	case PVar(nm) if (nm != null && nm.length > 1 && nm.charAt(0) == "_"):
		var base = nm.substr(1);
		if (VariableUsageCollector.usedInFunctionScope(body, base)) PVar(base) else a;	
	default:
		a;	
}) if (enumIndex a == 0) {
						var ` = a[0];
						{
							var nm = `;
							if (nm != null && nm.length > 1 && nm.charAt(0) == "_") {
								var base = nm.substr(1, null);
								if (reflaxe.elixir.ast.analyzers.VariableUsageCollector.usedInFunctionScope(body, base)) {
									reflaxe.elixir.ast.EPattern.PVar(base);
								} else {
									a;
								};
							} else {
								a;
							};
						};
					} else {
						a;
					});
				};
			};
			`;
		};
	}
}