class reflaxe.elixir.ast.transformers.HeexAssignsParamRenameFinalTransforms {

	public static function pass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EDef(name, args, guards, body):
		if (!hasUnderscoreAssigns(args) || !containsHSigilAny(body)) return n;
		makeASTWithMeta(EDef(name, rename(args), guards, body), n.metadata, n.pos);	
	case EDefp(name2, args2, guards2, body2):
		if (!hasUnderscoreAssigns(args2) || !containsHSigilAny(body2)) return n;
		makeASTWithMeta(EDefp(name2, rename(args2), guards2, body2), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 2: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name = `;
							var args = `;
							var guards = `;
							var body = `;
							{
								if (! reflaxe.elixir.ast.transformers.HeexAssignsParamRenameFinalTransforms.hasUnderscoreAssigns(args) || ! reflaxe.elixir.ast.transformers.HeexAssignsParamRenameFinalTransforms.containsHSigilAny(body)) {
									return n;
								};
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EDef(name, {
										var out = [];
										{
											var ` = 0;
											while ((` < args.length)) {
												var a = args[`];
												++ `;
												@:ast(switch (a) {
	case PVar(p) if (p == "_assigns"):
		out.push(PVar("assigns"));	
	default:
		out.push(a);	
}) if ((enumIndex a == 0)) {
													var ` = a[0];
													{
														var p = `;
														if ((p == "_assigns")) out.push(reflaxe.elixir.ast.EPattern.PVar("assigns")) else out.push(a);
													};
												} else out.push(a);
											};
										};
										out;
									}, guards, body);
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							};
						};
					};
					case 3: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name2 = `;
							var args2 = `;
							var guards2 = `;
							var body2 = `;
							{
								if (! reflaxe.elixir.ast.transformers.HeexAssignsParamRenameFinalTransforms.hasUnderscoreAssigns(args2) || ! reflaxe.elixir.ast.transformers.HeexAssignsParamRenameFinalTransforms.containsHSigilAny(body2)) {
									return n;
								};
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EDefp(name2, {
										var out = [];
										{
											var ` = 0;
											while ((` < args2.length)) {
												var a = args2[`];
												++ `;
												@:ast(switch (a) {
	case PVar(p) if (p == "_assigns"):
		out.push(PVar("assigns"));	
	default:
		out.push(a);	
}) if ((enumIndex a == 0)) {
													var ` = a[0];
													{
														var p = `;
														if ((p == "_assigns")) out.push(reflaxe.elixir.ast.EPattern.PVar("assigns")) else out.push(a);
													};
												} else out.push(a);
											};
										};
										out;
									}, guards2, body2);
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							};
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}

	static function hasUnderscoreAssigns(args:Array<reflaxe.elixir.ast.EPattern>) {
		if (args == null) {
			return false;
		};
		{
			var ` = 0;
			while (` < args.length) {
				var a = args[`];
				++ `;
				@:ast(switch (a) {
	case PVar(p) if (p == "_assigns"):
		return true;	
	default:
}) if (enumIndex a == 0) {
					var ` = a[0];
					{
						var p = `;
						if (p == "_assigns") {
							return true;
						} else {};
					};
				} else {};
			};
		};
		return false;
	}

	static inline function rename(args:Array<reflaxe.elixir.ast.EPattern>) {
		var out = [];
		{
			var ` = 0;
			while (` < args.length) {
				var a = args[`];
				++ `;
				@:ast(switch (a) {
	case PVar(p) if (p == "_assigns"):
		out.push(PVar("assigns"));	
	default:
		out.push(a);	
}) if (enumIndex a == 0) {
					var ` = a[0];
					{
						var p = `;
						if (p == "_assigns") {
							out.push(reflaxe.elixir.ast.EPattern.PVar("assigns"));
						} else {
							out.push(a);
						};
					};
				} else {
					out.push(a);
				};
			};
		};
		return out;
	}

	static function containsHSigilAny(node:reflaxe.elixir.ast.ElixirAST) {
		var found = [false];
		{};
		var walk = [null];
		walk[0] = function(n:reflaxe.elixir.ast.ElixirAST) {
			if (found[0] || n == null || n.def == null) {
				return;
			};
			@:ast(switch (n.def) {
	case ESigil(t, _, _) if (t == "H"):
		found = true;	
	case ERemoteCall(mod, funcName, _):
		if (funcName == "sigil_H") {
			found = true;
		};
		walk(mod);	
	case ERaw(code):
		if (code != null) {
			var i = code.indexOf("~H");
			if (i != -1) {
				var before = i > 0 ? code.substr(i - 1, 1) : null;
				var after = i + 2 < code.length ? code.substr(i + 2, 1) : null;
				if (!isIdentChar(before)) {
					found = true;
				};
			};
		};	
	case EBlock(es):
		for (e  in  es) walk(e);	
	case EIf(c, t, e):
		walk(c);
		walk(t);
		if (e != null) walk(e);	
	case ECase(e, cs):
		walk(e);
		for (cl  in  cs) walk(cl.body);	
	case EDo(b):
		for (e  in  b) walk(e);	
	case EParen(inner):
		walk(inner);	
	case ECall(t, _, as):
		if (t != null) walk(t);
		for (a  in  as) walk(a);	
	case EBinary(_, l, r):
		walk(l);
		walk(r);	
	case EList(el):
		for (e  in  el) walk(e);	
	case ETuple(el):
		for (e  in  el) walk(e);	
	case EMap(p):
		for (kv  in  p) {
			walk(kv.key);
			walk(kv.value);
		};	
	case EStruct(_, fs):
		for (f  in  fs) walk(f.value);	
	case EFn(cs):
		for (cl  in  cs) walk(cl.body);	
	default:
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 6: {
						var ` = `[0];
						var ` = `[1];
						{
							var e = `;
							var cs = `;
							{
								walk[0](e);
								{
									var ` = 0;
									while (` < cs.length) {
										var cl = cs[`];
										++ `;
										walk[0](cl.body);
									};
								};
							};
						};
					};
					case 10: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var c = `;
							var t = `;
							var e = `;
							{
								walk[0](c);
								walk[0](t);
								if (e != null) {
									walk[0](e);
								};
							};
						};
					};
					case 15: {
						var ` = `[0];
						{
							var el = `;
							{
								{
									var ` = 0;
									while (` < el.length) {
										var e = el[`];
										++ `;
										walk[0](e);
									};
								};
							};
						};
					};
					case 16: {
						var ` = `[0];
						{
							var el = `;
							{
								{
									var ` = 0;
									while (` < el.length) {
										var e = el[`];
										++ `;
										walk[0](e);
									};
								};
							};
						};
					};
					case 17: {
						var ` = `[0];
						{
							var p = `;
							{
								{
									var ` = 0;
									while (` < p.length) {
										var kv = p[`];
										++ `;
										walk[0](kv.key);
										walk[0](kv.value);
									};
								};
							};
						};
					};
					case 18: {
						var ` = `[0];
						var ` = `[1];
						{
							var fs = `;
							{
								{
									var ` = 0;
									while (` < fs.length) {
										var f = fs[`];
										++ `;
										walk[0](f.value);
									};
								};
							};
						};
					};
					case 22: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var t = `;
							var as = `;
							{
								if (t != null) {
									walk[0](t);
								};
								{
									var ` = 0;
									while (` < as.length) {
										var a = as[`];
										++ `;
										walk[0](a);
									};
								};
							};
						};
					};
					case 24: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var mod = `;
							var funcName = `;
							{
								if (funcName == "sigil_H") {
									found[0] = true;
								};
								walk[0](mod);
							};
						};
					};
					case 26: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var l = `;
							var r = `;
							{
								walk[0](l);
								walk[0](r);
							};
						};
					};
					case 42: {
						var ` = `[0];
						{
							var cs = `;
							{
								{
									var ` = 0;
									while (` < cs.length) {
										var cl = cs[`];
										++ `;
										walk[0](cl.body);
									};
								};
							};
						};
					};
					case 53: {
						var ` = `[0];
						{
							var es = `;
							{
								{
									var ` = 0;
									while (` < es.length) {
										var e = es[`];
										++ `;
										walk[0](e);
									};
								};
							};
						};
					};
					case 54: {
						var ` = `[0];
						{
							var inner = `;
							{
								walk[0](inner);
							};
						};
					};
					case 55: {
						var ` = `[0];
						{
							var b = `;
							{
								{
									var ` = 0;
									while (` < b.length) {
										var e = b[`];
										++ `;
										walk[0](e);
									};
								};
							};
						};
					};
					case 61: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var t = `;
							if (t == "H") {
								found[0] = true;
							} else {};
						};
					};
					case 62: {
						var ` = `[0];
						{
							var code = `;
							{
								if (code != null) {
									var i = code.indexOf("~H", null);
									if (i != -1) {
										var before = if (i > 0) {
											code.substr(i - 1, 1);
										} else {
											null;
										};
										var after = if (i + 2 < code.length) {
											code.substr(i + 2, 1);
										} else {
											null;
										};
										if (! if (before == null || before.length == 0) {
											false;
										} else {
											var ch = before.charCodeAt(0);
											(ch >= 48 && ch <= 57) || (ch >= 65 && ch <= 90) || (ch >= 97 && ch <= 122) || before == "_";
										}) {
											found[0] = true;
										};
									};
								};
							};
						};
					};
					default: {}
				};
			};
		};
		walk[0](node);
		return found[0];
	}
}