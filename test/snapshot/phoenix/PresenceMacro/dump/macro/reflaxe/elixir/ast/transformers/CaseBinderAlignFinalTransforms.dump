class reflaxe.elixir.ast.transformers.CaseBinderAlignFinalTransforms {

	static function prefer(names:Array<String>) {
		if (names == null || names.length == 0) {
			return null;
		};
		var order = ["todo", "id", "message", "params", "reason"];
		{
			var ` = 0;
			while (` < order.length) {
				var p = order[`];
				++ `;
				{
					var ` = 0;
					while (` < names.length) {
						var n = names[`];
						++ `;
						if (n == p) {
							return n;
						};
					};
				};
			};
		};
		return null;
	}

	public static function pass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case ECase(target, clauses):
		var out = [];
		for (cl  in  clauses) {
			var binder = extractTagPayloadBinder(cl.pattern);
			if (binder != null) {
				Sys.println("[CaseBinderAlignFinal] clause with binder=" + binder);
				Sys.println("[CaseBinderAlignFinal] Found {:tag, " + binder + "}");
				var declared = collectDeclaredNames(cl.pattern, cl.body);
				var used = collectUsedLowerVars(cl.body);
				var declArr = [for (k  in  declared.keys()) k];
				Sys.println("[CaseBinderAlignFinal] declared=" + declArr.join(","));
				Sys.println("[CaseBinderAlignFinal] used=" + used.join(","));
				var undef:Array<String> = [];
				for (u  in  used) if (!declared.exists(u) && u != binder) undef.push(u);
				if (undef.length == 0) {
					var ex = new StringMap<Bool>();
					ex.set(binder, true);
					for (k  in  declared.keys()) ex.set(k, true);
					var alt = findFirstMeaningfulVar(cl.body, ex);
					if (alt != null) undef.push(alt);
				};
				Sys.println("[CaseBinderAlignFinal] used=" + used.join(",") + " declared=" + (function() {
					var a = [];
					for (k  in  declared.keys()) a.push(k);
					return a.join(",");
				})() + " undef=" + undef.join(","));
				if (undef.length > 1) {
					var pref = prefer(undef);
					if (pref != null) undef = [pref];
				};
				if (undef.length == 1) {
					var newName = undef[0];
					var newPat = rewriteTagPayloadBinder(cl.pattern, newName);
					if (newPat != null) {
						Sys.println("[CaseBinderAlignFinal] Renaming binder " + binder + " -> " + newName);
						var newBody = replaceVar(cl.body, binder, newName);
						out.push({ pattern : newPat, guard : cl.guard, body : newBody });
						continue;
					};
				};
			};
			out.push(cl);
		};
		makeASTWithMeta(ECase(target, out), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				if (enumIndex ` == 6) {
					var ` = `[0];
					var ` = `[1];
					{
						var target = `;
						var clauses = `;
						{
							var out = [];
							{
								var ` = 0;
								while (` < clauses.length) {
									var cl = clauses[`];
									++ `;
									var binder = reflaxe.elixir.ast.transformers.CaseBinderAlignFinalTransforms.extractTagPayloadBinder(cl.pattern);
									if (binder != null) {
										Sys.println("[CaseBinderAlignFinal] clause with binder=" + binder);
										Sys.println("[CaseBinderAlignFinal] Found {:tag, " + binder + "}");
										var declared = reflaxe.elixir.ast.transformers.CaseBinderAlignFinalTransforms.collectDeclaredNames(cl.pattern, cl.body);
										var used = reflaxe.elixir.ast.transformers.CaseBinderAlignFinalTransforms.collectUsedLowerVars(cl.body);
										var declArr = {
											var ` = [];
											for (k in declared.keys()) {
												`.push(k);
											};
											`;
										};
										Sys.println("[CaseBinderAlignFinal] declared=" + declArr.join(","));
										Sys.println("[CaseBinderAlignFinal] used=" + used.join(","));
										var undef = [];
										{
											var ` = 0;
											while (` < used.length) {
												var u = used[`];
												++ `;
												if (! declared.exists(u) && u != binder) {
													undef.push(u);
												};
											};
										};
										if (undef.length == 0) {
											var ex = new haxe.ds.StringMap();
											ex.set(binder, true);
											for (k in declared.keys()) {
												ex.set(k, true);
											};
											var alt = reflaxe.elixir.ast.transformers.CaseBinderAlignFinalTransforms.findFirstMeaningfulVar(cl.body, ex);
											if (alt != null) {
												undef.push(alt);
											};
										};
										Sys.println("[CaseBinderAlignFinal] used=" + used.join(",") + " declared=" + (function() {
											var a = [];
											for (k in declared.keys()) {
												a.push(k);
											};
											return a.join(",");
										})() + " undef=" + undef.join(","));
										if (undef.length > 1) {
											var pref = reflaxe.elixir.ast.transformers.CaseBinderAlignFinalTransforms.prefer(undef);
											if (pref != null) {
												undef = [pref];
											};
										};
										if (undef.length == 1) {
											var newName = undef[0];
											var newPat = reflaxe.elixir.ast.transformers.CaseBinderAlignFinalTransforms.rewriteTagPayloadBinder(cl.pattern, newName);
											if (newPat != null) {
												Sys.println("[CaseBinderAlignFinal] Renaming binder " + binder + " -> " + newName);
												var newBody = reflaxe.elixir.ast.transformers.CaseBinderAlignFinalTransforms.replaceVar(cl.body, binder, newName);
												out.push({pattern : newPat, guard : cl.guard, body : newBody});
												continue;
											};
										};
									};
									out.push(cl);
								};
							};
							{def : reflaxe.elixir.ast.ElixirASTDef.ECase(target, out), metadata : n.metadata, pos : n.pos};
						};
					};
				} else {
					n;
				};
			};
		});
	}

	static function extractTagPayloadBinder(p:reflaxe.elixir.ast.EPattern) {
		return @:ast(switch (p) {
	case PTuple(es) if (es.length == 2):
		switch (es[0]) {
			case PLiteral(l):
				switch (es[1]) {
					case PVar(n):
						n;					
					default:
						null;					
				};			
			default:
				null;			
		};	
	default:
		null;	
}) if (enumIndex p == 2) {
			var ` = p[0];
			{
				var es = `;
				if (es.length == 2) {
					@:ast(switch (es[0]) {
	case PLiteral(l):
		switch (es[1]) {
			case PVar(n):
				n;			
			default:
				null;			
		};	
	default:
		null;	
}) {
						var ` = es[0];
						if (enumIndex ` == 1) {
							var ` = `[0];
							{
								var l = `;
								{
									@:ast(switch (es[1]) {
	case PVar(n):
		n;	
	default:
		null;	
}) {
										var ` = es[1];
										if (enumIndex ` == 0) {
											var ` = `[0];
											{
												var n = `;
												{
													n;
												};
											};
										} else {
											null;
										};
									};
								};
							};
						} else {
							null;
						};
					};
				} else {
					null;
				};
			};
		} else {
			null;
		};
	}

	static function rewriteTagPayloadBinder(p:reflaxe.elixir.ast.EPattern, newName:String) {
		return @:ast(switch (p) {
	case PTuple(es) if (es.length == 2):
		switch (es[0]) {
			case PLiteral(_):
				switch (es[1]) {
					case PVar(_):
						PTuple([es[0], PVar(newName)]);					
					default:
						null;					
				};			
			default:
				null;			
		};	
	default:
		null;	
}) if (enumIndex p == 2) {
			var ` = p[0];
			{
				var es = `;
				if (es.length == 2) {
					@:ast(switch (es[0]) {
	case PLiteral(_):
		switch (es[1]) {
			case PVar(_):
				PTuple([es[0], PVar(newName)]);			
			default:
				null;			
		};	
	default:
		null;	
}) {
						var ` = es[0];
						if (enumIndex ` == 1) {
							var ` = `[0];
							{
								@:ast(switch (es[1]) {
	case PVar(_):
		PTuple([es[0], PVar(newName)]);	
	default:
		null;	
}) {
									var ` = es[1];
									if (enumIndex ` == 0) {
										var ` = `[0];
										{
											reflaxe.elixir.ast.EPattern.PTuple([es[0], reflaxe.elixir.ast.EPattern.PVar(newName)]);
										};
									} else {
										null;
									};
								};
							};
						} else {
							null;
						};
					};
				} else {
					null;
				};
			};
		} else {
			null;
		};
	}

	static function collectDeclaredNames(p:reflaxe.elixir.ast.EPattern, body:reflaxe.elixir.ast.ElixirAST) {
		var m = {
			{};
			new haxe.ds.StringMap();
		};
		var pat = [null];
		pat[0] = function(pt:reflaxe.elixir.ast.EPattern) {
			@:ast(switch (pt) {
	case PVar(n):
		m.set(n, true);	
	case PTuple(es) | PList(es):
		for (e  in  es) pat(e);	
	case PCons(h, t):
		pat(h);
		pat(t);	
	case PMap(kvs):
		for (kv  in  kvs) pat(kv.value);	
	case PStruct(_, fs):
		for (f  in  fs) pat(f.value);	
	case PPin(inner):
		pat(inner);	
	default:
}) switch (enumIndex pt) {
				case 0: {
					var ` = pt[0];
					{
						var n = `;
						{
							{
								m.set(n, true);
							};
						};
					};
				};
				case 2: {
					var ` = pt[0];
					{
						var es = `;
						{
							{
								var ` = 0;
								while (` < es.length) {
									var e = es[`];
									++ `;
									pat[0](e);
								};
							};
						};
					};
				};
				case 3: {
					var ` = pt[0];
					{
						var es = `;
						{
							{
								var ` = 0;
								while (` < es.length) {
									var e = es[`];
									++ `;
									pat[0](e);
								};
							};
						};
					};
				};
				case 4: {
					var ` = pt[0];
					var ` = pt[1];
					{
						var h = `;
						var t = `;
						{
							pat[0](h);
							pat[0](t);
						};
					};
				};
				case 5: {
					var ` = pt[0];
					{
						var kvs = `;
						{
							{
								var ` = 0;
								while (` < kvs.length) {
									var kv = kvs[`];
									++ `;
									pat[0](kv.value);
								};
							};
						};
					};
				};
				case 6: {
					var ` = pt[0];
					var ` = pt[1];
					{
						var fs = `;
						{
							{
								var ` = 0;
								while (` < fs.length) {
									var f = fs[`];
									++ `;
									pat[0](f.value);
								};
							};
						};
					};
				};
				case 7: {
					var ` = pt[0];
					{
						var inner = `;
						{
							pat[0](inner);
						};
					};
				};
				default: {}
			};
		};
		pat[0](p);
		reflaxe.elixir.ast.ElixirASTTransformer.transformNode(body, function(n:reflaxe.elixir.ast.ElixirAST) {
			@:ast(switch (n.def) {
	case EMatch(pt, _):
		pat(pt);	
	case EBinary(Match, { def : EVar(lhs) }, _):
		m.set(lhs, true);	
	default:
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 8: {
						var ` = `[0];
						var ` = `[1];
						{
							var pt = `;
							{
								pat[0](pt);
							};
						};
					};
					case 26: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						if (enumIndex ` == 27) {
							{
								var ` = `.def;
								var ` = `.metadata;
								var ` = `.pos;
								if (enumIndex ` == 38) {
									var ` = `[0];
									{
										var lhs = `;
										{
											{
												m.set(lhs, true);
											};
										};
									};
								} else {};
							};
						} else {};
					};
					default: {}
				};
			};
			return n;
		});
		return m;
	}

	@:has_untyped
	static function collectUsedLowerVars(ast:reflaxe.elixir.ast.ElixirAST) {
		var names = {
			{};
			new haxe.ds.StringMap();
		};
		try {
			var meta = ast.metadata;
			if (meta != null && meta.usedLocalsFromTyped != null) {
				var arr = meta.usedLocalsFromTyped;
				{
					var ` = 0;
					while (` < arr.length) {
						var n = arr[`];
						++ `;
						if (n != null && n.length > 0 && if (n == null || n.length == 0) {
							false;
						} else {
							var c = n.charAt(0);
							c.toLowerCase() == c;
						}) {
							{
								names.set(n, true);
							};
						};
					};
				};
			};
		} catch (`:Dynamic) {
			{};
			{};
			if (true) {
				{};
				{};
			} else throw `;
		};
		reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			@:ast(switch (n.def) {
	case EVar(v):
		if (isLower(v)) names.set(v, true);	
	case EString(s):
		if (s != null && s.indexOf("#{") != -1) {
			var block = new EReg("\\#\\{([^}]*)\\}", "g");
			var pos = 0;
			while (block.matchSub(s, pos)) {
				var inner = block.matched(1);
				var tok = new EReg("[a-z_][a-z0-9_]*", "gi");
				var tpos = 0;
				while (tok.matchSub(inner, tpos)) {
					var id = tok.matched(0);
					if (isLower(id)) names.set(id, true);
					tpos = tok.matchedPos().pos + tok.matchedPos().len;
				};
				pos = block.matchedPos().pos + block.matchedPos().len;
			};
		};	
	default:
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 32: {
						var ` = `[0];
						{
							var s = `;
							{
								if (s != null && s.indexOf("#{", null) != -1) {
									var block = new EReg("\\#\\{([^}]*)\\}", "g");
									var pos = 0;
									while (block.matchSub(s, pos, null)) {
										var inner = block.matched(1);
										var tok = new EReg("[a-z_][a-z0-9_]*", "gi");
										var tpos = 0;
										while (tok.matchSub(inner, tpos, null)) {
											var id = tok.matched(0);
											if (if (id == null || id.length == 0) {
												false;
											} else {
												var c = id.charAt(0);
												c.toLowerCase() == c;
											}) {
												{
													names.set(id, true);
												};
											};
											tpos = tok.matchedPos().pos + tok.matchedPos().len;
										};
										pos = block.matchedPos().pos + block.matchedPos().len;
									};
								};
							};
						};
					};
					case 38: {
						var ` = `[0];
						{
							var v = `;
							{
								if (if (v == null || v.length == 0) {
									false;
								} else {
									var c = v.charAt(0);
									c.toLowerCase() == c;
								}) {
									{
										names.set(v, true);
									};
								};
							};
						};
					};
					default: {}
				};
			};
			return n;
		});
		return {
			var ` = [];
			for (k in names.keys()) {
				`.push(k);
			};
			`;
		};
	}

	static function findFirstMeaningfulVar(ast:reflaxe.elixir.ast.ElixirAST, exclude:haxe.ds.StringMap<Bool>) {
		var pick = [null];
		reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			if (pick[0] != null || n == null || n.def == null) {
				return n;
			};
			@:ast(switch (n.def) {
	case EVar(v):
		if (isLower(v) && !exclude.exists(v)) pick = v;	
	default:
}) {
				var ` = n.def;
				if (enumIndex ` == 38) {
					var ` = `[0];
					{
						var v = `;
						{
							if (if (v == null || v.length == 0) {
								false;
							} else {
								var c = v.charAt(0);
								c.toLowerCase() == c;
							} && ! exclude.exists(v)) {
								pick[0] = v;
							};
						};
					};
				} else {};
			};
			return n;
		});
		return pick[0];
	}

	static inline function isLower(s:String) {
		if (s == null || s.length == 0) {
			return false;
		};
		var c = s.charAt(0);
		return c.toLowerCase() == c;
	}

	static function replaceVar(body:reflaxe.elixir.ast.ElixirAST, from:String, to:String) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(body, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EVar(v) if (v == from):
		makeASTWithMeta(EVar(to), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				if (enumIndex ` == 38) {
					var ` = `[0];
					{
						var v = `;
						if (v == from) {
							{def : reflaxe.elixir.ast.ElixirASTDef.EVar(to), metadata : n.metadata, pos : n.pos};
						} else {
							n;
						};
					};
				} else {
					n;
				};
			};
		});
	}
}