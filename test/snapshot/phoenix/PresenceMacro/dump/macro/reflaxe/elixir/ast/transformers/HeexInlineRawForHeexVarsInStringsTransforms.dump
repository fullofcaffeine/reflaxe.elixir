class reflaxe.elixir.ast.transformers.HeexInlineRawForHeexVarsInStringsTransforms {

	public static function transformPass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EDef(name, args, guards, body):
		var vars = collectVars(body);
		makeASTWithMeta(EDef(name, args, guards, rewriteStrings(body, vars)), n.metadata, n.pos);	
	case EDefp(name, args, guards, body):
		var vars2 = collectVars(body);
		makeASTWithMeta(EDefp(name, args, guards, rewriteStrings(body, vars2)), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 2: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name = `;
							var args = `;
							var guards = `;
							var body = `;
							{
								var vars = reflaxe.elixir.ast.transformers.HeexInlineRawForHeexVarsInStringsTransforms.collectVars(body);
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EDef(name, args, guards, reflaxe.elixir.ast.transformers.HeexInlineRawForHeexVarsInStringsTransforms.rewriteStrings(body, vars));
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							};
						};
					};
					case 3: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name = `;
							var args = `;
							var guards = `;
							var body = `;
							{
								var vars2 = reflaxe.elixir.ast.transformers.HeexInlineRawForHeexVarsInStringsTransforms.collectVars(body);
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EDefp(name, args, guards, reflaxe.elixir.ast.transformers.HeexInlineRawForHeexVarsInStringsTransforms.rewriteStrings(body, vars2));
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							};
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}

	static function collectVars(body:reflaxe.elixir.ast.ElixirAST) {
		var s = new haxe.ds.StringMap();
		var add = function(name:String) {
			if (! s.exists(name)) {
				s.set(name, true);
			};
		};
		var looksLikeHtml = function(str:String) {
			if (str == null) {
				return false;
			};
			var t = StringTools.trim(str);
			return t.indexOf("<", null) != -1 && t.indexOf(">", null) != -1;
		};
		var rhsHasHeexLike = function(n:reflaxe.elixir.ast.ElixirAST) {
			var found = [false];
			var scan = [null];
			scan[0] = function(x:reflaxe.elixir.ast.ElixirAST) {
				if (found[0] || x == null || x.def == null) {
					return;
				};
				@:ast(switch (x.def) {
	case ESigil(type, _, _) if (type == "H"):
		found = true;
		return;	
	case EString(s) if (looksLikeHtml(s)):
		found = true;
		return;	
	case EBlock(es):
		for (e  in  es) scan(e);	
	case EIf(c, t, e):
		scan(t);
		if (e != null) scan(e);	
	case ECase(e, cs):
		for (cl  in  cs) scan(cl.body);	
	case EDo(es):
		for (e  in  es) scan(e);	
	case EParen(inner):
		scan(inner);	
	default:
}) {
					var ` = x.def;
					switch (enumIndex `) {
						case 6: {
							var ` = `[0];
							var ` = `[1];
							{
								var e = `;
								var cs = `;
								{
									{
										var ` = 0;
										while (` < cs.length) {
											var cl = cs[`];
											++ `;
											scan[0](cl.body);
										};
									};
								};
							};
						};
						case 10: {
							var ` = `[0];
							var ` = `[1];
							var ` = `[2];
							{
								var c = `;
								var t = `;
								var e = `;
								{
									scan[0](t);
									if (e != null) {
										scan[0](e);
									};
								};
							};
						};
						case 32: {
							var ` = `[0];
							{
								var s = `;
								if (looksLikeHtml(s)) {
									found[0] = true;
									return;
								} else {};
							};
						};
						case 53: {
							var ` = `[0];
							{
								var es = `;
								{
									{
										var ` = 0;
										while (` < es.length) {
											var e = es[`];
											++ `;
											scan[0](e);
										};
									};
								};
							};
						};
						case 54: {
							var ` = `[0];
							{
								var inner = `;
								{
									scan[0](inner);
								};
							};
						};
						case 55: {
							var ` = `[0];
							{
								var es = `;
								{
									{
										var ` = 0;
										while (` < es.length) {
											var e = es[`];
											++ `;
											scan[0](e);
										};
									};
								};
							};
						};
						case 61: {
							var ` = `[0];
							var ` = `[1];
							var ` = `[2];
							{
								var type = `;
								if (type == "H") {
									found[0] = true;
									return;
								} else {};
							};
						};
						default: {}
					};
				};
			};
			scan[0](n);
			return found[0];
		};
		var walk = [null];
		walk[0] = function(n:reflaxe.elixir.ast.ElixirAST) {
			if (n == null || n.def == null) {
				return;
			};
			@:ast(switch (n.def) {
	case EMatch(PVar(v), rhs):
		if (rhsHasHeexLike(rhs)) add(v);	
	case EBlock(es):
		for (e  in  es) walk(e);	
	case EIf(c, t, e):
		walk(t);
		if (e != null) walk(e);	
	case ECase(e, cs):
		for (cl  in  cs) walk(cl.body);	
	case EDo(es):
		for (e  in  es) walk(e);	
	default:
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 6: {
						var ` = `[0];
						var ` = `[1];
						{
							var e = `;
							var cs = `;
							{
								{
									var ` = 0;
									while (` < cs.length) {
										var cl = cs[`];
										++ `;
										walk[0](cl.body);
									};
								};
							};
						};
					};
					case 8: {
						var ` = `[0];
						var ` = `[1];
						if (enumIndex ` == 0) {
							var ` = `[0];
							{
								var v = `;
								var rhs = `;
								{
									if (rhsHasHeexLike(rhs)) {
										add(v);
									};
								};
							};
						} else {};
					};
					case 10: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var c = `;
							var t = `;
							var e = `;
							{
								walk[0](t);
								if (e != null) {
									walk[0](e);
								};
							};
						};
					};
					case 53: {
						var ` = `[0];
						{
							var es = `;
							{
								{
									var ` = 0;
									while (` < es.length) {
										var e = es[`];
										++ `;
										walk[0](e);
									};
								};
							};
						};
					};
					case 55: {
						var ` = `[0];
						{
							var es = `;
							{
								{
									var ` = 0;
									while (` < es.length) {
										var e = es[`];
										++ `;
										walk[0](e);
									};
								};
							};
						};
					};
					default: {}
				};
			};
		};
		walk[0](body);
		return s;
	}

	static function rewriteStrings(body:reflaxe.elixir.ast.ElixirAST, vars:haxe.ds.StringMap<Bool>) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(body, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EString(s) if (s != null && s.indexOf("#") != -1):
		var updated = s;
		for (k  in  vars.keys()) {
			updated = updated.split("#{" + k + "}").join("#{Phoenix.HTML.raw(" + k + ")}");
		};
		if (updated != s) makeASTWithMeta(EString(updated), n.metadata, n.pos) else n;	
	default:
		n;	
}) {
				var ` = n.def;
				if (enumIndex ` == 32) {
					var ` = `[0];
					{
						var s = `;
						if (s != null && s.indexOf("#", null) != -1) {
							var updated = s;
							for (k in vars.keys()) {
								updated = updated.split("#{" + k + "}").join("#{Phoenix.HTML.raw(" + k + ")}");
							};
							if (updated != s) {
								{def : reflaxe.elixir.ast.ElixirASTDef.EString(updated), metadata : n.metadata, pos : n.pos};
							} else {
								n;
							};
						} else {
							n;
						};
					};
				} else {
					n;
				};
			};
		});
	}
}