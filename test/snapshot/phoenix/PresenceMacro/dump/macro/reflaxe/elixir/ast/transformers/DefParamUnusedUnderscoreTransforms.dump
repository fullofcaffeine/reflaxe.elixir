class reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreTransforms {

	public static function transformPass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EModule(name, attrs, body):
		var isPhoenixCtx = (n.metadata?.isPhoenixWeb == true) || (name != null && ((name.indexOf("Web.") >= 0) || StringTools.endsWith(name, ".Live") || StringTools.endsWith(name, ".Presence") || StringTools.endsWith(name, "Web")));
		if (!isPhoenixCtx || (name != null && StringTools.endsWith(name, ".Gettext"))) return n;
		var newBody = [];
		for (b  in  body) newBody.push(rewriteDefs(b));
		makeASTWithMeta(EModule(name, attrs, newBody), n.metadata, n.pos);	
	case EDefmodule(name, doBlock):
		var isPhoenixCtx2 = (n.metadata?.isPhoenixWeb == true) || (name != null && ((name.indexOf("Web.") >= 0) || StringTools.endsWith(name, ".Live") || StringTools.endsWith(name, ".Presence") || StringTools.endsWith(name, "Web")));
		if (!isPhoenixCtx2 || (name != null && StringTools.endsWith(name, ".Gettext"))) return n;
		makeASTWithMeta(EDefmodule(name, rewriteDefs(doBlock)), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 0: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var name = `;
							var attrs = `;
							var body = `;
							{
								var isPhoenixCtx = ({
									var tmp = n.metadata;
									if (tmp != null) tmp.isPhoenixWeb else null;
								} == true) || (name != null && ((name.indexOf("Web.", null) >= 0) || StringTools.endsWith(name, ".Live") || StringTools.endsWith(name, ".Presence") || StringTools.endsWith(name, "Web")));
								if (! isPhoenixCtx || (name != null && StringTools.endsWith(name, ".Gettext"))) {
									return n;
								};
								var newBody = [];
								{
									var ` = 0;
									while (` < body.length) {
										var b = body[`];
										++ `;
										newBody.push(reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreTransforms.rewriteDefs(b));
									};
								};
								{def : reflaxe.elixir.ast.ElixirASTDef.EModule(name, attrs, newBody), metadata : n.metadata, pos : n.pos};
							};
						};
					};
					case 1: {
						var ` = `[0];
						var ` = `[1];
						{
							var name = `;
							var doBlock = `;
							{
								var isPhoenixCtx2 = ({
									var tmp = n.metadata;
									if (tmp != null) tmp.isPhoenixWeb else null;
								} == true) || (name != null && ((name.indexOf("Web.", null) >= 0) || StringTools.endsWith(name, ".Live") || StringTools.endsWith(name, ".Presence") || StringTools.endsWith(name, "Web")));
								if (! isPhoenixCtx2 || (name != null && StringTools.endsWith(name, ".Gettext"))) {
									return n;
								};
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EDefmodule(name, reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreTransforms.rewriteDefs(doBlock));
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							};
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}

	static function rewriteDefs(node:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(node, function(x:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (x.def) {
	case EDef(name, args, guards, body):
		if ((name == "handle_event" || StringTools.startsWith(name, "handle_event")) && args != null && args.length == 3) {
			makeASTWithMeta(EDef(name, args, guards, body), x.metadata, x.pos);
		} else {
			var paramNames = extractParamNames(args);
			var used = collectUsedNames(body, paramNames);
			var newArgs = underscoreUnusedParams(args, used);
			makeASTWithMeta(EDef(name, newArgs, guards, body), x.metadata, x.pos);
		};	
	case EDefp(name, args2, guards2, body2):
		if ((name == "handle_event" || StringTools.startsWith(name, "handle_event")) && args2 != null && args2.length == 3) {
			makeASTWithMeta(EDefp(name, args2, guards2, body2), x.metadata, x.pos);
		} else {
			var paramNames2 = extractParamNames(args2);
			var used2 = collectUsedNames(body2, paramNames2);
			var newArgs2 = underscoreUnusedParams(args2, used2);
			makeASTWithMeta(EDefp(name, newArgs2, guards2, body2), x.metadata, x.pos);
		};	
	default:
		x;	
}) {
				var ` = x.def;
				switch (enumIndex `) {
					case 2: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name = `;
							var args = `;
							var guards = `;
							var body = `;
							{
								if ((name == "handle_event" || StringTools.startsWith(name, "handle_event")) && args != null && args.length == 3) {
									{def : reflaxe.elixir.ast.ElixirASTDef.EDef(name, args, guards, body), metadata : x.metadata, pos : x.pos};
								} else {
									var paramNames = reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreTransforms.extractParamNames(args);
									var used = reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreTransforms.collectUsedNames(body, paramNames);
									var newArgs = reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreTransforms.underscoreUnusedParams(args, used);
									{def : reflaxe.elixir.ast.ElixirASTDef.EDef(name, newArgs, guards, body), metadata : x.metadata, pos : x.pos};
								};
							};
						};
					};
					case 3: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name = `;
							var args2 = `;
							var guards2 = `;
							var body2 = `;
							{
								if ((name == "handle_event" || StringTools.startsWith(name, "handle_event")) && args2 != null && args2.length == 3) {
									{def : reflaxe.elixir.ast.ElixirASTDef.EDefp(name, args2, guards2, body2), metadata : x.metadata, pos : x.pos};
								} else {
									var paramNames2 = reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreTransforms.extractParamNames(args2);
									var used2 = reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreTransforms.collectUsedNames(body2, paramNames2);
									var newArgs2 = reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreTransforms.underscoreUnusedParams(args2, used2);
									{def : reflaxe.elixir.ast.ElixirASTDef.EDefp(name, newArgs2, guards2, body2), metadata : x.metadata, pos : x.pos};
								};
							};
						};
					};
					default: {
						x;
					}
				};
			};
		});
	}

	static function extractParamNames(args:Array<reflaxe.elixir.ast.EPattern>) {
		var names = [];
		var visit = [null];
		visit[0] = function(p:reflaxe.elixir.ast.EPattern) {
			@:ast(switch (p) {
	case PVar(n):
		if (n != null && n.length > 0) names.push(n);	
	case PTuple(es):
		for (e  in  es) visit(e);	
	case PList(es):
		for (e  in  es) visit(e);	
	case PCons(h, t):
		visit(h);
		visit(t);	
	case PMap(kvs):
		for (kv  in  kvs) visit(kv.value);	
	case PStruct(_, fs):
		for (f  in  fs) visit(f.value);	
	case PPin(inner):
		visit(inner);	
	default:
}) switch (enumIndex p) {
				case 0: {
					var ` = p[0];
					{
						var n = `;
						{
							if (n != null && n.length > 0) {
								names.push(n);
							};
						};
					};
				};
				case 2: {
					var ` = p[0];
					{
						var es = `;
						{
							{
								var ` = 0;
								while (` < es.length) {
									var e = es[`];
									++ `;
									visit[0](e);
								};
							};
						};
					};
				};
				case 3: {
					var ` = p[0];
					{
						var es = `;
						{
							{
								var ` = 0;
								while (` < es.length) {
									var e = es[`];
									++ `;
									visit[0](e);
								};
							};
						};
					};
				};
				case 4: {
					var ` = p[0];
					var ` = p[1];
					{
						var h = `;
						var t = `;
						{
							visit[0](h);
							visit[0](t);
						};
					};
				};
				case 5: {
					var ` = p[0];
					{
						var kvs = `;
						{
							{
								var ` = 0;
								while (` < kvs.length) {
									var kv = kvs[`];
									++ `;
									visit[0](kv.value);
								};
							};
						};
					};
				};
				case 6: {
					var ` = p[0];
					var ` = p[1];
					{
						var fs = `;
						{
							{
								var ` = 0;
								while (` < fs.length) {
									var f = fs[`];
									++ `;
									visit[0](f.value);
								};
							};
						};
					};
				};
				case 7: {
					var ` = p[0];
					{
						var inner = `;
						{
							visit[0](inner);
						};
					};
				};
				default: {}
			};
		};
		if (args != null) {
			{
				var ` = 0;
				while (` < args.length) {
					var a = args[`];
					++ `;
					visit[0](a);
				};
			};
		};
		return names;
	}

	static function underscoreUnusedParams(args:Array<reflaxe.elixir.ast.EPattern>, used:Map<String, Bool>) {
		if (args == null) {
			return args;
		};
		return {
			var ` = [];
			{
				var ` = 0;
				while (` < args.length) {
					var a = args[`];
					++ `;
					`.push(reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreTransforms.underscorePattern(a, used));
				};
			};
			`;
		};
	}

	static function underscorePattern(p:reflaxe.elixir.ast.EPattern, used:Map<String, Bool>) {
		return @:ast(switch (p) {
	case PVar(name):
		var preserve = (name == "assigns" || name == "opts" || name == "args" || name == "conn");
		if (!preserve && name != null && name.length > 0 && name.charAt(0) != "_" && !used.exists(name)) PVar("_" + name) else p;	
	case PTuple(es):
		PTuple([for (e  in  es) underscorePattern(e, used)]);	
	case PList(es):
		PList([for (e  in  es) underscorePattern(e, used)]);	
	case PCons(h, t):
		PCons(underscorePattern(h, used), underscorePattern(t, used));	
	case PMap(kvs):
		PMap([for (kv  in  kvs) { key : kv.key, value : underscorePattern(kv.value, used) }]);	
	case PStruct(nm, fs):
		PStruct(nm, [for (f  in  fs) { key : f.key, value : underscorePattern(f.value, used) }]);	
	case PPin(inner):
		PPin(underscorePattern(inner, used));	
	default:
		p;	
}) switch (enumIndex p) {
			case 0: {
				var ` = p[0];
				{
					var name = `;
					{
						var preserve = (name == "assigns" || name == "opts" || name == "args" || name == "conn");
						if (! preserve && name != null && name.length > 0 && name.charAt(0) != "_" && ! used.exists(name)) {
							reflaxe.elixir.ast.EPattern.PVar("_" + name);
						} else {
							p;
						};
					};
				};
			};
			case 2: {
				var ` = p[0];
				{
					var es = `;
					{
						reflaxe.elixir.ast.EPattern.PTuple({
							var ` = [];
							{
								var ` = 0;
								while (` < es.length) {
									var e = es[`];
									++ `;
									`.push(reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreTransforms.underscorePattern(e, used));
								};
							};
							`;
						});
					};
				};
			};
			case 3: {
				var ` = p[0];
				{
					var es = `;
					{
						reflaxe.elixir.ast.EPattern.PList({
							var ` = [];
							{
								var ` = 0;
								while (` < es.length) {
									var e = es[`];
									++ `;
									`.push(reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreTransforms.underscorePattern(e, used));
								};
							};
							`;
						});
					};
				};
			};
			case 4: {
				var ` = p[0];
				var ` = p[1];
				{
					var h = `;
					var t = `;
					{
						reflaxe.elixir.ast.EPattern.PCons(reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreTransforms.underscorePattern(h, used), reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreTransforms.underscorePattern(t, used));
					};
				};
			};
			case 5: {
				var ` = p[0];
				{
					var kvs = `;
					{
						reflaxe.elixir.ast.EPattern.PMap({
							var ` = [];
							{
								var ` = 0;
								while (` < kvs.length) {
									var kv = kvs[`];
									++ `;
									`.push({key : kv.key, value : reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreTransforms.underscorePattern(kv.value, used)});
								};
							};
							`;
						});
					};
				};
			};
			case 6: {
				var ` = p[0];
				var ` = p[1];
				{
					var nm = `;
					var fs = `;
					{
						reflaxe.elixir.ast.EPattern.PStruct(nm, {
							var ` = [];
							{
								var ` = 0;
								while (` < fs.length) {
									var f = fs[`];
									++ `;
									`.push({key : f.key, value : reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreTransforms.underscorePattern(f.value, used)});
								};
							};
							`;
						});
					};
				};
			};
			case 7: {
				var ` = p[0];
				{
					var inner = `;
					{
						reflaxe.elixir.ast.EPattern.PPin(reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreTransforms.underscorePattern(inner, used));
					};
				};
			};
			default: {
				p;
			}
		};
	}

	static function collectUsedNames(body:reflaxe.elixir.ast.ElixirAST, paramNames:Array<String>) {
		var names = {
			{};
			new haxe.ds.StringMap();
		};
		var paramSet = {
			{};
			new haxe.ds.StringMap();
		};
		if (paramNames != null) {
			{
				var ` = 0;
				while (` < paramNames.length) {
					var pn = paramNames[`];
					++ `;
					if (pn != null && pn.length > 0) {
						{
							paramSet.set(pn, true);
						};
					};
				};
			};
		};
		{};
		{};
		var visit = [null];
		visit[0] = function(n:reflaxe.elixir.ast.ElixirAST) {
			if (n == null || n.def == null) {
				return;
			};
			@:ast(switch (n.def) {
	case EVar(v):
		names.set(v, true);	
	case EString(s):
		if (s != null) scanInterpolation(s, names);	
	case ERaw(code):
		if (code != null) {
			scanInterpolation(code, names);
			markTokenUsage(code);
		};	
	case EList(els):
		for (el  in  els) visit(el);	
	case ETuple(els):
		for (el  in  els) visit(el);	
	case EMap(pairs):
		for (p  in  pairs) {
			visit(p.key);
			visit(p.value);
		};	
	case EKeywordList(pairs):
		for (p  in  pairs) visit(p.value);	
	case EStructUpdate(base, fields):
		visit(base);
		for (f  in  fields) visit(f.value);	
	case EField(obj, _):
		visit(obj);	
	case EAccess(tgt, key):
		visit(tgt);
		visit(key);	
	case EBlock(ss):
		for (s  in  ss) visit(s);	
	case EIf(c, t, e):
		visit(c);
		visit(t);
		if (e != null) visit(e);	
	case ECase(expr, cs):
		visit(expr);
		for (c  in  cs) visit(c.body);	
	case EBinary(_, l, r):
		visit(l);
		visit(r);	
	case EMatch(_, rhs):
		visit(rhs);	
	case ECall(t, _, as):
		if (t != null) visit(t);
		if (as != null) for (a  in  as) visit(a);	
	case ERemoteCall(t2, _, as2):
		visit(t2);
		if (as2 != null) for (a2  in  as2) visit(a2);	
	case EFn(clauses):
		for (cl  in  clauses) visit(cl.body);	
	default:
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 6: {
						var ` = `[0];
						var ` = `[1];
						{
							var expr = `;
							var cs = `;
							{
								visit[0](expr);
								{
									var ` = 0;
									while (` < cs.length) {
										var c = cs[`];
										++ `;
										visit[0](c.body);
									};
								};
							};
						};
					};
					case 8: {
						var ` = `[0];
						var ` = `[1];
						{
							var rhs = `;
							{
								visit[0](rhs);
							};
						};
					};
					case 10: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var c = `;
							var t = `;
							var e = `;
							{
								visit[0](c);
								visit[0](t);
								if (e != null) {
									visit[0](e);
								};
							};
						};
					};
					case 15: {
						var ` = `[0];
						{
							var els = `;
							{
								{
									var ` = 0;
									while (` < els.length) {
										var el = els[`];
										++ `;
										visit[0](el);
									};
								};
							};
						};
					};
					case 16: {
						var ` = `[0];
						{
							var els = `;
							{
								{
									var ` = 0;
									while (` < els.length) {
										var el = els[`];
										++ `;
										visit[0](el);
									};
								};
							};
						};
					};
					case 17: {
						var ` = `[0];
						{
							var pairs = `;
							{
								{
									var ` = 0;
									while (` < pairs.length) {
										var p = pairs[`];
										++ `;
										visit[0](p.key);
										visit[0](p.value);
									};
								};
							};
						};
					};
					case 19: {
						var ` = `[0];
						var ` = `[1];
						{
							var base = `;
							var fields = `;
							{
								visit[0](base);
								{
									var ` = 0;
									while (` < fields.length) {
										var f = fields[`];
										++ `;
										visit[0](f.value);
									};
								};
							};
						};
					};
					case 20: {
						var ` = `[0];
						{
							var pairs = `;
							{
								{
									var ` = 0;
									while (` < pairs.length) {
										var p = pairs[`];
										++ `;
										visit[0](p.value);
									};
								};
							};
						};
					};
					case 22: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var t = `;
							var as = `;
							{
								if (t != null) {
									visit[0](t);
								};
								if (as != null) {
									{
										var ` = 0;
										while (` < as.length) {
											var a = as[`];
											++ `;
											visit[0](a);
										};
									};
								};
							};
						};
					};
					case 24: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var t2 = `;
							var as2 = `;
							{
								visit[0](t2);
								if (as2 != null) {
									{
										var ` = 0;
										while (` < as2.length) {
											var a2 = as2[`];
											++ `;
											visit[0](a2);
										};
									};
								};
							};
						};
					};
					case 26: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var l = `;
							var r = `;
							{
								visit[0](l);
								visit[0](r);
							};
						};
					};
					case 28: {
						var ` = `[0];
						var ` = `[1];
						{
							var obj = `;
							{
								visit[0](obj);
							};
						};
					};
					case 29: {
						var ` = `[0];
						var ` = `[1];
						{
							var tgt = `;
							var key = `;
							{
								visit[0](tgt);
								visit[0](key);
							};
						};
					};
					case 32: {
						var ` = `[0];
						{
							var s = `;
							{
								if (s != null) {
									{
										var i = 0;
										while (i < s.length) {
											var idx = s.indexOf("#{", i);
											if (idx == -1) {
												break;
											};
											var j = idx + 2;
											var buf = new StringBuf();
											while (j < s.length) {
												var c = s.charAt(j);
												if (c == "}") {
													break;
												};
												if (new EReg("[A-Za-z0-9_]", "").match(c)) {
													buf.add(c);
												};
												j ++;
											};
											var name = buf.toString();
											if (name.length > 0) {
												{
													names.set(name, true);
												};
											};
											i = j + 1;
										};
									};
								};
							};
						};
					};
					case 38: {
						var ` = `[0];
						{
							var v = `;
							{
								{
									names.set(v, true);
								};
							};
						};
					};
					case 42: {
						var ` = `[0];
						{
							var clauses = `;
							{
								{
									var ` = 0;
									while (` < clauses.length) {
										var cl = clauses[`];
										++ `;
										visit[0](cl.body);
									};
								};
							};
						};
					};
					case 53: {
						var ` = `[0];
						{
							var ss = `;
							{
								{
									var ` = 0;
									while (` < ss.length) {
										var s = ss[`];
										++ `;
										visit[0](s);
									};
								};
							};
						};
					};
					case 62: {
						var ` = `[0];
						{
							var code = `;
							{
								if (code != null) {
									{
										var i = 0;
										while (i < code.length) {
											var idx = code.indexOf("#{", i);
											if (idx == -1) {
												break;
											};
											var j = idx + 2;
											var buf = new StringBuf();
											while (j < code.length) {
												var c = code.charAt(j);
												if (c == "}") {
													break;
												};
												if (new EReg("[A-Za-z0-9_]", "").match(c)) {
													buf.add(c);
												};
												j ++;
											};
											var name = buf.toString();
											if (name.length > 0) {
												{
													names.set(name, true);
												};
											};
											i = j + 1;
										};
									};
									{
										if (code == null) {
											null;
										} else {
											for (pn in paramSet.keys()) {
												if (pn == null || pn.length == 0 || pn.charAt(0) == "_") {
													continue;
												};
												var start = 0;
												while (true) {
													var i = code.indexOf(pn, start);
													if (i == -1) {
														break;
													};
													var before = if (i > 0) {
														code.substr(i - 1, 1);
													} else {
														null;
													};
													var afterIdx = i + pn.length;
													var after = if (afterIdx < code.length) {
														code.substr(afterIdx, 1);
													} else {
														null;
													};
													if (! if (before == null || before.length == 0) {
														false;
													} else {
														var ch = before.charCodeAt(0);
														(ch >= 48 && ch <= 57) || (ch >= 65 && ch <= 90) || (ch >= 97 && ch <= 122) || before == "_";
													} && ! if (after == null || after.length == 0) {
														false;
													} else {
														var ch = after.charCodeAt(0);
														(ch >= 48 && ch <= 57) || (ch >= 65 && ch <= 90) || (ch >= 97 && ch <= 122) || after == "_";
													}) {
														{
															names.set(pn, true);
														};
														break;
													};
													start = i + pn.length;
												};
											};
										};
									};
								};
							};
						};
					};
					default: {}
				};
			};
		};
		visit[0](body);
		return names;
	}

	static inline function scanInterpolation(text:String, out:Map<String, Bool>) {
		var i = 0;
		while (i < text.length) {
			var idx = text.indexOf("#{", i);
			if (idx == -1) {
				break;
			};
			var j = idx + 2;
			var buf = new StringBuf();
			while (j < text.length) {
				var c = text.charAt(j);
				if (c == "}") {
					break;
				};
				if (new EReg("[A-Za-z0-9_]", "").match(c)) {
					buf.add(c);
				};
				j ++;
			};
			var name = buf.toString();
			if (name.length > 0) {
				{
					out.set(name, true);
				};
			};
			i = j + 1;
		};
	}
}