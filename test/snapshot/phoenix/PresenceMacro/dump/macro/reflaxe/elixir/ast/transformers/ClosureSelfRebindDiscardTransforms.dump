class reflaxe.elixir.ast.transformers.ClosureSelfRebindDiscardTransforms {

	public static function pass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EFn(clauses):
		var out = [];
		for (cl  in  clauses) {
			var binder:Null<String> = switch (cl.args.length == 1 ? cl.args[0] : null) {
				case PVar(v):
					v;				
				default:
					null;				
			};
			if (binder == null) {
				out.push(cl);
				continue;
			};
			var newBody = ElixirASTTransformer.transformNode(cl.body, function(x:ElixirAST):ElixirAST {
				return switch (x.def) {
					case EBinary(Match, left, rhs):
						switch (left.def) {
							case EVar(v) if (v == binder):
								makeASTWithMeta(EBinary(Match, makeASTWithMeta(EVar("_"), left.metadata, left.pos), rhs), x.metadata, x.pos);							
							default:
								x;							
						};					
					case EMatch(pat, rhs2):
						switch (pat) {
							case PVar(v2) if (v2 == binder):
								makeASTWithMeta(EMatch(PVar("_"), rhs2), x.metadata, x.pos);							
							default:
								x;							
						};					
					default:
						x;					
				};
			});
			out.push({ args : cl.args, guard : cl.guard, body : newBody });
		};
		makeASTWithMeta(EFn(out), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				if (enumIndex ` == 42) {
					var ` = `[0];
					{
						var clauses = `;
						{
							var out = [];
							{
								var ` = 0;
								while (` < clauses.length) {
									var cl = clauses[`];
									++ `;
									var binder = @:ast(switch (cl.args.length == 1 ? cl.args[0] : null) {
	case PVar(v):
		v;	
	default:
		null;	
}) {
										var ` = if (cl.args.length == 1) {
											cl.args[0];
										} else {
											null;
										};
										if (` == null) {
											null;
										} else if (enumIndex ` == 0) {
											var ` = `[0];
											{
												var v = `;
												{
													v;
												};
											};
										} else {
											null;
										};
									};
									if (binder == null) {
										out.push(cl);
										continue;
									};
									var newBody = reflaxe.elixir.ast.ElixirASTTransformer.transformNode(cl.body, function(x:reflaxe.elixir.ast.ElixirAST) {
										return @:ast(switch (x.def) {
	case EBinary(Match, left, rhs):
		switch (left.def) {
			case EVar(v) if (v == binder):
				makeASTWithMeta(EBinary(Match, makeASTWithMeta(EVar("_"), left.metadata, left.pos), rhs), x.metadata, x.pos);			
			default:
				x;			
		};	
	case EMatch(pat, rhs2):
		switch (pat) {
			case PVar(v2) if (v2 == binder):
				makeASTWithMeta(EMatch(PVar("_"), rhs2), x.metadata, x.pos);			
			default:
				x;			
		};	
	default:
		x;	
}) {
											var ` = x.def;
											switch (enumIndex `) {
												case 8: {
													var ` = `[0];
													var ` = `[1];
													{
														var pat = `;
														var rhs2 = `;
														{
															@:ast(switch (pat) {
	case PVar(v2) if (v2 == binder):
		makeASTWithMeta(EMatch(PVar("_"), rhs2), x.metadata, x.pos);	
	default:
		x;	
}) if (enumIndex pat == 0) {
																var ` = pat[0];
																{
																	var v2 = `;
																	if (v2 == binder) {
																		{def : reflaxe.elixir.ast.ElixirASTDef.EMatch(reflaxe.elixir.ast.EPattern.PVar("_"), rhs2), metadata : x.metadata, pos : x.pos};
																	} else {
																		x;
																	};
																};
															} else {
																x;
															};
														};
													};
												};
												case 26: {
													var ` = `[0];
													var ` = `[1];
													var ` = `[2];
													if (enumIndex ` == 27) {
														{
															var left = `;
															var rhs = `;
															{
																@:ast(switch (left.def) {
	case EVar(v) if (v == binder):
		makeASTWithMeta(EBinary(Match, makeASTWithMeta(EVar("_"), left.metadata, left.pos), rhs), x.metadata, x.pos);	
	default:
		x;	
}) {
																	var ` = left.def;
																	if (enumIndex ` == 38) {
																		var ` = `[0];
																		{
																			var v = `;
																			if (v == binder) {
																				{def : reflaxe.elixir.ast.ElixirASTDef.EBinary(reflaxe.elixir.ast.EBinaryOp.Match, {def : reflaxe.elixir.ast.ElixirASTDef.EVar("_"), metadata : left.metadata, pos : left.pos}, rhs), metadata : x.metadata, pos : x.pos};
																			} else {
																				x;
																			};
																		};
																	} else {
																		x;
																	};
																};
															};
														};
													} else {
														x;
													};
												};
												default: {
													x;
												}
											};
										};
									});
									out.push({args : cl.args, guard : cl.guard, body : newBody});
								};
							};
							{def : reflaxe.elixir.ast.ElixirASTDef.EFn(out), metadata : n.metadata, pos : n.pos};
						};
					};
				} else {
					n;
				};
			};
		});
	}
}