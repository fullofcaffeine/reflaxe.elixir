class reflaxe.elixir.ast.transformers.HandleInfoScrutineeToPayloadRefTransforms {

	public static function transformPass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EDef(name, args, guards, body):
		if (name == "handle_info" && args.length == 2) {
			Sys.println("[HandleInfoScrutineeToPayload] start in handle_info/2");
			var newBody = rewriteInBody(body);
			makeASTWithMeta(EDef(name, args, guards, newBody), n.metadata, n.pos);
		} else n;	
	default:
		n;	
}) {
				var ` = n.def;
				if (enumIndex ` == 2) {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					var ` = `[3];
					{
						var name = `;
						var args = `;
						var guards = `;
						var body = `;
						{
							if (name == "handle_info" && args.length == 2) {
								Sys.println("[HandleInfoScrutineeToPayload] start in handle_info/2");
								var newBody = reflaxe.elixir.ast.transformers.HandleInfoScrutineeToPayloadRefTransforms.rewriteInBody(body);
								{def : reflaxe.elixir.ast.ElixirASTDef.EDef(name, args, guards, newBody), metadata : n.metadata, pos : n.pos};
							} else {
								n;
							};
						};
					};
				} else {
					n;
				};
			};
		});
	}

	static function rewriteInBody(body:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(body, function(x:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (x.def) {
	case ECase(scrut, clauses):
		var s = switch (scrut.def) {
			case EVar(v):
				v;			
			default:
				null;			
		};
		if (s == null) return x;
		Sys.println("[HandleInfoScrutineeToPayload] found case scrutinee var=" + s);
		var out:Array<ECaseClause> = [];
		for (cl  in  clauses) out.push(rewriteClause(cl, s));
		makeASTWithMeta(ECase(scrut, out), x.metadata, x.pos);	
	default:
		x;	
}) {
				var ` = x.def;
				if (enumIndex ` == 6) {
					var ` = `[0];
					var ` = `[1];
					{
						var scrut = `;
						var clauses = `;
						{
							var s = @:ast(switch (scrut.def) {
	case EVar(v):
		v;	
	default:
		null;	
}) {
								var ` = scrut.def;
								if (enumIndex ` == 38) {
									var ` = `[0];
									{
										var v = `;
										{
											v;
										};
									};
								} else {
									null;
								};
							};
							if (s == null) {
								return x;
							};
							Sys.println("[HandleInfoScrutineeToPayload] found case scrutinee var=" + s);
							var out = [];
							{
								var ` = 0;
								while (` < clauses.length) {
									var cl = clauses[`];
									++ `;
									out.push(reflaxe.elixir.ast.transformers.HandleInfoScrutineeToPayloadRefTransforms.rewriteClause(cl, s));
								};
							};
							{def : reflaxe.elixir.ast.ElixirASTDef.ECase(scrut, out), metadata : x.metadata, pos : x.pos};
						};
					};
				} else {
					x;
				};
			};
		});
	}

	static function rewriteClause(cl:reflaxe.elixir.ast.ECaseClause, scrutVar:String) {
		var binder = reflaxe.elixir.ast.transformers.HandleInfoScrutineeToPayloadRefTransforms.extractSecondBinder(cl.pattern);
		if (binder == null) {
			return cl;
		};
		Sys.println("[HandleInfoScrutineeToPayload] clause binder=" + binder + " (from scrutinee=" + scrutVar + ")");
		var newBody = reflaxe.elixir.ast.transformers.HandleInfoScrutineeToPayloadRefTransforms.substituteVar(cl.body, scrutVar, binder);
		return {pattern : cl.pattern, guard : cl.guard, body : newBody};
	}

	static function extractSecondBinder(p:reflaxe.elixir.ast.EPattern) {
		return @:ast(switch (p) {
	case PTuple(items) if (items.length == 2):
		switch (items[1]) {
			case PVar(n):
				n;			
			case PPin(inner):
				switch (inner) {
					case PVar(n2):
						n2;					
					default:
						null;					
				};			
			default:
				null;			
		};	
	default:
		null;	
}) if (enumIndex p == 2) {
			var ` = p[0];
			{
				var items = `;
				if (items.length == 2) {
					@:ast(switch (items[1]) {
	case PVar(n):
		n;	
	case PPin(inner):
		switch (inner) {
			case PVar(n2):
				n2;			
			default:
				null;			
		};	
	default:
		null;	
}) {
						var ` = items[1];
						switch (enumIndex `) {
							case 0: {
								var ` = `[0];
								{
									var n = `;
									{
										n;
									};
								};
							};
							case 7: {
								var ` = `[0];
								{
									var inner = `;
									{
										@:ast(switch (inner) {
	case PVar(n2):
		n2;	
	default:
		null;	
}) if (enumIndex inner == 0) {
											var ` = inner[0];
											{
												var n2 = `;
												{
													n2;
												};
											};
										} else {
											null;
										};
									};
								};
							};
							default: {
								null;
							}
						};
					};
				} else {
					null;
				};
			};
		} else {
			null;
		};
	}

	static function substituteVar(body:reflaxe.elixir.ast.ElixirAST, from:String, to:String) {
		if (from == to) {
			return body;
		};
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(body, function(x:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (x.def) {
	case EVar(v) if (v == from):
		makeASTWithMeta(EVar(to), x.metadata, x.pos);	
	default:
		x;	
}) {
				var ` = x.def;
				if (enumIndex ` == 38) {
					var ` = `[0];
					{
						var v = `;
						if (v == from) {
							{def : reflaxe.elixir.ast.ElixirASTDef.EVar(to), metadata : x.metadata, pos : x.pos};
						} else {
							x;
						};
					};
				} else {
					x;
				};
			};
		});
	}
}