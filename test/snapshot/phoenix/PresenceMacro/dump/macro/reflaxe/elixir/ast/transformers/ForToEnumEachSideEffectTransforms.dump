class reflaxe.elixir.ast.transformers.ForToEnumEachSideEffectTransforms {

	public static function pass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EFor(generators, filters, body, into, _uniq) if (into == null && generators != null && generators.length == 1):
		var g = generators[0];
		switch (g.pattern) {
			case PVar(varName):
				var collection = g.expr;
				var source = (filters != null && filters.length > 0) ? makeAST(ERemoteCall(makeAST(EVar("Enum")), "filter", [collection, makeAST(EFn([{ args : [PVar(varName)], guard : null, body : foldAnd(filters) }]))])) : collection;
				var paramName = varName;
				var rewrittenBody = body;
				var each = makeAST(ERemoteCall(makeAST(EVar("Enum")), "each", [source, makeAST(EFn([{ args : [PVar(paramName)], guard : null, body : rewrittenBody }]))]));
				makeASTWithMeta(each.def, n.metadata, n.pos);			
			default:
				n;			
		};	
	default:
		n;	
}) {
				var ` = n.def;
				if (enumIndex ` == 41) {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					var ` = `[3];
					var ` = `[4];
					{
						var generators = `;
						var filters = `;
						var body = `;
						var into = `;
						var _uniq = `;
						if (into == null && generators != null && generators.length == 1) {
							var g = generators[0];
							@:ast(switch (g.pattern) {
	case PVar(varName):
		var collection = g.expr;
		var source = (filters != null && filters.length > 0) ? makeAST(ERemoteCall(makeAST(EVar("Enum")), "filter", [collection, makeAST(EFn([{ args : [PVar(varName)], guard : null, body : foldAnd(filters) }]))])) : collection;
		var paramName = varName;
		var rewrittenBody = body;
		var each = makeAST(ERemoteCall(makeAST(EVar("Enum")), "each", [source, makeAST(EFn([{ args : [PVar(paramName)], guard : null, body : rewrittenBody }]))]));
		makeASTWithMeta(each.def, n.metadata, n.pos);	
	default:
		n;	
}) {
								var ` = g.pattern;
								if (enumIndex ` == 0) {
									var ` = `[0];
									{
										var varName = `;
										{
											var collection = g.expr;
											var source = if ((filters != null && filters.length > 0)) {
												{
													var def = reflaxe.elixir.ast.ElixirASTDef.ERemoteCall({
														var pos = null;
														{def : reflaxe.elixir.ast.ElixirASTDef.EVar("Enum"), metadata : {}, pos : pos};
													}, "filter", [collection, {
														var def = reflaxe.elixir.ast.ElixirASTDef.EFn([{args : [reflaxe.elixir.ast.EPattern.PVar(varName)], guard : null, body : reflaxe.elixir.ast.transformers.ForToEnumEachSideEffectTransforms.foldAnd(filters)}]);
														var pos = null;
														{def : def, metadata : {}, pos : pos};
													}]);
													var pos = null;
													{def : def, metadata : {}, pos : pos};
												};
											} else {
												collection;
											};
											var paramName = varName;
											var rewrittenBody = body;
											var each = {
												var pos = null;
												{def : reflaxe.elixir.ast.ElixirASTDef.ERemoteCall({
													var pos = null;
													{def : reflaxe.elixir.ast.ElixirASTDef.EVar("Enum"), metadata : {}, pos : pos};
												}, "each", [source, {
													var pos = null;
													{def : reflaxe.elixir.ast.ElixirASTDef.EFn([{args : [reflaxe.elixir.ast.EPattern.PVar(paramName)], guard : null, body : rewrittenBody}]), metadata : {}, pos : pos};
												}]), metadata : {}, pos : pos};
											};
											{def : each.def, metadata : n.metadata, pos : n.pos};
										};
									};
								} else {
									n;
								};
							};
						} else {
							n;
						};
					};
				} else {
					n;
				};
			};
		});
	}

	static function foldAnd(filters:Array<reflaxe.elixir.ast.ElixirAST>) {
		if (filters == null || filters.length == 0) {
			return {
				var def = reflaxe.elixir.ast.ElixirASTDef.EAtom(@:implicitCast {
					var this;
					this = reflaxe.elixir.ast.NameUtils.toSnakeCase("true");
					cast this;
				});
				var pos = null;
				{def : def, metadata : {}, pos : pos};
			};
		};
		var acc = filters[0];
		{
			var ` = 1;
			var ` = filters.length;
			while (` < `) {
				var i = ` ++;
				acc = {
					var pos = null;
					{def : reflaxe.elixir.ast.ElixirASTDef.EBinary(reflaxe.elixir.ast.EBinaryOp.And, acc, filters[i]), metadata : {}, pos : pos};
				};
			};
		};
		return acc;
	}

	static function renameVar(node:reflaxe.elixir.ast.ElixirAST, from:String, to:String) {
		if (from == to) {
			return node;
		};
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(node, function(x:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (x.def) {
	case EVar(v) if (v == from):
		makeASTWithMeta(EVar(to), x.metadata, x.pos);	
	default:
		x;	
}) {
				var ` = x.def;
				if (enumIndex ` == 38) {
					var ` = `[0];
					{
						var v = `;
						if (v == from) {
							{def : reflaxe.elixir.ast.ElixirASTDef.EVar(to), metadata : x.metadata, pos : x.pos};
						} else {
							x;
						};
					};
				} else {
					x;
				};
			};
		});
	}
}