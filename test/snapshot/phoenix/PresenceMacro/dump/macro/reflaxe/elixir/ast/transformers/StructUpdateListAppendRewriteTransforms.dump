class reflaxe.elixir.ast.transformers.StructUpdateListAppendRewriteTransforms {

	public static function transformPass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			@:ast(switch (n.def) {
	case EStructUpdate(structExpr, fields) if (fields != null && fields.length == 1):
		var f = fields[0];
		var keyName = f.key;
		var baseName = extractBaseVarName(structExpr);
		var out:ElixirAST = switch (f.value.def) {
			case EBinary(op, left, right) if (op == Concat && baseName != null && keyName != null):
				if (isStructFieldRef(left, baseName, keyName)) {
					var assign = makeAST(EMatch(PVar(keyName), makeAST(EBinary(Concat, makeAST(EVar(keyName)), right))));
					makeASTWithMeta(assign.def, n.metadata, n.pos);
				} else n;			
			default:
				n;			
		};
		return out;	
	default:
		return n;	
}) {
				var ` = n.def;
				if (enumIndex ` == 19) {
					var ` = `[0];
					var ` = `[1];
					{
						var structExpr = `;
						var fields = `;
						if (fields != null && fields.length == 1) {
							var f = fields[0];
							var keyName = f.key;
							var baseName = reflaxe.elixir.ast.transformers.StructUpdateListAppendRewriteTransforms.extractBaseVarName(structExpr);
							var out = @:ast(switch (f.value.def) {
	case EBinary(op, left, right) if (op == Concat && baseName != null && keyName != null):
		if (isStructFieldRef(left, baseName, keyName)) {
			var assign = makeAST(EMatch(PVar(keyName), makeAST(EBinary(Concat, makeAST(EVar(keyName)), right))));
			makeASTWithMeta(assign.def, n.metadata, n.pos);
		} else n;	
	default:
		n;	
}) {
								var ` = f.value.def;
								if (enumIndex ` == 26) {
									var ` = `[0];
									var ` = `[1];
									var ` = `[2];
									{
										var op = `;
										var left = `;
										var right = `;
										if (op == reflaxe.elixir.ast.EBinaryOp.Concat && baseName != null && keyName != null) {
											if (reflaxe.elixir.ast.transformers.StructUpdateListAppendRewriteTransforms.isStructFieldRef(left, baseName, keyName)) {
												var assign = {
													var pos = null;
													{def : reflaxe.elixir.ast.ElixirASTDef.EMatch(reflaxe.elixir.ast.EPattern.PVar(keyName), {
														var pos = null;
														{def : reflaxe.elixir.ast.ElixirASTDef.EBinary(reflaxe.elixir.ast.EBinaryOp.Concat, {
															var pos = null;
															{def : reflaxe.elixir.ast.ElixirASTDef.EVar(keyName), metadata : {}, pos : pos};
														}, right), metadata : {}, pos : pos};
													}), metadata : {}, pos : pos};
												};
												{def : assign.def, metadata : n.metadata, pos : n.pos};
											} else {
												n;
											};
										} else {
											n;
										};
									};
								} else {
									n;
								};
							};
							return out;
						} else {
							return n;
						};
					};
				} else {
					return n;
				};
			};
		});
	}

	static function extractBaseVarName(e:reflaxe.elixir.ast.ElixirAST) {
		return @:ast(switch (e.def) {
	case EVar(name):
		name;	
	default:
		null;	
}) {
			var ` = e.def;
			if (enumIndex ` == 38) {
				var ` = `[0];
				{
					var name = `;
					{
						name;
					};
				};
			} else {
				null;
			};
		};
	}

	static function isStructFieldRef(e:reflaxe.elixir.ast.ElixirAST, base:String, field:String) {
		return @:ast(switch (e.def) {
	case EField(left, fname):
		switch (left.def) {
			case EVar(v) if (v == base && fname == field):
				true;			
			default:
				false;			
		};	
	default:
		false;	
}) {
			var ` = e.def;
			if (enumIndex ` == 28) {
				var ` = `[0];
				var ` = `[1];
				{
					var left = `;
					var fname = `;
					{
						@:ast(switch (left.def) {
	case EVar(v) if (v == base && fname == field):
		true;	
	default:
		false;	
}) {
							var ` = left.def;
							if (enumIndex ` == 38) {
								var ` = `[0];
								{
									var v = `;
									if (v == base && fname == field) {
										true;
									} else {
										false;
									};
								};
							} else {
								false;
							};
						};
					};
				};
			} else {
				false;
			};
		};
	}
}