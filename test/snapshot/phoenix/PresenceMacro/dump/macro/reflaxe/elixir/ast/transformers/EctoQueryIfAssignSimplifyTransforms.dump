class reflaxe.elixir.ast.transformers.EctoQueryIfAssignSimplifyTransforms {

	public static function pass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EMatch(PVar(varName), rhs):
		var simplified = simplifyIfAssign(varName, rhs);
		if (simplified != null) makeASTWithMeta(EMatch(PVar(varName), simplified), n.metadata, n.pos) else n;	
	case EBinary(Match, { def : EVar(varName2) }, rhs2):
		var simplified2 = simplifyIfAssign(varName2, rhs2);
		if (simplified2 != null) makeASTWithMeta(EBinary(Match, makeAST(EVar(varName2)), simplified2), n.metadata, n.pos) else n;	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 8: {
						var ` = `[0];
						var ` = `[1];
						if (enumIndex ` == 0) {
							var ` = `[0];
							{
								var varName = `;
								var rhs = `;
								{
									var simplified = reflaxe.elixir.ast.transformers.EctoQueryIfAssignSimplifyTransforms.simplifyIfAssign(varName, rhs);
									if (simplified != null) {
										{def : reflaxe.elixir.ast.ElixirASTDef.EMatch(reflaxe.elixir.ast.EPattern.PVar(varName), simplified), metadata : n.metadata, pos : n.pos};
									} else {
										n;
									};
								};
							};
						} else {
							n;
						};
					};
					case 26: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						if (enumIndex ` == 27) {
							{
								var ` = `.def;
								var ` = `.metadata;
								var ` = `.pos;
								if (enumIndex ` == 38) {
									var ` = `[0];
									{
										var varName2 = `;
										var rhs2 = `;
										{
											var simplified2 = reflaxe.elixir.ast.transformers.EctoQueryIfAssignSimplifyTransforms.simplifyIfAssign(varName2, rhs2);
											if (simplified2 != null) {
												{def : reflaxe.elixir.ast.ElixirASTDef.EBinary(reflaxe.elixir.ast.EBinaryOp.Match, {
													var pos = null;
													{def : reflaxe.elixir.ast.ElixirASTDef.EVar(varName2), metadata : {}, pos : pos};
												}, simplified2), metadata : n.metadata, pos : n.pos};
											} else {
												n;
											};
										};
									};
								} else {
									n;
								};
							};
						} else {
							n;
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}

	static function simplifyIfAssign(varName:String, expr:reflaxe.elixir.ast.ElixirAST) {
		return @:ast(switch (expr.def) {
	case EIf(cond, thenExpr, elseExpr):
		function rewriteStmt(stmt:ElixirAST):Null<ElixirAST> {
			return switch (stmt.def) {
				case EMatch(PVar(inner), innerRhs) if (isEctoWhere(innerRhs)):
					if (inner == varName || (inner != null && inner.length > 1 && inner.charAt(0) == "_" && inner.substr(1) == varName)) {
						innerRhs;
					} else {
						rewriteInnerVar(innerRhs, inner, varName);
					};				
				case EBinary(Match, { def : EVar(inner2) }, innerRhs2) if (isEctoWhere(innerRhs2)):
					if (inner2 == varName || (inner2 != null && inner2.length > 1 && inner2.charAt(0) == "_" && inner2.substr(1) == varName)) {
						innerRhs2;
					} else {
						rewriteInnerVar(innerRhs2, inner2, varName);
					};				
				case EMatch(PVar(innerU), innerRhsU) if (isEctoWhere(innerRhsU) && innerU == varName):
					makeAST(EBinary(Match, makeAST(EVar("_" + innerU)), innerRhsU));				
				case EBinary(Match, { def : EVar(innerU2) }, innerRhsU2) if (isEctoWhere(innerRhsU2) && innerU2 == varName):
					makeAST(EBinary(Match, makeAST(EVar("_" + innerU2)), innerRhsU2));				
				default:
					null;				
			};
		};
		var newThen = (function() {
			switch (thenExpr.def) {
				case EMatch(_, _) | EBinary(Match, _, _):
					var r = rewriteStmt(thenExpr);
					return r != null ? r : thenExpr;				
				case EBlock(ss) if (ss.length > 0):
					var last = ss[ss.length - 1];
					var rewritten = rewriteStmt(last);
					if (rewritten != null) {
						var prefix = ss.copy();
						prefix.pop();
						return makeAST(EBlock(prefix.concat([rewritten])));
					} else return thenExpr;				
				case EDo(ss2) if (ss2.length > 0):
					var last2 = ss2[ss2.length - 1];
					var rewritten2 = rewriteStmt(last2);
					if (rewritten2 != null) {
						var prefix2 = ss2.copy();
						prefix2.pop();
						return makeAST(EDo(prefix2.concat([rewritten2])));
					} else return thenExpr;				
				default:
					return thenExpr;				
			};
		})();
		makeAST(EIf(cond, newThen, elseExpr));	
	default:
		null;	
}) {
			var ` = expr.def;
			if (enumIndex ` == 10) {
				var ` = `[0];
				var ` = `[1];
				var ` = `[2];
				{
					var cond = `;
					var thenExpr = `;
					var elseExpr = `;
					{
						var rewriteStmt = function(stmt:reflaxe.elixir.ast.ElixirAST) {
							return @:ast(switch (stmt.def) {
	case EMatch(PVar(inner), innerRhs) if (isEctoWhere(innerRhs)):
		if (inner == varName || (inner != null && inner.length > 1 && inner.charAt(0) == "_" && inner.substr(1) == varName)) {
			innerRhs;
		} else {
			rewriteInnerVar(innerRhs, inner, varName);
		};	
	case EBinary(Match, { def : EVar(inner2) }, innerRhs2) if (isEctoWhere(innerRhs2)):
		if (inner2 == varName || (inner2 != null && inner2.length > 1 && inner2.charAt(0) == "_" && inner2.substr(1) == varName)) {
			innerRhs2;
		} else {
			rewriteInnerVar(innerRhs2, inner2, varName);
		};	
	case EMatch(PVar(innerU), innerRhsU) if (isEctoWhere(innerRhsU) && innerU == varName):
		makeAST(EBinary(Match, makeAST(EVar("_" + innerU)), innerRhsU));	
	case EBinary(Match, { def : EVar(innerU2) }, innerRhsU2) if (isEctoWhere(innerRhsU2) && innerU2 == varName):
		makeAST(EBinary(Match, makeAST(EVar("_" + innerU2)), innerRhsU2));	
	default:
		null;	
}) {
								var ` = stmt.def;
								switch (enumIndex `) {
									case 8: {
										var ` = `[0];
										var ` = `[1];
										if (enumIndex ` == 0) {
											var ` = `[0];
											{
												var inner = `;
												var innerRhs = `;
												if (reflaxe.elixir.ast.transformers.EctoQueryIfAssignSimplifyTransforms.isEctoWhere(innerRhs)) {
													if (inner == varName || (inner != null && inner.length > 1 && inner.charAt(0) == "_" && inner.substr(1, null) == varName)) {
														innerRhs;
													} else {
														reflaxe.elixir.ast.transformers.EctoQueryIfAssignSimplifyTransforms.rewriteInnerVar(innerRhs, inner, varName);
													};
												} else {
													var innerU = `;
													var innerRhsU = `;
													if (reflaxe.elixir.ast.transformers.EctoQueryIfAssignSimplifyTransforms.isEctoWhere(innerRhsU) && innerU == varName) {
														{
															var pos = null;
															{def : reflaxe.elixir.ast.ElixirASTDef.EBinary(reflaxe.elixir.ast.EBinaryOp.Match, {
																var pos = null;
																{def : reflaxe.elixir.ast.ElixirASTDef.EVar("_" + innerU), metadata : {}, pos : pos};
															}, innerRhsU), metadata : {}, pos : pos};
														};
													} else {
														null;
													};
												};
											};
										} else {
											null;
										};
									};
									case 26: {
										var ` = `[0];
										var ` = `[1];
										var ` = `[2];
										if (enumIndex ` == 27) {
											{
												var ` = `.def;
												var ` = `.metadata;
												var ` = `.pos;
												if (enumIndex ` == 38) {
													var ` = `[0];
													{
														var inner2 = `;
														var innerRhs2 = `;
														if (reflaxe.elixir.ast.transformers.EctoQueryIfAssignSimplifyTransforms.isEctoWhere(innerRhs2)) {
															if (inner2 == varName || (inner2 != null && inner2.length > 1 && inner2.charAt(0) == "_" && inner2.substr(1, null) == varName)) {
																innerRhs2;
															} else {
																reflaxe.elixir.ast.transformers.EctoQueryIfAssignSimplifyTransforms.rewriteInnerVar(innerRhs2, inner2, varName);
															};
														} else {
															var innerU2 = `;
															var innerRhsU2 = `;
															if (reflaxe.elixir.ast.transformers.EctoQueryIfAssignSimplifyTransforms.isEctoWhere(innerRhsU2) && innerU2 == varName) {
																{
																	var pos = null;
																	{def : reflaxe.elixir.ast.ElixirASTDef.EBinary(reflaxe.elixir.ast.EBinaryOp.Match, {
																		var pos = null;
																		{def : reflaxe.elixir.ast.ElixirASTDef.EVar("_" + innerU2), metadata : {}, pos : pos};
																	}, innerRhsU2), metadata : {}, pos : pos};
																};
															} else {
																null;
															};
														};
													};
												} else {
													null;
												};
											};
										} else {
											null;
										};
									};
									default: {
										null;
									}
								};
							};
						};
						var newThen = (function() {
							@:ast(switch (thenExpr.def) {
	case EMatch(_, _) | EBinary(Match, _, _):
		var r = rewriteStmt(thenExpr);
		return r != null ? r : thenExpr;	
	case EBlock(ss) if (ss.length > 0):
		var last = ss[ss.length - 1];
		var rewritten = rewriteStmt(last);
		if (rewritten != null) {
			var prefix = ss.copy();
			prefix.pop();
			return makeAST(EBlock(prefix.concat([rewritten])));
		} else return thenExpr;	
	case EDo(ss2) if (ss2.length > 0):
		var last2 = ss2[ss2.length - 1];
		var rewritten2 = rewriteStmt(last2);
		if (rewritten2 != null) {
			var prefix2 = ss2.copy();
			prefix2.pop();
			return makeAST(EDo(prefix2.concat([rewritten2])));
		} else return thenExpr;	
	default:
		return thenExpr;	
}) {
								var ` = thenExpr.def;
								switch (enumIndex `) {
									case 8: {
										var ` = `[0];
										var ` = `[1];
										{
											var r = rewriteStmt(thenExpr);
											return if (r != null) {
												r;
											} else {
												thenExpr;
											};
										};
									};
									case 26: {
										var ` = `[0];
										var ` = `[1];
										var ` = `[2];
										if (enumIndex ` == 27) {
											{
												var r = rewriteStmt(thenExpr);
												return if (r != null) {
													r;
												} else {
													thenExpr;
												};
											};
										} else {
											return thenExpr;
										};
									};
									case 53: {
										var ` = `[0];
										{
											var ss = `;
											if (ss.length > 0) {
												var last = ss[ss.length - 1];
												var rewritten = rewriteStmt(last);
												if (rewritten != null) {
													var prefix = ss.copy();
													prefix.pop();
													return {
														var def = reflaxe.elixir.ast.ElixirASTDef.EBlock(prefix.concat([rewritten]));
														var pos = null;
														{def : def, metadata : {}, pos : pos};
													};
												} else {
													return thenExpr;
												};
											} else {
												return thenExpr;
											};
										};
									};
									case 55: {
										var ` = `[0];
										{
											var ss2 = `;
											if (ss2.length > 0) {
												var last2 = ss2[ss2.length - 1];
												var rewritten2 = rewriteStmt(last2);
												if (rewritten2 != null) {
													var prefix2 = ss2.copy();
													prefix2.pop();
													return {
														var def = reflaxe.elixir.ast.ElixirASTDef.EDo(prefix2.concat([rewritten2]));
														var pos = null;
														{def : def, metadata : {}, pos : pos};
													};
												} else {
													return thenExpr;
												};
											} else {
												return thenExpr;
											};
										};
									};
									default: {
										return thenExpr;
									}
								};
							};
						})();
						{
							var pos = null;
							{def : reflaxe.elixir.ast.ElixirASTDef.EIf(cond, newThen, elseExpr), metadata : {}, pos : pos};
						};
					};
				};
			} else {
				null;
			};
		};
	}

	static function isEctoWhere(expr:reflaxe.elixir.ast.ElixirAST) {
		return @:ast(switch (expr.def) {
	case ERemoteCall({ def : EVar(m) }, fn, _) if (m == "Ecto.Query" && fn == "where"):
		true;	
	default:
		false;	
}) {
			var ` = expr.def;
			if (enumIndex ` == 24) {
				var ` = `[0];
				var ` = `[1];
				var ` = `[2];
				{
					var ` = `.def;
					var ` = `.metadata;
					var ` = `.pos;
					if (enumIndex ` == 38) {
						var ` = `[0];
						{
							var m = `;
							var fn = `;
							if (m == "Ecto.Query" && fn == "where") {
								true;
							} else {
								false;
							};
						};
					} else {
						false;
					};
				};
			} else {
				false;
			};
		};
	}

	static function rewriteInnerVar(expr:reflaxe.elixir.ast.ElixirAST, from:String, to:String) {
		if (from == to) {
			return expr;
		};
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(expr, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EVar(v) if (v == from):
		makeASTWithMeta(EVar(to), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				if (enumIndex ` == 38) {
					var ` = `[0];
					{
						var v = `;
						if (v == from) {
							{def : reflaxe.elixir.ast.ElixirASTDef.EVar(to), metadata : n.metadata, pos : n.pos};
						} else {
							n;
						};
					};
				} else {
					n;
				};
			};
		});
	}
}