class reflaxe.elixir.behaviors.PresenceBehaviorTransformer implements reflaxe.elixir.behaviors.IBehaviorTransformer {

	public function new() {}

	public function transformMethodCall(className:String, methodName:String, args:Array<reflaxe.elixir.ast.ElixirAST>, isStatic:Bool) {
		if (className != "Presence" && className != "phoenix.Presence") {
			return null;
		};
		var snakeCaseMethod = this.toSnakeCase(methodName);
		var needsSelfInjection = this.needsSelf(methodName, args.length);
		if (needsSelfInjection) {
			var selfCall = {def : reflaxe.elixir.ast.ElixirASTDef.ECall(null, "self", []), metadata : {}, pos : null};
			var argsWithSelf = [selfCall].concat(args);
			return {def : reflaxe.elixir.ast.ElixirASTDef.ECall(null, snakeCaseMethod, argsWithSelf), metadata : {}, pos : null};
		} else {
			return {def : reflaxe.elixir.ast.ElixirASTDef.ECall(null, snakeCaseMethod, args), metadata : {}, pos : null};
		};
	}

	function needsSelf(methodName:String, argCount:Int) {
		var effectiveMethod = this.resolveNativeMethodName(methodName);
		return @:ast(switch (effectiveMethod) {
	case "track":
		true;	
	case "update":
		true;	
	case "untrack":
		true;	
	case "list", "getByKey", "get_by_key":
		false;	
	default:
		false;	
}) switch (effectiveMethod) {
			case "getByKey", "get_by_key", "list": {
				{
					false;
				};
			};
			case "track": {
				{
					true;
				};
			};
			case "untrack": {
				{
					true;
				};
			};
			case "update": {
				{
					true;
				};
			};
			default: {
				false;
			}
		};
	}

	function resolveNativeMethodName(methodName:String) {
		return @:ast(switch (methodName) {
	case "trackPid":
		"track";	
	case "updatePid":
		"update";	
	case "untrackPid":
		"untrack";	
	default:
		methodName;	
}) switch (methodName) {
			case "trackPid": {
				{
					"track";
				};
			};
			case "untrackPid": {
				{
					"untrack";
				};
			};
			case "updatePid": {
				{
					"update";
				};
			};
			default: {
				methodName;
			}
		};
	}

	function toSnakeCase(str:String) {
		var result = "";
		{
			var ` = 0;
			var ` = str.length;
			while (` < `) {
				var i = ` ++;
				var char = str.charAt(i);
				if (i > 0 && char == char.toUpperCase() && char != char.toLowerCase()) {
					result += "_" + char.toLowerCase();
				} else {
					result += char.toLowerCase();
				};
			};
		};
		return result;
	}
}