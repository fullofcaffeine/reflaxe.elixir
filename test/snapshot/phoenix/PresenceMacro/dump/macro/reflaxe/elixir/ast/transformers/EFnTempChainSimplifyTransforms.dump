class reflaxe.elixir.ast.transformers.EFnTempChainSimplifyTransforms {

	public static function pass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EFn(clauses) if (clauses.length == 1):
		var cl = clauses[0];
		var b = cl.body;
		var nb = switch (b.def) {
			case EBlock(stmts):
				makeASTWithMeta(EBlock(simplify(stmts, b.metadata, b.pos)), b.metadata, b.pos);			
			default:
				b;			
		};
		makeASTWithMeta(EFn([{ args : cl.args, guard : cl.guard, body : nb }]), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				if (enumIndex ` == 42) {
					var ` = `[0];
					{
						var clauses = `;
						if (clauses.length == 1) {
							var cl = clauses[0];
							var b = cl.body;
							var nb = @:ast(switch (b.def) {
	case EBlock(stmts):
		makeASTWithMeta(EBlock(simplify(stmts, b.metadata, b.pos)), b.metadata, b.pos);	
	default:
		b;	
}) {
								var ` = b.def;
								if (enumIndex ` == 53) {
									var ` = `[0];
									{
										var stmts = `;
										{
											{
												var def = reflaxe.elixir.ast.ElixirASTDef.EBlock(reflaxe.elixir.ast.transformers.EFnTempChainSimplifyTransforms.simplify(stmts, b.metadata, b.pos));
												var meta = b.metadata;
												var pos = b.pos;
												{def : def, metadata : meta, pos : pos};
											};
										};
									};
								} else {
									b;
								};
							};
							{def : reflaxe.elixir.ast.ElixirASTDef.EFn([{args : cl.args, guard : cl.guard, body : nb}]), metadata : n.metadata, pos : n.pos};
						} else {
							n;
						};
					};
				} else {
					n;
				};
			};
		});
	}

	static function simplify(stmts:Array<reflaxe.elixir.ast.ElixirAST>, meta:Dynamic, pos:Dynamic) {
		if (stmts.length >= 2) {
			var last = stmts[stmts.length - 1];
			@:ast(switch (last.def) {
	case EVar(name):
		var assignIdx = -1;
		var rhs:Null<ElixirAST> = null;
		for (i  in  0 ... stmts.length - 1) {
			var idx = (stmts.length - 2) - i;
			switch (stmts[idx].def) {
				case EBinary(Match, left, r):
					switch (left.def) {
						case EVar(nm) if (nm == name):
							assignIdx = idx;
							rhs = r;						
						default:
					};				
				case EMatch(pat, r2):
					switch (pat) {
						case PVar(nm2) if (nm2 == name):
							assignIdx = idx;
							rhs = r2;						
						default:
					};				
				default:
			};
			if (assignIdx != -1) break;
		};
		if (assignIdx != -1 && rhs != null) {
			var out:Array<ElixirAST> = [];
			for (j  in  0 ... assignIdx) out.push(stmts[j]);
			for (j  in  assignIdx + 1 ... stmts.length - 1) {
				var d = stmts[j].def;
				var dropped = false;
				switch (d) {
					case EBinary(Match, left2, rnil):
						var isNil = switch (rnil.def) {
							case ENil:
								true;							
							default:
								false;							
						};
						if (isNil) switch (left2.def) {
							case EVar(nm3) if (nm3 == name):
								dropped = true;							
							default:
						};					
					case EMatch(pat2, rnil2):
						var isNil2 = switch (rnil2.def) {
							case ENil:
								true;							
							default:
								false;							
						};
						if (isNil2) switch (pat2) {
							case PVar(nm4) if (nm4 == name):
								dropped = true;							
							default:
						};					
					default:
				};
				if (!dropped) out.push(stmts[j]);
			};
			out.push(rhs);
			return out;
		};	
	default:
}) {
				var ` = last.def;
				if (enumIndex ` == 38) {
					var ` = `[0];
					{
						var name = `;
						{
							var assignIdx = -1;
							var rhs = null;
							{
								var ` = 0;
								var ` = stmts.length - 1;
								while (` < `) {
									var i = ` ++;
									var idx = (stmts.length - 2) - i;
									@:ast(switch (stmts[idx].def) {
	case EBinary(Match, left, r):
		switch (left.def) {
			case EVar(nm) if (nm == name):
				assignIdx = idx;
				rhs = r;			
			default:
		};	
	case EMatch(pat, r2):
		switch (pat) {
			case PVar(nm2) if (nm2 == name):
				assignIdx = idx;
				rhs = r2;			
			default:
		};	
	default:
}) {
										var ` = stmts[idx].def;
										switch (enumIndex `) {
											case 8: {
												var ` = `[0];
												var ` = `[1];
												{
													var pat = `;
													var r2 = `;
													{
														@:ast(switch (pat) {
	case PVar(nm2) if (nm2 == name):
		assignIdx = idx;
		rhs = r2;	
	default:
}) if (enumIndex pat == 0) {
															var ` = pat[0];
															{
																var nm2 = `;
																if (nm2 == name) {
																	assignIdx = idx;
																	rhs = r2;
																} else {};
															};
														} else {};
													};
												};
											};
											case 26: {
												var ` = `[0];
												var ` = `[1];
												var ` = `[2];
												if (enumIndex ` == 27) {
													{
														var left = `;
														var r = `;
														{
															@:ast(switch (left.def) {
	case EVar(nm) if (nm == name):
		assignIdx = idx;
		rhs = r;	
	default:
}) {
																var ` = left.def;
																if (enumIndex ` == 38) {
																	var ` = `[0];
																	{
																		var nm = `;
																		if (nm == name) {
																			assignIdx = idx;
																			rhs = r;
																		} else {};
																	};
																} else {};
															};
														};
													};
												} else {};
											};
											default: {}
										};
									};
									if (assignIdx != -1) {
										break;
									};
								};
							};
							if (assignIdx != -1 && rhs != null) {
								var out = [];
								{
									var ` = 0;
									var ` = assignIdx;
									while (` < `) {
										var j = ` ++;
										out.push(stmts[j]);
									};
								};
								{
									var ` = assignIdx + 1;
									var ` = stmts.length - 1;
									while (` < `) {
										var j = ` ++;
										var d = stmts[j].def;
										var dropped = false;
										@:ast(switch (d) {
	case EBinary(Match, left2, rnil):
		var isNil = switch (rnil.def) {
			case ENil:
				true;			
			default:
				false;			
		};
		if (isNil) switch (left2.def) {
			case EVar(nm3) if (nm3 == name):
				dropped = true;			
			default:
		};	
	case EMatch(pat2, rnil2):
		var isNil2 = switch (rnil2.def) {
			case ENil:
				true;			
			default:
				false;			
		};
		if (isNil2) switch (pat2) {
			case PVar(nm4) if (nm4 == name):
				dropped = true;			
			default:
		};	
	default:
}) switch (enumIndex d) {
											case 8: {
												var ` = d[0];
												var ` = d[1];
												{
													var pat2 = `;
													var rnil2 = `;
													{
														var isNil2 = @:ast(switch (rnil2.def) {
	case ENil:
		true;	
	default:
		false;	
}) {
															var ` = rnil2.def;
															if (enumIndex ` == 36) {
																{
																	true;
																};
															} else {
																false;
															};
														};
														if (isNil2) {
															@:ast(switch (pat2) {
	case PVar(nm4) if (nm4 == name):
		dropped = true;	
	default:
}) if (enumIndex pat2 == 0) {
																var ` = pat2[0];
																{
																	var nm4 = `;
																	if (nm4 == name) {
																		dropped = true;
																	} else {};
																};
															} else {};
														};
													};
												};
											};
											case 26: {
												var ` = d[0];
												var ` = d[1];
												var ` = d[2];
												if (enumIndex ` == 27) {
													{
														var left2 = `;
														var rnil = `;
														{
															var isNil = @:ast(switch (rnil.def) {
	case ENil:
		true;	
	default:
		false;	
}) {
																var ` = rnil.def;
																if (enumIndex ` == 36) {
																	{
																		true;
																	};
																} else {
																	false;
																};
															};
															if (isNil) {
																@:ast(switch (left2.def) {
	case EVar(nm3) if (nm3 == name):
		dropped = true;	
	default:
}) {
																	var ` = left2.def;
																	if (enumIndex ` == 38) {
																		var ` = `[0];
																		{
																			var nm3 = `;
																			if (nm3 == name) {
																				dropped = true;
																			} else {};
																		};
																	} else {};
																};
															};
														};
													};
												} else {};
											};
											default: {}
										};
										if (! dropped) {
											out.push(stmts[j]);
										};
									};
								};
								out.push(rhs);
								return out;
							};
						};
					};
				} else {};
			};
		};
		return stmts;
	}
}