class reflaxe.elixir.ast.transformers.ControllerLocalUnusedUnderscoreTransforms {

	public static function pass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EModule(name, attrs, body) if (isControllerModule(n, name)):
		var out:Array<ElixirAST> = [];
		for (b  in  body) out.push(applyToDefs(b));
		makeASTWithMeta(EModule(name, attrs, out), n.metadata, n.pos);	
	case EDefmodule(modName, doBlock) if (isControllerDoBlock(n, doBlock)):
		makeASTWithMeta(EDefmodule(modName, applyToDefs(doBlock)), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 0: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var name = `;
							var attrs = `;
							var body = `;
							if (if ({
								var tmp = n.metadata;
								if (tmp != null) tmp.isPhoenixWeb else null;
							} == true && {
								var tmp = n.metadata;
								if (tmp != null) tmp.phoenixContext else null;
							} == reflaxe.elixir.ast.PhoenixContext.Controller) {
								true;
							} else {
								name != null && name.indexOf("Web.", null) >= 0 && StringTools.endsWith(name, "Controller");
							}) {
								var out = [];
								{
									var ` = 0;
									while (` < body.length) {
										var b = body[`];
										++ `;
										out.push(reflaxe.elixir.ast.transformers.ControllerLocalUnusedUnderscoreTransforms.applyToDefs(b));
									};
								};
								{def : reflaxe.elixir.ast.ElixirASTDef.EModule(name, attrs, out), metadata : n.metadata, pos : n.pos};
							} else {
								n;
							};
						};
					};
					case 1: {
						var ` = `[0];
						var ` = `[1];
						{
							var modName = `;
							var doBlock = `;
							if ({
								var tmp = n.metadata;
								if (tmp != null) tmp.phoenixContext else null;
							} == reflaxe.elixir.ast.PhoenixContext.Controller) {
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EDefmodule(modName, reflaxe.elixir.ast.transformers.ControllerLocalUnusedUnderscoreTransforms.applyToDefs(doBlock));
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							} else {
								n;
							};
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}

	static function applyToDefs(node:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(node, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EDef(name, args, guards, body):
		makeASTWithMeta(EDef(name, args, guards, underscoreUnused(body)), n.metadata, n.pos);	
	case EDefp(name2, args2, guards2, body2):
		makeASTWithMeta(EDefp(name2, args2, guards2, underscoreUnused(body2)), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 2: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name = `;
							var args = `;
							var guards = `;
							var body = `;
							{
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EDef(name, args, guards, reflaxe.elixir.ast.transformers.ControllerLocalUnusedUnderscoreTransforms.underscoreUnused(body));
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							};
						};
					};
					case 3: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name2 = `;
							var args2 = `;
							var guards2 = `;
							var body2 = `;
							{
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EDefp(name2, args2, guards2, reflaxe.elixir.ast.transformers.ControllerLocalUnusedUnderscoreTransforms.underscoreUnused(body2));
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							};
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}

	static function underscoreUnused(body:reflaxe.elixir.ast.ElixirAST) {
		return @:ast(switch (body.def) {
	case EBlock(stmts):
		var out:Array<ElixirAST> = [];
		for (i  in  0 ... stmts.length) {
			var s = stmts[i];
			var s1 = switch (s.def) {
				case EMatch(PVar(b), rhs) if (!usedLater(stmts, i + 1, b)):
					makeASTWithMeta(EMatch(PVar("_" + b), rhs), s.metadata, s.pos);				
				case EBinary(Match, left, right):
					switch (left.def) {
						case EVar(b2) if (!usedLater(stmts, i + 1, b2)):
							makeASTWithMeta(EBinary(Match, makeAST(EVar("_" + b2)), right), s.metadata, s.pos);						
						default:
							s;						
					};				
				case ECase(expr, clauses):
					var newClauses = [];
					for (cl  in  clauses) newClauses.push({ pattern : cl.pattern, guard : cl.guard, body : underscoreUnused(cl.body) });
					makeASTWithMeta(ECase(expr, newClauses), s.metadata, s.pos);				
				default:
					s;				
			};
			out.push(s1);
		};
		makeASTWithMeta(EBlock(out), body.metadata, body.pos);	
	case EDo(stmts2):
		var out2:Array<ElixirAST> = [];
		for (i  in  0 ... stmts2.length) {
			var s = stmts2[i];
			var s1 = switch (s.def) {
				case EMatch(PVar(b), rhs) if (!usedLater(stmts2, i + 1, b)):
					makeASTWithMeta(EMatch(PVar("_" + b), rhs), s.metadata, s.pos);				
				case EBinary(Match, left, right):
					switch (left.def) {
						case EVar(b2) if (!usedLater(stmts2, i + 1, b2)):
							makeASTWithMeta(EBinary(Match, makeAST(EVar("_" + b2)), right), s.metadata, s.pos);						
						default:
							s;						
					};				
				case ECase(expr, clauses):
					var newClauses = [];
					for (cl  in  clauses) newClauses.push({ pattern : cl.pattern, guard : cl.guard, body : underscoreUnused(cl.body) });
					makeASTWithMeta(ECase(expr, newClauses), s.metadata, s.pos);				
				default:
					s;				
			};
			out2.push(s1);
		};
		makeASTWithMeta(EDo(out2), body.metadata, body.pos);	
	default:
		body;	
}) {
			var ` = body.def;
			switch (enumIndex `) {
				case 53: {
					var ` = `[0];
					{
						var stmts = `;
						{
							var out = [];
							{
								var ` = 0;
								var ` = stmts.length;
								while (` < `) {
									var i = ` ++;
									var s = stmts[i];
									var s1 = @:ast(switch (s.def) {
	case EMatch(PVar(b), rhs) if (!usedLater(stmts, i + 1, b)):
		makeASTWithMeta(EMatch(PVar("_" + b), rhs), s.metadata, s.pos);	
	case EBinary(Match, left, right):
		switch (left.def) {
			case EVar(b2) if (!usedLater(stmts, i + 1, b2)):
				makeASTWithMeta(EBinary(Match, makeAST(EVar("_" + b2)), right), s.metadata, s.pos);			
			default:
				s;			
		};	
	case ECase(expr, clauses):
		var newClauses = [];
		for (cl  in  clauses) newClauses.push({ pattern : cl.pattern, guard : cl.guard, body : underscoreUnused(cl.body) });
		makeASTWithMeta(ECase(expr, newClauses), s.metadata, s.pos);	
	default:
		s;	
}) {
										var ` = s.def;
										switch (enumIndex `) {
											case 6: {
												var ` = `[0];
												var ` = `[1];
												{
													var expr = `;
													var clauses = `;
													{
														var newClauses = [];
														{
															var ` = 0;
															while (` < clauses.length) {
																var cl = clauses[`];
																++ `;
																newClauses.push({pattern : cl.pattern, guard : cl.guard, body : reflaxe.elixir.ast.transformers.ControllerLocalUnusedUnderscoreTransforms.underscoreUnused(cl.body)});
															};
														};
														{def : reflaxe.elixir.ast.ElixirASTDef.ECase(expr, newClauses), metadata : s.metadata, pos : s.pos};
													};
												};
											};
											case 8: {
												var ` = `[0];
												var ` = `[1];
												if (enumIndex ` == 0) {
													var ` = `[0];
													{
														var b = `;
														var rhs = `;
														if (! reflaxe.elixir.ast.transformers.ControllerLocalUnusedUnderscoreTransforms.usedLater(stmts, i + 1, b)) {
															{def : reflaxe.elixir.ast.ElixirASTDef.EMatch(reflaxe.elixir.ast.EPattern.PVar("_" + b), rhs), metadata : s.metadata, pos : s.pos};
														} else {
															s;
														};
													};
												} else {
													s;
												};
											};
											case 26: {
												var ` = `[0];
												var ` = `[1];
												var ` = `[2];
												if (enumIndex ` == 27) {
													{
														var left = `;
														var right = `;
														{
															@:ast(switch (left.def) {
	case EVar(b2) if (!usedLater(stmts, i + 1, b2)):
		makeASTWithMeta(EBinary(Match, makeAST(EVar("_" + b2)), right), s.metadata, s.pos);	
	default:
		s;	
}) {
																var ` = left.def;
																if (enumIndex ` == 38) {
																	var ` = `[0];
																	{
																		var b2 = `;
																		if (! reflaxe.elixir.ast.transformers.ControllerLocalUnusedUnderscoreTransforms.usedLater(stmts, i + 1, b2)) {
																			{def : reflaxe.elixir.ast.ElixirASTDef.EBinary(reflaxe.elixir.ast.EBinaryOp.Match, {
																				var pos = null;
																				{def : reflaxe.elixir.ast.ElixirASTDef.EVar("_" + b2), metadata : {}, pos : pos};
																			}, right), metadata : s.metadata, pos : s.pos};
																		} else {
																			s;
																		};
																	};
																} else {
																	s;
																};
															};
														};
													};
												} else {
													s;
												};
											};
											default: {
												s;
											}
										};
									};
									out.push(s1);
								};
							};
							{def : reflaxe.elixir.ast.ElixirASTDef.EBlock(out), metadata : body.metadata, pos : body.pos};
						};
					};
				};
				case 55: {
					var ` = `[0];
					{
						var stmts2 = `;
						{
							var out2 = [];
							{
								var ` = 0;
								var ` = stmts2.length;
								while (` < `) {
									var i = ` ++;
									var s = stmts2[i];
									var s1 = @:ast(switch (s.def) {
	case EMatch(PVar(b), rhs) if (!usedLater(stmts2, i + 1, b)):
		makeASTWithMeta(EMatch(PVar("_" + b), rhs), s.metadata, s.pos);	
	case EBinary(Match, left, right):
		switch (left.def) {
			case EVar(b2) if (!usedLater(stmts2, i + 1, b2)):
				makeASTWithMeta(EBinary(Match, makeAST(EVar("_" + b2)), right), s.metadata, s.pos);			
			default:
				s;			
		};	
	case ECase(expr, clauses):
		var newClauses = [];
		for (cl  in  clauses) newClauses.push({ pattern : cl.pattern, guard : cl.guard, body : underscoreUnused(cl.body) });
		makeASTWithMeta(ECase(expr, newClauses), s.metadata, s.pos);	
	default:
		s;	
}) {
										var ` = s.def;
										switch (enumIndex `) {
											case 6: {
												var ` = `[0];
												var ` = `[1];
												{
													var expr = `;
													var clauses = `;
													{
														var newClauses = [];
														{
															var ` = 0;
															while (` < clauses.length) {
																var cl = clauses[`];
																++ `;
																newClauses.push({pattern : cl.pattern, guard : cl.guard, body : reflaxe.elixir.ast.transformers.ControllerLocalUnusedUnderscoreTransforms.underscoreUnused(cl.body)});
															};
														};
														{def : reflaxe.elixir.ast.ElixirASTDef.ECase(expr, newClauses), metadata : s.metadata, pos : s.pos};
													};
												};
											};
											case 8: {
												var ` = `[0];
												var ` = `[1];
												if (enumIndex ` == 0) {
													var ` = `[0];
													{
														var b = `;
														var rhs = `;
														if (! reflaxe.elixir.ast.transformers.ControllerLocalUnusedUnderscoreTransforms.usedLater(stmts2, i + 1, b)) {
															{def : reflaxe.elixir.ast.ElixirASTDef.EMatch(reflaxe.elixir.ast.EPattern.PVar("_" + b), rhs), metadata : s.metadata, pos : s.pos};
														} else {
															s;
														};
													};
												} else {
													s;
												};
											};
											case 26: {
												var ` = `[0];
												var ` = `[1];
												var ` = `[2];
												if (enumIndex ` == 27) {
													{
														var left = `;
														var right = `;
														{
															@:ast(switch (left.def) {
	case EVar(b2) if (!usedLater(stmts2, i + 1, b2)):
		makeASTWithMeta(EBinary(Match, makeAST(EVar("_" + b2)), right), s.metadata, s.pos);	
	default:
		s;	
}) {
																var ` = left.def;
																if (enumIndex ` == 38) {
																	var ` = `[0];
																	{
																		var b2 = `;
																		if (! reflaxe.elixir.ast.transformers.ControllerLocalUnusedUnderscoreTransforms.usedLater(stmts2, i + 1, b2)) {
																			{def : reflaxe.elixir.ast.ElixirASTDef.EBinary(reflaxe.elixir.ast.EBinaryOp.Match, {
																				var pos = null;
																				{def : reflaxe.elixir.ast.ElixirASTDef.EVar("_" + b2), metadata : {}, pos : pos};
																			}, right), metadata : s.metadata, pos : s.pos};
																		} else {
																			s;
																		};
																	};
																} else {
																	s;
																};
															};
														};
													};
												} else {
													s;
												};
											};
											default: {
												s;
											}
										};
									};
									out2.push(s1);
								};
							};
							{def : reflaxe.elixir.ast.ElixirASTDef.EDo(out2), metadata : body.metadata, pos : body.pos};
						};
					};
				};
				default: {
					body;
				}
			};
		};
	}

	static function usedLater(stmts:Array<reflaxe.elixir.ast.ElixirAST>, start:Int, name:String) {
		var found = [false];
		var scan = [null];
		scan[0] = function(n:reflaxe.elixir.ast.ElixirAST, inLhs:Bool = false) {
			if (found[0] || n == null || n.def == null) {
				return;
			};
			@:ast(switch (n.def) {
	case EVar(v) if (v == name && !inLhs):
		found = true;	
	case EBinary(Match, l, r):
		scan(l, true);
		scan(r, false);	
	case EMatch(pat, rhs):
		scan(rhs, false);	
	case EBlock(ss):
		for (s  in  ss) scan(s);	
	case EDo(ss2):
		for (s  in  ss2) scan(s);	
	case EIf(c, t, e):
		scan(c);
		scan(t);
		if (e != null) scan(e);	
	case ECase(expr, clauses):
		scan(expr, false);
		for (cl  in  clauses) {
			if (cl.guard != null) scan(cl.guard, false);
			scan(cl.body, false);
		};	
	case EWith(clauses, doBlock, elseBlock):
		for (wc  in  clauses) scan(wc.expr, false);
		scan(doBlock, false);
		if (elseBlock != null) scan(elseBlock, false);	
	case ECall(t, _, as):
		if (t != null) scan(t, false);
		if (as != null) for (a  in  as) scan(a, false);	
	case ERemoteCall(t2, _, as2):
		scan(t2, false);
		if (as2 != null) for (a2  in  as2) scan(a2, false);	
	case EField(obj, _):
		scan(obj, false);	
	case EAccess(obj2, key):
		scan(obj2, false);
		scan(key, false);	
	case EKeywordList(pairs):
		for (p  in  pairs) scan(p.value, false);	
	case EMap(pairs):
		for (p  in  pairs) {
			scan(p.key, false);
			scan(p.value, false);
		};	
	case EStructUpdate(base, fs):
		scan(base, false);
		for (f  in  fs) scan(f.value, false);	
	case ETuple(es) | EList(es):
		for (e  in  es) scan(e, false);	
	case EFn(clauses):
		for (cl  in  clauses) {
			if (cl.guard != null) scan(cl.guard, false);
			scan(cl.body, false);
		};	
	default:
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 6: {
						var ` = `[0];
						var ` = `[1];
						{
							var expr = `;
							var clauses = `;
							{
								scan[0](expr, false);
								{
									var ` = 0;
									while (` < clauses.length) {
										var cl = clauses[`];
										++ `;
										if (cl.guard != null) {
											scan[0](cl.guard, false);
										};
										scan[0](cl.body, false);
									};
								};
							};
						};
					};
					case 8: {
						var ` = `[0];
						var ` = `[1];
						{
							var pat = `;
							var rhs = `;
							{
								scan[0](rhs, false);
							};
						};
					};
					case 9: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var clauses = `;
							var doBlock = `;
							var elseBlock = `;
							{
								{
									var ` = 0;
									while (` < clauses.length) {
										var wc = clauses[`];
										++ `;
										scan[0](wc.expr, false);
									};
								};
								scan[0](doBlock, false);
								if (elseBlock != null) {
									scan[0](elseBlock, false);
								};
							};
						};
					};
					case 10: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var c = `;
							var t = `;
							var e = `;
							{
								scan[0](c, null);
								scan[0](t, null);
								if (e != null) {
									scan[0](e, null);
								};
							};
						};
					};
					case 15: {
						var ` = `[0];
						{
							var es = `;
							{
								{
									var ` = 0;
									while (` < es.length) {
										var e = es[`];
										++ `;
										scan[0](e, false);
									};
								};
							};
						};
					};
					case 16: {
						var ` = `[0];
						{
							var es = `;
							{
								{
									var ` = 0;
									while (` < es.length) {
										var e = es[`];
										++ `;
										scan[0](e, false);
									};
								};
							};
						};
					};
					case 17: {
						var ` = `[0];
						{
							var pairs = `;
							{
								{
									var ` = 0;
									while (` < pairs.length) {
										var p = pairs[`];
										++ `;
										scan[0](p.key, false);
										scan[0](p.value, false);
									};
								};
							};
						};
					};
					case 19: {
						var ` = `[0];
						var ` = `[1];
						{
							var base = `;
							var fs = `;
							{
								scan[0](base, false);
								{
									var ` = 0;
									while (` < fs.length) {
										var f = fs[`];
										++ `;
										scan[0](f.value, false);
									};
								};
							};
						};
					};
					case 20: {
						var ` = `[0];
						{
							var pairs = `;
							{
								{
									var ` = 0;
									while (` < pairs.length) {
										var p = pairs[`];
										++ `;
										scan[0](p.value, false);
									};
								};
							};
						};
					};
					case 22: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var t = `;
							var as = `;
							{
								if (t != null) {
									scan[0](t, false);
								};
								if (as != null) {
									{
										var ` = 0;
										while (` < as.length) {
											var a = as[`];
											++ `;
											scan[0](a, false);
										};
									};
								};
							};
						};
					};
					case 24: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var t2 = `;
							var as2 = `;
							{
								scan[0](t2, false);
								if (as2 != null) {
									{
										var ` = 0;
										while (` < as2.length) {
											var a2 = as2[`];
											++ `;
											scan[0](a2, false);
										};
									};
								};
							};
						};
					};
					case 26: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						if (enumIndex ` == 27) {
							{
								var l = `;
								var r = `;
								{
									scan[0](l, true);
									scan[0](r, false);
								};
							};
						} else {};
					};
					case 28: {
						var ` = `[0];
						var ` = `[1];
						{
							var obj = `;
							{
								scan[0](obj, false);
							};
						};
					};
					case 29: {
						var ` = `[0];
						var ` = `[1];
						{
							var obj2 = `;
							var key = `;
							{
								scan[0](obj2, false);
								scan[0](key, false);
							};
						};
					};
					case 38: {
						var ` = `[0];
						{
							var v = `;
							if (v == name && ! inLhs) {
								found[0] = true;
							} else {};
						};
					};
					case 42: {
						var ` = `[0];
						{
							var clauses = `;
							{
								{
									var ` = 0;
									while (` < clauses.length) {
										var cl = clauses[`];
										++ `;
										if (cl.guard != null) {
											scan[0](cl.guard, false);
										};
										scan[0](cl.body, false);
									};
								};
							};
						};
					};
					case 53: {
						var ` = `[0];
						{
							var ss = `;
							{
								{
									var ` = 0;
									while (` < ss.length) {
										var s = ss[`];
										++ `;
										scan[0](s, null);
									};
								};
							};
						};
					};
					case 55: {
						var ` = `[0];
						{
							var ss2 = `;
							{
								{
									var ` = 0;
									while (` < ss2.length) {
										var s = ss2[`];
										++ `;
										scan[0](s, null);
									};
								};
							};
						};
					};
					default: {}
				};
			};
		};
		{
			var ` = start;
			var ` = stmts.length;
			while (` < `) {
				var j = ` ++;
				if (! found[0]) {
					scan[0](stmts[j], false);
				};
			};
		};
		return found[0];
	}

	static inline function isControllerModule(node:reflaxe.elixir.ast.ElixirAST, name:String) {
		if ({
			var tmp = node.metadata;
			if (tmp != null) tmp.isPhoenixWeb else null;
		} == true && {
			var tmp = node.metadata;
			if (tmp != null) tmp.phoenixContext else null;
		} == reflaxe.elixir.ast.PhoenixContext.Controller) {
			return true;
		};
		return name != null && name.indexOf("Web.", null) >= 0 && StringTools.endsWith(name, "Controller");
	}

	static inline function isControllerDoBlock(node:reflaxe.elixir.ast.ElixirAST, doBlock:reflaxe.elixir.ast.ElixirAST) {
		return {
			var tmp = node.metadata;
			if (tmp != null) tmp.phoenixContext else null;
		} == reflaxe.elixir.ast.PhoenixContext.Controller;
	}
}