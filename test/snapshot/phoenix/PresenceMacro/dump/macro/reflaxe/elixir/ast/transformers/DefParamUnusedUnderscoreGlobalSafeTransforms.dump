class reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreGlobalSafeTransforms {

	public static function pass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EDef(name, args, guards, body):
		var skip = (name == "handle_event" || StringTools.startsWith(name, "handle_event")) && args != null && args.length == 3;
		var newArgs = skip ? args : underscoreArgsIfUnused(args, body);
		makeASTWithMeta(EDef(name, newArgs, guards, body), n.metadata, n.pos);	
	case EDefp(name2, args2, guards2, body2):
		var skip2 = (name2 == "handle_event" || StringTools.startsWith(name2, "handle_event")) && args2 != null && args2.length == 3;
		var newArgs2 = skip2 ? args2 : underscoreArgsIfUnused(args2, body2);
		makeASTWithMeta(EDefp(name2, newArgs2, guards2, body2), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 2: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name = `;
							var args = `;
							var guards = `;
							var body = `;
							{
								var skip = (name == "handle_event" || StringTools.startsWith(name, "handle_event")) && args != null && args.length == 3;
								var newArgs = if (skip) {
									args;
								} else {
									reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreGlobalSafeTransforms.underscoreArgsIfUnused(args, body);
								};
								{def : reflaxe.elixir.ast.ElixirASTDef.EDef(name, newArgs, guards, body), metadata : n.metadata, pos : n.pos};
							};
						};
					};
					case 3: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name2 = `;
							var args2 = `;
							var guards2 = `;
							var body2 = `;
							{
								var skip2 = (name2 == "handle_event" || StringTools.startsWith(name2, "handle_event")) && args2 != null && args2.length == 3;
								var newArgs2 = if (skip2) {
									args2;
								} else {
									reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreGlobalSafeTransforms.underscoreArgsIfUnused(args2, body2);
								};
								{def : reflaxe.elixir.ast.ElixirASTDef.EDefp(name2, newArgs2, guards2, body2), metadata : n.metadata, pos : n.pos};
							};
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}

	static function underscoreArgsIfUnused(args:Array<reflaxe.elixir.ast.EPattern>, body:reflaxe.elixir.ast.ElixirAST) {
		if (args == null) {
			return args;
		};
		return {
			var ` = [];
			{
				var ` = 0;
				while (` < args.length) {
					var a = args[`];
					++ `;
					`.push(reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreGlobalSafeTransforms.underscoreIfUnused(a, body));
				};
			};
			`;
		};
	}

	static function underscoreIfUnused(p:reflaxe.elixir.ast.EPattern, body:reflaxe.elixir.ast.ElixirAST) {
		return @:ast(switch (p) {
	case PVar(nm) if (nm != null && nm.length > 0 && nm.charAt(0) != "_" && !usedInBody(body, nm)):
		PVar("_" + nm);	
	default:
		p;	
}) if (enumIndex p == 0) {
			var ` = p[0];
			{
				var nm = `;
				if (nm != null && nm.length > 0 && nm.charAt(0) != "_" && ! reflaxe.elixir.ast.transformers.DefParamUnusedUnderscoreGlobalSafeTransforms.usedInBody(body, nm)) {
					reflaxe.elixir.ast.EPattern.PVar("_" + nm);
				} else {
					p;
				};
			};
		} else {
			p;
		};
	}

	static function usedInBody(body:reflaxe.elixir.ast.ElixirAST, name:String) {
		if (name == null || name.length == 0) {
			return false;
		};
		if (reflaxe.elixir.ast.analyzers.VariableUsageCollector.usedInFunctionScope(body, name)) {
			return true;
		};
		var found = [false];
		reflaxe.elixir.ast.ElixirASTTransformer.transformNode(body, function(n:reflaxe.elixir.ast.ElixirAST) {
			if (found[0] || n == null || n.def == null) {
				return n;
			};
			@:ast(switch (n.def) {
	case ERaw(code):
		if (code != null && code.indexOf(name) != -1) found = true;	
	default:
}) {
				var ` = n.def;
				if (enumIndex ` == 62) {
					var ` = `[0];
					{
						var code = `;
						{
							if (code != null && code.indexOf(name, null) != -1) {
								found[0] = true;
							};
						};
					};
				} else {};
			};
			return n;
		});
		return found[0];
	}
}