class reflaxe.elixir.ast.transformers.CaseBinderRebindUnderscoreTransforms {

	public static function pass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case ECase(target, clauses):
		var newClauses = [];
		for (cl  in  clauses) {
			var binders = collectPatternBinders(cl.pattern);
			var bodyStmts:Array<ElixirAST> = switch (cl.body.def) {
				case EBlock(ss):
					ss;				
				default:
					[cl.body];				
			};
			var toUnderscore:Array<String> = [];
			for (b  in  binders) {
				var rebindIdx = firstRebindIndex(bodyStmts, b);
				var useIdx = firstUseIndex(bodyStmts, b);
				if (rebindIdx >= 0 && (useIdx == -1 || rebindIdx < useIdx)) {
					if (!isAliasFromUnderscoredBinder(bodyStmts[rebindIdx], b)) {
						toUnderscore.push(b);
					};
				};
			};
			var newPat = (toUnderscore.length > 0) ? underscoreBinders(cl.pattern, toUnderscore) : cl.pattern;
			newClauses.push({ pattern : newPat, guard : cl.guard, body : cl.body });
		};
		makeASTWithMeta(ECase(target, newClauses), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				if (enumIndex ` == 6) {
					var ` = `[0];
					var ` = `[1];
					{
						var target = `;
						var clauses = `;
						{
							var newClauses = [];
							{
								var ` = 0;
								while (` < clauses.length) {
									var cl = clauses[`];
									++ `;
									var binders = reflaxe.elixir.ast.transformers.CaseBinderRebindUnderscoreTransforms.collectPatternBinders(cl.pattern);
									var bodyStmts = @:ast(switch (cl.body.def) {
	case EBlock(ss):
		ss;	
	default:
		[cl.body];	
}) {
										var ` = cl.body.def;
										if (enumIndex ` == 53) {
											var ` = `[0];
											{
												var ss = `;
												{
													ss;
												};
											};
										} else {
											[cl.body];
										};
									};
									var toUnderscore = [];
									{
										var ` = 0;
										while (` < binders.length) {
											var b = binders[`];
											++ `;
											var rebindIdx = reflaxe.elixir.ast.transformers.CaseBinderRebindUnderscoreTransforms.firstRebindIndex(bodyStmts, b);
											var useIdx = reflaxe.elixir.ast.transformers.CaseBinderRebindUnderscoreTransforms.firstUseIndex(bodyStmts, b);
											if (rebindIdx >= 0 && (useIdx == -1 || rebindIdx < useIdx)) {
												if (! reflaxe.elixir.ast.transformers.CaseBinderRebindUnderscoreTransforms.isAliasFromUnderscoredBinder(bodyStmts[rebindIdx], b)) {
													toUnderscore.push(b);
												};
											};
										};
									};
									var newPat = if ((toUnderscore.length > 0)) {
										reflaxe.elixir.ast.transformers.CaseBinderRebindUnderscoreTransforms.underscoreBinders(cl.pattern, toUnderscore);
									} else {
										cl.pattern;
									};
									newClauses.push({pattern : newPat, guard : cl.guard, body : cl.body});
								};
							};
							{def : reflaxe.elixir.ast.ElixirASTDef.ECase(target, newClauses), metadata : n.metadata, pos : n.pos};
						};
					};
				} else {
					n;
				};
			};
		});
	}

	static function collectPatternBinders(p:reflaxe.elixir.ast.EPattern) {
		var out = [];
		var walk = [null];
		walk[0] = function(px:reflaxe.elixir.ast.EPattern) {
			@:ast(switch (px) {
	case PVar(n):
		out.push(n);	
	case PTuple(es):
		for (e  in  es) walk(e);	
	case PList(es):
		for (e  in  es) walk(e);	
	case PCons(h, t):
		walk(h);
		walk(t);	
	case PMap(kvs):
		for (kv  in  kvs) walk(kv.value);	
	case PStruct(_, fs):
		for (f  in  fs) walk(f.value);	
	case PPin(inner):
		walk(inner);	
	default:
}) switch (enumIndex px) {
				case 0: {
					var ` = px[0];
					{
						var n = `;
						{
							out.push(n);
						};
					};
				};
				case 2: {
					var ` = px[0];
					{
						var es = `;
						{
							{
								var ` = 0;
								while (` < es.length) {
									var e = es[`];
									++ `;
									walk[0](e);
								};
							};
						};
					};
				};
				case 3: {
					var ` = px[0];
					{
						var es = `;
						{
							{
								var ` = 0;
								while (` < es.length) {
									var e = es[`];
									++ `;
									walk[0](e);
								};
							};
						};
					};
				};
				case 4: {
					var ` = px[0];
					var ` = px[1];
					{
						var h = `;
						var t = `;
						{
							walk[0](h);
							walk[0](t);
						};
					};
				};
				case 5: {
					var ` = px[0];
					{
						var kvs = `;
						{
							{
								var ` = 0;
								while (` < kvs.length) {
									var kv = kvs[`];
									++ `;
									walk[0](kv.value);
								};
							};
						};
					};
				};
				case 6: {
					var ` = px[0];
					var ` = px[1];
					{
						var fs = `;
						{
							{
								var ` = 0;
								while (` < fs.length) {
									var f = fs[`];
									++ `;
									walk[0](f.value);
								};
							};
						};
					};
				};
				case 7: {
					var ` = px[0];
					{
						var inner = `;
						{
							walk[0](inner);
						};
					};
				};
				default: {}
			};
		};
		walk[0](p);
		return out;
	}

	static function underscoreBinders(p:reflaxe.elixir.ast.EPattern, names:Array<String>) {
		return @:ast(switch (p) {
	case PVar(n):
		if (names.indexOf(n) != -1 && n.charAt(0) != "_") PVar("_" + n) else p;	
	case PTuple(es):
		PTuple([for (e  in  es) underscoreBinders(e, names)]);	
	case PList(es):
		PList([for (e  in  es) underscoreBinders(e, names)]);	
	case PCons(h, t):
		PCons(underscoreBinders(h, names), underscoreBinders(t, names));	
	case PMap(kvs):
		PMap([for (kv  in  kvs) { key : kv.key, value : underscoreBinders(kv.value, names) }]);	
	case PStruct(nm, fs):
		PStruct(nm, [for (f  in  fs) { key : f.key, value : underscoreBinders(f.value, names) }]);	
	case PPin(inner):
		PPin(underscoreBinders(inner, names));	
	default:
		p;	
}) switch (enumIndex p) {
			case 0: {
				var ` = p[0];
				{
					var n = `;
					{
						if (names.indexOf(n, null) != -1 && n.charAt(0) != "_") {
							reflaxe.elixir.ast.EPattern.PVar("_" + n);
						} else {
							p;
						};
					};
				};
			};
			case 2: {
				var ` = p[0];
				{
					var es = `;
					{
						reflaxe.elixir.ast.EPattern.PTuple({
							var ` = [];
							{
								var ` = 0;
								while (` < es.length) {
									var e = es[`];
									++ `;
									`.push(reflaxe.elixir.ast.transformers.CaseBinderRebindUnderscoreTransforms.underscoreBinders(e, names));
								};
							};
							`;
						});
					};
				};
			};
			case 3: {
				var ` = p[0];
				{
					var es = `;
					{
						reflaxe.elixir.ast.EPattern.PList({
							var ` = [];
							{
								var ` = 0;
								while (` < es.length) {
									var e = es[`];
									++ `;
									`.push(reflaxe.elixir.ast.transformers.CaseBinderRebindUnderscoreTransforms.underscoreBinders(e, names));
								};
							};
							`;
						});
					};
				};
			};
			case 4: {
				var ` = p[0];
				var ` = p[1];
				{
					var h = `;
					var t = `;
					{
						reflaxe.elixir.ast.EPattern.PCons(reflaxe.elixir.ast.transformers.CaseBinderRebindUnderscoreTransforms.underscoreBinders(h, names), reflaxe.elixir.ast.transformers.CaseBinderRebindUnderscoreTransforms.underscoreBinders(t, names));
					};
				};
			};
			case 5: {
				var ` = p[0];
				{
					var kvs = `;
					{
						reflaxe.elixir.ast.EPattern.PMap({
							var ` = [];
							{
								var ` = 0;
								while (` < kvs.length) {
									var kv = kvs[`];
									++ `;
									`.push({key : kv.key, value : reflaxe.elixir.ast.transformers.CaseBinderRebindUnderscoreTransforms.underscoreBinders(kv.value, names)});
								};
							};
							`;
						});
					};
				};
			};
			case 6: {
				var ` = p[0];
				var ` = p[1];
				{
					var nm = `;
					var fs = `;
					{
						reflaxe.elixir.ast.EPattern.PStruct(nm, {
							var ` = [];
							{
								var ` = 0;
								while (` < fs.length) {
									var f = fs[`];
									++ `;
									`.push({key : f.key, value : reflaxe.elixir.ast.transformers.CaseBinderRebindUnderscoreTransforms.underscoreBinders(f.value, names)});
								};
							};
							`;
						});
					};
				};
			};
			case 7: {
				var ` = p[0];
				{
					var inner = `;
					{
						reflaxe.elixir.ast.EPattern.PPin(reflaxe.elixir.ast.transformers.CaseBinderRebindUnderscoreTransforms.underscoreBinders(inner, names));
					};
				};
			};
			default: {
				p;
			}
		};
	}

	static function firstRebindIndex(stmts:Array<reflaxe.elixir.ast.ElixirAST>, name:String) {
		{
			var ` = 0;
			var ` = stmts.length;
			while (` < `) {
				var i = ` ++;
				@:ast(switch (stmts[i].def) {
	case EBinary(Match, left, _):
		switch (left.def) {
			case EVar(nm) if (nm == name):
				return i;			
			default:
		};	
	case EMatch(pat, _):
		switch (pat) {
			case PVar(nm2) if (nm2 == name):
				return i;			
			default:
		};	
	default:
}) {
					var ` = stmts[i].def;
					switch (enumIndex `) {
						case 8: {
							var ` = `[0];
							var ` = `[1];
							{
								var pat = `;
								{
									@:ast(switch (pat) {
	case PVar(nm2) if (nm2 == name):
		return i;	
	default:
}) if (enumIndex pat == 0) {
										var ` = pat[0];
										{
											var nm2 = `;
											if (nm2 == name) {
												return i;
											} else {};
										};
									} else {};
								};
							};
						};
						case 26: {
							var ` = `[0];
							var ` = `[1];
							var ` = `[2];
							if (enumIndex ` == 27) {
								{
									var left = `;
									{
										@:ast(switch (left.def) {
	case EVar(nm) if (nm == name):
		return i;	
	default:
}) {
											var ` = left.def;
											if (enumIndex ` == 38) {
												var ` = `[0];
												{
													var nm = `;
													if (nm == name) {
														return i;
													} else {};
												};
											} else {};
										};
									};
								};
							} else {};
						};
						default: {}
					};
				};
			};
		};
		return -1;
	}

	static function isAliasFromUnderscoredBinder(stmt:reflaxe.elixir.ast.ElixirAST, name:String) {
		return @:ast(switch (stmt.def) {
	case EBinary(Match, { def : EVar(lhs) }, { def : EVar(rhs) }) if (lhs == name && rhs == "_" + name):
		true;	
	case EMatch(PVar(p), { def : EVar(rhs2) }) if (p == name && rhs2 == "_" + name):
		true;	
	default:
		false;	
}) {
			var ` = stmt.def;
			switch (enumIndex `) {
				case 8: {
					var ` = `[0];
					var ` = `[1];
					if (enumIndex ` == 0) {
						var ` = `[0];
						{
							var ` = `.def;
							var ` = `.metadata;
							var ` = `.pos;
							if (enumIndex ` == 38) {
								var ` = `[0];
								{
									var rhs2 = `;
									var p = `;
									if (p == name && rhs2 == "_" + name) {
										true;
									} else {
										false;
									};
								};
							} else {
								false;
							};
						};
					} else {
						false;
					};
				};
				case 26: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					if (enumIndex ` == 27) {
						{
							var ` = `.def;
							var ` = `.metadata;
							var ` = `.pos;
							if (enumIndex ` == 38) {
								var ` = `[0];
								{
									var ` = `.def;
									var ` = `.metadata;
									var ` = `.pos;
									if (enumIndex ` == 38) {
										var ` = `[0];
										{
											var rhs = `;
											var lhs = `;
											if (lhs == name && rhs == "_" + name) {
												true;
											} else {
												false;
											};
										};
									} else {
										false;
									};
								};
							} else {
								false;
							};
						};
					} else {
						false;
					};
				};
				default: {
					false;
				}
			};
		};
	}

	static function firstUseIndex(stmts:Array<reflaxe.elixir.ast.ElixirAST>, name:String) {
		{
			var ` = 0;
			var ` = stmts.length;
			while (` < `) {
				var i = ` ++;
				if (reflaxe.elixir.ast.transformers.CaseBinderRebindUnderscoreTransforms.stmtUsesVar(stmts[i], name)) {
					return i;
				};
			};
		};
		return -1;
	}

	static function stmtUsesVar(n:reflaxe.elixir.ast.ElixirAST, name:String) {
		var found = [false];
		var walk = [null];
		walk[0] = function(x:reflaxe.elixir.ast.ElixirAST, inPattern:Bool) {
			if (x == null || found[0]) {
				return;
			};
			@:ast(switch (x.def) {
	case EVar(v) if (!inPattern && v == name):
		found = true;	
	case EBinary(Match, _, rhs):
		walk(rhs, false);	
	case EMatch(_, rhs2):
		walk(rhs2, false);	
	case EBlock(ss):
		for (s  in  ss) walk(s, false);	
	case EIf(c, t, e):
		walk(c, false);
		walk(t, false);
		if (e != null) walk(e, false);	
	case EBinary(_, l, r):
		walk(l, false);
		walk(r, false);	
	case ECall(tgt, _, args):
		if (tgt != null) walk(tgt, false);
		for (a  in  args) walk(a, false);	
	case ERemoteCall(tgt2, _, args2):
		walk(tgt2, false);
		for (a2  in  args2) walk(a2, false);	
	case ECase(expr, cs):
		walk(expr, false);
		for (c  in  cs) walk(c.body, false);	
	default:
}) {
				var ` = x.def;
				switch (enumIndex `) {
					case 6: {
						var ` = `[0];
						var ` = `[1];
						{
							var expr = `;
							var cs = `;
							{
								walk[0](expr, false);
								{
									var ` = 0;
									while (` < cs.length) {
										var c = cs[`];
										++ `;
										walk[0](c.body, false);
									};
								};
							};
						};
					};
					case 8: {
						var ` = `[0];
						var ` = `[1];
						{
							var rhs2 = `;
							{
								walk[0](rhs2, false);
							};
						};
					};
					case 10: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var c = `;
							var t = `;
							var e = `;
							{
								walk[0](c, false);
								walk[0](t, false);
								if (e != null) {
									walk[0](e, false);
								};
							};
						};
					};
					case 22: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var tgt = `;
							var args = `;
							{
								if (tgt != null) {
									walk[0](tgt, false);
								};
								{
									var ` = 0;
									while (` < args.length) {
										var a = args[`];
										++ `;
										walk[0](a, false);
									};
								};
							};
						};
					};
					case 24: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var tgt2 = `;
							var args2 = `;
							{
								walk[0](tgt2, false);
								{
									var ` = 0;
									while (` < args2.length) {
										var a2 = args2[`];
										++ `;
										walk[0](a2, false);
									};
								};
							};
						};
					};
					case 26: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						if (enumIndex ` == 27) {
							{
								var rhs = `;
								{
									walk[0](rhs, false);
								};
							};
						} else {
							var l = `;
							var r = `;
							{
								walk[0](l, false);
								walk[0](r, false);
							};
						};
					};
					case 38: {
						var ` = `[0];
						{
							var v = `;
							if (! inPattern && v == name) {
								found[0] = true;
							} else {};
						};
					};
					case 53: {
						var ` = `[0];
						{
							var ss = `;
							{
								{
									var ` = 0;
									while (` < ss.length) {
										var s = ss[`];
										++ `;
										walk[0](s, false);
									};
								};
							};
						};
					};
					default: {}
				};
			};
		};
		walk[0](n, false);
		return found[0];
	}
}