class reflaxe.elixir.ast.SubstitutionHelpers {

	public static function replaceNullCoalVar(expr:haxe.macro.TypedExpr, varId:Int, initExpr:haxe.macro.TypedExpr) {
		return @:ast(switch (expr.expr) {
	case TBinop(OpNullCoal, { expr : TLocal(v) }, defaultExpr) if (v.id == varId):
		{ expr : TIf({ expr : TBinop(OpNotEq, initExpr, { expr : TConst(TNull), t : expr.t, pos : expr.pos }), t : expr.t, pos : expr.pos }, initExpr, defaultExpr), t : expr.t, pos : expr.pos };	
	case TLocal(v) if (v.id == varId):
		initExpr;	
	case TBlock(exprs):
		{ expr : TBlock(exprs.map(function(e) ->  @:implicitReturn return replaceNullCoalVar(e, varId, initExpr))), t : expr.t, pos : expr.pos };	
	case TIf(cond, thenExpr, elseExpr):
		{ expr : TIf(replaceNullCoalVar(cond, varId, initExpr), replaceNullCoalVar(thenExpr, varId, initExpr), elseExpr != null ? replaceNullCoalVar(elseExpr, varId, initExpr) : null), t : expr.t, pos : expr.pos };	
	case TCall(e, el):
		{ expr : TCall(replaceNullCoalVar(e, varId, initExpr), el.map(function(arg) ->  @:implicitReturn return replaceNullCoalVar(arg, varId, initExpr))), t : expr.t, pos : expr.pos };	
	default:
		expr;	
}) {
			var ` = expr.expr;
			switch (enumIndex `) {
				case 1: {
					var ` = `[0];
					{
						var v = `;
						if (v.id == varId) {
							initExpr;
						} else {
							expr;
						};
					};
				};
				case 3: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					if (enumIndex ` == 24) {
						{
							var ` = `.expr;
							var ` = `.pos;
							var ` = `.t;
							if (enumIndex ` == 1) {
								var ` = `[0];
								{
									var v = `;
									var defaultExpr = `;
									if (v.id == varId) {
										{expr : haxe.macro.TypedExprDef.TIf({expr : haxe.macro.TypedExprDef.TBinop(haxe.macro.Binop.OpNotEq, initExpr, {expr : haxe.macro.TypedExprDef.TConst(haxe.macro.TConstant.TNull), t : expr.t, pos : expr.pos}), t : expr.t, pos : expr.pos}, initExpr, defaultExpr), t : expr.t, pos : expr.pos};
									} else {
										expr;
									};
								};
							} else {
								expr;
							};
						};
					} else {
						expr;
					};
				};
				case 9: {
					var ` = `[0];
					var ` = `[1];
					{
						var e = `;
						var el = `;
						{
							{expr : haxe.macro.TypedExprDef.TCall(reflaxe.elixir.ast.SubstitutionHelpers.replaceNullCoalVar(e, varId, initExpr), {
								var ` = [];
								{
									var ` = 0;
									var ` = el;
									while (` < `.length) {
										var v = `[`];
										++ `;
										`.push(function(arg:haxe.macro.TypedExpr) {
											return reflaxe.elixir.ast.SubstitutionHelpers.replaceNullCoalVar(arg, varId, initExpr);
										}(v));
									};
								};
								`;
							}), t : expr.t, pos : expr.pos};
						};
					};
				};
				case 14: {
					var ` = `[0];
					{
						var exprs = `;
						{
							{expr : haxe.macro.TypedExprDef.TBlock({
								var ` = [];
								{
									var ` = 0;
									var ` = exprs;
									while (` < `.length) {
										var v = `[`];
										++ `;
										`.push(function(e:haxe.macro.TypedExpr) {
											return reflaxe.elixir.ast.SubstitutionHelpers.replaceNullCoalVar(e, varId, initExpr);
										}(v));
									};
								};
								`;
							}), t : expr.t, pos : expr.pos};
						};
					};
				};
				case 16: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					{
						var cond = `;
						var thenExpr = `;
						var elseExpr = `;
						{
							{expr : haxe.macro.TypedExprDef.TIf(reflaxe.elixir.ast.SubstitutionHelpers.replaceNullCoalVar(cond, varId, initExpr), reflaxe.elixir.ast.SubstitutionHelpers.replaceNullCoalVar(thenExpr, varId, initExpr), if (elseExpr != null) {
								reflaxe.elixir.ast.SubstitutionHelpers.replaceNullCoalVar(elseExpr, varId, initExpr);
							} else {
								null;
							}), t : expr.t, pos : expr.pos};
						};
					};
				};
				default: {
					expr;
				}
			};
		};
	}

	public static function substituteVariable(expr:haxe.macro.TypedExpr, varToReplace:haxe.macro.TVar, replacement:haxe.macro.TypedExpr) {
		return @:ast(switch (expr.expr) {
	case TLocal(v) if (v.id == varToReplace.id):
		replacement;	
	case TBlock(exprs):
		{ expr : TBlock(exprs.map(function(e) ->  @:implicitReturn return substituteVariable(e, varToReplace, replacement))), t : expr.t, pos : expr.pos };	
	case TCall(e, el):
		{ expr : TCall(substituteVariable(e, varToReplace, replacement), el.map(function(arg) ->  @:implicitReturn return substituteVariable(arg, varToReplace, replacement))), t : expr.t, pos : expr.pos };	
	case TIf(cond, thenExpr, elseExpr):
		{ expr : TIf(substituteVariable(cond, varToReplace, replacement), substituteVariable(thenExpr, varToReplace, replacement), elseExpr != null ? substituteVariable(elseExpr, varToReplace, replacement) : null), t : expr.t, pos : expr.pos };	
	case TBinop(op, e1, e2):
		{ expr : TBinop(op, substituteVariable(e1, varToReplace, replacement), substituteVariable(e2, varToReplace, replacement)), t : expr.t, pos : expr.pos };	
	case TUnop(op, postFix, e):
		{ expr : TUnop(op, postFix, substituteVariable(e, varToReplace, replacement)), t : expr.t, pos : expr.pos };	
	case TField(e, fa):
		{ expr : TField(substituteVariable(e, varToReplace, replacement), fa), t : expr.t, pos : expr.pos };	
	case TArrayDecl(el):
		{ expr : TArrayDecl(el.map(function(e) ->  @:implicitReturn return substituteVariable(e, varToReplace, replacement))), t : expr.t, pos : expr.pos };	
	case TObjectDecl(fields):
		{ expr : TObjectDecl(fields.map(function(f) ->  @:implicitReturn return { name : f.name, expr : substituteVariable(f.expr, varToReplace, replacement) })), t : expr.t, pos : expr.pos };	
	case TSwitch(e, cases, edef):
		{ expr : TSwitch(substituteVariable(e, varToReplace, replacement), cases.map(function(c) ->  @:implicitReturn return { values : c.values.map(function(v) ->  @:implicitReturn return substituteVariable(v, varToReplace, replacement)), expr : substituteVariable(c.expr, varToReplace, replacement) }), edef != null ? substituteVariable(edef, varToReplace, replacement) : null), t : expr.t, pos : expr.pos };	
	case TFor(v, e1, e2):
		if (v.id == varToReplace.id) {
			expr;
		} else {
			{ expr : TFor(v, substituteVariable(e1, varToReplace, replacement), substituteVariable(e2, varToReplace, replacement)), t : expr.t, pos : expr.pos };
		};	
	case TWhile(econd, e, normalWhile):
		{ expr : TWhile(substituteVariable(econd, varToReplace, replacement), substituteVariable(e, varToReplace, replacement), normalWhile), t : expr.t, pos : expr.pos };	
	case TParenthesis(e):
		{ expr : TParenthesis(substituteVariable(e, varToReplace, replacement)), t : expr.t, pos : expr.pos };	
	case TReturn(e):
		{ expr : TReturn(e != null ? substituteVariable(e, varToReplace, replacement) : null), t : expr.t, pos : expr.pos };	
	case TThrow(e):
		{ expr : TThrow(substituteVariable(e, varToReplace, replacement)), t : expr.t, pos : expr.pos };	
	case TTry(e, catches):
		{ expr : TTry(substituteVariable(e, varToReplace, replacement), catches.map(function(c) ->  @:implicitReturn return { v : c.v, expr : c.v.id == varToReplace.id ? c.expr : substituteVariable(c.expr, varToReplace, replacement) })), t : expr.t, pos : expr.pos };	
	case TVar(v, init):
		if (v.id == varToReplace.id) {
			expr;
		} else {
			{ expr : TVar(v, init != null ? substituteVariable(init, varToReplace, replacement) : null), t : expr.t, pos : expr.pos };
		};	
	default:
		expr;	
}) {
			var ` = expr.expr;
			switch (enumIndex `) {
				case 1: {
					var ` = `[0];
					{
						var v = `;
						if (v.id == varToReplace.id) {
							replacement;
						} else {
							expr;
						};
					};
				};
				case 3: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					{
						var op = `;
						var e1 = `;
						var e2 = `;
						{
							{expr : haxe.macro.TypedExprDef.TBinop(op, reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(e1, varToReplace, replacement), reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(e2, varToReplace, replacement)), t : expr.t, pos : expr.pos};
						};
					};
				};
				case 4: {
					var ` = `[0];
					var ` = `[1];
					{
						var e = `;
						var fa = `;
						{
							{expr : haxe.macro.TypedExprDef.TField(reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(e, varToReplace, replacement), fa), t : expr.t, pos : expr.pos};
						};
					};
				};
				case 6: {
					var ` = `[0];
					{
						var e = `;
						{
							{expr : haxe.macro.TypedExprDef.TParenthesis(reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(e, varToReplace, replacement)), t : expr.t, pos : expr.pos};
						};
					};
				};
				case 7: {
					var ` = `[0];
					{
						var fields = `;
						{
							{expr : haxe.macro.TypedExprDef.TObjectDecl({
								var ` = [];
								{
									var ` = 0;
									var ` = fields;
									while (` < `.length) {
										var v = `[`];
										++ `;
										`.push(function(f:{ name : String, expr : haxe.macro.TypedExpr }) {
											return {name : f.name, expr : reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(f.expr, varToReplace, replacement)};
										}(v));
									};
								};
								`;
							}), t : expr.t, pos : expr.pos};
						};
					};
				};
				case 8: {
					var ` = `[0];
					{
						var el = `;
						{
							{expr : haxe.macro.TypedExprDef.TArrayDecl({
								var ` = [];
								{
									var ` = 0;
									var ` = el;
									while (` < `.length) {
										var v = `[`];
										++ `;
										`.push(function(e:haxe.macro.TypedExpr) {
											return reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(e, varToReplace, replacement);
										}(v));
									};
								};
								`;
							}), t : expr.t, pos : expr.pos};
						};
					};
				};
				case 9: {
					var ` = `[0];
					var ` = `[1];
					{
						var e = `;
						var el = `;
						{
							{expr : haxe.macro.TypedExprDef.TCall(reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(e, varToReplace, replacement), {
								var ` = [];
								{
									var ` = 0;
									var ` = el;
									while (` < `.length) {
										var v = `[`];
										++ `;
										`.push(function(arg:haxe.macro.TypedExpr) {
											return reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(arg, varToReplace, replacement);
										}(v));
									};
								};
								`;
							}), t : expr.t, pos : expr.pos};
						};
					};
				};
				case 11: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					{
						var op = `;
						var postFix = `;
						var e = `;
						{
							{expr : haxe.macro.TypedExprDef.TUnop(op, postFix, reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(e, varToReplace, replacement)), t : expr.t, pos : expr.pos};
						};
					};
				};
				case 13: {
					var ` = `[0];
					var ` = `[1];
					{
						var v = `;
						var init = `;
						{
							if (v.id == varToReplace.id) {
								expr;
							} else {
								{expr : haxe.macro.TypedExprDef.TVar(v, if (init != null) {
									reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(init, varToReplace, replacement);
								} else {
									null;
								}), t : expr.t, pos : expr.pos};
							};
						};
					};
				};
				case 14: {
					var ` = `[0];
					{
						var exprs = `;
						{
							{expr : haxe.macro.TypedExprDef.TBlock({
								var ` = [];
								{
									var ` = 0;
									var ` = exprs;
									while (` < `.length) {
										var v = `[`];
										++ `;
										`.push(function(e:haxe.macro.TypedExpr) {
											return reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(e, varToReplace, replacement);
										}(v));
									};
								};
								`;
							}), t : expr.t, pos : expr.pos};
						};
					};
				};
				case 15: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					{
						var v = `;
						var e1 = `;
						var e2 = `;
						{
							if (v.id == varToReplace.id) {
								expr;
							} else {
								{expr : haxe.macro.TypedExprDef.TFor(v, reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(e1, varToReplace, replacement), reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(e2, varToReplace, replacement)), t : expr.t, pos : expr.pos};
							};
						};
					};
				};
				case 16: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					{
						var cond = `;
						var thenExpr = `;
						var elseExpr = `;
						{
							{expr : haxe.macro.TypedExprDef.TIf(reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(cond, varToReplace, replacement), reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(thenExpr, varToReplace, replacement), if (elseExpr != null) {
								reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(elseExpr, varToReplace, replacement);
							} else {
								null;
							}), t : expr.t, pos : expr.pos};
						};
					};
				};
				case 17: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					{
						var econd = `;
						var e = `;
						var normalWhile = `;
						{
							{expr : haxe.macro.TypedExprDef.TWhile(reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(econd, varToReplace, replacement), reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(e, varToReplace, replacement), normalWhile), t : expr.t, pos : expr.pos};
						};
					};
				};
				case 18: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					{
						var e = `;
						var cases = `;
						var edef = `;
						{
							{expr : haxe.macro.TypedExprDef.TSwitch(reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(e, varToReplace, replacement), {
								var ` = [];
								{
									var ` = 0;
									var ` = cases;
									while (` < `.length) {
										var v = `[`];
										++ `;
										`.push(function(c:{ values : Array<haxe.macro.TypedExpr>, expr : haxe.macro.TypedExpr }) {
											return {values : {
												var _this = c.values;
												{
													var ` = [];
													{
														var ` = 0;
														var ` = _this;
														while ((` < `.length)) {
															var v = `[`];
															++ `;
															`.push(reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(v, varToReplace, replacement));
														};
													};
													`;
												};
											}, expr : reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(c.expr, varToReplace, replacement)};
										}(v));
									};
								};
								`;
							}, if (edef != null) {
								reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(edef, varToReplace, replacement);
							} else {
								null;
							}), t : expr.t, pos : expr.pos};
						};
					};
				};
				case 19: {
					var ` = `[0];
					var ` = `[1];
					{
						var e = `;
						var catches = `;
						{
							{expr : haxe.macro.TypedExprDef.TTry(reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(e, varToReplace, replacement), {
								var ` = [];
								{
									var ` = 0;
									var ` = catches;
									while (` < `.length) {
										var v = `[`];
										++ `;
										`.push(function(c:{ v : haxe.macro.TVar, expr : haxe.macro.TypedExpr }) {
											return {v : c.v, expr : if ((c.v.id == varToReplace.id)) c.expr else reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(c.expr, varToReplace, replacement)};
										}(v));
									};
								};
								`;
							}), t : expr.t, pos : expr.pos};
						};
					};
				};
				case 20: {
					var ` = `[0];
					{
						var e = `;
						{
							{expr : haxe.macro.TypedExprDef.TReturn(if (e != null) {
								reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(e, varToReplace, replacement);
							} else {
								null;
							}), t : expr.t, pos : expr.pos};
						};
					};
				};
				case 23: {
					var ` = `[0];
					{
						var e = `;
						{
							{expr : haxe.macro.TypedExprDef.TThrow(reflaxe.elixir.ast.SubstitutionHelpers.substituteVariable(e, varToReplace, replacement)), t : expr.t, pos : expr.pos};
						};
					};
				};
				default: {
					expr;
				}
			};
		};
	}

	public static function buildWithSubstitution(expr:haxe.macro.TypedExpr, loopVar:Null<haxe.macro.TVar>, context:reflaxe.elixir.CompilationContext) {
		if (loopVar != null) {};
		return reflaxe.elixir.ast.ElixirASTBuilder.buildFromTypedExpr(expr, context);
	}
}