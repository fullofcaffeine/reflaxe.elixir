class reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms {

	public static function pass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EDef(name, args, guards, body):
		makeASTWithMeta(EDef(name, args, guards, rewriteBody(body)), n.metadata, n.pos);	
	case EDefp(name, args, guards, body):
		makeASTWithMeta(EDefp(name, args, guards, rewriteBody(body)), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 2: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name = `;
							var args = `;
							var guards = `;
							var body = `;
							{
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EDef(name, args, guards, reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.rewriteBody(body));
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							};
						};
					};
					case 3: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name = `;
							var args = `;
							var guards = `;
							var body = `;
							{
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EDefp(name, args, guards, reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.rewriteBody(body));
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							};
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}

	static function rewriteBody(body:reflaxe.elixir.ast.ElixirAST) {
		return @:ast(switch (body.def) {
	case EBlock(stmts):
		var usesCs = false;
		for (si  in  0 ... stmts.length) if (isValidateCallReferencingCs(stmts[si])) {
			usesCs = true;
			break;
		};
		if (!usesCs) return body;
		var sourceIdx = -1;
		var sourceExpr:Null<ElixirAST> = null;
		for (wi  in  0 ... stmts.length) {
			if (isNestedWildcardAssign(stmts[wi])) {
				sourceIdx = wi;
				sourceExpr = bindCsFrom(stmts[wi]);
				break;
			};
		};
		if (sourceExpr == null) {
			for (wi  in  0 ... stmts.length) {
				switch (stmts[wi].def) {
					case ERaw(code) if (code != null && code.indexOf("Ecto.Changeset.cast(") != -1):
						sourceIdx = wi;
						sourceExpr = makeASTWithMeta(EBinary(Match, makeAST(EVar("cs")), stmts[wi]), stmts[wi].metadata, stmts[wi].pos);
						break;					
					default:
				};
				if (sourceExpr != null) break;
			};
		};
		if (sourceExpr == null) return body;
		var out:Array<ElixirAST> = [];
		var inserted = false;
		for (i  in  0 ... stmts.length) {
			if (!inserted) {
				out.push(sourceExpr);
				inserted = true;
				if (i == sourceIdx) continue;
			};
			if (i == sourceIdx) {
				continue;
			};
			out.push(stmts[i]);
		};
		makeASTWithMeta(EBlock(out), body.metadata, body.pos);	
	case EDo(stmts2):
		var tmp = makeAST(EBlock(stmts2));
		var res = rewriteBody(tmp);
		switch (res.def) {
			case EBlock(os):
				makeASTWithMeta(EDo(os), body.metadata, body.pos);			
			default:
				res;			
		};	
	default:
		body;	
}) {
			var ` = body.def;
			switch (enumIndex `) {
				case 53: {
					var ` = `[0];
					{
						var stmts = `;
						{
							var usesCs = false;
							{
								var ` = 0;
								var ` = stmts.length;
								while (` < `) {
									var si = ` ++;
									if (reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.isValidateCallReferencingCs(stmts[si])) {
										usesCs = true;
										break;
									};
								};
							};
							if (! usesCs) {
								return body;
							};
							var sourceIdx = -1;
							var sourceExpr = null;
							{
								var ` = 0;
								var ` = stmts.length;
								while (` < `) {
									var wi = ` ++;
									if (reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.isNestedWildcardAssign(stmts[wi])) {
										sourceIdx = wi;
										sourceExpr = reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.bindCsFrom(stmts[wi]);
										break;
									};
								};
							};
							if (sourceExpr == null) {
								{
									var ` = 0;
									var ` = stmts.length;
									while (` < `) {
										var wi = ` ++;
										@:ast(switch (stmts[wi].def) {
	case ERaw(code) if (code != null && code.indexOf("Ecto.Changeset.cast(") != -1):
		sourceIdx = wi;
		sourceExpr = makeASTWithMeta(EBinary(Match, makeAST(EVar("cs")), stmts[wi]), stmts[wi].metadata, stmts[wi].pos);
		break;	
	default:
}) {
											var ` = stmts[wi].def;
											if (enumIndex ` == 62) {
												var ` = `[0];
												{
													var code = `;
													if (code != null && code.indexOf("Ecto.Changeset.cast(", null) != -1) {
														sourceIdx = wi;
														sourceExpr = {def : reflaxe.elixir.ast.ElixirASTDef.EBinary(reflaxe.elixir.ast.EBinaryOp.Match, {
															var pos = null;
															{def : reflaxe.elixir.ast.ElixirASTDef.EVar("cs"), metadata : {}, pos : pos};
														}, stmts[wi]), metadata : stmts[wi].metadata, pos : stmts[wi].pos};
														break;
													} else {};
												};
											} else {};
										};
										if (sourceExpr != null) {
											break;
										};
									};
								};
							};
							if (sourceExpr == null) {
								return body;
							};
							var out = [];
							var inserted = false;
							{
								var ` = 0;
								var ` = stmts.length;
								while (` < `) {
									var i = ` ++;
									if (! inserted) {
										out.push(sourceExpr);
										inserted = true;
										if (i == sourceIdx) {
											continue;
										};
									};
									if (i == sourceIdx) {
										continue;
									};
									out.push(stmts[i]);
								};
							};
							{def : reflaxe.elixir.ast.ElixirASTDef.EBlock(out), metadata : body.metadata, pos : body.pos};
						};
					};
				};
				case 55: {
					var ` = `[0];
					{
						var stmts2 = `;
						{
							var tmp = {
								var pos = null;
								{def : reflaxe.elixir.ast.ElixirASTDef.EBlock(stmts2), metadata : {}, pos : pos};
							};
							var res = reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.rewriteBody(tmp);
							@:ast(switch (res.def) {
	case EBlock(os):
		makeASTWithMeta(EDo(os), body.metadata, body.pos);	
	default:
		res;	
}) {
								var ` = res.def;
								if (enumIndex ` == 53) {
									var ` = `[0];
									{
										var os = `;
										{
											{def : reflaxe.elixir.ast.ElixirASTDef.EDo(os), metadata : body.metadata, pos : body.pos};
										};
									};
								} else {
									res;
								};
							};
						};
					};
				};
				default: {
					body;
				}
			};
		};
	}

	static function collectDeclsFromStmt(s:reflaxe.elixir.ast.ElixirAST, declared:Map<String, Bool>) {
		if (s == null || s.def == null) {
			return;
		};
		@:ast(switch (s.def) {
	case EMatch(p, _):
		collectPatternDecls(p, declared);	
	case EBinary(Match, left, _):
		collectLhsDecls(left, declared);	
	default:
}) {
			var ` = s.def;
			switch (enumIndex `) {
				case 8: {
					var ` = `[0];
					var ` = `[1];
					{
						var p = `;
						{
							reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.collectPatternDecls(p, declared);
						};
					};
				};
				case 26: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					if (enumIndex ` == 27) {
						{
							var left = `;
							{
								reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.collectLhsDecls(left, declared);
							};
						};
					} else {};
				};
				default: {}
			};
		};
	}

	static function collectPatternDecls(p:reflaxe.elixir.ast.EPattern, declared:Map<String, Bool>) {
		@:ast(switch (p) {
	case PVar(n):
		declared.set(n, true);	
	case PTuple(es):
		for (e  in  es) collectPatternDecls(e, declared);	
	case PList(es):
		for (e  in  es) collectPatternDecls(e, declared);	
	case PCons(h, t):
		collectPatternDecls(h, declared);
		collectPatternDecls(t, declared);	
	case PMap(kvs):
		for (kv  in  kvs) collectPatternDecls(kv.value, declared);	
	case PStruct(_, fs):
		for (f  in  fs) collectPatternDecls(f.value, declared);	
	case PPin(inner):
		collectPatternDecls(inner, declared);	
	default:
}) switch (enumIndex p) {
			case 0: {
				var ` = p[0];
				{
					var n = `;
					{
						{
							declared.set(n, true);
						};
					};
				};
			};
			case 2: {
				var ` = p[0];
				{
					var es = `;
					{
						{
							var ` = 0;
							while (` < es.length) {
								var e = es[`];
								++ `;
								reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.collectPatternDecls(e, declared);
							};
						};
					};
				};
			};
			case 3: {
				var ` = p[0];
				{
					var es = `;
					{
						{
							var ` = 0;
							while (` < es.length) {
								var e = es[`];
								++ `;
								reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.collectPatternDecls(e, declared);
							};
						};
					};
				};
			};
			case 4: {
				var ` = p[0];
				var ` = p[1];
				{
					var h = `;
					var t = `;
					{
						reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.collectPatternDecls(h, declared);
						reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.collectPatternDecls(t, declared);
					};
				};
			};
			case 5: {
				var ` = p[0];
				{
					var kvs = `;
					{
						{
							var ` = 0;
							while (` < kvs.length) {
								var kv = kvs[`];
								++ `;
								reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.collectPatternDecls(kv.value, declared);
							};
						};
					};
				};
			};
			case 6: {
				var ` = p[0];
				var ` = p[1];
				{
					var fs = `;
					{
						{
							var ` = 0;
							while (` < fs.length) {
								var f = fs[`];
								++ `;
								reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.collectPatternDecls(f.value, declared);
							};
						};
					};
				};
			};
			case 7: {
				var ` = p[0];
				{
					var inner = `;
					{
						reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.collectPatternDecls(inner, declared);
					};
				};
			};
			default: {}
		};
	}

	static function collectLhsDecls(lhs:reflaxe.elixir.ast.ElixirAST, declared:Map<String, Bool>) {
		if (lhs == null || lhs.def == null) {
			return;
		};
		@:ast(switch (lhs.def) {
	case EVar(n):
		declared.set(n, true);	
	case EBinary(Match, l2, r2):
		collectLhsDecls(l2, declared);
		collectLhsDecls(r2, declared);	
	default:
}) {
			var ` = lhs.def;
			switch (enumIndex `) {
				case 26: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					if (enumIndex ` == 27) {
						{
							var l2 = `;
							var r2 = `;
							{
								reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.collectLhsDecls(l2, declared);
								reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.collectLhsDecls(r2, declared);
							};
						};
					} else {};
				};
				case 38: {
					var ` = `[0];
					{
						var n = `;
						{
							{
								declared.set(n, true);
							};
						};
					};
				};
				default: {}
			};
		};
	}

	static function isValidateCallReferencingCs(s:reflaxe.elixir.ast.ElixirAST) {
		return @:ast(switch (s.def) {
	case ECall(_, _, _):
		false;	
	case ERemoteCall(mod, func, args):
		var isChangeset = switch (mod.def) {
			case EVar(m) if (m == "Ecto.Changeset"):
				true;			
			default:
				false;			
		};
		var isValidate = (func != null && StringTools.startsWith(func, "validate_"));
		var csFirstArg = (args != null && args.length > 0) && switch (args[0].def) {
			case EVar(v) if (v == "cs"):
				true;			
			default:
				false;			
		};
		isChangeset && isValidate && csFirstArg;	
	case ERaw(code):
		if (code == null) false else {
			if (code.indexOf("Ecto.Changeset.validate_") != -1) {
				var idx = code.indexOf("Ecto.Changeset.validate_");
				if (idx >= 0) {
					var after = code.substr(idx);
					var p = after.indexOf("(");
					if (p > 0) {
						var rest = StringTools.trim(after.substr(p + 1));
						if (StringTools.startsWith(rest, "cs") || StringTools.startsWith(rest, "(cs")) return true;
					};
				};
			};
			false;
		};	
	default:
		false;	
}) {
			var ` = s.def;
			switch (enumIndex `) {
				case 22: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					{
						false;
					};
				};
				case 24: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					{
						var mod = `;
						var func = `;
						var args = `;
						{
							var isChangeset = @:ast(switch (mod.def) {
	case EVar(m) if (m == "Ecto.Changeset"):
		true;	
	default:
		false;	
}) {
								var ` = mod.def;
								if (enumIndex ` == 38) {
									var ` = `[0];
									{
										var m = `;
										if (m == "Ecto.Changeset") {
											true;
										} else {
											false;
										};
									};
								} else {
									false;
								};
							};
							var isValidate = (func != null && StringTools.startsWith(func, "validate_"));
							var csFirstArg = (args != null && args.length > 0) && @:ast(switch (args[0].def) {
	case EVar(v) if (v == "cs"):
		true;	
	default:
		false;	
}) {
								var ` = args[0].def;
								if (enumIndex ` == 38) {
									var ` = `[0];
									{
										var v = `;
										if (v == "cs") {
											true;
										} else {
											false;
										};
									};
								} else {
									false;
								};
							};
							isChangeset && isValidate && csFirstArg;
						};
					};
				};
				case 62: {
					var ` = `[0];
					{
						var code = `;
						{
							if (code == null) {
								false;
							} else {
								if (code.indexOf("Ecto.Changeset.validate_", null) != -1) {
									var idx = code.indexOf("Ecto.Changeset.validate_", null);
									if (idx >= 0) {
										var after = code.substr(idx, null);
										var p = after.indexOf("(", null);
										if (p > 0) {
											var rest = StringTools.trim(after.substr(p + 1, null));
											if (StringTools.startsWith(rest, "cs") || StringTools.startsWith(rest, "(cs")) {
												return true;
											};
										};
									};
								};
								false;
							};
						};
					};
				};
				default: {
					false;
				}
			};
		};
	}

	static function bindCsFrom(prev:reflaxe.elixir.ast.ElixirAST) {
		if (prev == null || prev.def == null) {
			return prev;
		};
		var rhs = null;
		@:ast(switch (prev.def) {
	case EBinary(Match, _, r):
		rhs = peelNestedAssignRhs(r);	
	case EMatch(_, r2):
		rhs = r2;	
	default:
		rhs = prev;	
}) {
			var ` = prev.def;
			switch (enumIndex `) {
				case 8: {
					var ` = `[0];
					var ` = `[1];
					{
						var r2 = `;
						{
							rhs = r2;
						};
					};
				};
				case 26: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					if (enumIndex ` == 27) {
						{
							var r = `;
							{
								rhs = reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.peelNestedAssignRhs(r);
							};
						};
					} else {
						rhs = prev;
					};
				};
				default: {
					rhs = prev;
				}
			};
		};
		return {def : reflaxe.elixir.ast.ElixirASTDef.EBinary(reflaxe.elixir.ast.EBinaryOp.Match, {
			var pos = null;
			{def : reflaxe.elixir.ast.ElixirASTDef.EVar("cs"), metadata : {}, pos : pos};
		}, rhs), metadata : prev.metadata, pos : prev.pos};
	}

	static function isNestedWildcardAssign(s:reflaxe.elixir.ast.ElixirAST) {
		if (s == null || s.def == null) {
			return false;
		};
		return @:ast(switch (s.def) {
	case EBinary(Match, left, _):
		lhsHasWildcard(left);	
	case EMatch(pat, _):
		patternHasWildcard(pat);	
	default:
		false;	
}) {
			var ` = s.def;
			switch (enumIndex `) {
				case 8: {
					var ` = `[0];
					var ` = `[1];
					{
						var pat = `;
						{
							reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.patternHasWildcard(pat);
						};
					};
				};
				case 26: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					if (enumIndex ` == 27) {
						{
							var left = `;
							{
								reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.lhsHasWildcard(left);
							};
						};
					} else {
						false;
					};
				};
				default: {
					false;
				}
			};
		};
	}

	static function lhsHasWildcard(lhs:reflaxe.elixir.ast.ElixirAST) {
		return @:ast(switch (lhs.def) {
	case EVar(v) if (v == "_" || (v != null && v.length > 1 && v.charAt(0) == "_")):
		true;	
	case EBinary(Match, l2, r2):
		lhsHasWildcard(l2) || lhsHasWildcard(r2);	
	default:
		false;	
}) {
			var ` = lhs.def;
			switch (enumIndex `) {
				case 26: {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					if (enumIndex ` == 27) {
						{
							var l2 = `;
							var r2 = `;
							{
								reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.lhsHasWildcard(l2) || reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.lhsHasWildcard(r2);
							};
						};
					} else {
						false;
					};
				};
				case 38: {
					var ` = `[0];
					{
						var v = `;
						if (v == "_" || (v != null && v.length > 1 && v.charAt(0) == "_")) {
							true;
						} else {
							false;
						};
					};
				};
				default: {
					false;
				}
			};
		};
	}

	static function patternHasWildcard(p:reflaxe.elixir.ast.EPattern) {
		return @:ast(switch (p) {
	case PVar(n) if (n == "_" || (n != null && n.length > 1 && n.charAt(0) == "_")):
		true;	
	case PTuple(es):
		var any = false;
		for (e  in  es) any = any || patternHasWildcard(e);
		any;	
	case PList(es):
		var any2 = false;
		for (e  in  es) any2 = any2 || patternHasWildcard(e);
		any2;	
	case PCons(h, t):
		patternHasWildcard(h) || patternHasWildcard(t);	
	default:
		false;	
}) switch (enumIndex p) {
			case 0: {
				var ` = p[0];
				{
					var n = `;
					if (n == "_" || (n != null && n.length > 1 && n.charAt(0) == "_")) {
						true;
					} else {
						false;
					};
				};
			};
			case 2: {
				var ` = p[0];
				{
					var es = `;
					{
						var any = false;
						{
							var ` = 0;
							while (` < es.length) {
								var e = es[`];
								++ `;
								any = any || reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.patternHasWildcard(e);
							};
						};
						any;
					};
				};
			};
			case 3: {
				var ` = p[0];
				{
					var es = `;
					{
						var any2 = false;
						{
							var ` = 0;
							while (` < es.length) {
								var e = es[`];
								++ `;
								any2 = any2 || reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.patternHasWildcard(e);
							};
						};
						any2;
					};
				};
			};
			case 4: {
				var ` = p[0];
				var ` = p[1];
				{
					var h = `;
					var t = `;
					{
						reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.patternHasWildcard(h) || reflaxe.elixir.ast.transformers.IntroduceChangesetBinderTransforms.patternHasWildcard(t);
					};
				};
			};
			default: {
				false;
			}
		};
	}

	static function peelNestedAssignRhs(n:reflaxe.elixir.ast.ElixirAST) {
		var cur = n;
		while (cur != null && cur.def != null) {
			@:ast(switch (cur.def) {
	case EBinary(Match, left, inner):
		var isUnderscore = switch (left.def) {
			case EVar(v) if (v == "_" || (v != null && v.length > 1 && v.charAt(0) == "_")):
				true;			
			default:
				false;			
		};
		if (isUnderscore) cur = inner else return cur;	
	case EMatch(PVar(p), inner2):
		var isUnderscorePat = (p == "_" || (p != null && p.length > 1 && p.charAt(0) == "_"));
		if (isUnderscorePat) cur = inner2 else return cur;	
	default:
		return cur;	
}) {
				var ` = cur.def;
				switch (enumIndex `) {
					case 8: {
						var ` = `[0];
						var ` = `[1];
						if (enumIndex ` == 0) {
							var ` = `[0];
							{
								var p = `;
								var inner2 = `;
								{
									var isUnderscorePat = (p == "_" || (p != null && p.length > 1 && p.charAt(0) == "_"));
									if (isUnderscorePat) {
										cur = inner2;
									} else {
										return cur;
									};
								};
							};
						} else {
							return cur;
						};
					};
					case 26: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						if (enumIndex ` == 27) {
							{
								var left = `;
								var inner = `;
								{
									var isUnderscore = @:ast(switch (left.def) {
	case EVar(v) if (v == "_" || (v != null && v.length > 1 && v.charAt(0) == "_")):
		true;	
	default:
		false;	
}) {
										var ` = left.def;
										if (enumIndex ` == 38) {
											var ` = `[0];
											{
												var v = `;
												if (v == "_" || (v != null && v.length > 1 && v.charAt(0) == "_")) {
													true;
												} else {
													false;
												};
											};
										} else {
											false;
										};
									};
									if (isUnderscore) {
										cur = inner;
									} else {
										return cur;
									};
								};
							};
						} else {
							return cur;
						};
					};
					default: {
						return cur;
					}
				};
			};
		};
		return if (cur == null) {
			n;
		} else {
			cur;
		};
	}
}