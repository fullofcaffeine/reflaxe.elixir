class reflaxe.elixir.ast.transformers.HeexAttributeExprNormalizeTransforms {

	public static function transformPass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.transformers.HeexAttributeExprNormalizeTransforms.normalize(ast, null);
	}

	public static function contextualPass(ast:reflaxe.elixir.ast.ElixirAST, ctx:reflaxe.elixir.CompilationContext) {
		return reflaxe.elixir.ast.transformers.HeexAttributeExprNormalizeTransforms.normalize(ast, ctx);
	}

	static function normalize(ast:reflaxe.elixir.ast.ElixirAST, ctx:Null<reflaxe.elixir.CompilationContext>) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case ESigil(type, content, modifiers) if (type == "H"):
		var updated = rewriteHeexAttributes(content);
		if (updated != content) makeASTWithMeta(ESigil(type, updated, modifiers), n.metadata, n.pos) else n;	
	default:
		n;	
}) {
				var ` = n.def;
				if (enumIndex ` == 61) {
					var ` = `[0];
					var ` = `[1];
					var ` = `[2];
					{
						var type = `;
						var content = `;
						var modifiers = `;
						if (type == "H") {
							var updated = reflaxe.elixir.ast.transformers.HeexAttributeExprNormalizeTransforms.rewriteHeexAttributes(content);
							if (updated != content) {
								{def : reflaxe.elixir.ast.ElixirASTDef.ESigil(type, updated, modifiers), metadata : n.metadata, pos : n.pos};
							} else {
								n;
							};
						} else {
							n;
						};
					};
				} else {
					n;
				};
			};
		});
	}

	static function rewriteHeexAttributes(s:String) {
		var out = new StringBuf();
		var i = 0;
		while (i < s.length) {
			var j = s.indexOf("<%", i);
			if (j == -1) {
				out.add(s.substr(i, null));
				break;
			};
			var k = j - 1;
			var seenGt = false;
			while (k >= i) {
				var ch = s.charAt(k);
				if (ch == ">") {
					seenGt = true;
					break;
				};
				if (ch == "=") {
					break;
				};
				k --;
			};
			if (k < i || seenGt || s.charAt(k) != "=") {
				out.add(s.substr(i, j - i));
				out.add("<%");
				i = j + 2;
				continue;
			};
			out.add(s.substr(i, (k - i) + 1));
			var vpos = k + 1;
			while (vpos < s.length && new EReg("^\\s$", "").match(s.charAt(vpos))) {
				vpos ++;
			};
			var quote = null;
			if (vpos < s.length && (s.charAt(vpos) == "\"" || s.charAt(vpos) == "'")) {
				quote = s.charAt(vpos);
				vpos ++;
			};
			if (vpos != j) {
				out.add(s.substr(k + 1, j - (k + 1)));
				out.add("<%");
				i = j + 2;
				continue;
			};
			if (j + 3 <= s.length && s.charAt(j + 2) == "=") {
				var end = s.indexOf("%>", j + 3);
				if (end == -1) {
					out.add(s.substr(i, null));
					break;
				};
				var expr = StringTools.trim(s.substr(j + 3, end - (j + 3)));
				if (StringTools.startsWith(expr, "if ") && StringTools.endsWith(expr, " do")) {
					var condStr = StringTools.trim(expr.substr(3, expr.length - 3 - 3));
					var thenStartPos = end + 2;
					var elseMarkerPos = s.indexOf("<% else %>", thenStartPos);
					var endMarkerPos = s.indexOf("<% end %>", thenStartPos);
					if (endMarkerPos == -1) {
						out.add(s.substr(i, null));
						break;
					};
					var thenEndPos = if ((elseMarkerPos != -1 && elseMarkerPos < endMarkerPos)) {
						elseMarkerPos;
					} else {
						endMarkerPos;
					};
					var thenContent = StringTools.trim(s.substr(thenStartPos, thenEndPos - thenStartPos));
					var elseContent = if ((elseMarkerPos != -1 && elseMarkerPos < endMarkerPos)) {
						StringTools.trim(s.substr(elseMarkerPos + 10, endMarkerPos - (elseMarkerPos + 10)));
					} else {
						null;
					};
					if (! ((StringTools.startsWith(thenContent, "\"") && StringTools.endsWith(thenContent, "\"")) || (StringTools.startsWith(thenContent, "'") && StringTools.endsWith(thenContent, "'")))) {
						thenContent = {
							var t = StringTools.replace(thenContent, "\"", "\\\"");
							"\"" + t + "\"";
						};
					};
					if (elseContent != null && ! ((StringTools.startsWith(elseContent, "\"") && StringTools.endsWith(elseContent, "\"")) || (StringTools.startsWith(elseContent, "'") && StringTools.endsWith(elseContent, "'")))) {
						elseContent = {
							var t = StringTools.replace(elseContent, "\"", "\\\"");
							"\"" + t + "\"";
						};
					};
					out.add("{");
					out.add("if " + condStr + ", do: " + thenContent + (if (elseContent != null) {
						", else: " + elseContent;
					} else {
						"";
					}));
					out.add("}");
					var postEndPos = endMarkerPos + 9;
					if (quote != null && postEndPos < s.length && s.charAt(postEndPos) == quote) {
						postEndPos ++;
					};
					i = postEndPos;
					continue;
				} else {
					var rx = new EReg("^inspect\\((.*)\\)$", "");
					if (rx.match(expr)) {
						expr = StringTools.trim(rx.matched(1));
					};
					out.add("{");
					out.add(expr);
					out.add("}");
					var p = end + 2;
					if (quote != null && p < s.length && s.charAt(p) == quote) {
						p ++;
					};
					i = p;
					continue;
				};
			};
			var ifStart = s.indexOf("if", j + 2);
			var doPos = s.indexOf("do %>", j + 2);
			if (ifStart != -1 && doPos != -1 && ifStart < doPos) {
				var condStr = StringTools.trim(s.substr(ifStart + 2, (doPos) - (ifStart + 2)));
				var thenStart = doPos + 5;
				var elseOpen = s.indexOf("<% else %>", thenStart);
				var endOpen = s.indexOf("<% end %>", thenStart);
				if (endOpen == -1) {
					out.add(s.substr(i, null));
					break;
				};
				var thenEnd = if ((elseOpen != -1 && elseOpen < endOpen)) {
					elseOpen;
				} else {
					endOpen;
				};
				var thenHtml = StringTools.trim(s.substr(thenStart, thenEnd - thenStart));
				var elseHtml = if ((elseOpen != -1 && elseOpen < endOpen)) {
					StringTools.trim(s.substr(elseOpen + 10, endOpen - (elseOpen + 10)));
				} else {
					null;
				};
				if (! ((StringTools.startsWith(thenHtml, "\"") && StringTools.endsWith(thenHtml, "\"")) || (StringTools.startsWith(thenHtml, "'") && StringTools.endsWith(thenHtml, "'")))) {
					thenHtml = {
						var t = StringTools.replace(thenHtml, "\"", "\\\"");
						"\"" + t + "\"";
					};
				};
				if (elseHtml != null && ! ((StringTools.startsWith(elseHtml, "\"") && StringTools.endsWith(elseHtml, "\"")) || (StringTools.startsWith(elseHtml, "'") && StringTools.endsWith(elseHtml, "'")))) {
					elseHtml = {
						var t = StringTools.replace(elseHtml, "\"", "\\\"");
						"\"" + t + "\"";
					};
				};
				out.add("{");
				out.add("if " + condStr + ", do: " + thenHtml + (if (elseHtml != null) {
					", else: " + elseHtml;
				} else {
					"";
				}));
				out.add("}");
				var p2 = endOpen + 9;
				if (quote != null && p2 < s.length && s.charAt(p2) == quote) {
					p2 ++;
				};
				i = p2;
				continue;
			};
			out.add(s.substr(k + 1, j - (k + 1)));
			out.add("<%");
			i = j + 2;
		};
		return out.toString();
	}

	static inline function isQuoted(s:String) {
		return ((StringTools.startsWith(s, "\"") && StringTools.endsWith(s, "\"")) || (StringTools.startsWith(s, "'") && StringTools.endsWith(s, "'")));
	}

	static inline function quoteWrap(s:String) {
		var t = StringTools.replace(s, "\"", "\\\"");
		return "\"" + t + "\"";
	}
}