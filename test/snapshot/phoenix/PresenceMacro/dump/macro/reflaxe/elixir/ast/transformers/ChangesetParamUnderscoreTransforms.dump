class reflaxe.elixir.ast.transformers.ChangesetParamUnderscoreTransforms {

	public static function pass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EDef(name, args, guards, body) if (name == "changeset"):
		var newArgs = underscoreUnused(args, body);
		makeASTWithMeta(EDef(name, newArgs, guards, body), n.metadata, n.pos);	
	case EDefp(functionName, functionArgs, functionGuards, functionBody) if (functionName == "changeset"):
		var newArgs = underscoreUnused(functionArgs, functionBody);
		makeASTWithMeta(EDefp(functionName, newArgs, functionGuards, functionBody), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 2: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var name = `;
							var args = `;
							var guards = `;
							var body = `;
							if (name == "changeset") {
								var newArgs = reflaxe.elixir.ast.transformers.ChangesetParamUnderscoreTransforms.underscoreUnused(args, body);
								{def : reflaxe.elixir.ast.ElixirASTDef.EDef(name, newArgs, guards, body), metadata : n.metadata, pos : n.pos};
							} else {
								n;
							};
						};
					};
					case 3: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						var ` = `[3];
						{
							var functionName = `;
							var functionArgs = `;
							var functionGuards = `;
							var functionBody = `;
							if (functionName == "changeset") {
								var newArgs = reflaxe.elixir.ast.transformers.ChangesetParamUnderscoreTransforms.underscoreUnused(functionArgs, functionBody);
								{def : reflaxe.elixir.ast.ElixirASTDef.EDefp(functionName, newArgs, functionGuards, functionBody), metadata : n.metadata, pos : n.pos};
							} else {
								n;
							};
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}

	static function underscoreUnused(args:Array<reflaxe.elixir.ast.EPattern>, body:reflaxe.elixir.ast.ElixirAST) {
		if (args == null) {
			return args;
		};
		if (reflaxe.elixir.ast.transformers.ChangesetParamUnderscoreTransforms.bodyHasChangesetOps(body)) {
			return args;
		};
		return {
			var ` = [];
			{
				var ` = 0;
				while (` < args.length) {
					var a = args[`];
					++ `;
					`.push(@:ast(switch (a) {
	case PVar(nm) if (nm != null && nm.length > 0 && nm.charAt(0) != "_"):
		var used = VariableUsageCollector.usedInFunctionScope(body, nm) || usedInChangesetCalls(body, nm) || usedInRawTokens(body, nm);
		used ? a : PVar("_" + nm);	
	default:
		a;	
}) if (enumIndex a == 0) {
						var ` = a[0];
						{
							var nm = `;
							if (nm != null && nm.length > 0 && nm.charAt(0) != "_") {
								var used = reflaxe.elixir.ast.analyzers.VariableUsageCollector.usedInFunctionScope(body, nm) || reflaxe.elixir.ast.transformers.ChangesetParamUnderscoreTransforms.usedInChangesetCalls(body, nm) || reflaxe.elixir.ast.transformers.ChangesetParamUnderscoreTransforms.usedInRawTokens(body, nm);
								if (used) {
									a;
								} else {
									reflaxe.elixir.ast.EPattern.PVar("_" + nm);
								};
							} else {
								a;
							};
						};
					} else {
						a;
					});
				};
			};
			`;
		};
	}

	static function usedInChangesetCalls(body:reflaxe.elixir.ast.ElixirAST, name:String) {
		var found = [false];
		var walk = [null];
		walk[0] = function(n:reflaxe.elixir.ast.ElixirAST) {
			if (n == null || n.def == null || found[0]) {
				return;
			};
			@:ast(switch (n.def) {
	case ERemoteCall(mod, fn, args) if (fn == "change" || fn == "cast"):
		switch (mod.def) {
			case EVar(m) if (m == "Ecto.Changeset"):
				if (args != null) for (a  in  args) switch (a.def) {
					case EVar(v) if (v == name):
						found = true;					
					default:
				};			
			default:
		};
		if (!found && args != null) for (a  in  args) walk(a);	
	case EBlock(es):
		for (e  in  es) walk(e);	
	case EIf(c, t, e):
		walk(c);
		walk(t);
		if (e != null) walk(e);	
	case ECase(e, cs):
		walk(e);
		for (c  in  cs) {
			if (c.guard != null) walk(c.guard);
			walk(c.body);
		};	
	case ECall(t, _, as):
		if (t != null) walk(t);
		if (as != null) for (a  in  as) walk(a);	
	case ERemoteCall(m2, _, as2):
		walk(m2);
		if (as2 != null) for (a  in  as2) walk(a);	
	default:
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 6: {
						var ` = `[0];
						var ` = `[1];
						{
							var e = `;
							var cs = `;
							{
								walk[0](e);
								{
									var ` = 0;
									while (` < cs.length) {
										var c = cs[`];
										++ `;
										if (c.guard != null) {
											walk[0](c.guard);
										};
										walk[0](c.body);
									};
								};
							};
						};
					};
					case 10: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var c = `;
							var t = `;
							var e = `;
							{
								walk[0](c);
								walk[0](t);
								if (e != null) {
									walk[0](e);
								};
							};
						};
					};
					case 22: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var t = `;
							var as = `;
							{
								if (t != null) {
									walk[0](t);
								};
								if (as != null) {
									{
										var ` = 0;
										while (` < as.length) {
											var a = as[`];
											++ `;
											walk[0](a);
										};
									};
								};
							};
						};
					};
					case 24: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var mod = `;
							var fn = `;
							var args = `;
							if (fn == "change" || fn == "cast") {
								@:ast(switch (mod.def) {
	case EVar(m) if (m == "Ecto.Changeset"):
		if (args != null) for (a  in  args) switch (a.def) {
			case EVar(v) if (v == name):
				found = true;			
			default:
		};	
	default:
}) {
									var ` = mod.def;
									if (enumIndex ` == 38) {
										var ` = `[0];
										{
											var m = `;
											if (m == "Ecto.Changeset") {
												if (args != null) {
													{
														var ` = 0;
														while (` < args.length) {
															var a = args[`];
															++ `;
															@:ast(switch (a.def) {
	case EVar(v) if (v == name):
		found = true;	
	default:
}) {
																var ` = a.def;
																if (enumIndex ` == 38) {
																	var ` = `[0];
																	{
																		var v = `;
																		if (v == name) {
																			found[0] = true;
																		} else {};
																	};
																} else {};
															};
														};
													};
												};
											} else {};
										};
									} else {};
								};
								if (! found[0] && args != null) {
									{
										var ` = 0;
										while (` < args.length) {
											var a = args[`];
											++ `;
											walk[0](a);
										};
									};
								};
							} else {
								var m2 = `;
								var as2 = `;
								{
									walk[0](m2);
									if (as2 != null) {
										{
											var ` = 0;
											while (` < as2.length) {
												var a = as2[`];
												++ `;
												walk[0](a);
											};
										};
									};
								};
							};
						};
					};
					case 53: {
						var ` = `[0];
						{
							var es = `;
							{
								{
									var ` = 0;
									while (` < es.length) {
										var e = es[`];
										++ `;
										walk[0](e);
									};
								};
							};
						};
					};
					default: {}
				};
			};
		};
		walk[0](body);
		return found[0];
	}

	static function usedInRawTokens(body:reflaxe.elixir.ast.ElixirAST, name:String) {
		var found = [false];
		{};
		var walk = [null];
		walk[0] = function(n:reflaxe.elixir.ast.ElixirAST) {
			if (n == null || n.def == null || found[0]) {
				return;
			};
			@:ast(switch (n.def) {
	case ERaw(code):
		if (code != null) {
			var idx = 0;
			while (!found) {
				var i = code.indexOf(name, idx);
				if (i == -1) break;
				var before = i > 0 ? code.substr(i - 1, 1) : null;
				var afterIdx = i + name.length;
				var after = afterIdx < code.length ? code.substr(afterIdx, 1) : null;
				if (!isIdentChar(before) && !isIdentChar(after)) {
					found = true;
					break;
				};
				idx = i + name.length;
			};
		};	
	case EBlock(es):
		for (e  in  es) walk(e);	
	case EIf(c, t, e):
		walk(c);
		walk(t);
		if (e != null) walk(e);	
	case ECase(ex, cs):
		walk(ex);
		for (c  in  cs) {
			if (c.guard != null) walk(c.guard);
			walk(c.body);
		};	
	case ECall(t, _, as):
		if (t != null) walk(t);
		if (as != null) for (a  in  as) walk(a);	
	case ERemoteCall(m, _, as):
		walk(m);
		if (as != null) for (a  in  as) walk(a);	
	default:
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 6: {
						var ` = `[0];
						var ` = `[1];
						{
							var ex = `;
							var cs = `;
							{
								walk[0](ex);
								{
									var ` = 0;
									while (` < cs.length) {
										var c = cs[`];
										++ `;
										if (c.guard != null) {
											walk[0](c.guard);
										};
										walk[0](c.body);
									};
								};
							};
						};
					};
					case 10: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var c = `;
							var t = `;
							var e = `;
							{
								walk[0](c);
								walk[0](t);
								if (e != null) {
									walk[0](e);
								};
							};
						};
					};
					case 22: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var t = `;
							var as = `;
							{
								if (t != null) {
									walk[0](t);
								};
								if (as != null) {
									{
										var ` = 0;
										while (` < as.length) {
											var a = as[`];
											++ `;
											walk[0](a);
										};
									};
								};
							};
						};
					};
					case 24: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var m = `;
							var as = `;
							{
								walk[0](m);
								if (as != null) {
									{
										var ` = 0;
										while (` < as.length) {
											var a = as[`];
											++ `;
											walk[0](a);
										};
									};
								};
							};
						};
					};
					case 53: {
						var ` = `[0];
						{
							var es = `;
							{
								{
									var ` = 0;
									while (` < es.length) {
										var e = es[`];
										++ `;
										walk[0](e);
									};
								};
							};
						};
					};
					case 62: {
						var ` = `[0];
						{
							var code = `;
							{
								if (code != null) {
									var idx = 0;
									while (! found[0]) {
										var i = code.indexOf(name, idx);
										if (i == -1) {
											break;
										};
										var before = if (i > 0) {
											code.substr(i - 1, 1);
										} else {
											null;
										};
										var afterIdx = i + name.length;
										var after = if (afterIdx < code.length) {
											code.substr(afterIdx, 1);
										} else {
											null;
										};
										if (! if (before == null || before.length == 0) {
											false;
										} else {
											var ch = before.charCodeAt(0);
											(ch >= 48 && ch <= 57) || (ch >= 65 && ch <= 90) || (ch >= 97 && ch <= 122) || before == "_" || before == ".";
										} && ! if (after == null || after.length == 0) {
											false;
										} else {
											var ch = after.charCodeAt(0);
											(ch >= 48 && ch <= 57) || (ch >= 65 && ch <= 90) || (ch >= 97 && ch <= 122) || after == "_" || after == ".";
										}) {
											found[0] = true;
											break;
										};
										idx = i + name.length;
									};
								};
							};
						};
					};
					default: {}
				};
			};
		};
		walk[0](body);
		return found[0];
	}

	static function bodyHasChangesetOps(body:reflaxe.elixir.ast.ElixirAST) {
		var found = [false];
		var walk = [null];
		walk[0] = function(n:reflaxe.elixir.ast.ElixirAST) {
			if (n == null || n.def == null || found[0]) {
				return;
			};
			@:ast(switch (n.def) {
	case ERemoteCall(mod, _, _):
		switch (mod.def) {
			case EVar(m) if (m == "Ecto.Changeset"):
				found = true;			
			default:
		};	
	case ERaw(code):
		if (code != null && code.indexOf("Ecto.Changeset.") != -1) found = true;	
	case EBlock(es):
		for (e  in  es) walk(e);	
	case EIf(c, t, e):
		walk(c);
		walk(t);
		if (e != null) walk(e);	
	case ECase(ex, cs):
		walk(ex);
		for (c  in  cs) {
			if (c.guard != null) walk(c.guard);
			walk(c.body);
		};	
	case ECall(t, _, as):
		if (t != null) walk(t);
		if (as != null) for (a  in  as) walk(a);	
	case ERemoteCall(m2, _, as2):
		walk(m2);
		if (as2 != null) for (a  in  as2) walk(a);	
	default:
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 6: {
						var ` = `[0];
						var ` = `[1];
						{
							var ex = `;
							var cs = `;
							{
								walk[0](ex);
								{
									var ` = 0;
									while (` < cs.length) {
										var c = cs[`];
										++ `;
										if (c.guard != null) {
											walk[0](c.guard);
										};
										walk[0](c.body);
									};
								};
							};
						};
					};
					case 10: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var c = `;
							var t = `;
							var e = `;
							{
								walk[0](c);
								walk[0](t);
								if (e != null) {
									walk[0](e);
								};
							};
						};
					};
					case 22: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var t = `;
							var as = `;
							{
								if (t != null) {
									walk[0](t);
								};
								if (as != null) {
									{
										var ` = 0;
										while (` < as.length) {
											var a = as[`];
											++ `;
											walk[0](a);
										};
									};
								};
							};
						};
					};
					case 24: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var mod = `;
							{
								@:ast(switch (mod.def) {
	case EVar(m) if (m == "Ecto.Changeset"):
		found = true;	
	default:
}) {
									var ` = mod.def;
									if (enumIndex ` == 38) {
										var ` = `[0];
										{
											var m = `;
											if (m == "Ecto.Changeset") {
												found[0] = true;
											} else {};
										};
									} else {};
								};
							};
						};
					};
					case 53: {
						var ` = `[0];
						{
							var es = `;
							{
								{
									var ` = 0;
									while (` < es.length) {
										var e = es[`];
										++ `;
										walk[0](e);
									};
								};
							};
						};
					};
					case 62: {
						var ` = `[0];
						{
							var code = `;
							{
								if (code != null && code.indexOf("Ecto.Changeset.", null) != -1) {
									found[0] = true;
								};
							};
						};
					};
					default: {}
				};
			};
		};
		walk[0](body);
		return found[0];
	}
}