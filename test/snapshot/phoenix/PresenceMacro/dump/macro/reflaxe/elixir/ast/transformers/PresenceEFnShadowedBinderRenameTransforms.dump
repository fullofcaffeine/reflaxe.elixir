class reflaxe.elixir.ast.transformers.PresenceEFnShadowedBinderRenameTransforms {

	public static function pass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EModule(name, attrs, body) if (looksLikePresence(name)):
		makeASTWithMeta(EModule(name, attrs, [for (b  in  body) renameInNode(b)]), n.metadata, n.pos);	
	case EDefmodule(name2, doBlock) if (looksLikePresence(name2)):
		makeASTWithMeta(EDefmodule(name2, renameInNode(doBlock)), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 0: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var name = `;
							var attrs = `;
							var body = `;
							if (name != null && (StringTools.endsWith(name, ".Presence") || name.indexOf("Web.Presence", null) >= 0)) {
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EModule(name, attrs, {
										var ` = [];
										{
											var ` = 0;
											while ((` < body.length)) {
												var b = body[`];
												++ `;
												`.push(reflaxe.elixir.ast.transformers.PresenceEFnShadowedBinderRenameTransforms.renameInNode(b));
											};
										};
										`;
									});
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							} else {
								n;
							};
						};
					};
					case 1: {
						var ` = `[0];
						var ` = `[1];
						{
							var name2 = `;
							var doBlock = `;
							if (name2 != null && (StringTools.endsWith(name2, ".Presence") || name2.indexOf("Web.Presence", null) >= 0)) {
								{
									var def = reflaxe.elixir.ast.ElixirASTDef.EDefmodule(name2, reflaxe.elixir.ast.transformers.PresenceEFnShadowedBinderRenameTransforms.renameInNode(doBlock));
									var meta = n.metadata;
									var pos = n.pos;
									{def : def, metadata : meta, pos : pos};
								};
							} else {
								n;
							};
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}

	static inline function looksLikePresence(name:String) {
		return name != null && (StringTools.endsWith(name, ".Presence") || name.indexOf("Web.Presence", null) >= 0);
	}

	static function renameInNode(node:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(node, function(x:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (x.def) {
	case EFn(clauses):
		var out = [];
		for (cl  in  clauses) {
			var newArgs = cl.args;
			var needRename = false;
			var binder:Null<String> = null;
			if (cl.args != null && cl.args.length > 0) switch (cl.args[0]) {
				case PVar(nm):
					binder = nm;				
				default:
			};
			if (binder != null) {
				var assigned = false;
				ElixirASTTransformer.transformNode(cl.body, function(t:ElixirAST):ElixirAST {
					switch (t.def) {
						case EBinary(Match, left, _):
							switch (left.def) {
								case EVar(v) if (v == binder):
									assigned = true;								
								default:
							};						
						default:
					};
					return t;
				});
				needRename = assigned;
			};
			if (needRename && binder != null) {
				var target = chooseTargetName(cl.body, "entry");
				var newFirst = PVar(target);
				newArgs = cl.args.copy();
				newArgs[0] = newFirst;
				var newBody = ElixirASTTransformer.transformNode(cl.body, function(t2:ElixirAST):ElixirAST {
					return switch (t2.def) {
						case EVar(v2) if (v2 == binder):
							makeASTWithMeta(EVar(target), t2.metadata, t2.pos);						
						default:
							t2;						
					};
				});
				out.push({ args : newArgs, guard : cl.guard, body : newBody });
			} else {
				out.push(cl);
			};
		};
		makeASTWithMeta(EFn(out), x.metadata, x.pos);	
	default:
		x;	
}) {
				var ` = x.def;
				if (enumIndex ` == 42) {
					var ` = `[0];
					{
						var clauses = `;
						{
							var out = [];
							{
								var ` = 0;
								while (` < clauses.length) {
									var cl = clauses[`];
									++ `;
									var newArgs = cl.args;
									var needRename = false;
									var binder = [null];
									if (cl.args != null && cl.args.length > 0) {
										@:ast(switch (cl.args[0]) {
	case PVar(nm):
		binder = nm;	
	default:
}) {
											var ` = cl.args[0];
											if (enumIndex ` == 0) {
												var ` = `[0];
												{
													var nm = `;
													{
														binder[0] = nm;
													};
												};
											} else {};
										};
									};
									if (binder[0] != null) {
										var assigned = [false];
										reflaxe.elixir.ast.ElixirASTTransformer.transformNode(cl.body, function(t:reflaxe.elixir.ast.ElixirAST) {
											@:ast(switch (t.def) {
	case EBinary(Match, left, _):
		switch (left.def) {
			case EVar(v) if (v == binder):
				assigned = true;			
			default:
		};	
	default:
}) {
												var ` = t.def;
												if (enumIndex ` == 26) {
													var ` = `[0];
													var ` = `[1];
													var ` = `[2];
													if (enumIndex ` == 27) {
														{
															var left = `;
															{
																@:ast(switch (left.def) {
	case EVar(v) if (v == binder):
		assigned = true;	
	default:
}) {
																	var ` = left.def;
																	if (enumIndex ` == 38) {
																		var ` = `[0];
																		{
																			var v = `;
																			if (v == binder[0]) {
																				assigned[0] = true;
																			} else {};
																		};
																	} else {};
																};
															};
														};
													} else {};
												} else {};
											};
											return t;
										});
										needRename = assigned[0];
									};
									if (needRename && binder[0] != null) {
										var target = reflaxe.elixir.ast.transformers.PresenceEFnShadowedBinderRenameTransforms.chooseTargetName(cl.body, "entry");
										var newFirst = reflaxe.elixir.ast.EPattern.PVar(target);
										newArgs = cl.args.copy();
										newArgs[0] = newFirst;
										var newBody = reflaxe.elixir.ast.ElixirASTTransformer.transformNode(cl.body, function(t2:reflaxe.elixir.ast.ElixirAST) {
											return @:ast(switch (t2.def) {
	case EVar(v2) if (v2 == binder):
		makeASTWithMeta(EVar(target), t2.metadata, t2.pos);	
	default:
		t2;	
}) {
												var ` = t2.def;
												if (enumIndex ` == 38) {
													var ` = `[0];
													{
														var v2 = `;
														if (v2 == binder[0]) {
															{def : reflaxe.elixir.ast.ElixirASTDef.EVar(target), metadata : t2.metadata, pos : t2.pos};
														} else {
															t2;
														};
													};
												} else {
													t2;
												};
											};
										});
										out.push({args : newArgs, guard : cl.guard, body : newBody});
									} else {
										out.push(cl);
									};
								};
							};
							{def : reflaxe.elixir.ast.ElixirASTDef.EFn(out), metadata : x.metadata, pos : x.pos};
						};
					};
				} else {
					x;
				};
			};
		});
	}

	static function chooseTargetName(body:reflaxe.elixir.ast.ElixirAST, base:String) {
		var target = base;
		var idx = 2;
		while (reflaxe.elixir.ast.transformers.PresenceEFnShadowedBinderRenameTransforms.nameExists(body, target)) {
			target = base + idx;
			idx ++;
		};
		return target;
	}

	static function nameExists(body:reflaxe.elixir.ast.ElixirAST, name:String) {
		var found = [false];
		reflaxe.elixir.ast.ElixirASTTransformer.transformNode(body, function(n:reflaxe.elixir.ast.ElixirAST) {
			@:ast(switch (n.def) {
	case EVar(v) if (v == name):
		found = true;	
	default:
}) {
				var ` = n.def;
				if (enumIndex ` == 38) {
					var ` = `[0];
					{
						var v = `;
						if (v == name) {
							found[0] = true;
						} else {};
					};
				} else {};
			};
			return n;
		});
		return found[0];
	}
}