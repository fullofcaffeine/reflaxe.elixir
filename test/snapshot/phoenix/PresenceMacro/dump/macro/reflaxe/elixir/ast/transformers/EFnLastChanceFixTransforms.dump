class reflaxe.elixir.ast.transformers.EFnLastChanceFixTransforms {

	public static function pass(ast:reflaxe.elixir.ast.ElixirAST) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(ast, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EFn(clauses):
		var newClauses = [];
		for (cl  in  clauses) {
			var binderOrig:Null<String> = null;
			if (cl.args != null && cl.args.length == 1) switch (cl.args[0]) {
				case PVar(name):
					binderOrig = name;				
				default:
			};
			if (binderOrig == null) {
				newClauses.push(cl);
				continue;
			};
			var binderBase = (binderOrig.length > 1 && binderOrig.charAt(0) == "_") ? binderOrig.substr(1) : binderOrig;
			var outArg:EPattern = PVar(binderBase);
			var b = binderBase;
			var newBody = renameVarInNode(cl.body, "_" + b, b);
			var used = collectUsedVars(newBody);
			used.remove(b);
			used.remove("_" + b);
			var unders:Array<String> = [];
			for (k  in  used.keys()) if (k != null && k.length > 1 && k.charAt(0) == "_" && looksLikeVar(k.substr(1))) unders.push(k);
			if (unders.length == 1) {
				var uv = unders[0];
				newBody = renameVarInNode(newBody, uv, b);
				used = collectUsedVars(newBody);
				used.remove(b);
				used.remove("_" + b);
			};
			var victims:Array<String> = [];
			for (k  in  used.keys()) if (looksLikeVar(k)) victims.push(k);
			var recvVictims = [];
			for (v  in  victims) if (varUsedAsFieldReceiver(newBody, v)) recvVictims.push(v);
			if (recvVictims.length == 1) {
				var victim = recvVictims[0];
				newBody = renameVarInNode(newBody, victim, b);
			} else if (victims.length == 1) {
				var victim2 = victims[0];
				newBody = renameVarInNode(newBody, victim2, b);
			};
			newClauses.push({ args : [outArg], guard : cl.guard, body : newBody });
		};
		makeASTWithMeta(EFn(newClauses), n.metadata, n.pos);	
	default:
		n;	
}) {
				var ` = n.def;
				if (enumIndex ` == 42) {
					var ` = `[0];
					{
						var clauses = `;
						{
							var newClauses = [];
							{
								var ` = 0;
								while (` < clauses.length) {
									var cl = clauses[`];
									++ `;
									var binderOrig = null;
									if (cl.args != null && cl.args.length == 1) {
										@:ast(switch (cl.args[0]) {
	case PVar(name):
		binderOrig = name;	
	default:
}) {
											var ` = cl.args[0];
											if (enumIndex ` == 0) {
												var ` = `[0];
												{
													var name = `;
													{
														binderOrig = name;
													};
												};
											} else {};
										};
									};
									if (binderOrig == null) {
										newClauses.push(cl);
										continue;
									};
									var binderBase = if ((binderOrig.length > 1 && binderOrig.charAt(0) == "_")) {
										binderOrig.substr(1, null);
									} else {
										binderOrig;
									};
									var outArg = reflaxe.elixir.ast.EPattern.PVar(binderBase);
									var b = binderBase;
									var newBody = reflaxe.elixir.ast.transformers.EFnLastChanceFixTransforms.renameVarInNode(cl.body, "_" + b, b);
									var used = reflaxe.elixir.ast.transformers.EFnLastChanceFixTransforms.collectUsedVars(newBody);
									used.remove(b);
									used.remove("_" + b);
									var unders = [];
									for (k in used.keys()) {
										if (k != null && k.length > 1 && k.charAt(0) == "_" && reflaxe.elixir.ast.transformers.EFnLastChanceFixTransforms.looksLikeVar(k.substr(1, null))) {
											unders.push(k);
										};
									};
									if (unders.length == 1) {
										var uv = unders[0];
										newBody = reflaxe.elixir.ast.transformers.EFnLastChanceFixTransforms.renameVarInNode(newBody, uv, b);
										used = reflaxe.elixir.ast.transformers.EFnLastChanceFixTransforms.collectUsedVars(newBody);
										used.remove(b);
										used.remove("_" + b);
									};
									var victims = [];
									for (k in used.keys()) {
										if (reflaxe.elixir.ast.transformers.EFnLastChanceFixTransforms.looksLikeVar(k)) {
											victims.push(k);
										};
									};
									var recvVictims = [];
									{
										var ` = 0;
										while (` < victims.length) {
											var v = victims[`];
											++ `;
											if (reflaxe.elixir.ast.transformers.EFnLastChanceFixTransforms.varUsedAsFieldReceiver(newBody, v)) {
												recvVictims.push(v);
											};
										};
									};
									if (recvVictims.length == 1) {
										var victim = recvVictims[0];
										newBody = reflaxe.elixir.ast.transformers.EFnLastChanceFixTransforms.renameVarInNode(newBody, victim, b);
									} else {
										if (victims.length == 1) {
											var victim2 = victims[0];
											newBody = reflaxe.elixir.ast.transformers.EFnLastChanceFixTransforms.renameVarInNode(newBody, victim2, b);
										};
									};
									newClauses.push({args : [outArg], guard : cl.guard, body : newBody});
								};
							};
							{def : reflaxe.elixir.ast.ElixirASTDef.EFn(newClauses), metadata : n.metadata, pos : n.pos};
						};
					};
				} else {
					n;
				};
			};
		});
	}

	static function looksLikeVar(name:String) {
		if (name == null || name.length == 0) {
			return false;
		};
		var c = name.charAt(0);
		if (c == "_" || c.toLowerCase() != c) {
			return false;
		};
		return name.indexOf(".", null) == -1;
	}

	static function collectUsedVars(node:reflaxe.elixir.ast.ElixirAST) {
		var used = {
			{};
			new haxe.ds.StringMap();
		};
		var visit = [null];
		visit[0] = function(e:reflaxe.elixir.ast.ElixirAST) {
			if (e == null || e.def == null) {
				return;
			};
			@:ast(switch (e.def) {
	case EVar(name):
		used.set(name, true);	
	case EField(target, _):
		visit(target);	
	case EBlock(stmts):
		for (s  in  stmts) visit(s);	
	case EIf(c, t, el):
		visit(c);
		visit(t);
		if (el != null) visit(el);	
	case ECase(expr, clauses):
		visit(expr);
		for (c  in  clauses) {
			if (c.guard != null) visit(c.guard);
			visit(c.body);
		};	
	case EBinary(_, l, r):
		visit(l);
		visit(r);	
	case EMatch(_, rhs):
		visit(rhs);	
	case ECall(tgt, _, args):
		if (tgt != null) visit(tgt);
		for (a  in  args) visit(a);	
	case ERemoteCall(tgt2, _, args2):
		visit(tgt2);
		for (a2  in  args2) visit(a2);	
	case EList(els):
		for (el  in  els) visit(el);	
	case ETuple(els):
		for (el  in  els) visit(el);	
	case EMap(pairs):
		for (p  in  pairs) {
			visit(p.key);
			visit(p.value);
		};	
	case EKeywordList(pairs):
		for (p  in  pairs) visit(p.value);	
	case EStructUpdate(base, fields):
		visit(base);
		for (f  in  fields) visit(f.value);	
	case EFn(clauses):
		for (cl  in  clauses) visit(cl.body);	
	default:
}) {
				var ` = e.def;
				switch (enumIndex `) {
					case 6: {
						var ` = `[0];
						var ` = `[1];
						{
							var expr = `;
							var clauses = `;
							{
								visit[0](expr);
								{
									var ` = 0;
									while (` < clauses.length) {
										var c = clauses[`];
										++ `;
										if (c.guard != null) {
											visit[0](c.guard);
										};
										visit[0](c.body);
									};
								};
							};
						};
					};
					case 8: {
						var ` = `[0];
						var ` = `[1];
						{
							var rhs = `;
							{
								visit[0](rhs);
							};
						};
					};
					case 10: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var c = `;
							var t = `;
							var el = `;
							{
								visit[0](c);
								visit[0](t);
								if (el != null) {
									visit[0](el);
								};
							};
						};
					};
					case 15: {
						var ` = `[0];
						{
							var els = `;
							{
								{
									var ` = 0;
									while (` < els.length) {
										var el = els[`];
										++ `;
										visit[0](el);
									};
								};
							};
						};
					};
					case 16: {
						var ` = `[0];
						{
							var els = `;
							{
								{
									var ` = 0;
									while (` < els.length) {
										var el = els[`];
										++ `;
										visit[0](el);
									};
								};
							};
						};
					};
					case 17: {
						var ` = `[0];
						{
							var pairs = `;
							{
								{
									var ` = 0;
									while (` < pairs.length) {
										var p = pairs[`];
										++ `;
										visit[0](p.key);
										visit[0](p.value);
									};
								};
							};
						};
					};
					case 19: {
						var ` = `[0];
						var ` = `[1];
						{
							var base = `;
							var fields = `;
							{
								visit[0](base);
								{
									var ` = 0;
									while (` < fields.length) {
										var f = fields[`];
										++ `;
										visit[0](f.value);
									};
								};
							};
						};
					};
					case 20: {
						var ` = `[0];
						{
							var pairs = `;
							{
								{
									var ` = 0;
									while (` < pairs.length) {
										var p = pairs[`];
										++ `;
										visit[0](p.value);
									};
								};
							};
						};
					};
					case 22: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var tgt = `;
							var args = `;
							{
								if (tgt != null) {
									visit[0](tgt);
								};
								{
									var ` = 0;
									while (` < args.length) {
										var a = args[`];
										++ `;
										visit[0](a);
									};
								};
							};
						};
					};
					case 24: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var tgt2 = `;
							var args2 = `;
							{
								visit[0](tgt2);
								{
									var ` = 0;
									while (` < args2.length) {
										var a2 = args2[`];
										++ `;
										visit[0](a2);
									};
								};
							};
						};
					};
					case 26: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var l = `;
							var r = `;
							{
								visit[0](l);
								visit[0](r);
							};
						};
					};
					case 28: {
						var ` = `[0];
						var ` = `[1];
						{
							var target = `;
							{
								visit[0](target);
							};
						};
					};
					case 38: {
						var ` = `[0];
						{
							var name = `;
							{
								{
									used.set(name, true);
								};
							};
						};
					};
					case 42: {
						var ` = `[0];
						{
							var clauses = `;
							{
								{
									var ` = 0;
									while (` < clauses.length) {
										var cl = clauses[`];
										++ `;
										visit[0](cl.body);
									};
								};
							};
						};
					};
					case 53: {
						var ` = `[0];
						{
							var stmts = `;
							{
								{
									var ` = 0;
									while (` < stmts.length) {
										var s = stmts[`];
										++ `;
										visit[0](s);
									};
								};
							};
						};
					};
					default: {}
				};
			};
		};
		visit[0](node);
		return used;
	}

	static function varUsedAsFieldReceiver(node:reflaxe.elixir.ast.ElixirAST, varName:String) {
		var found = [false];
		var walk = [null];
		walk[0] = function(n:reflaxe.elixir.ast.ElixirAST) {
			if (n == null || n.def == null || found[0]) {
				return;
			};
			@:ast(switch (n.def) {
	case EField(target, _):
		switch (target.def) {
			case EVar(v) if (v == varName):
				found = true;			
			default:
				walk(target);			
		};	
	case EBlock(ss):
		for (s  in  ss) walk(s);	
	case EDo(ss2):
		for (s  in  ss2) walk(s);	
	case EIf(c, t, e):
		walk(c);
		walk(t);
		if (e != null) walk(e);	
	case ECase(expr, cls):
		walk(expr);
		for (cl  in  cls) {
			if (cl.guard != null) walk(cl.guard);
			walk(cl.body);
		};	
	case EWith(clauses, doBlock, elseBlock):
		for (wc  in  clauses) walk(wc.expr);
		walk(doBlock);
		if (elseBlock != null) walk(elseBlock);	
	case ECall(t, _, as):
		if (t != null) walk(t);
		if (as != null) for (a  in  as) walk(a);	
	case ERemoteCall(t2, _, as2):
		walk(t2);
		if (as2 != null) for (a2  in  as2) walk(a2);	
	case EKeywordList(pairs):
		for (p  in  pairs) walk(p.value);	
	case EMap(pairs):
		for (p  in  pairs) {
			walk(p.key);
			walk(p.value);
		};	
	case EStructUpdate(base, fs):
		walk(base);
		for (f  in  fs) walk(f.value);	
	case ETuple(es) | EList(es):
		for (e  in  es) walk(e);	
	case EFn(clauses):
		for (cl  in  clauses) {
			if (cl.guard != null) walk(cl.guard);
			walk(cl.body);
		};	
	default:
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 6: {
						var ` = `[0];
						var ` = `[1];
						{
							var expr = `;
							var cls = `;
							{
								walk[0](expr);
								{
									var ` = 0;
									while (` < cls.length) {
										var cl = cls[`];
										++ `;
										if (cl.guard != null) {
											walk[0](cl.guard);
										};
										walk[0](cl.body);
									};
								};
							};
						};
					};
					case 9: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var clauses = `;
							var doBlock = `;
							var elseBlock = `;
							{
								{
									var ` = 0;
									while (` < clauses.length) {
										var wc = clauses[`];
										++ `;
										walk[0](wc.expr);
									};
								};
								walk[0](doBlock);
								if (elseBlock != null) {
									walk[0](elseBlock);
								};
							};
						};
					};
					case 10: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var c = `;
							var t = `;
							var e = `;
							{
								walk[0](c);
								walk[0](t);
								if (e != null) {
									walk[0](e);
								};
							};
						};
					};
					case 15: {
						var ` = `[0];
						{
							var es = `;
							{
								{
									var ` = 0;
									while (` < es.length) {
										var e = es[`];
										++ `;
										walk[0](e);
									};
								};
							};
						};
					};
					case 16: {
						var ` = `[0];
						{
							var es = `;
							{
								{
									var ` = 0;
									while (` < es.length) {
										var e = es[`];
										++ `;
										walk[0](e);
									};
								};
							};
						};
					};
					case 17: {
						var ` = `[0];
						{
							var pairs = `;
							{
								{
									var ` = 0;
									while (` < pairs.length) {
										var p = pairs[`];
										++ `;
										walk[0](p.key);
										walk[0](p.value);
									};
								};
							};
						};
					};
					case 19: {
						var ` = `[0];
						var ` = `[1];
						{
							var base = `;
							var fs = `;
							{
								walk[0](base);
								{
									var ` = 0;
									while (` < fs.length) {
										var f = fs[`];
										++ `;
										walk[0](f.value);
									};
								};
							};
						};
					};
					case 20: {
						var ` = `[0];
						{
							var pairs = `;
							{
								{
									var ` = 0;
									while (` < pairs.length) {
										var p = pairs[`];
										++ `;
										walk[0](p.value);
									};
								};
							};
						};
					};
					case 22: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var t = `;
							var as = `;
							{
								if (t != null) {
									walk[0](t);
								};
								if (as != null) {
									{
										var ` = 0;
										while (` < as.length) {
											var a = as[`];
											++ `;
											walk[0](a);
										};
									};
								};
							};
						};
					};
					case 24: {
						var ` = `[0];
						var ` = `[1];
						var ` = `[2];
						{
							var t2 = `;
							var as2 = `;
							{
								walk[0](t2);
								if (as2 != null) {
									{
										var ` = 0;
										while (` < as2.length) {
											var a2 = as2[`];
											++ `;
											walk[0](a2);
										};
									};
								};
							};
						};
					};
					case 28: {
						var ` = `[0];
						var ` = `[1];
						{
							var target = `;
							{
								@:ast(switch (target.def) {
	case EVar(v) if (v == varName):
		found = true;	
	default:
		walk(target);	
}) {
									var ` = target.def;
									if (enumIndex ` == 38) {
										var ` = `[0];
										{
											var v = `;
											if (v == varName) {
												found[0] = true;
											} else {
												walk[0](target);
											};
										};
									} else {
										walk[0](target);
									};
								};
							};
						};
					};
					case 42: {
						var ` = `[0];
						{
							var clauses = `;
							{
								{
									var ` = 0;
									while (` < clauses.length) {
										var cl = clauses[`];
										++ `;
										if (cl.guard != null) {
											walk[0](cl.guard);
										};
										walk[0](cl.body);
									};
								};
							};
						};
					};
					case 53: {
						var ` = `[0];
						{
							var ss = `;
							{
								{
									var ` = 0;
									while (` < ss.length) {
										var s = ss[`];
										++ `;
										walk[0](s);
									};
								};
							};
						};
					};
					case 55: {
						var ` = `[0];
						{
							var ss2 = `;
							{
								{
									var ` = 0;
									while (` < ss2.length) {
										var s = ss2[`];
										++ `;
										walk[0](s);
									};
								};
							};
						};
					};
					default: {}
				};
			};
		};
		walk[0](node);
		return found[0];
	}

	static function renameVarInNode(node:reflaxe.elixir.ast.ElixirAST, from:String, to:String) {
		return reflaxe.elixir.ast.ElixirASTTransformer.transformNode(node, function(n:reflaxe.elixir.ast.ElixirAST) {
			return @:ast(switch (n.def) {
	case EVar(name) if (name == from):
		makeASTWithMeta(EVar(to), n.metadata, n.pos);	
	case ERaw(_):
		n;	
	default:
		n;	
}) {
				var ` = n.def;
				switch (enumIndex `) {
					case 38: {
						var ` = `[0];
						{
							var name = `;
							if (name == from) {
								{def : reflaxe.elixir.ast.ElixirASTDef.EVar(to), metadata : n.metadata, pos : n.pos};
							} else {
								n;
							};
						};
					};
					case 62: {
						var ` = `[0];
						{
							n;
						};
					};
					default: {
						n;
					}
				};
			};
		});
	}
}